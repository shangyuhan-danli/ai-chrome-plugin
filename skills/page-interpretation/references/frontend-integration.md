# å‰ç«¯é›†æˆæŒ‡å—

æœ¬æ–‡æ¡£æä¾›äº†å¦‚ä½•åœ¨å‰ç«¯èŠå¤©ç•Œé¢ä¸­æ˜¾ç¤ºç¾è§‚çš„ skill é¢„è§ˆæ•ˆæœçš„å®Œæ•´å®ç°æ–¹æ¡ˆã€‚

## âš ï¸ é‡è¦è¯´æ˜ï¼šä¸ä¾èµ–åç«¯æ ¼å¼

**å‰ç«¯é›†æˆæ–¹æ¡ˆæ˜¯çµæ´»çš„ï¼Œä¸å¼ºåˆ¶è¦æ±‚åç«¯è¿”å›ç‰¹å®šæ ¼å¼ã€‚** ä½ å¯ä»¥é€‰æ‹©ä»¥ä¸‹ä»»ä¸€æ–¹æ¡ˆï¼š

- **æ–¹æ¡ˆAï¼šå‰ç«¯ç›´æ¥ç”Ÿæˆ** - AI ç”Ÿæˆ MD æ–‡æ¡£åï¼Œå‰ç«¯è§£æå¹¶ç”Ÿæˆ HTML é¢„è§ˆï¼ˆæ¨èï¼‰
- **æ–¹æ¡ˆBï¼šåç«¯è¿”å› HTML** - åç«¯ç”Ÿæˆ HTMLï¼Œå‰ç«¯ç›´æ¥æ¸²æŸ“
- **æ–¹æ¡ˆCï¼šåç«¯è¿”å›ç»“æ„åŒ–æ•°æ®** - åç«¯è¿”å› JSONï¼Œå‰ç«¯æ ¹æ®æ•°æ®ç”Ÿæˆ HTML

**æ¨èä½¿ç”¨æ–¹æ¡ˆA**ï¼Œå› ä¸ºï¼š
- âœ… ä¸ä¾èµ–åç«¯æ”¹åŠ¨
- âœ… å‰ç«¯å®Œå…¨æ§åˆ¶é¢„è§ˆæ ·å¼
- âœ… å¯ä»¥çµæ´»è°ƒæ•´å’Œä¼˜åŒ–
- âœ… å‡å°‘åç«¯è´Ÿæ‹…

## ç›®å½•

- [å®ç°æ–¹æ¡ˆé€‰æ‹©](#å®ç°æ–¹æ¡ˆé€‰æ‹©)
- [æ–¹æ¡ˆAï¼šå‰ç«¯ç›´æ¥ç”Ÿæˆï¼ˆæ¨èï¼‰](#æ–¹æ¡ˆaå‰ç«¯ç›´æ¥ç”Ÿæˆæ¨è)
- [æ–¹æ¡ˆBï¼šåç«¯è¿”å›HTML](#æ–¹æ¡ˆbåç«¯è¿”å›html)
- [æ–¹æ¡ˆCï¼šåç«¯è¿”å›ç»“æ„åŒ–æ•°æ®](#æ–¹æ¡ˆcåç«¯è¿”å›ç»“æ„åŒ–æ•°æ®)
- [æ·»åŠ æ–°çš„ Block ç±»å‹](#æ·»åŠ æ–°çš„-block-ç±»å‹)
- [å‰ç«¯æ¸²æŸ“å®ç°](#å‰ç«¯æ¸²æŸ“å®ç°)
- [äº¤äº’åŠŸèƒ½å®ç°](#äº¤äº’åŠŸèƒ½å®ç°)
- [æ ·å¼ä¼˜åŒ–](#æ ·å¼ä¼˜åŒ–)

## å®ç°æ–¹æ¡ˆé€‰æ‹©

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **æ–¹æ¡ˆAï¼šå‰ç«¯ç”Ÿæˆ** | ä¸ä¾èµ–åç«¯ã€çµæ´»å¯æ§ | å‰ç«¯ä»£ç è¾ƒå¤š | âœ… **æ¨è** - å¤§å¤šæ•°æƒ…å†µ |
| **æ–¹æ¡ˆBï¼šåç«¯è¿”å›HTML** | å‰ç«¯ç®€å•ã€åç«¯ç»Ÿä¸€ | ä¾èµ–åç«¯æ”¹åŠ¨ã€æ ·å¼éš¾è°ƒ | åç«¯å·²æ”¯æŒHTMLç”Ÿæˆ |
| **æ–¹æ¡ˆCï¼šåç«¯è¿”å›æ•°æ®** | å‰åç«¯åˆ†ç¦»ã€æ•°æ®æ¸…æ™° | éœ€è¦çº¦å®šæ•°æ®ç»“æ„ | å‰åç«¯åä½œå¼€å‘ |

## æ–¹æ¡ˆAï¼šå‰ç«¯ç›´æ¥ç”Ÿæˆï¼ˆæ¨èï¼‰

### æ ¸å¿ƒæ€è·¯

AI ç”Ÿæˆ MD æ–‡æ¡£åï¼Œå‰ç«¯ï¼š
1. è§£æ MD æ–‡æ¡£å†…å®¹
2. æå–å…³é”®ä¿¡æ¯ï¼ˆskillåç§°ã€æ“ä½œã€é€‰æ‹©å™¨ç­‰ï¼‰
3. åœ¨å‰ç«¯ç”Ÿæˆ HTML é¢„è§ˆ
4. æ¸²æŸ“åˆ°èŠå¤©ç•Œé¢

### å®ç°æ­¥éª¤

#### 1. è§£æ MD æ–‡æ¡£

```typescript
// è§£æ MD æ–‡æ¡£ï¼Œæå–å…³é”®ä¿¡æ¯
const parseSkillMarkdown = (markdown: string) => {
  // è§£æ frontmatter
  const frontmatterMatch = markdown.match(/^---\n([\s\S]*?)\n---/)
  const frontmatter = frontmatterMatch ? parseYAML(frontmatterMatch[1]) : {}
  
  // æå– skill åç§°å’Œæè¿°
  const name = frontmatter.name || 'unknown'
  const description = frontmatter.description || ''
  
  // æå–é€‚ç”¨é¡µé¢
  const pagePatternMatch = markdown.match(/## é€‚ç”¨é¡µé¢\n([\s\S]*?)(?=\n##|$)/)
  const pagePattern = pagePatternMatch ? pagePatternMatch[1].trim() : ''
  
  // æå–æ“ä½œåˆ—è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…å¯ä»¥ä½¿ç”¨æ›´å¤æ‚çš„è§£æï¼‰
  const operations: Array<{ name: string; icon: string }> = []
  const operationMatches = markdown.matchAll(/### \d+\.\s+(.+?)\n/g)
  for (const match of operationMatches) {
    const operationName = match[1].trim()
    // æ ¹æ®æ“ä½œåç§°é€‰æ‹©å›¾æ ‡
    const icon = getOperationIcon(operationName)
    operations.push({ name: operationName, icon })
  }
  
  // æå–é€‰æ‹©å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
  const selectors: Array<{
    name: string
    selector: string
    description: string
    type: string
    fallback?: string[]
  }> = []
  
  // ä½¿ç”¨æ­£åˆ™æˆ–æ›´å¤æ‚çš„è§£æå™¨æå–é€‰æ‹©å™¨ä¿¡æ¯
  const selectorMatches = markdown.matchAll(/selector:\s*['"](.+?)['"]/g)
  // ... è§£æé€‰æ‹©å™¨
  
  return {
    name,
    description,
    pagePattern,
    operations,
    selectors,
    markdownContent: markdown
  }
}
```

#### 2. ç”Ÿæˆ HTML é¢„è§ˆ

```typescript
// æ ¹æ®è§£æçš„æ•°æ®ç”Ÿæˆ HTML
const generateSkillPreviewHTML = (skillData: {
  name: string
  description: string
  pagePattern: string
  operations: Array<{ name: string; icon: string }>
  selectors: Array<any>
}) => {
  // ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ HTMLï¼ˆå¯ä»¥ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²æˆ–æ¨¡æ¿å¼•æ“ï¼‰
  return `
    <div class="skill-preview-card" style="...">
      <div class="skill-header">
        <h2>${skillData.name} Skill</h2>
      </div>
      <div class="skill-info">
        <div>é€‚ç”¨é¡µé¢: <code>${skillData.pagePattern}</code></div>
        <div>æ“ä½œæ•°é‡: ${skillData.operations.length} ä¸ª</div>
      </div>
      <div class="skill-operations">
        ${skillData.operations.map(op => `
          <div class="operation-item">
            <span>${op.icon}</span>
            <span>${op.name}</span>
          </div>
        `).join('')}
      </div>
    </div>
  `
}
```

#### 3. åœ¨ AI å“åº”ä¸­å¤„ç†

```typescript
// å½“ AI è¿”å›åŒ…å« MD æ–‡æ¡£çš„å“åº”æ—¶
const handleAIResponse = (response: string) => {
  // æ£€æµ‹æ˜¯å¦åŒ…å« skill MD æ–‡æ¡£
  if (response.includes('---\nname:') && response.includes('## é€‚ç”¨é¡µé¢')) {
    // æå– MD æ–‡æ¡£å†…å®¹
    const mdMatch = response.match(/```markdown\n([\s\S]*?)\n```/) || 
                    response.match(/---\n([\s\S]*?)(?=\n```|$)/)
    
    if (mdMatch) {
      const markdown = mdMatch[1]
      
      // è§£æå¹¶ç”Ÿæˆé¢„è§ˆ
      const skillData = parseSkillMarkdown(markdown)
      const previewHTML = generateSkillPreviewHTML(skillData)
      
      // åˆ›å»ºé¢„è§ˆæ¶ˆæ¯
      const previewMessage: StreamMessage = {
        sessionId: currentSessionId.value,
        role: 'assistant',
        blocks: [
          { type: 'text', text: 'âœ… Skill æ–‡æ¡£å·²ç”Ÿæˆï¼' },
          {
            type: 'html',
            html: previewHTML,
            data: {
              markdownContent: markdown,
              fileName: `${skillData.name}.md`
            }
          } as HtmlBlock
        ],
        createdAt: Date.now()
      }
      
      streamMessages.value.push(previewMessage)
    }
  }
}
```

### ä¼˜ç‚¹

- âœ… **ä¸ä¾èµ–åç«¯**ï¼šå®Œå…¨åœ¨å‰ç«¯å¤„ç†
- âœ… **çµæ´»å¯æ§**ï¼šå¯ä»¥éšæ—¶è°ƒæ•´é¢„è§ˆæ ·å¼å’Œç»“æ„
- âœ… **æ˜“äºè°ƒè¯•**ï¼šå‰ç«¯å¯ä»¥ç›´æ¥çœ‹åˆ°å’Œä¿®æ”¹é¢„è§ˆ
- âœ… **å‡å°‘åç«¯è´Ÿæ‹…**ï¼šåç«¯åªéœ€è¦è¿”å› MD æ–‡æ¡£

## æ–¹æ¡ˆBï¼šåç«¯è¿”å›HTML

å¦‚æœåç«¯å·²ç»æ”¯æŒç”Ÿæˆ HTMLï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

### å®ç°æ–¹å¼

```typescript
// åç«¯è¿”å›æ ¼å¼ï¼ˆç¤ºä¾‹ï¼‰
{
  "markdown": "...",  // MD æ–‡æ¡£
  "preview": {
    "html": "<div>...</div>",  // åç«¯ç”Ÿæˆçš„ HTML
    "type": "skill_preview"
  }
}

// å‰ç«¯ç›´æ¥ä½¿ç”¨
const previewMessage: StreamMessage = {
  blocks: [
    { type: 'text', text: 'âœ… Skill å·²ç”Ÿæˆï¼' },
    {
      type: 'html',
      html: response.preview.html,  // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„ HTML
      data: {
        markdownContent: response.markdown,
        fileName: 'skill.md'
      }
    } as HtmlBlock
  ]
}
```

## æ–¹æ¡ˆCï¼šåç«¯è¿”å›ç»“æ„åŒ–æ•°æ®

å¦‚æœåç«¯è¿”å›ç»“æ„åŒ–çš„ JSON æ•°æ®ï¼š

### æ•°æ®ç»“æ„ç¤ºä¾‹

```typescript
interface SkillData {
  name: string
  description: string
  pagePattern: string
  operations: Array<{
    name: string
    icon: string
    path: string
    selectors: Array<{
      name: string
      selector: string
      description: string
      type: string
      fallback?: string[]
    }>
    workflow: string[]
  }>
}
```

### å‰ç«¯ç”Ÿæˆ HTML

```typescript
// åç«¯è¿”å›ç»“æ„åŒ–æ•°æ®
const skillData: SkillData = response.data

// å‰ç«¯æ ¹æ®æ•°æ®ç”Ÿæˆ HTML
const previewHTML = generateSkillPreviewHTML(skillData)

const previewMessage: StreamMessage = {
  blocks: [
    { type: 'text', text: 'âœ… Skill å·²ç”Ÿæˆï¼' },
    {
      type: 'html',
      html: previewHTML,
      data: { skillData }
    } as HtmlBlock
  ]
}
```

## æ·»åŠ æ–°çš„ Block ç±»å‹

### 1. æ›´æ–°ç±»å‹å®šä¹‰

åœ¨ `src/utils/types.ts` ä¸­æ·»åŠ æ–°çš„ block ç±»å‹ï¼š

```typescript
// æ·»åŠ  'html' æˆ– 'skill_preview' åˆ° ContentBlockType
export type ContentBlockType = 'text' | 'tool_use' | 'summary' | 'question' | 'image' | 'html'

// æ·»åŠ  HTML Block æ¥å£
export interface HtmlBlock {
  type: 'html'
  html: string
  style?: string  // å¯é€‰çš„æ ·å¼æ ‡è¯†
  data?: Record<string, any>  // é™„åŠ æ•°æ®ï¼ˆå¦‚ markdown å†…å®¹ã€æ–‡ä»¶åç­‰ï¼‰
}

// æ›´æ–° ContentBlock è”åˆç±»å‹
export type ContentBlock = TextBlock | ToolUseBlock | SummaryBlock | QuestionBlock | HtmlBlock
```

### 2. æ›´æ–°æ¶ˆæ¯æ¥å£ï¼ˆå¦‚éœ€è¦ï¼‰

å¦‚æœéœ€è¦åœ¨æ¶ˆæ¯ä¸­å­˜å‚¨é¢å¤–çš„å…ƒæ•°æ®ï¼š

```typescript
export interface StreamMessage {
  // ... ç°æœ‰å­—æ®µ
  blocks: ContentBlock[]
  // å¯ä»¥æ·»åŠ  skill ç›¸å…³çš„å…ƒæ•°æ®
  skillPreview?: {
    markdownContent?: string
    skillName?: string
    fileName?: string
  }
}
```

## å‰ç«¯æ¸²æŸ“å®ç°

### 1. åœ¨ App.vue ä¸­æ·»åŠ  HTML Block æ¸²æŸ“

åœ¨æ¶ˆæ¯æ¸²æŸ“æ¨¡æ¿ä¸­æ·»åŠ  HTML block çš„å¤„ç†ï¼š

```vue
<template>
  <!-- ç°æœ‰çš„ block ç±»å‹... -->
  
  <!-- HTML Block (Skill é¢„è§ˆ) -->
  <div v-else-if="block.type === 'html'" class="html-block skill-preview-block">
    <div 
      class="skill-preview-container"
      v-html="sanitizeHtml((block as HtmlBlock).html)"
    ></div>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <div v-if="(block as HtmlBlock).data" class="skill-preview-actions">
      <button 
        v-if="(block as HtmlBlock).data.markdownContent"
        class="btn btn-download-skill"
        @click="downloadSkillFile((block as HtmlBlock).data)"
      >
        ğŸ“¥ ä¸‹è½½ MD æ–‡ä»¶
      </button>
      <button 
        class="btn btn-copy-skill"
        @click="copySkillContent((block as HtmlBlock).data)"
      >
        ğŸ“‹ å¤åˆ¶å†…å®¹
      </button>
    </div>
  </div>
</template>
```

### 2. HTML å®‰å…¨å¤„ç†

æ·»åŠ  HTML æ¸…ç†å‡½æ•°ï¼Œé˜²æ­¢ XSS æ”»å‡»ï¼š

```typescript
import DOMPurify from 'dompurify'  // éœ€è¦å®‰è£… dompurify

// HTML æ¸…ç†å‡½æ•°
const sanitizeHtml = (html: string): string => {
  // ä½¿ç”¨ DOMPurify æ¸…ç† HTMLï¼Œä½†ä¿ç•™æ ·å¼å’Œç»“æ„
  return DOMPurify.sanitize(html, {
    ALLOWED_TAGS: [
      'div', 'span', 'h1', 'h2', 'h3', 'p', 'code', 'pre',
      'button', 'a', 'img', 'svg', 'path', 'polyline', 'line',
      'ul', 'ol', 'li', 'strong', 'em', 'br', 'hr'
    ],
    ALLOWED_ATTR: [
      'class', 'style', 'id', 'href', 'target', 'rel',
      'onclick', 'data-*', 'aria-*', 'role', 'alt', 'src'
    ],
    ALLOWED_STYLES: {
      '*': {
        'color': true,
        'background': true,
        'background-color': true,
        'background-image': true,
        'border': true,
        'border-radius': true,
        'padding': true,
        'margin': true,
        'font-size': true,
        'font-weight': true,
        'display': true,
        'flex': true,
        'gap': true,
        'box-shadow': true,
        'transition': true,
        // ... å…¶ä»–éœ€è¦çš„æ ·å¼å±æ€§
      }
    }
  })
}
```

### 3. äº‹ä»¶å§”æ‰˜å¤„ç†äº¤äº’

ç”±äº HTML æ˜¯åŠ¨æ€æ’å…¥çš„ï¼Œéœ€è¦ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†äº¤äº’ï¼š

```typescript
// åœ¨ç»„ä»¶æŒ‚è½½åæ·»åŠ äº‹ä»¶ç›‘å¬
onMounted(() => {
  // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†é¢„è§ˆå†…çš„æŒ‰é’®ç‚¹å‡»
  const container = document.querySelector('.chat-messages')
  if (container) {
    container.addEventListener('click', handlePreviewClick)
  }
})

onUnmounted(() => {
  const container = document.querySelector('.chat-messages')
  if (container) {
    container.removeEventListener('click', handlePreviewClick)
  }
})

// å¤„ç†é¢„è§ˆå†…çš„ç‚¹å‡»äº‹ä»¶
const handlePreviewClick = (event: MouseEvent) => {
  const target = event.target as HTMLElement
  
  // å¤„ç†å¤åˆ¶é€‰æ‹©å™¨æŒ‰é’®
  if (target.classList.contains('copy-selector-btn') || target.closest('.copy-selector-btn')) {
    const btn = target.classList.contains('copy-selector-btn') 
      ? target 
      : target.closest('.copy-selector-btn') as HTMLElement
    const selector = btn.getAttribute('data-selector')
    if (selector) {
      copySelector(selector)
    }
  }
  
  // å¤„ç†ä¸‹è½½æŒ‰é’®
  if (target.classList.contains('btn-download') || target.closest('.btn-download')) {
    const btn = target.classList.contains('btn-download')
      ? target
      : target.closest('.btn-download') as HTMLElement
    const markdownContent = btn.getAttribute('data-markdown')
    const fileName = btn.getAttribute('data-filename')
    if (markdownContent) {
      downloadSkillFile({
        markdownContent,
        fileName: fileName || `skill_${Date.now()}.md`
      })
    }
  }
  
  // å¤„ç†å±•å¼€/æŠ˜å 
  if (target.classList.contains('toggle-preview') || target.closest('.toggle-preview')) {
    const container = target.closest('.skill-preview-card')
    if (container) {
      container.classList.toggle('expanded')
    }
  }
}
```

## äº¤äº’åŠŸèƒ½å®ç°

### 1. ä¸‹è½½ MD æ–‡ä»¶

```typescript
const downloadSkillFile = (data: { markdownContent: string; fileName?: string }) => {
  const blob = new Blob([data.markdownContent], { type: 'text/markdown;charset=utf-8' })
  const url = URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.download = data.fileName || `skill_${Date.now()}.md`
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
  URL.revokeObjectURL(url)
  
  // æ˜¾ç¤ºæˆåŠŸæç¤º
  showToast('æ–‡ä»¶å·²ä¸‹è½½')
}
```

### 2. å¤åˆ¶é€‰æ‹©å™¨

```typescript
const copySelector = async (selector: string) => {
  try {
    await navigator.clipboard.writeText(selector)
    showToast('é€‰æ‹©å™¨å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
  } catch (error) {
    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
    const textArea = document.createElement('textarea')
    textArea.value = selector
    textArea.style.position = 'fixed'
    textArea.style.opacity = '0'
    document.body.appendChild(textArea)
    textArea.select()
    document.execCommand('copy')
    document.body.removeChild(textArea)
    showToast('é€‰æ‹©å™¨å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
  }
}
```

### 3. å¤åˆ¶ Skill å†…å®¹

```typescript
const copySkillContent = async (data: { markdownContent?: string; html?: string }) => {
  const content = data.markdownContent || data.html || ''
  try {
    await navigator.clipboard.writeText(content)
    showToast('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
  } catch (error) {
    console.error('å¤åˆ¶å¤±è´¥:', error)
    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}
```

### 4. æ˜¾ç¤ºæç¤ºæ¶ˆæ¯

```typescript
const showToast = (message: string, duration: number = 2000) => {
  // åˆ›å»º toast å…ƒç´ 
  const toast = document.createElement('div')
  toast.className = 'toast-message'
  toast.textContent = message
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #333;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `
  
  document.body.appendChild(toast)
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease'
    setTimeout(() => {
      document.body.removeChild(toast)
    }, 300)
  }, duration)
}
```

## æ ·å¼ä¼˜åŒ–

### 1. æ·»åŠ  Skill é¢„è§ˆæ ·å¼

åœ¨ `App.vue` çš„ `<style>` éƒ¨åˆ†æ·»åŠ ï¼š

```css
/* Skill é¢„è§ˆå—æ ·å¼ */
.skill-preview-block {
  margin: var(--space-3) 0;
  max-width: 100%;
  overflow-x: auto;
}

.skill-preview-container {
  /* ç¡®ä¿é¢„è§ˆå†…å®¹æ­£ç¡®æ˜¾ç¤º */
  width: 100%;
  min-height: 200px;
}

/* ç¡®ä¿é¢„è§ˆå†…çš„æ ·å¼æ­£ç¡®åº”ç”¨ */
.skill-preview-container :deep(.skill-preview-card) {
  /* é¢„è§ˆå¡ç‰‡æ ·å¼å·²åœ¨ HTML ä¸­å†…è”ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ è¦†ç›–æ ·å¼ */
  max-width: 100%;
  box-sizing: border-box;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .skill-preview-container :deep(.skill-preview-card) {
    padding: 16px;
    font-size: 14px;
  }
  
  .skill-preview-container :deep(.skill-header h2) {
    font-size: 20px;
  }
}

/* æ“ä½œæŒ‰é’®åŒºåŸŸ */
.skill-preview-actions {
  display: flex;
  gap: var(--space-2);
  margin-top: var(--space-3);
  padding-top: var(--space-3);
  border-top: 1px solid var(--border-color);
  flex-wrap: wrap;
}

.btn-download-skill,
.btn-copy-skill {
  padding: var(--space-2) var(--space-4);
  border-radius: var(--radius-md);
  border: 1px solid var(--border-color);
  background: var(--bg-secondary);
  color: var(--text-primary);
  cursor: pointer;
  font-size: var(--text-sm);
  transition: all var(--transition-base);
  display: flex;
  align-items: center;
  gap: var(--space-1);
}

.btn-download-skill:hover,
.btn-copy-skill:hover {
  background: var(--bg-tertiary);
  border-color: var(--primary-500);
}

/* ç¡®ä¿é¢„è§ˆå†…çš„æŒ‰é’®æ ·å¼ */
.skill-preview-container :deep(button) {
  cursor: pointer;
  transition: all 0.3s ease;
}

.skill-preview-container :deep(button:hover) {
  opacity: 0.9;
  transform: translateY(-1px);
}

/* ä»£ç å—æ ·å¼ */
.skill-preview-container :deep(code) {
  font-family: 'Monaco', 'Courier New', monospace;
  font-size: 13px;
  padding: 2px 6px;
  border-radius: 4px;
}

/* é€‰æ‹©å™¨å¡ç‰‡æ ·å¼ */
.skill-preview-container :deep(.selector-card) {
  transition: all 0.3s ease;
}

.skill-preview-container :deep(.selector-card:hover) {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* åŠ¨ç”» */
@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOut {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}
```

### 2. ç¡®ä¿æ ·å¼éš”ç¦»

ä¸ºäº†é¿å…æ ·å¼å†²çªï¼Œå»ºè®®ï¼š

1. **ä½¿ç”¨ scoped æ ·å¼**ï¼šåœ¨ç»„ä»¶ä¸­ä½¿ç”¨ `<style scoped>`
2. **ä½¿ç”¨ CSS å˜é‡**ï¼šåˆ©ç”¨ç°æœ‰çš„ CSS å˜é‡ç³»ç»Ÿ
3. **å†…è”å…³é”®æ ·å¼**ï¼šåœ¨ç”Ÿæˆçš„ HTML ä¸­ä½¿ç”¨å†…è”æ ·å¼
4. **ä½¿ç”¨æ·±åº¦é€‰æ‹©å™¨**ï¼šä½¿ç”¨ `:deep()` æ¥å½±å“å­å…ƒç´ 

## å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šå‰ç«¯è§£æ MD å¹¶ç”Ÿæˆé¢„è§ˆï¼ˆæ¨èï¼‰

```typescript
// å½“ AI è¿”å›åŒ…å« MD æ–‡æ¡£çš„æ–‡æœ¬æ—¶
const handleStreamContent = (content: string) => {
  // æ£€æµ‹æ˜¯å¦åŒ…å« skill MD æ–‡æ¡£
  const mdPattern = /```markdown\n([\s\S]*?)\n```|^---\nname:([\s\S]*?)(?=\n```|$)/
  const mdMatch = content.match(mdPattern)
  
  if (mdMatch) {
    const markdown = mdMatch[1] || mdMatch[2]
    
    // è§£æ MD æ–‡æ¡£
    const skillData = parseSkillMarkdown(markdown)
    
    // ç”Ÿæˆ HTML é¢„è§ˆ
    const previewHTML = generateSkillPreviewHTML(skillData)
    
    // åˆ›å»ºé¢„è§ˆæ¶ˆæ¯
    const previewMessage: StreamMessage = {
      sessionId: currentSessionId.value,
      role: 'assistant',
      blocks: [
        { type: 'text', text: 'âœ… Skill æ–‡æ¡£å·²ç”Ÿæˆï¼' },
        {
          type: 'html',
          html: previewHTML,
          data: {
            markdownContent: markdown,
            fileName: `${skillData.name}.md`
          }
        } as HtmlBlock
      ],
      createdAt: Date.now()
    }
    
    streamMessages.value.push(previewMessage)
    nextTick(scrollToBottom)
  }
}
```

### ç¤ºä¾‹2ï¼šä»åç«¯ç»“æ„åŒ–æ•°æ®ç”Ÿæˆ

```typescript
// åç«¯è¿”å›ç»“æ„åŒ–æ•°æ®
interface BackendResponse {
  skill: {
    name: string
    description: string
    pagePattern: string
    operations: Array<{ name: string; icon: string }>
    selectors: Array<any>
  }
  markdown: string
}

// å‰ç«¯å¤„ç†
const handleBackendResponse = (response: BackendResponse) => {
  const previewHTML = generateSkillPreviewHTML(response.skill)
  
  const previewMessage: StreamMessage = {
    sessionId: currentSessionId.value,
    role: 'assistant',
    blocks: [
      { type: 'text', text: 'âœ… Skill å·²ç”Ÿæˆï¼' },
      {
        type: 'html',
        html: previewHTML,
        data: {
          markdownContent: response.markdown,
          fileName: `${response.skill.name}.md`
        }
      } as HtmlBlock
    ],
    createdAt: Date.now()
  }
  
  streamMessages.value.push(previewMessage)
}
```

### ç¤ºä¾‹3ï¼šç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„ HTML

```typescript
// åç«¯è¿”å› HTML
interface BackendResponse {
  markdown: string
  previewHtml: string  // åç«¯å·²ç”Ÿæˆçš„ HTML
}

// å‰ç«¯ç›´æ¥ä½¿ç”¨
const handleBackendResponse = (response: BackendResponse) => {
  const previewMessage: StreamMessage = {
    sessionId: currentSessionId.value,
    role: 'assistant',
    blocks: [
      { type: 'text', text: 'âœ… Skill å·²ç”Ÿæˆï¼' },
      {
        type: 'html',
        html: response.previewHtml,  // ç›´æ¥ä½¿ç”¨
        data: {
          markdownContent: response.markdown,
          fileName: 'skill.md'
        }
      } as HtmlBlock
    ],
    createdAt: Date.now()
  }
  
  streamMessages.value.push(previewMessage)
}
```

## æ–¹æ¡ˆé€‰æ‹©å»ºè®®

### ä½•æ—¶ä½¿ç”¨æ–¹æ¡ˆAï¼ˆå‰ç«¯ç”Ÿæˆï¼‰

âœ… **æ¨èä½¿ç”¨**ï¼Œé€‚åˆä»¥ä¸‹æƒ…å†µï¼š
- åç«¯åªè¿”å› MD æ–‡æ¡£æˆ–æ–‡æœ¬
- éœ€è¦çµæ´»æ§åˆ¶é¢„è§ˆæ ·å¼
- ä¸æƒ³ä¿®æ”¹åç«¯ä»£ç 
- å‰ç«¯å›¢é˜Ÿç‹¬ç«‹å¼€å‘

### ä½•æ—¶ä½¿ç”¨æ–¹æ¡ˆBï¼ˆåç«¯è¿”å›HTMLï¼‰

é€‚åˆä»¥ä¸‹æƒ…å†µï¼š
- åç«¯å·²æœ‰ HTML ç”Ÿæˆèƒ½åŠ›
- éœ€è¦ç»Ÿä¸€çš„é¢„è§ˆæ ·å¼ï¼ˆå¤šç«¯å…±äº«ï¼‰
- åç«¯å›¢é˜Ÿæ„¿æ„æ”¯æŒ

### ä½•æ—¶ä½¿ç”¨æ–¹æ¡ˆCï¼ˆåç«¯è¿”å›æ•°æ®ï¼‰

é€‚åˆä»¥ä¸‹æƒ…å†µï¼š
- å‰åç«¯åä½œå¼€å‘
- éœ€è¦æ¸…æ™°çš„æ•°æ®ç»“æ„
- å‰ç«¯éœ€è¦æ ¹æ®æ•°æ®åšæ›´å¤šå¤„ç†

## æœ€ä½³å®è·µ

1. **å®‰å…¨æ€§**ï¼š
   - å§‹ç»ˆä½¿ç”¨ DOMPurify æ¸…ç† HTMLï¼ˆæ–¹æ¡ˆAå’ŒCå¿…é¡»ï¼‰
   - éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥
   - ä½¿ç”¨ CSPï¼ˆContent Security Policyï¼‰

2. **æ€§èƒ½**ï¼š
   - å»¶è¿ŸåŠ è½½å¤§å‹é¢„è§ˆ
   - ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¦‚æœé¢„è§ˆå¾ˆå¤šï¼‰
   - ç¼“å­˜ç”Ÿæˆçš„ HTMLï¼ˆæ–¹æ¡ˆAï¼‰

3. **å¯è®¿é—®æ€§**ï¼š
   - æ·»åŠ é€‚å½“çš„ ARIA æ ‡ç­¾
   - ç¡®ä¿é”®ç›˜å¯¼èˆªå¯ç”¨
   - æä¾›æ–‡æœ¬æ›¿ä»£æ–¹æ¡ˆ

4. **å“åº”å¼**ï¼š
   - ç¡®ä¿åœ¨ä¸åŒå±å¹•å°ºå¯¸ä¸‹æ­£å¸¸æ˜¾ç¤º
   - æµ‹è¯•ç§»åŠ¨ç«¯ä½“éªŒ
   - ä½¿ç”¨ç›¸å¯¹å•ä½è€Œéå›ºå®šåƒç´ 

5. **ç”¨æˆ·ä½“éªŒ**ï¼š
   - æä¾›åŠ è½½çŠ¶æ€
   - æ˜¾ç¤ºé”™è¯¯æç¤º
   - æ·»åŠ æ“ä½œåé¦ˆï¼ˆå¦‚å¤åˆ¶æˆåŠŸæç¤ºï¼‰

## æ³¨æ„äº‹é¡¹

1. **XSS é˜²æŠ¤**ï¼š
   - æ–¹æ¡ˆAå’ŒCï¼šå¿…é¡»ä½¿ç”¨ DOMPurify æ¸…ç† HTML
   - æ–¹æ¡ˆBï¼šå¦‚æœåç«¯å¯ä¿¡ï¼Œå¯ä»¥ç®€åŒ–æ¸…ç†ï¼Œä½†ä»å»ºè®®æ¸…ç†

2. **æ ·å¼å†²çª**ï¼šä½¿ç”¨ scoped æ ·å¼æˆ–å‘½åç©ºé—´

3. **äº‹ä»¶å¤„ç†**ï¼šä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åŠ¨æ€å†…å®¹

4. **æµè§ˆå™¨å…¼å®¹æ€§**ï¼šæµ‹è¯•ä¸åŒæµè§ˆå™¨çš„è¡¨ç°

5. **æ€§èƒ½å½±å“**ï¼šé¿å…è¿‡å¤§çš„ HTML ç»“æ„

6. **æ•°æ®æ ¼å¼**ï¼š
   - **ä¸å¼ºåˆ¶è¦æ±‚åç«¯è¿”å›ç‰¹å®šæ ¼å¼**
   - å‰ç«¯å¯ä»¥æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©æœ€é€‚åˆçš„æ–¹æ¡ˆ
   - æ¨èæ–¹æ¡ˆAï¼Œå› ä¸ºå®ƒæœ€çµæ´»ä¸”ä¸ä¾èµ–åç«¯
