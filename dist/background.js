var M=Object.defineProperty;var P=(i,t,s)=>t in i?M(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s;var y=(i,t,s)=>P(i,typeof t!="symbol"?t+"":t,s);class C{constructor(){y(this,"dbName","ai-chat-db");y(this,"version",2);y(this,"db",null)}async init(){return new Promise((t,s)=>{const e=indexedDB.open(this.dbName,this.version);e.onerror=()=>s(e.error),e.onsuccess=()=>{this.db=e.result,t()},e.onupgradeneeded=o=>{const n=o.target.result,a=o.oldVersion;if(n.objectStoreNames.contains("sessions")){if(a<2){const c=o.target.transaction.objectStore("sessions");c.indexNames.contains("tabId")||c.createIndex("tabId","tabId",{unique:!1})}}else{const r=n.createObjectStore("sessions",{keyPath:"id",autoIncrement:!0});r.createIndex("createdAt","createdAt",{unique:!1}),r.createIndex("tabId","tabId",{unique:!1})}if(!n.objectStoreNames.contains("messages")){const r=n.createObjectStore("messages",{keyPath:"id",autoIncrement:!0});r.createIndex("sessionId","sessionId",{unique:!1}),r.createIndex("createdAt","createdAt",{unique:!1})}n.objectStoreNames.contains("settings")||n.createObjectStore("settings",{keyPath:"key"})}})}async addSession(t,s,e,o){const n={title:t,tabId:s||null,pageUrl:e||"",pageTitle:o||"",createdAt:Date.now(),updatedAt:Date.now()};return this.add("sessions",n)}async updateSession(t,s){return this.db||await this.init(),new Promise((e,o)=>{const n=this.db.transaction(["sessions"],"readwrite"),a=n.objectStore("sessions"),r=a.get(t);r.onsuccess=()=>{const c=r.result;if(c){const h={...c,...s,updatedAt:Date.now()};a.put(h)}},n.oncomplete=()=>e(),n.onerror=()=>o(n.error)})}async getSessionByTabId(t){return this.db||await this.init(),new Promise((s,e)=>{const r=this.db.transaction(["sessions"],"readonly").objectStore("sessions").index("tabId").get(t);r.onsuccess=()=>s(r.result||null),r.onerror=()=>e(r.error)})}async getSession(t){return this.db||await this.init(),new Promise((s,e)=>{const a=this.db.transaction(["sessions"],"readonly").objectStore("sessions").get(t);a.onsuccess=()=>s(a.result||null),a.onerror=()=>e(a.error)})}async addMessage(t,s,e,o,n){const a={sessionId:t,role:s,content:e,blocks:o||[{type:"text",text:e}],think:n||"",createdAt:Date.now()};return this.add("messages",a)}async getMessages(t){return this.db||await this.init(),new Promise((s,e)=>{const r=this.db.transaction(["messages"],"readonly").objectStore("messages").index("sessionId").getAll(t);r.onsuccess=()=>s(r.result),r.onerror=()=>e(r.error)})}async getSessions(){return this.db||await this.init(),new Promise((t,s)=>{const n=this.db.transaction(["sessions"],"readonly").objectStore("sessions").getAll();n.onsuccess=()=>t(n.result),n.onerror=()=>s(n.error)})}async saveSetting(t,s){await this.put("settings",{key:t,value:s})}async getSetting(t){return this.db||await this.init(),new Promise((s,e)=>{const a=this.db.transaction(["settings"],"readonly").objectStore("settings").get(t);a.onsuccess=()=>{var r;return s((r=a.result)==null?void 0:r.value)},a.onerror=()=>e(a.error)})}async deleteSession(t){return this.db||await this.init(),new Promise((s,e)=>{const o=this.db.transaction(["sessions","messages"],"readwrite");o.objectStore("sessions").delete(t);const c=o.objectStore("messages").index("sessionId").openCursor(IDBKeyRange.only(t));c.onsuccess=h=>{const u=h.target.result;u&&(u.delete(),u.continue())},o.oncomplete=()=>s(),o.onerror=()=>e(o.error)})}async add(t,s){return this.db||await this.init(),new Promise((e,o)=>{const r=this.db.transaction([t],"readwrite").objectStore(t).add(s);r.onsuccess=()=>e(r.result),r.onerror=()=>o(r.error)})}async put(t,s){return this.db||await this.init(),new Promise((e,o)=>{const r=this.db.transaction([t],"readwrite").objectStore(t).put(s);r.onsuccess=()=>e(),r.onerror=()=>o(r.error)})}}const g=new C,v={baseUrl:"http://localhost:8000"};class R{constructor(t=v){y(this,"config");this.config=t}updateConfig(t){this.config={...this.config,...t}}setToken(t){this.config.token=t}setBaseUrl(t){this.config.baseUrl=t}getHeaders(){const t={"Content-Type":"application/json"};return this.config.token&&(t.Authorization=`Bearer ${this.config.token}`),t}async getAgents(t,s){try{const e=new URLSearchParams;e.append("user_id",t),s&&e.append("tags",s);const o=await fetch(`${this.config.baseUrl}/api/v1/agent/list?${e}`,{headers:this.getHeaders()});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const n=await o.json();return{agents:(n.data||n||[]).map(c=>({id:c.agent_id||c.id,name:c.agent_name||c.name,description:c.agent_description||c.description||"",avatar:c.avatar,tags:c.tags,matchScore:c.match_score||c.matchScore})),recommended:n.recommended}}catch(e){return console.error("获取 Agent 列表失败:",e),{agents:[]}}}async chatStream(t,s,e,o){var n;try{const a=await fetch(`${this.config.baseUrl}/api/v1/agent/chat`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(t)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const r=(n=a.body)==null?void 0:n.getReader(),c=new TextDecoder;if(!r)throw new Error("无法获取响应流");let h="";for(;;){const{done:u,value:l}=await r.read();if(u)break;h+=c.decode(l,{stream:!0});const f=h.split(`
`);h=f.pop()||"";for(const I of f){const b=I.trim();if(!b||b.startsWith("event:"))continue;let p=b;if(b.startsWith("data:")&&(p=b.slice(5).trim()),!!p)try{const d=JSON.parse(p);if(d.message==="对话完成"){e();return}const m={};d.role&&(m.role=d.role),d.content&&(m.content=d.content),d.think&&(m.think=d.think),d.tool_call&&(m.toolCall=d.tool_call),d.statistic&&(m.statistic=d.statistic),Object.keys(m).length>0&&s(m)}catch{console.warn("解析流式数据失败，跳过:",p)}}}if(h.trim()){let u=h.trim();if(u.startsWith("event:")){const l=u.match(/data:(.+)/);l?u=l[1].trim():u=""}else u.startsWith("data:")&&(u=u.slice(5).trim());if(u)try{const l=JSON.parse(u);if(l.message==="对话完成"){e();return}const f={};l.role&&(f.role=l.role),l.content&&(f.content=l.content),l.think&&(f.think=l.think),l.tool_call&&(f.toolCall=l.tool_call),l.statistic&&(f.statistic=l.statistic),Object.keys(f).length>0&&s(f)}catch{}}e()}catch(a){o(a instanceof Error?a:new Error(String(a)))}}async getHistory(t,s=1,e=20){try{const o=await fetch(`${this.config.baseUrl}/api/sessions/${t}/history?page=${s}&pageSize=${e}`,{headers:this.getHeaders()});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);return(await o.json()).data||{messages:[],total:0,hasMore:!1}}catch(o){return console.error("获取会话历史失败:",o),{messages:[],total:0,hasMore:!1}}}async recognizeIntent(t){try{const s=await fetch(`${this.config.baseUrl}/api/intent/recognize`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({url:t})});return s.ok?(await s.json()).data:null}catch(s){return console.error("意图识别失败:",s),null}}}const w=new R;function q(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,i=>{const t=Math.random()*16|0;return(i==="x"?t:t&3|8).toString(16)})}g.init().catch(console.error);async function D(){const i=await g.getSetting("apiEndpoint"),t=await g.getSetting("apiKey");i&&w.setBaseUrl(i),t&&w.setToken(t)}D().catch(console.error);chrome.runtime.onMessage.addListener((i,t,s)=>(G(i,t).then(s),!0));const T=new Map;function k(i){return T.has(i)||T.set(i,q()),T.get(i)}chrome.runtime.onConnect.addListener(i=>{if(i.name==="chat-stream"){let t="",s="",e=[],o=null;i.onMessage.addListener(async n=>{const{agentId:a,sessionId:r,message:c,model:h,userId:u,role:l,currentPageInfo:f,browserTools:I}=n;o=r,t="",s="",e=[],l==="user"&&await g.addMessage(r,"user",c);const b=k(r);if(!a){i.postMessage({type:"error",error:"请先选择一个 Agent"});return}const p={message:c,role:l||"user",model:h||"claude-3-opus",agent_id:a,session_id:b,user_id:u||"default_user",current_page_info:f,browser_tools:I};await w.chatStream(p,d=>{d.content&&(t+=d.content),d.think&&d.think.reasoning_content&&(s=d.think.reasoning_content),i.postMessage({type:"data",data:d})},async()=>{o!==null&&(t&&e.push({type:"text",text:t}),await g.addMessage(o,"assistant",t,e,s)),i.postMessage({type:"done"})},d=>{i.postMessage({type:"error",error:d.message})})})}});async function G(i,t){var o;const{type:s,payload:e}=i;try{switch(s){case"TOGGLE_CHAT":return(o=t.tab)!=null&&o.id&&chrome.tabs.sendMessage(t.tab.id,{type:"TOGGLE_CHAT"}),{success:!0};case"SEND_MESSAGE":const{sessionId:n,content:a,agentId:r}=e;await g.addMessage(n,"user",a);let c;return r?c=await B(r,n,a,e.model,e.userId):c="请先选择一个 Agent 后再发送消息",await g.addMessage(n,"assistant",c),{success:!0,response:c};case"GET_MESSAGES":return{success:!0,data:await g.getMessages(e.sessionId)};case"GET_SESSIONS":return{success:!0,data:await g.getSessions()};case"CREATE_SESSION":return{success:!0,data:{id:await g.addSession(e.title||"新对话",e.tabId,e.pageUrl,e.pageTitle)}};case"GET_SESSION_BY_TAB":return{success:!0,data:await g.getSessionByTabId(e.tabId)};case"GET_SESSION":return{success:!0,data:await g.getSession(e.sessionId)};case"UPDATE_SESSION":return await g.updateSession(e.sessionId,e.updates),{success:!0};case"DELETE_SESSION":return await g.deleteSession(e.sessionId),{success:!0};case"SAVE_SETTING":return await g.saveSetting(e.key,e.value),e.key==="apiEndpoint"?w.setBaseUrl(e.value):e.key==="apiKey"&&w.setToken(e.value),{success:!0};case"GET_SETTING":return{success:!0,data:await g.getSetting(e.key)};case"TOOL_RESPONSE":const{toolResponse:p,agentId:d,model:m,userId:U}=e,j=k(e.sessionId),N={message:JSON.stringify({tool_id:p.toolId,approved:p.approved,result:p.result||""}),role:"function",model:m||"claude-3-opus",agent_id:d||"",session_id:j,user_id:U||"default_user"};return new Promise(A=>{const _=[];let E="",O="",x=null;w.chatStream(N,S=>{S.content&&(E+=S.content),S.think&&!S.think.partial&&(O=S.think.reasoning_content),S.toolCall&&!S.toolCall.partial&&(x={type:"tool_use",id:`tool_${Date.now()}`,name:S.toolCall.tool_name,input:JSON.parse(S.toolCall.arguments||"{}"),status:"pending"})},()=>{E&&_.push({type:"text",text:E}),x&&_.push(x),A({success:!0,blocks:_,isComplete:!x,think:O})},S=>{A({success:!1,error:S.message})})});case"GET_AGENTS":return{success:!0,data:await w.getAgents((e==null?void 0:e.userId)||"default_user",e==null?void 0:e.tags)};case"GET_HISTORY":return{success:!0,data:await w.getHistory(e.sessionId,e.page,e.pageSize)};case"RECOGNIZE_INTENT":return{success:!0,data:await w.recognizeIntent(e.url)};default:return{success:!1,error:"Unknown message type"}}}catch(n){return console.error("Background error:",n),{success:!1,error:String(n)}}}async function B(i,t,s,e,o){return new Promise((n,a)=>{let r="";const c=k(t),h={message:s,role:"user",model:e||"claude-3-opus",agent_id:i,session_id:c,user_id:o||"default_user"};w.chatStream(h,u=>{u.content&&(r+=u.content)},()=>n(r),u=>a(u))})}chrome.runtime.onInstalled.addListener(async()=>{console.log("AI Chat Extension installed"),await g.init(),(await g.getSessions()).length===0&&await g.addSession("默认对话")});
