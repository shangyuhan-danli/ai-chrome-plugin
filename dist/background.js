var C=Object.defineProperty;var M=(o,e,s)=>e in o?C(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var y=(o,e,s)=>M(o,typeof e!="symbol"?e+"":e,s);class N{constructor(){y(this,"dbName","ai-chat-db");y(this,"version",1);y(this,"db",null)}async init(){return new Promise((e,s)=>{const t=indexedDB.open(this.dbName,this.version);t.onerror=()=>s(t.error),t.onsuccess=()=>{this.db=t.result,e()},t.onupgradeneeded=n=>{const r=n.target.result;if(r.objectStoreNames.contains("sessions")||r.createObjectStore("sessions",{keyPath:"id",autoIncrement:!0}).createIndex("createdAt","createdAt",{unique:!1}),!r.objectStoreNames.contains("messages")){const i=r.createObjectStore("messages",{keyPath:"id",autoIncrement:!0});i.createIndex("sessionId","sessionId",{unique:!1}),i.createIndex("createdAt","createdAt",{unique:!1})}r.objectStoreNames.contains("settings")||r.createObjectStore("settings",{keyPath:"key"})}})}async addSession(e){const s={title:e,createdAt:Date.now(),updatedAt:Date.now()};return this.add("sessions",s)}async addMessage(e,s,t){const n={sessionId:e,role:s,content:t,createdAt:Date.now()};return this.add("messages",n)}async getMessages(e){return this.db||await this.init(),new Promise((s,t)=>{const a=this.db.transaction(["messages"],"readonly").objectStore("messages").index("sessionId").getAll(e);a.onsuccess=()=>s(a.result),a.onerror=()=>t(a.error)})}async getSessions(){return this.db||await this.init(),new Promise((e,s)=>{const r=this.db.transaction(["sessions"],"readonly").objectStore("sessions").getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>s(r.error)})}async saveSetting(e,s){await this.put("settings",{key:e,value:s})}async getSetting(e){return this.db||await this.init(),new Promise((s,t)=>{const i=this.db.transaction(["settings"],"readonly").objectStore("settings").get(e);i.onsuccess=()=>{var a;return s((a=i.result)==null?void 0:a.value)},i.onerror=()=>t(i.error)})}async deleteSession(e){return this.db||await this.init(),new Promise((s,t)=>{const n=this.db.transaction(["sessions","messages"],"readwrite");n.objectStore("sessions").delete(e);const l=n.objectStore("messages").index("sessionId").openCursor(IDBKeyRange.only(e));l.onsuccess=d=>{const c=d.target.result;c&&(c.delete(),c.continue())},n.oncomplete=()=>s(),n.onerror=()=>t(n.error)})}async add(e,s){return this.db||await this.init(),new Promise((t,n)=>{const a=this.db.transaction([e],"readwrite").objectStore(e).add(s);a.onsuccess=()=>t(a.result),a.onerror=()=>n(a.error)})}async put(e,s){return this.db||await this.init(),new Promise((t,n)=>{const a=this.db.transaction([e],"readwrite").objectStore(e).put(s);a.onsuccess=()=>t(),a.onerror=()=>n(a.error)})}}const u=new N,j={baseUrl:"http://localhost:8000"};class P{constructor(e=j){y(this,"config");this.config=e}updateConfig(e){this.config={...this.config,...e}}setToken(e){this.config.token=e}setBaseUrl(e){this.config.baseUrl=e}getHeaders(){const e={"Content-Type":"application/json"};return this.config.token&&(e.Authorization=`Bearer ${this.config.token}`),e}async getAgents(e){try{const s=new URLSearchParams;e&&s.append("url",e);const t=await fetch(`${this.config.baseUrl}/api/agents?${s}`,{headers:this.getHeaders()});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return(await t.json()).data||{agents:[]}}catch(s){return console.error("获取 Agent 列表失败:",s),{agents:[]}}}async chatStream(e,s,t,n){var r;try{const i=await fetch(`${this.config.baseUrl}/api/v1/agent/chat`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(e)});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const a=(r=i.body)==null?void 0:r.getReader(),l=new TextDecoder;if(!a)throw new Error("无法获取响应流");let d="";for(;;){const{done:c,value:S}=await a.read();if(c)break;d+=l.decode(S,{stream:!0});const x=d.split(`
`);d=x.pop()||"";for(const m of x){const w=m.trim();if(w)try{const g=JSON.parse(w);if(g.message==="对话完成"){t();return}const p={};g.content&&(p.content=g.content),g.think&&(p.think=g.think),g.tool_call&&(p.toolCall=g.tool_call),g.statistic&&(p.statistic=g.statistic),Object.keys(p).length>0&&s(p)}catch{console.warn("解析流式数据失败，跳过:",w)}}}if(d.trim())try{const c=JSON.parse(d.trim());if(c.message==="对话完成"){t();return}const S={};c.content&&(S.content=c.content),c.think&&(S.think=c.think),c.tool_call&&(S.toolCall=c.tool_call),c.statistic&&(S.statistic=c.statistic),Object.keys(S).length>0&&s(S)}catch{}t()}catch(i){n(i instanceof Error?i:new Error(String(i)))}}async getHistory(e,s=1,t=20){try{const n=await fetch(`${this.config.baseUrl}/api/sessions/${e}/history?page=${s}&pageSize=${t}`,{headers:this.getHeaders()});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return(await n.json()).data||{messages:[],total:0,hasMore:!1}}catch(n){return console.error("获取会话历史失败:",n),{messages:[],total:0,hasMore:!1}}}async recognizeIntent(e){try{const s=await fetch(`${this.config.baseUrl}/api/intent/recognize`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({url:e})});return s.ok?(await s.json()).data:null}catch(s){return console.error("意图识别失败:",s),null}}}const f=new P;function R(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,o=>{const e=Math.random()*16|0;return(o==="x"?e:e&3|8).toString(16)})}u.init().catch(console.error);async function v(){const o=await u.getSetting("apiEndpoint"),e=await u.getSetting("apiKey");o&&f.setBaseUrl(o),e&&f.setToken(e)}v().catch(console.error);chrome.runtime.onMessage.addListener((o,e,s)=>(D(o,e).then(s),!0));const k=new Map;function T(o){return k.has(o)||k.set(o,R()),k.get(o)}chrome.runtime.onConnect.addListener(o=>{o.name==="chat-stream"&&o.onMessage.addListener(async e=>{const{agentId:s,sessionId:t,message:n,model:r,userId:i,role:a}=e;a==="user"&&await u.addMessage(t,"user",n);const l=T(t),d={message:n,role:a||"user",model:r||"claude-3-opus",agent_id:s,session_id:l,user_id:i||"default_user"};await f.chatStream(d,c=>{o.postMessage({type:"data",data:c})},()=>{o.postMessage({type:"done"})},c=>{o.postMessage({type:"error",error:c.message})})})});async function D(o,e){var n;const{type:s,payload:t}=o;try{switch(s){case"TOGGLE_CHAT":return(n=e.tab)!=null&&n.id&&chrome.tabs.sendMessage(e.tab.id,{type:"TOGGLE_CHAT"}),{success:!0};case"SEND_MESSAGE":const{sessionId:r,content:i,agentId:a}=t;await u.addMessage(r,"user",i);let l;return a?l=await G(a,r,i,t.model,t.userId):l="请先选择一个 Agent 后再发送消息",await u.addMessage(r,"assistant",l),{success:!0,response:l};case"GET_MESSAGES":return{success:!0,data:await u.getMessages(t.sessionId)};case"GET_SESSIONS":return{success:!0,data:await u.getSessions()};case"CREATE_SESSION":return{success:!0,data:{id:await u.addSession(t.title||"新对话")}};case"DELETE_SESSION":return await u.deleteSession(t.sessionId),{success:!0};case"SAVE_SETTING":return await u.saveSetting(t.key,t.value),t.key==="apiEndpoint"?f.setBaseUrl(t.value):t.key==="apiKey"&&f.setToken(t.value),{success:!0};case"GET_SETTING":return{success:!0,data:await u.getSetting(t.key)};case"TOOL_RESPONSE":const{toolResponse:m,agentId:w,model:g,userId:p}=t,O=T(t.sessionId),U={message:JSON.stringify({tool_id:m.toolId,approved:m.approved,result:m.result||""}),role:"function",model:g||"claude-3-opus",agent_id:w||"",session_id:O,user_id:p||"default_user"};return new Promise(_=>{const I=[];let E="",A="",b=null;f.chatStream(U,h=>{h.content&&(E+=h.content),h.think&&!h.think.partial&&(A=h.think.reasoning_content),h.toolCall&&!h.toolCall.partial&&(b={type:"tool_use",id:`tool_${Date.now()}`,name:h.toolCall.tool_name,input:JSON.parse(h.toolCall.arguments||"{}"),status:"pending"})},()=>{E&&I.push({type:"text",text:E}),b&&I.push(b),_({success:!0,blocks:I,isComplete:!b,think:A})},h=>{_({success:!1,error:h.message})})});case"GET_AGENTS":return{success:!0,data:await f.getAgents(t==null?void 0:t.url)};case"GET_HISTORY":return{success:!0,data:await f.getHistory(t.sessionId,t.page,t.pageSize)};case"RECOGNIZE_INTENT":return{success:!0,data:await f.recognizeIntent(t.url)};default:return{success:!1,error:"Unknown message type"}}}catch(r){return console.error("Background error:",r),{success:!1,error:String(r)}}}async function G(o,e,s,t,n){return new Promise((r,i)=>{let a="";const l=T(e),d={message:s,role:"user",model:t||"claude-3-opus",agent_id:o,session_id:l,user_id:n||"default_user"};f.chatStream(d,c=>{c.content&&(a+=c.content)},()=>r(a),c=>i(c))})}chrome.runtime.onInstalled.addListener(async()=>{console.log("AI Chat Extension installed"),await u.init(),(await u.getSessions()).length===0&&await u.addSession("默认对话")});
