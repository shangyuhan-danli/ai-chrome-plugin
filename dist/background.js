var C=Object.defineProperty;var M=(o,e,s)=>e in o?C(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var y=(o,e,s)=>M(o,typeof e!="symbol"?e+"":e,s);class N{constructor(){y(this,"dbName","ai-chat-db");y(this,"version",1);y(this,"db",null)}async init(){return new Promise((e,s)=>{const t=indexedDB.open(this.dbName,this.version);t.onerror=()=>s(t.error),t.onsuccess=()=>{this.db=t.result,e()},t.onupgradeneeded=n=>{const r=n.target.result;if(r.objectStoreNames.contains("sessions")||r.createObjectStore("sessions",{keyPath:"id",autoIncrement:!0}).createIndex("createdAt","createdAt",{unique:!1}),!r.objectStoreNames.contains("messages")){const i=r.createObjectStore("messages",{keyPath:"id",autoIncrement:!0});i.createIndex("sessionId","sessionId",{unique:!1}),i.createIndex("createdAt","createdAt",{unique:!1})}r.objectStoreNames.contains("settings")||r.createObjectStore("settings",{keyPath:"key"})}})}async addSession(e){const s={title:e,createdAt:Date.now(),updatedAt:Date.now()};return this.add("sessions",s)}async addMessage(e,s,t){const n={sessionId:e,role:s,content:t,createdAt:Date.now()};return this.add("messages",n)}async getMessages(e){return this.db||await this.init(),new Promise((s,t)=>{const a=this.db.transaction(["messages"],"readonly").objectStore("messages").index("sessionId").getAll(e);a.onsuccess=()=>s(a.result),a.onerror=()=>t(a.error)})}async getSessions(){return this.db||await this.init(),new Promise((e,s)=>{const r=this.db.transaction(["sessions"],"readonly").objectStore("sessions").getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>s(r.error)})}async saveSetting(e,s){await this.put("settings",{key:e,value:s})}async getSetting(e){return this.db||await this.init(),new Promise((s,t)=>{const i=this.db.transaction(["settings"],"readonly").objectStore("settings").get(e);i.onsuccess=()=>{var a;return s((a=i.result)==null?void 0:a.value)},i.onerror=()=>t(i.error)})}async deleteSession(e){return this.db||await this.init(),new Promise((s,t)=>{const n=this.db.transaction(["sessions","messages"],"readwrite");n.objectStore("sessions").delete(e);const u=n.objectStore("messages").index("sessionId").openCursor(IDBKeyRange.only(e));u.onsuccess=l=>{const c=l.target.result;c&&(c.delete(),c.continue())},n.oncomplete=()=>s(),n.onerror=()=>t(n.error)})}async add(e,s){return this.db||await this.init(),new Promise((t,n)=>{const a=this.db.transaction([e],"readwrite").objectStore(e).add(s);a.onsuccess=()=>t(a.result),a.onerror=()=>n(a.error)})}async put(e,s){return this.db||await this.init(),new Promise((t,n)=>{const a=this.db.transaction([e],"readwrite").objectStore(e).put(s);a.onsuccess=()=>t(),a.onerror=()=>n(a.error)})}}const d=new N,v={baseUrl:"http://localhost:8000"};class j{constructor(e=v){y(this,"config");this.config=e}updateConfig(e){this.config={...this.config,...e}}setToken(e){this.config.token=e}setBaseUrl(e){this.config.baseUrl=e}getHeaders(){const e={"Content-Type":"application/json"};return this.config.token&&(e.Authorization=`Bearer ${this.config.token}`),e}async getAgents(e,s){try{const t=new URLSearchParams;t.append("user_id",e),s&&t.append("tags",s);const n=await fetch(`${this.config.baseUrl}/api/v1/agent/list?${t}`,{headers:this.getHeaders()});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const r=await n.json();return{agents:(r.data||r||[]).map(u=>({id:u.agent_id||u.id,name:u.agent_name||u.name,description:u.agent_description||u.description||"",avatar:u.avatar,tags:u.tags,matchScore:u.match_score||u.matchScore})),recommended:r.recommended}}catch(t){return console.error("获取 Agent 列表失败:",t),{agents:[]}}}async chatStream(e,s,t,n){var r;try{const i=await fetch(`${this.config.baseUrl}/api/v1/agent/chat`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(e)});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const a=(r=i.body)==null?void 0:r.getReader(),u=new TextDecoder;if(!a)throw new Error("无法获取响应流");let l="";for(;;){const{done:c,value:S}=await a.read();if(c)break;l+=u.decode(S,{stream:!0});const x=l.split(`
`);l=x.pop()||"";for(const m of x){const w=m.trim();if(w)try{const g=JSON.parse(w);if(g.message==="对话完成"){t();return}const p={};g.content&&(p.content=g.content),g.think&&(p.think=g.think),g.tool_call&&(p.toolCall=g.tool_call),g.statistic&&(p.statistic=g.statistic),Object.keys(p).length>0&&s(p)}catch{console.warn("解析流式数据失败，跳过:",w)}}}if(l.trim())try{const c=JSON.parse(l.trim());if(c.message==="对话完成"){t();return}const S={};c.content&&(S.content=c.content),c.think&&(S.think=c.think),c.tool_call&&(S.toolCall=c.tool_call),c.statistic&&(S.statistic=c.statistic),Object.keys(S).length>0&&s(S)}catch{}t()}catch(i){n(i instanceof Error?i:new Error(String(i)))}}async getHistory(e,s=1,t=20){try{const n=await fetch(`${this.config.baseUrl}/api/sessions/${e}/history?page=${s}&pageSize=${t}`,{headers:this.getHeaders()});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return(await n.json()).data||{messages:[],total:0,hasMore:!1}}catch(n){return console.error("获取会话历史失败:",n),{messages:[],total:0,hasMore:!1}}}async recognizeIntent(e){try{const s=await fetch(`${this.config.baseUrl}/api/intent/recognize`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({url:e})});return s.ok?(await s.json()).data:null}catch(s){return console.error("意图识别失败:",s),null}}}const f=new j;function P(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,o=>{const e=Math.random()*16|0;return(o==="x"?e:e&3|8).toString(16)})}d.init().catch(console.error);async function R(){const o=await d.getSetting("apiEndpoint"),e=await d.getSetting("apiKey");o&&f.setBaseUrl(o),e&&f.setToken(e)}R().catch(console.error);chrome.runtime.onMessage.addListener((o,e,s)=>(D(o,e).then(s),!0));const E=new Map;function k(o){return E.has(o)||E.set(o,P()),E.get(o)}chrome.runtime.onConnect.addListener(o=>{o.name==="chat-stream"&&o.onMessage.addListener(async e=>{const{agentId:s,sessionId:t,message:n,model:r,userId:i,role:a}=e;a==="user"&&await d.addMessage(t,"user",n);const u=k(t);if(!s){o.postMessage({type:"error",error:"请先选择一个 Agent"});return}const l={message:n,role:a||"user",model:r||"claude-3-opus",agent_id:s,session_id:u,user_id:i||"default_user"};await f.chatStream(l,c=>{o.postMessage({type:"data",data:c})},()=>{o.postMessage({type:"done"})},c=>{o.postMessage({type:"error",error:c.message})})})});async function D(o,e){var n;const{type:s,payload:t}=o;try{switch(s){case"TOGGLE_CHAT":return(n=e.tab)!=null&&n.id&&chrome.tabs.sendMessage(e.tab.id,{type:"TOGGLE_CHAT"}),{success:!0};case"SEND_MESSAGE":const{sessionId:r,content:i,agentId:a}=t;await d.addMessage(r,"user",i);let u;return a?u=await G(a,r,i,t.model,t.userId):u="请先选择一个 Agent 后再发送消息",await d.addMessage(r,"assistant",u),{success:!0,response:u};case"GET_MESSAGES":return{success:!0,data:await d.getMessages(t.sessionId)};case"GET_SESSIONS":return{success:!0,data:await d.getSessions()};case"CREATE_SESSION":return{success:!0,data:{id:await d.addSession(t.title||"新对话")}};case"DELETE_SESSION":return await d.deleteSession(t.sessionId),{success:!0};case"SAVE_SETTING":return await d.saveSetting(t.key,t.value),t.key==="apiEndpoint"?f.setBaseUrl(t.value):t.key==="apiKey"&&f.setToken(t.value),{success:!0};case"GET_SETTING":return{success:!0,data:await d.getSetting(t.key)};case"TOOL_RESPONSE":const{toolResponse:m,agentId:w,model:g,userId:p}=t,O=k(t.sessionId),U={message:JSON.stringify({tool_id:m.toolId,approved:m.approved,result:m.result||""}),role:"function",model:g||"claude-3-opus",agent_id:w||"",session_id:O,user_id:p||"default_user"};return new Promise(T=>{const I=[];let _="",A="",b=null;f.chatStream(U,h=>{h.content&&(_+=h.content),h.think&&!h.think.partial&&(A=h.think.reasoning_content),h.toolCall&&!h.toolCall.partial&&(b={type:"tool_use",id:`tool_${Date.now()}`,name:h.toolCall.tool_name,input:JSON.parse(h.toolCall.arguments||"{}"),status:"pending"})},()=>{_&&I.push({type:"text",text:_}),b&&I.push(b),T({success:!0,blocks:I,isComplete:!b,think:A})},h=>{T({success:!1,error:h.message})})});case"GET_AGENTS":return{success:!0,data:await f.getAgents((t==null?void 0:t.userId)||"default_user",t==null?void 0:t.tags)};case"GET_HISTORY":return{success:!0,data:await f.getHistory(t.sessionId,t.page,t.pageSize)};case"RECOGNIZE_INTENT":return{success:!0,data:await f.recognizeIntent(t.url)};default:return{success:!1,error:"Unknown message type"}}}catch(r){return console.error("Background error:",r),{success:!1,error:String(r)}}}async function G(o,e,s,t,n){return new Promise((r,i)=>{let a="";const u=k(e),l={message:s,role:"user",model:t||"claude-3-opus",agent_id:o,session_id:u,user_id:n||"default_user"};f.chatStream(l,c=>{c.content&&(a+=c.content)},()=>r(a),c=>i(c))})}chrome.runtime.onInstalled.addListener(async()=>{console.log("AI Chat Extension installed"),await d.init(),(await d.getSessions()).length===0&&await d.addSession("默认对话")});
