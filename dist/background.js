var q=Object.defineProperty;var v=(u,s,t)=>s in u?q(u,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[s]=t;var _=(u,s,t)=>v(u,typeof s!="symbol"?s+"":s,t);const k=class k{constructor(){_(this,"dbName","ai-chat-db");_(this,"version",2);_(this,"db",null)}async init(){return new Promise((s,t)=>{const e=indexedDB.open(this.dbName,this.version);e.onerror=()=>t(e.error),e.onsuccess=()=>{this.db=e.result,s()},e.onupgradeneeded=r=>{const o=r.target.result,i=r.oldVersion;if(o.objectStoreNames.contains("sessions")){if(i<2){const c=r.target.transaction.objectStore("sessions");c.indexNames.contains("tabId")||c.createIndex("tabId","tabId",{unique:!1})}}else{const n=o.createObjectStore("sessions",{keyPath:"id",autoIncrement:!0});n.createIndex("createdAt","createdAt",{unique:!1}),n.createIndex("tabId","tabId",{unique:!1})}if(!o.objectStoreNames.contains("messages")){const n=o.createObjectStore("messages",{keyPath:"id",autoIncrement:!0});n.createIndex("sessionId","sessionId",{unique:!1}),n.createIndex("createdAt","createdAt",{unique:!1})}o.objectStoreNames.contains("settings")||o.createObjectStore("settings",{keyPath:"key"})}})}async addSession(s,t,e,r){const o={title:s,tabId:t||null,pageUrl:e||"",pageTitle:r||"",createdAt:Date.now(),updatedAt:Date.now()};return this.add("sessions",o)}async updateSession(s,t){return this.db||await this.init(),new Promise((e,r)=>{const o=this.db.transaction(["sessions"],"readwrite"),i=o.objectStore("sessions"),n=i.get(s);n.onsuccess=()=>{const c=n.result;if(c){const S={...c,...t,updatedAt:Date.now()};i.put(S)}},o.oncomplete=()=>e(),o.onerror=()=>r(o.error)})}async getSessionByTabId(s){return this.db||await this.init(),new Promise((t,e)=>{const n=this.db.transaction(["sessions"],"readonly").objectStore("sessions").index("tabId").get(s);n.onsuccess=()=>t(n.result||null),n.onerror=()=>e(n.error)})}async getSession(s){return this.db||await this.init(),new Promise((t,e)=>{const i=this.db.transaction(["sessions"],"readonly").objectStore("sessions").get(s);i.onsuccess=()=>t(i.result||null),i.onerror=()=>e(i.error)})}async addMessage(s,t,e,r,o){const i={sessionId:s,role:t,content:e,blocks:r||[{type:"text",text:e}],think:o||"",createdAt:Date.now()};return this.add("messages",i)}async getMessages(s){return this.db||await this.init(),new Promise((t,e)=>{const n=this.db.transaction(["messages"],"readonly").objectStore("messages").index("sessionId").getAll(s);n.onsuccess=()=>t(n.result),n.onerror=()=>e(n.error)})}async getSessions(){return this.db||await this.init(),new Promise((s,t)=>{const o=this.db.transaction(["sessions"],"readonly").objectStore("sessions").getAll();o.onsuccess=()=>s(o.result),o.onerror=()=>t(o.error)})}async saveSetting(s,t){await this.put("settings",{key:s,value:t})}async getSetting(s){return this.db||await this.init(),new Promise((t,e)=>{const i=this.db.transaction(["settings"],"readonly").objectStore("settings").get(s);i.onsuccess=()=>{var n;return t((n=i.result)==null?void 0:n.value)},i.onerror=()=>e(i.error)})}async deleteSession(s){return this.db||await this.init(),new Promise((t,e)=>{const r=this.db.transaction(["sessions","messages"],"readwrite");r.objectStore("sessions").delete(s);const c=r.objectStore("messages").index("sessionId").openCursor(IDBKeyRange.only(s));c.onsuccess=S=>{const g=S.target.result;g&&(g.delete(),g.continue())},r.oncomplete=()=>t(),r.onerror=()=>e(r.error)})}async add(s,t){return this.db||await this.init(),new Promise((e,r)=>{const n=this.db.transaction([s],"readwrite").objectStore(s).add(t);n.onsuccess=()=>e(n.result),n.onerror=()=>r(n.error)})}async put(s,t){return this.db||await this.init(),new Promise((e,r)=>{const n=this.db.transaction([s],"readwrite").objectStore(s).put(t);n.onsuccess=()=>e(),n.onerror=()=>r(n.error)})}async getRetentionDays(){return await this.getSetting("retentionDays")??k.DEFAULT_RETENTION_DAYS}async setRetentionDays(s){await this.saveSetting("retentionDays",s)}async cleanExpiredSessions(){const s=await this.getRetentionDays(),t=Date.now()-s*24*60*60*1e3;return this.db||await this.init(),new Promise((e,r)=>{let o=0,i=0;const n=[],c=this.db.transaction(["sessions","messages"],"readwrite"),S=c.objectStore("sessions"),g=c.objectStore("messages"),l=S.openCursor();l.onsuccess=h=>{const y=h.target.result;if(y){const f=y.value;f.updatedAt<t&&(n.push(f.id),y.delete(),o++),y.continue()}else if(n.length>0){const f=g.openCursor();f.onsuccess=b=>{const a=b.target.result;a&&(n.includes(a.value.sessionId)&&(a.delete(),i++),a.continue())}}},c.oncomplete=()=>e({deletedSessions:o,deletedMessages:i}),c.onerror=()=>r(c.error)})}async exportSession(s){const t=await this.getSession(s);if(!t)return null;const e=await this.getMessages(s);return{session:t,messages:e,exportedAt:new Date().toISOString()}}async exportAllSessions(){const s=await this.getSessions();this.db||await this.init();const t=await new Promise((e,r)=>{const n=this.db.transaction(["messages"],"readonly").objectStore("messages").getAll();n.onsuccess=()=>e(n.result),n.onerror=()=>r(n.error)});return{sessions:s,messages:t,exportedAt:new Date().toISOString()}}async renameSession(s,t){await this.updateSession(s,{title:t})}};_(k,"DEFAULT_RETENTION_DAYS",90);let O=k;const d=new O,G={baseUrl:"http://localhost:8000"};class L{constructor(s=G){_(this,"config");this.config=s}updateConfig(s){this.config={...this.config,...s}}setToken(s){this.config.token=s}setBaseUrl(s){this.config.baseUrl=s}getHeaders(){const s={"Content-Type":"application/json"};return this.config.token&&(s.Authorization=`Bearer ${this.config.token}`),s}async getAgents(s,t){try{const e=new URLSearchParams;e.append("user_id",s),t&&e.append("tags",t);const r=await fetch(`${this.config.baseUrl}/api/v1/agent/list?${e}`,{headers:this.getHeaders()});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const o=await r.json();return{agents:(o.data||o||[]).map(c=>({id:c.agent_id||c.id,name:c.agent_name||c.name,description:c.agent_description||c.description||"",avatar:c.avatar,tags:c.tags,matchScore:c.match_score||c.matchScore})),recommended:o.recommended}}catch(e){return console.error("获取 Agent 列表失败:",e),{agents:[]}}}async chatStream(s,t,e,r){var o;try{const i=await fetch(`${this.config.baseUrl}/api/v1/agent/chat`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(s)});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const n=(o=i.body)==null?void 0:o.getReader(),c=new TextDecoder;if(!n)throw new Error("无法获取响应流");let S="";for(;;){const{done:g,value:l}=await n.read();if(g)break;S+=c.decode(l,{stream:!0});const h=S.split(`
`);S=h.pop()||"";for(const y of h){const f=y.trim();if(!f||f.startsWith("event:"))continue;let b=f;if(f.startsWith("data:")&&(b=f.slice(5).trim()),!!b)try{const a=JSON.parse(b);if(a.message==="对话完成"){e();return}const p={};a.role&&(p.role=a.role),a.content&&(p.content=a.content),a.think&&(p.think=a.think),a.tool_call&&(p.toolCall=a.tool_call),a.answer&&(p.answer=a.answer),a.ask&&(p.ask=a.ask),a.statistic&&(p.statistic=a.statistic),Object.keys(p).length>0&&t(p)}catch{console.warn("解析流式数据失败，跳过:",b)}}}if(S.trim()){let g=S.trim();if(g.startsWith("event:")){const l=g.match(/data:(.+)/);l?g=l[1].trim():g=""}else g.startsWith("data:")&&(g=g.slice(5).trim());if(g)try{const l=JSON.parse(g);if(l.message==="对话完成"){e();return}const h={};l.role&&(h.role=l.role),l.content&&(h.content=l.content),l.think&&(h.think=l.think),l.tool_call&&(h.toolCall=l.tool_call),l.answer&&(h.answer=l.answer),l.ask&&(h.ask=l.ask),l.statistic&&(h.statistic=l.statistic),Object.keys(h).length>0&&t(h)}catch{}}e()}catch(i){r(i instanceof Error?i:new Error(String(i)))}}async getHistory(s,t=1,e=20){try{const r=await fetch(`${this.config.baseUrl}/api/sessions/${s}/history?page=${t}&pageSize=${e}`,{headers:this.getHeaders()});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return(await r.json()).data||{messages:[],total:0,hasMore:!1}}catch(r){return console.error("获取会话历史失败:",r),{messages:[],total:0,hasMore:!1}}}async recognizeIntent(s){try{const t=await fetch(`${this.config.baseUrl}/api/intent/recognize`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({url:s})});return t.ok?(await t.json()).data:null}catch(t){return console.error("意图识别失败:",t),null}}}const m=new L;function $(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,u=>{const s=Math.random()*16|0;return(u==="x"?s:s&3|8).toString(16)})}d.init().then(()=>{d.cleanExpiredSessions().then(u=>{u.deletedSessions>0&&console.log(`[Cleanup] 已清理 ${u.deletedSessions} 个过期会话，${u.deletedMessages} 条消息`)}).catch(console.error)}).catch(console.error);async function B(){const u=await d.getSetting("apiEndpoint"),s=await d.getSetting("apiKey");u&&m.setBaseUrl(u),s&&m.setToken(s)}B().catch(console.error);chrome.runtime.onMessage.addListener((u,s,t)=>(H(u,s).then(t),!0));const N=new Map;function R(u){return N.has(u)||N.set(u,$()),N.get(u)}chrome.runtime.onConnect.addListener(u=>{if(u.name==="chat-stream"){let s="",t="",e=[],r=null;u.onMessage.addListener(async o=>{const{agentId:i,sessionId:n,message:c,model:S,userId:g,role:l,currentPageInfo:h,browserTools:y}=o;r=n,s="",t="",e=[],l==="user"&&await d.addMessage(n,"user",c);const f=R(n);if(!i){u.postMessage({type:"error",error:"请先选择一个 Agent"});return}const b={message:c,role:l||"user",model:S||"deepseek",agent_id:i,session_id:f,user_id:g||"default_user",current_page_info:h,browser_tools:y};await m.chatStream(b,a=>{if(a.content&&(s+=a.content),a.think&&a.think.reasoning_content&&(t=a.think.reasoning_content),a.toolCall&&a.toolCall.tool_name)try{e.push({type:"tool_use",id:`tool_${Date.now()}`,name:a.toolCall.tool_name,input:JSON.parse(a.toolCall.arguments||"{}"),status:"pending"})}catch(p){console.error("解析工具参数失败:",p)}a.answer&&a.answer.result&&e.push({type:"summary",text:a.answer.result}),a.ask&&a.ask.question&&e.push({type:"question",text:a.ask.question}),u.postMessage({type:"data",data:a})},async()=>{r!==null&&(s&&!e.some(a=>a.type==="summary"||a.type==="question")&&e.unshift({type:"text",text:s}),await d.addMessage(r,"assistant",s,e,t)),u.postMessage({type:"done"})},a=>{u.postMessage({type:"error",error:a.message})})})}});async function H(u,s){var r;const{type:t,payload:e}=u;try{switch(t){case"TOGGLE_CHAT":return(r=s.tab)!=null&&r.id&&chrome.tabs.sendMessage(s.tab.id,{type:"TOGGLE_CHAT"}),{success:!0};case"SEND_MESSAGE":const{sessionId:o,content:i,agentId:n}=e;await d.addMessage(o,"user",i);let c;return n?c=await J(n,o,i,e.model,e.userId):c="请先选择一个 Agent 后再发送消息",await d.addMessage(o,"assistant",c),{success:!0,response:c};case"GET_MESSAGES":return{success:!0,data:await d.getMessages(e.sessionId)};case"GET_SESSIONS":return{success:!0,data:await d.getSessions()};case"CREATE_SESSION":return{success:!0,data:{id:await d.addSession(e.title||"新对话",e.tabId,e.pageUrl,e.pageTitle)}};case"GET_SESSION_BY_TAB":return{success:!0,data:await d.getSessionByTabId(e.tabId)};case"GET_SESSION":return{success:!0,data:await d.getSession(e.sessionId)};case"UPDATE_SESSION":return await d.updateSession(e.sessionId,e.updates),{success:!0};case"DELETE_SESSION":return await d.deleteSession(e.sessionId),{success:!0};case"SAVE_SETTING":return await d.saveSetting(e.key,e.value),e.key==="apiEndpoint"?m.setBaseUrl(e.value):e.key==="apiKey"&&m.setToken(e.value),{success:!0};case"GET_SETTING":return{success:!0,data:await d.getSetting(e.key)};case"RENAME_SESSION":return await d.renameSession(e.sessionId,e.title),{success:!0};case"EXPORT_SESSION":return{success:!0,data:await d.exportSession(e.sessionId)};case"EXPORT_ALL_SESSIONS":return{success:!0,data:await d.exportAllSessions()};case"GET_RETENTION_DAYS":return{success:!0,data:await d.getRetentionDays()};case"SET_RETENTION_DAYS":return await d.setRetentionDays(e.days),{success:!0};case"CLEAN_EXPIRED_SESSIONS":return{success:!0,data:await d.cleanExpiredSessions()};case"TOOL_RESPONSE":const{toolResponse:A,agentId:U,model:C,userId:P}=e,j=R(e.sessionId),M={message:JSON.stringify({tool_id:A.toolId,approved:A.approved,result:A.result||""}),role:"function",model:C||"deepseek",agent_id:U||"",session_id:j,user_id:P||"default_user"};return new Promise(I=>{const E=[];let x="",D="",T=null;m.chatStream(M,w=>{w.content&&(x+=w.content),w.think&&!w.think.partial&&(D=w.think.reasoning_content),w.toolCall&&!w.toolCall.partial&&(T={type:"tool_use",id:`tool_${Date.now()}`,name:w.toolCall.tool_name,input:JSON.parse(w.toolCall.arguments||"{}"),status:"pending"})},()=>{x&&E.push({type:"text",text:x}),T&&E.push(T),I({success:!0,blocks:E,isComplete:!T,think:D})},w=>{I({success:!1,error:w.message})})});case"GET_AGENTS":return{success:!0,data:await m.getAgents((e==null?void 0:e.userId)||"default_user",e==null?void 0:e.tags)};case"GET_HISTORY":return{success:!0,data:await m.getHistory(e.sessionId,e.page,e.pageSize)};case"RECOGNIZE_INTENT":return{success:!0,data:await m.recognizeIntent(e.url)};case"CAPTURE_VISIBLE_TAB":try{const{format:I,quality:E}=e||{},x={format:I||"png"};return I==="jpeg"&&E&&(x.quality=E),{success:!0,data:await chrome.tabs.captureVisibleTab(x)}}catch(I){return{success:!1,error:String(I)}}default:return{success:!1,error:"Unknown message type"}}}catch(o){return console.error("Background error:",o),{success:!1,error:String(o)}}}async function J(u,s,t,e,r){return new Promise((o,i)=>{let n="";const c=R(s),S={message:t,role:"user",model:e||"deepseek",agent_id:u,session_id:c,user_id:r||"default_user"};m.chatStream(S,g=>{g.content&&(n+=g.content)},()=>o(n),g=>i(g))})}chrome.runtime.onInstalled.addListener(async()=>{console.log("AI Chat Extension installed"),await d.init(),(await d.getSessions()).length===0&&await d.addSession("默认对话")});
