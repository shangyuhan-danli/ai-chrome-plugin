var p=Object.defineProperty;var m=(o,e,t)=>e in o?p(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var S=(o,e,t)=>m(o,typeof e!="symbol"?e+"":e,t);class b{constructor(){S(this,"dbName","ai-chat-db");S(this,"version",1);S(this,"db",null)}async init(){return new Promise((e,t)=>{const s=indexedDB.open(this.dbName,this.version);s.onerror=()=>t(s.error),s.onsuccess=()=>{this.db=s.result,e()},s.onupgradeneeded=n=>{const a=n.target.result;if(a.objectStoreNames.contains("sessions")||a.createObjectStore("sessions",{keyPath:"id",autoIncrement:!0}).createIndex("createdAt","createdAt",{unique:!1}),!a.objectStoreNames.contains("messages")){const r=a.createObjectStore("messages",{keyPath:"id",autoIncrement:!0});r.createIndex("sessionId","sessionId",{unique:!1}),r.createIndex("createdAt","createdAt",{unique:!1})}a.objectStoreNames.contains("settings")||a.createObjectStore("settings",{keyPath:"key"})}})}async addSession(e){const t={title:e,createdAt:Date.now(),updatedAt:Date.now()};return this.add("sessions",t)}async addMessage(e,t,s){const n={sessionId:e,role:t,content:s,createdAt:Date.now()};return this.add("messages",n)}async getMessages(e){return this.db||await this.init(),new Promise((t,s)=>{const i=this.db.transaction(["messages"],"readonly").objectStore("messages").index("sessionId").getAll(e);i.onsuccess=()=>t(i.result),i.onerror=()=>s(i.error)})}async getSessions(){return this.db||await this.init(),new Promise((e,t)=>{const a=this.db.transaction(["sessions"],"readonly").objectStore("sessions").getAll();a.onsuccess=()=>e(a.result),a.onerror=()=>t(a.error)})}async saveSetting(e,t){await this.put("settings",{key:e,value:t})}async getSetting(e){return this.db||await this.init(),new Promise((t,s)=>{const r=this.db.transaction(["settings"],"readonly").objectStore("settings").get(e);r.onsuccess=()=>{var i;return t((i=r.result)==null?void 0:i.value)},r.onerror=()=>s(r.error)})}async deleteSession(e){return this.db||await this.init(),new Promise((t,s)=>{const n=this.db.transaction(["sessions","messages"],"readwrite");n.objectStore("sessions").delete(e);const g=n.objectStore("messages").index("sessionId").openCursor(IDBKeyRange.only(e));g.onsuccess=l=>{const d=l.target.result;d&&(d.delete(),d.continue())},n.oncomplete=()=>t(),n.onerror=()=>s(n.error)})}async add(e,t){return this.db||await this.init(),new Promise((s,n)=>{const i=this.db.transaction([e],"readwrite").objectStore(e).add(t);i.onsuccess=()=>s(i.result),i.onerror=()=>n(i.error)})}async put(e,t){return this.db||await this.init(),new Promise((s,n)=>{const i=this.db.transaction([e],"readwrite").objectStore(e).put(t);i.onsuccess=()=>s(),i.onerror=()=>n(i.error)})}}const c=new b,E={baseUrl:"http://localhost:3000"};class I{constructor(e=E){S(this,"config");this.config=e}updateConfig(e){this.config={...this.config,...e}}setToken(e){this.config.token=e}setBaseUrl(e){this.config.baseUrl=e}getHeaders(){const e={"Content-Type":"application/json"};return this.config.token&&(e.Authorization=`Bearer ${this.config.token}`),e}async getAgents(e){try{const t=new URLSearchParams;e&&t.append("url",e);const s=await fetch(`${this.config.baseUrl}/api/agents?${t}`,{headers:this.getHeaders()});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);return(await s.json()).data||{agents:[]}}catch(t){return console.error("获取 Agent 列表失败:",t),{agents:[]}}}async chatStream(e,t,s,n){var a;try{const r=await fetch(`${this.config.baseUrl}/api/chat/stream`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(e)});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const i=(a=r.body)==null?void 0:a.getReader(),g=new TextDecoder;if(!i)throw new Error("无法获取响应流");let l="";for(;;){const{done:d,value:y}=await i.read();if(d)break;l+=g.decode(y,{stream:!0});const w=l.split(`
`);l=w.pop()||"";for(const f of w)if(f.startsWith("data: "))try{const h=JSON.parse(f.slice(6));h.type==="content"?t(h.content):h.type==="done"?s(h.messageId||""):h.type==="error"&&n(new Error(h.message||"服务端错误"))}catch{console.warn("解析 SSE 数据失败:",f)}}if(l.startsWith("data: "))try{const d=JSON.parse(l.slice(6));d.type==="content"?t(d.content):d.type==="done"&&s(d.messageId||"")}catch{}}catch(r){n(r instanceof Error?r:new Error(String(r)))}}async getHistory(e,t=1,s=20){try{const n=await fetch(`${this.config.baseUrl}/api/sessions/${e}/history?page=${t}&pageSize=${s}`,{headers:this.getHeaders()});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return(await n.json()).data||{messages:[],total:0,hasMore:!1}}catch(n){return console.error("获取会话历史失败:",n),{messages:[],total:0,hasMore:!1}}}async recognizeIntent(e){try{const t=await fetch(`${this.config.baseUrl}/api/intent/recognize`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({url:e})});return t.ok?(await t.json()).data:null}catch(t){return console.error("意图识别失败:",t),null}}}const u=new I;c.init().catch(console.error);async function T(){const o=await c.getSetting("apiEndpoint"),e=await c.getSetting("apiKey");o&&u.setBaseUrl(o),e&&u.setToken(e)}T().catch(console.error);chrome.runtime.onMessage.addListener((o,e,t)=>(A(o,e).then(t),!0));chrome.runtime.onConnect.addListener(o=>{o.name==="chat-stream"&&o.onMessage.addListener(async e=>{const{agentId:t,sessionId:s,message:n,context:a}=e;await c.addMessage(s,"user",n),await u.chatStream({agentId:t,sessionId:String(s),message:n,context:a},r=>o.postMessage({type:"content",content:r}),r=>o.postMessage({type:"done",messageId:r}),r=>o.postMessage({type:"error",error:r.message}))})});async function A(o,e){var n;const{type:t,payload:s}=o;try{switch(t){case"TOGGLE_CHAT":return(n=e.tab)!=null&&n.id&&chrome.tabs.sendMessage(e.tab.id,{type:"TOGGLE_CHAT"}),{success:!0};case"SEND_MESSAGE":const{sessionId:a,content:r,agentId:i}=s;await c.addMessage(a,"user",r);let g;return i?g=await k(i,a,r,s.context):g=await N(r),await c.addMessage(a,"assistant",g),{success:!0,response:g};case"GET_MESSAGES":return{success:!0,data:await c.getMessages(s.sessionId)};case"GET_SESSIONS":return{success:!0,data:await c.getSessions()};case"CREATE_SESSION":return{success:!0,data:{id:await c.addSession(s.title||"新对话")}};case"DELETE_SESSION":return await c.deleteSession(s.sessionId),{success:!0};case"SAVE_SETTING":return await c.saveSetting(s.key,s.value),s.key==="apiEndpoint"?u.setBaseUrl(s.value):s.key==="apiKey"&&u.setToken(s.value),{success:!0};case"GET_SETTING":return{success:!0,data:await c.getSetting(s.key)};case"GET_AGENTS":return{success:!0,data:await u.getAgents(s==null?void 0:s.url)};case"GET_HISTORY":return{success:!0,data:await u.getHistory(s.sessionId,s.page,s.pageSize)};case"RECOGNIZE_INTENT":return{success:!0,data:await u.recognizeIntent(s.url)};default:return{success:!1,error:"Unknown message type"}}}catch(a){return console.error("Background error:",a),{success:!1,error:String(a)}}}async function k(o,e,t,s){return new Promise((n,a)=>{let r="";u.chatStream({agentId:o,sessionId:String(e),message:t,context:s},i=>{r+=i},()=>n(r),i=>a(i))})}async function N(o){await new Promise(t=>setTimeout(t,1e3));const e=[`我理解你说的"${o}"。这是一个很好的问题！`,`关于"${o}"，让我来帮你分析一下...`,`收到你的消息："${o}"。我会尽力帮助你。`,`针对"${o}"这个问题，我的建议是...`];return e[Math.floor(Math.random()*e.length)]}chrome.runtime.onInstalled.addListener(async()=>{console.log("AI Chat Extension installed"),await c.init(),(await c.getSessions()).length===0&&await c.addSession("默认对话")});
