var g=Object.defineProperty;var h=(a,e,s)=>e in a?g(a,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[e]=s;var u=(a,e,s)=>h(a,typeof e!="symbol"?e+"":e,s);class w{constructor(){u(this,"dbName","ai-chat-db");u(this,"version",1);u(this,"db",null)}async init(){return new Promise((e,s)=>{const t=indexedDB.open(this.dbName,this.version);t.onerror=()=>s(t.error),t.onsuccess=()=>{this.db=t.result,e()},t.onupgradeneeded=o=>{const n=o.target.result;if(n.objectStoreNames.contains("sessions")||n.createObjectStore("sessions",{keyPath:"id",autoIncrement:!0}).createIndex("createdAt","createdAt",{unique:!1}),!n.objectStoreNames.contains("messages")){const i=n.createObjectStore("messages",{keyPath:"id",autoIncrement:!0});i.createIndex("sessionId","sessionId",{unique:!1}),i.createIndex("createdAt","createdAt",{unique:!1})}n.objectStoreNames.contains("settings")||n.createObjectStore("settings",{keyPath:"key"})}})}async addSession(e){const s={title:e,createdAt:Date.now(),updatedAt:Date.now()};return this.add("sessions",s)}async addMessage(e,s,t){const o={sessionId:e,role:s,content:t,createdAt:Date.now()};return this.add("messages",o)}async getMessages(e){return this.db||await this.init(),new Promise((s,t)=>{const r=this.db.transaction(["messages"],"readonly").objectStore("messages").index("sessionId").getAll(e);r.onsuccess=()=>s(r.result),r.onerror=()=>t(r.error)})}async getSessions(){return this.db||await this.init(),new Promise((e,s)=>{const n=this.db.transaction(["sessions"],"readonly").objectStore("sessions").getAll();n.onsuccess=()=>e(n.result),n.onerror=()=>s(n.error)})}async saveSetting(e,s){await this.put("settings",{key:e,value:s})}async getSetting(e){return this.db||await this.init(),new Promise((s,t)=>{const i=this.db.transaction(["settings"],"readonly").objectStore("settings").get(e);i.onsuccess=()=>{var r;return s((r=i.result)==null?void 0:r.value)},i.onerror=()=>t(i.error)})}async deleteSession(e){return this.db||await this.init(),new Promise((s,t)=>{const o=this.db.transaction(["sessions","messages"],"readwrite");o.objectStore("sessions").delete(e);const S=o.objectStore("messages").index("sessionId").openCursor(IDBKeyRange.only(e));S.onsuccess=l=>{const d=l.target.result;d&&(d.delete(),d.continue())},o.oncomplete=()=>s(),o.onerror=()=>t(o.error)})}async add(e,s){return this.db||await this.init(),new Promise((t,o)=>{const r=this.db.transaction([e],"readwrite").objectStore(e).add(s);r.onsuccess=()=>t(r.result),r.onerror=()=>o(r.error)})}async put(e,s){return this.db||await this.init(),new Promise((t,o)=>{const r=this.db.transaction([e],"readwrite").objectStore(e).put(s);r.onsuccess=()=>t(),r.onerror=()=>o(r.error)})}}const c=new w;c.init().catch(console.error);chrome.runtime.onMessage.addListener((a,e,s)=>(m(a,e).then(s),!0));async function m(a,e){var o;const{type:s,payload:t}=a;try{switch(s){case"TOGGLE_CHAT":return(o=e.tab)!=null&&o.id&&chrome.tabs.sendMessage(e.tab.id,{type:"TOGGLE_CHAT"}),{success:!0};case"SEND_MESSAGE":const{sessionId:n,content:i}=t;await c.addMessage(n,"user",i);const r=await b(i);return await c.addMessage(n,"assistant",r),{success:!0,response:r};case"GET_MESSAGES":return{success:!0,data:await c.getMessages(t.sessionId)};case"GET_SESSIONS":return{success:!0,data:await c.getSessions()};case"CREATE_SESSION":return{success:!0,data:{id:await c.addSession(t.title||"新对话")}};case"DELETE_SESSION":return await c.deleteSession(t.sessionId),{success:!0};case"SAVE_SETTING":return await c.saveSetting(t.key,t.value),{success:!0};case"GET_SETTING":return{success:!0,data:await c.getSetting(t.key)};default:return{success:!1,error:"Unknown message type"}}}catch(n){return console.error("Background error:",n),{success:!1,error:String(n)}}}async function b(a){await new Promise(s=>setTimeout(s,1e3));const e=[`我理解你说的"${a}"。这是一个很好的问题！`,`关于"${a}"，让我来帮你分析一下...`,`收到你的消息："${a}"。我会尽力帮助你。`,`针对"${a}"这个问题，我的建议是...`];return e[Math.floor(Math.random()*e.length)]}chrome.runtime.onInstalled.addListener(async()=>{console.log("AI Chat Extension installed"),await c.init(),(await c.getSessions()).length===0&&await c.addSession("默认对话")});
