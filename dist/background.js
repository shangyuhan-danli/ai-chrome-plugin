var C=Object.defineProperty;var N=(n,e,s)=>e in n?C(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var y=(n,e,s)=>N(n,typeof e!="symbol"?e+"":e,s);class M{constructor(){y(this,"dbName","ai-chat-db");y(this,"version",1);y(this,"db",null)}async init(){return new Promise((e,s)=>{const t=indexedDB.open(this.dbName,this.version);t.onerror=()=>s(t.error),t.onsuccess=()=>{this.db=t.result,e()},t.onupgradeneeded=r=>{const o=r.target.result;if(o.objectStoreNames.contains("sessions")||o.createObjectStore("sessions",{keyPath:"id",autoIncrement:!0}).createIndex("createdAt","createdAt",{unique:!1}),!o.objectStoreNames.contains("messages")){const i=o.createObjectStore("messages",{keyPath:"id",autoIncrement:!0});i.createIndex("sessionId","sessionId",{unique:!1}),i.createIndex("createdAt","createdAt",{unique:!1})}o.objectStoreNames.contains("settings")||o.createObjectStore("settings",{keyPath:"key"})}})}async addSession(e){const s={title:e,createdAt:Date.now(),updatedAt:Date.now()};return this.add("sessions",s)}async addMessage(e,s,t){const r={sessionId:e,role:s,content:t,createdAt:Date.now()};return this.add("messages",r)}async getMessages(e){return this.db||await this.init(),new Promise((s,t)=>{const a=this.db.transaction(["messages"],"readonly").objectStore("messages").index("sessionId").getAll(e);a.onsuccess=()=>s(a.result),a.onerror=()=>t(a.error)})}async getSessions(){return this.db||await this.init(),new Promise((e,s)=>{const o=this.db.transaction(["sessions"],"readonly").objectStore("sessions").getAll();o.onsuccess=()=>e(o.result),o.onerror=()=>s(o.error)})}async saveSetting(e,s){await this.put("settings",{key:e,value:s})}async getSetting(e){return this.db||await this.init(),new Promise((s,t)=>{const i=this.db.transaction(["settings"],"readonly").objectStore("settings").get(e);i.onsuccess=()=>{var a;return s((a=i.result)==null?void 0:a.value)},i.onerror=()=>t(i.error)})}async deleteSession(e){return this.db||await this.init(),new Promise((s,t)=>{const r=this.db.transaction(["sessions","messages"],"readwrite");r.objectStore("sessions").delete(e);const l=r.objectStore("messages").index("sessionId").openCursor(IDBKeyRange.only(e));l.onsuccess=d=>{const c=d.target.result;c&&(c.delete(),c.continue())},r.oncomplete=()=>s(),r.onerror=()=>t(r.error)})}async add(e,s){return this.db||await this.init(),new Promise((t,r)=>{const a=this.db.transaction([e],"readwrite").objectStore(e).add(s);a.onsuccess=()=>t(a.result),a.onerror=()=>r(a.error)})}async put(e,s){return this.db||await this.init(),new Promise((t,r)=>{const a=this.db.transaction([e],"readwrite").objectStore(e).put(s);a.onsuccess=()=>t(),a.onerror=()=>r(a.error)})}}const u=new M,P={baseUrl:"http://localhost:3000"};class j{constructor(e=P){y(this,"config");this.config=e}updateConfig(e){this.config={...this.config,...e}}setToken(e){this.config.token=e}setBaseUrl(e){this.config.baseUrl=e}getHeaders(){const e={"Content-Type":"application/json"};return this.config.token&&(e.Authorization=`Bearer ${this.config.token}`),e}async getAgents(e){try{const s=new URLSearchParams;e&&s.append("url",e);const t=await fetch(`${this.config.baseUrl}/api/agents?${s}`,{headers:this.getHeaders()});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return(await t.json()).data||{agents:[]}}catch(s){return console.error("获取 Agent 列表失败:",s),{agents:[]}}}async chatStream(e,s,t,r){var o;try{const i=await fetch(`${this.config.baseUrl}/api/chat/stream`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(e)});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const a=(o=i.body)==null?void 0:o.getReader(),l=new TextDecoder;if(!a)throw new Error("无法获取响应流");let d="";for(;;){const{done:c,value:S}=await a.read();if(c)break;d+=l.decode(S,{stream:!0});const x=d.split(`
`);d=x.pop()||"";for(const p of x){const w=p.trim();if(w)try{const g=JSON.parse(w);if(g.message==="对话完成"){t();return}const m={};g.content&&(m.content=g.content),g.think&&(m.think=g.think),g.tool_call&&(m.toolCall=g.tool_call),g.statistic&&(m.statistic=g.statistic),Object.keys(m).length>0&&s(m)}catch{console.warn("解析流式数据失败，跳过:",w)}}}if(d.trim())try{const c=JSON.parse(d.trim());if(c.message==="对话完成"){t();return}const S={};c.content&&(S.content=c.content),c.think&&(S.think=c.think),c.tool_call&&(S.toolCall=c.tool_call),c.statistic&&(S.statistic=c.statistic),Object.keys(S).length>0&&s(S)}catch{}t()}catch(i){r(i instanceof Error?i:new Error(String(i)))}}async getHistory(e,s=1,t=20){try{const r=await fetch(`${this.config.baseUrl}/api/sessions/${e}/history?page=${s}&pageSize=${t}`,{headers:this.getHeaders()});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return(await r.json()).data||{messages:[],total:0,hasMore:!1}}catch(r){return console.error("获取会话历史失败:",r),{messages:[],total:0,hasMore:!1}}}async recognizeIntent(e){try{const s=await fetch(`${this.config.baseUrl}/api/intent/recognize`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({url:e})});return s.ok?(await s.json()).data:null}catch(s){return console.error("意图识别失败:",s),null}}}const f=new j;function R(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)})}u.init().catch(console.error);async function $(){const n=await u.getSetting("apiEndpoint"),e=await u.getSetting("apiKey");n&&f.setBaseUrl(n),e&&f.setToken(e)}$().catch(console.error);chrome.runtime.onMessage.addListener((n,e,s)=>(v(n,e).then(s),!0));const k=new Map;function T(n){return k.has(n)||k.set(n,R()),k.get(n)}chrome.runtime.onConnect.addListener(n=>{n.name==="chat-stream"&&n.onMessage.addListener(async e=>{const{agentId:s,sessionId:t,message:r,model:o,userId:i,role:a}=e;a==="user"&&await u.addMessage(t,"user",r);const l=T(t),d={message:r,role:a||"user",model:o||"claude-3-opus",agent_id:s,session_id:l,user_id:i||"default_user"};await f.chatStream(d,c=>{n.postMessage({type:"data",data:c})},()=>{n.postMessage({type:"done"})},c=>{n.postMessage({type:"error",error:c.message})})})});async function v(n,e){var r;const{type:s,payload:t}=n;try{switch(s){case"TOGGLE_CHAT":return(r=e.tab)!=null&&r.id&&chrome.tabs.sendMessage(e.tab.id,{type:"TOGGLE_CHAT"}),{success:!0};case"SEND_MESSAGE":const{sessionId:o,content:i,agentId:a}=t;await u.addMessage(o,"user",i);let l;return a?l=await D(a,o,i,t.model,t.userId):l=await G(i),await u.addMessage(o,"assistant",l),{success:!0,response:l};case"GET_MESSAGES":return{success:!0,data:await u.getMessages(t.sessionId)};case"GET_SESSIONS":return{success:!0,data:await u.getSessions()};case"CREATE_SESSION":return{success:!0,data:{id:await u.addSession(t.title||"新对话")}};case"DELETE_SESSION":return await u.deleteSession(t.sessionId),{success:!0};case"SAVE_SETTING":return await u.saveSetting(t.key,t.value),t.key==="apiEndpoint"?f.setBaseUrl(t.value):t.key==="apiKey"&&f.setToken(t.value),{success:!0};case"GET_SETTING":return{success:!0,data:await u.getSetting(t.key)};case"TOOL_RESPONSE":const{toolResponse:p,agentId:w,model:g,userId:m}=t,O=T(t.sessionId),U={message:JSON.stringify({tool_id:p.toolId,approved:p.approved,result:p.result||""}),role:"function",model:g||"claude-3-opus",agent_id:w||"",session_id:O,user_id:m||"default_user"};return new Promise(_=>{const I=[];let E="",A="",b=null;f.chatStream(U,h=>{h.content&&(E+=h.content),h.think&&!h.think.partial&&(A=h.think.reasoning_content),h.toolCall&&!h.toolCall.partial&&(b={type:"tool_use",id:`tool_${Date.now()}`,name:h.toolCall.tool_name,input:JSON.parse(h.toolCall.arguments||"{}"),status:"pending"})},()=>{E&&I.push({type:"text",text:E}),b&&I.push(b),_({success:!0,blocks:I,isComplete:!b,think:A})},h=>{_({success:!1,error:h.message})})});case"GET_AGENTS":return{success:!0,data:await f.getAgents(t==null?void 0:t.url)};case"GET_HISTORY":return{success:!0,data:await f.getHistory(t.sessionId,t.page,t.pageSize)};case"RECOGNIZE_INTENT":return{success:!0,data:await f.recognizeIntent(t.url)};default:return{success:!1,error:"Unknown message type"}}}catch(o){return console.error("Background error:",o),{success:!1,error:String(o)}}}async function D(n,e,s,t,r){return new Promise((o,i)=>{let a="";const l=T(e),d={message:s,role:"user",model:t||"claude-3-opus",agent_id:n,session_id:l,user_id:r||"default_user"};f.chatStream(d,c=>{c.content&&(a+=c.content)},()=>o(a),c=>i(c))})}async function G(n){await new Promise(s=>setTimeout(s,1e3));const e=[`我理解你说的"${n}"。这是一个很好的问题！`,`关于"${n}"，让我来帮你分析一下...`,`收到你的消息："${n}"。我会尽力帮助你。`,`针对"${n}"这个问题，我的建议是...`];return e[Math.floor(Math.random()*e.length)]}chrome.runtime.onInstalled.addListener(async()=>{console.log("AI Chat Extension installed"),await u.init(),(await u.getSessions()).length===0&&await u.addSession("默认对话")});
