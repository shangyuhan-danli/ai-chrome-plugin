var U=Object.defineProperty;var v=(o,e,s)=>e in o?U(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var x=(o,e,s)=>v(o,typeof e!="symbol"?e+"":e,s);class C{constructor(){x(this,"dbName","ai-chat-db");x(this,"version",1);x(this,"db",null)}async init(){return new Promise((e,s)=>{const t=indexedDB.open(this.dbName,this.version);t.onerror=()=>s(t.error),t.onsuccess=()=>{this.db=t.result,e()},t.onupgradeneeded=n=>{const r=n.target.result;if(r.objectStoreNames.contains("sessions")||r.createObjectStore("sessions",{keyPath:"id",autoIncrement:!0}).createIndex("createdAt","createdAt",{unique:!1}),!r.objectStoreNames.contains("messages")){const i=r.createObjectStore("messages",{keyPath:"id",autoIncrement:!0});i.createIndex("sessionId","sessionId",{unique:!1}),i.createIndex("createdAt","createdAt",{unique:!1})}r.objectStoreNames.contains("settings")||r.createObjectStore("settings",{keyPath:"key"})}})}async addSession(e){const s={title:e,createdAt:Date.now(),updatedAt:Date.now()};return this.add("sessions",s)}async addMessage(e,s,t){const n={sessionId:e,role:s,content:t,createdAt:Date.now()};return this.add("messages",n)}async getMessages(e){return this.db||await this.init(),new Promise((s,t)=>{const a=this.db.transaction(["messages"],"readonly").objectStore("messages").index("sessionId").getAll(e);a.onsuccess=()=>s(a.result),a.onerror=()=>t(a.error)})}async getSessions(){return this.db||await this.init(),new Promise((e,s)=>{const r=this.db.transaction(["sessions"],"readonly").objectStore("sessions").getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>s(r.error)})}async saveSetting(e,s){await this.put("settings",{key:e,value:s})}async getSetting(e){return this.db||await this.init(),new Promise((s,t)=>{const i=this.db.transaction(["settings"],"readonly").objectStore("settings").get(e);i.onsuccess=()=>{var a;return s((a=i.result)==null?void 0:a.value)},i.onerror=()=>t(i.error)})}async deleteSession(e){return this.db||await this.init(),new Promise((s,t)=>{const n=this.db.transaction(["sessions","messages"],"readwrite");n.objectStore("sessions").delete(e);const c=n.objectStore("messages").index("sessionId").openCursor(IDBKeyRange.only(e));c.onsuccess=g=>{const u=g.target.result;u&&(u.delete(),u.continue())},n.oncomplete=()=>s(),n.onerror=()=>t(n.error)})}async add(e,s){return this.db||await this.init(),new Promise((t,n)=>{const a=this.db.transaction([e],"readwrite").objectStore(e).add(s);a.onsuccess=()=>t(a.result),a.onerror=()=>n(a.error)})}async put(e,s){return this.db||await this.init(),new Promise((t,n)=>{const a=this.db.transaction([e],"readwrite").objectStore(e).put(s);a.onsuccess=()=>t(),a.onerror=()=>n(a.error)})}}const l=new C,j={baseUrl:"http://localhost:8000"};class N{constructor(e=j){x(this,"config");this.config=e}updateConfig(e){this.config={...this.config,...e}}setToken(e){this.config.token=e}setBaseUrl(e){this.config.baseUrl=e}getHeaders(){const e={"Content-Type":"application/json"};return this.config.token&&(e.Authorization=`Bearer ${this.config.token}`),e}async getAgents(e,s){try{const t=new URLSearchParams;t.append("user_id",e),s&&t.append("tags",s);const n=await fetch(`${this.config.baseUrl}/api/v1/agent/list?${t}`,{headers:this.getHeaders()});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const r=await n.json();return{agents:(r.data||r||[]).map(c=>({id:c.agent_id||c.id,name:c.agent_name||c.name,description:c.agent_description||c.description||"",avatar:c.avatar,tags:c.tags,matchScore:c.match_score||c.matchScore})),recommended:r.recommended}}catch(t){return console.error("获取 Agent 列表失败:",t),{agents:[]}}}async chatStream(e,s,t,n){var r;try{const i=await fetch(`${this.config.baseUrl}/api/v1/agent/chat`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(e)});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const a=(r=i.body)==null?void 0:r.getReader(),c=new TextDecoder;if(!a)throw new Error("无法获取响应流");let g="";for(;;){const{done:u,value:d}=await a.read();if(u)break;g+=c.decode(d,{stream:!0});const S=g.split(`
`);g=S.pop()||"";for(const b of S){const w=b.trim();if(!w||w.startsWith("event:"))continue;let y=w;if(w.startsWith("data:")&&(y=w.slice(5).trim()),!!y)try{const h=JSON.parse(y);if(h.message==="对话完成"){t();return}const m={};h.content&&(m.content=h.content),h.think&&(m.think=h.think),h.tool_call&&(m.toolCall=h.tool_call),h.statistic&&(m.statistic=h.statistic),Object.keys(m).length>0&&s(m)}catch{console.warn("解析流式数据失败，跳过:",y)}}}if(g.trim()){let u=g.trim();if(u.startsWith("event:")){const d=u.match(/data:(.+)/);d?u=d[1].trim():u=""}else u.startsWith("data:")&&(u=u.slice(5).trim());if(u)try{const d=JSON.parse(u);if(d.message==="对话完成"){t();return}const S={};d.content&&(S.content=d.content),d.think&&(S.think=d.think),d.tool_call&&(S.toolCall=d.tool_call),d.statistic&&(S.statistic=d.statistic),Object.keys(S).length>0&&s(S)}catch{}}t()}catch(i){n(i instanceof Error?i:new Error(String(i)))}}async getHistory(e,s=1,t=20){try{const n=await fetch(`${this.config.baseUrl}/api/sessions/${e}/history?page=${s}&pageSize=${t}`,{headers:this.getHeaders()});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return(await n.json()).data||{messages:[],total:0,hasMore:!1}}catch(n){return console.error("获取会话历史失败:",n),{messages:[],total:0,hasMore:!1}}}async recognizeIntent(e){try{const s=await fetch(`${this.config.baseUrl}/api/intent/recognize`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({url:e})});return s.ok?(await s.json()).data:null}catch(s){return console.error("意图识别失败:",s),null}}}const p=new N;function P(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,o=>{const e=Math.random()*16|0;return(o==="x"?e:e&3|8).toString(16)})}l.init().catch(console.error);async function R(){const o=await l.getSetting("apiEndpoint"),e=await l.getSetting("apiKey");o&&p.setBaseUrl(o),e&&p.setToken(e)}R().catch(console.error);chrome.runtime.onMessage.addListener((o,e,s)=>(D(o,e).then(s),!0));const k=new Map;function T(o){return k.has(o)||k.set(o,P()),k.get(o)}chrome.runtime.onConnect.addListener(o=>{o.name==="chat-stream"&&o.onMessage.addListener(async e=>{const{agentId:s,sessionId:t,message:n,model:r,userId:i,role:a,currentPageInfo:c}=e;a==="user"&&await l.addMessage(t,"user",n);const g=T(t);if(!s){o.postMessage({type:"error",error:"请先选择一个 Agent"});return}const u={message:n,role:a||"user",model:r||"claude-3-opus",agent_id:s,session_id:g,user_id:i||"default_user",current_page_info:c};await p.chatStream(u,d=>{o.postMessage({type:"data",data:d})},()=>{o.postMessage({type:"done"})},d=>{o.postMessage({type:"error",error:d.message})})})});async function D(o,e){var n;const{type:s,payload:t}=o;try{switch(s){case"TOGGLE_CHAT":return(n=e.tab)!=null&&n.id&&chrome.tabs.sendMessage(e.tab.id,{type:"TOGGLE_CHAT"}),{success:!0};case"SEND_MESSAGE":const{sessionId:r,content:i,agentId:a}=t;await l.addMessage(r,"user",i);let c;return a?c=await G(a,r,i,t.model,t.userId):c="请先选择一个 Agent 后再发送消息",await l.addMessage(r,"assistant",c),{success:!0,response:c};case"GET_MESSAGES":return{success:!0,data:await l.getMessages(t.sessionId)};case"GET_SESSIONS":return{success:!0,data:await l.getSessions()};case"CREATE_SESSION":return{success:!0,data:{id:await l.addSession(t.title||"新对话")}};case"DELETE_SESSION":return await l.deleteSession(t.sessionId),{success:!0};case"SAVE_SETTING":return await l.saveSetting(t.key,t.value),t.key==="apiEndpoint"?p.setBaseUrl(t.value):t.key==="apiKey"&&p.setToken(t.value),{success:!0};case"GET_SETTING":return{success:!0,data:await l.getSetting(t.key)};case"TOOL_RESPONSE":const{toolResponse:b,agentId:w,model:y,userId:h}=t,m=T(t.sessionId),M={message:JSON.stringify({tool_id:b.toolId,approved:b.approved,result:b.result||""}),role:"function",model:y||"claude-3-opus",agent_id:w||"",session_id:m,user_id:h||"default_user"};return new Promise(A=>{const _=[];let E="",O="",I=null;p.chatStream(M,f=>{f.content&&(E+=f.content),f.think&&!f.think.partial&&(O=f.think.reasoning_content),f.toolCall&&!f.toolCall.partial&&(I={type:"tool_use",id:`tool_${Date.now()}`,name:f.toolCall.tool_name,input:JSON.parse(f.toolCall.arguments||"{}"),status:"pending"})},()=>{E&&_.push({type:"text",text:E}),I&&_.push(I),A({success:!0,blocks:_,isComplete:!I,think:O})},f=>{A({success:!1,error:f.message})})});case"GET_AGENTS":return{success:!0,data:await p.getAgents((t==null?void 0:t.userId)||"default_user",t==null?void 0:t.tags)};case"GET_HISTORY":return{success:!0,data:await p.getHistory(t.sessionId,t.page,t.pageSize)};case"RECOGNIZE_INTENT":return{success:!0,data:await p.recognizeIntent(t.url)};default:return{success:!1,error:"Unknown message type"}}}catch(r){return console.error("Background error:",r),{success:!1,error:String(r)}}}async function G(o,e,s,t,n){return new Promise((r,i)=>{let a="";const c=T(e),g={message:s,role:"user",model:t||"claude-3-opus",agent_id:o,session_id:c,user_id:n||"default_user"};p.chatStream(g,u=>{u.content&&(a+=u.content)},()=>r(a),u=>i(u))})}chrome.runtime.onInstalled.addListener(async()=>{console.log("AI Chat Extension installed"),await l.init(),(await l.getSessions()).length===0&&await l.addSession("默认对话")});
