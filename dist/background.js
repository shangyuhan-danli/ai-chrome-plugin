var v=Object.defineProperty;var q=(c,s,t)=>s in c?v(c,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[s]=t;var I=(c,s,t)=>q(c,typeof s!="symbol"?s+"":s,t);const x=class x{constructor(){I(this,"dbName","ai-chat-db");I(this,"version",2);I(this,"db",null)}async init(){return new Promise((s,t)=>{const e=indexedDB.open(this.dbName,this.version);e.onerror=()=>t(e.error),e.onsuccess=()=>{this.db=e.result,s()},e.onupgradeneeded=r=>{const o=r.target.result,a=r.oldVersion;if(o.objectStoreNames.contains("sessions")){if(a<2){const i=r.target.transaction.objectStore("sessions");i.indexNames.contains("tabId")||i.createIndex("tabId","tabId",{unique:!1})}}else{const n=o.createObjectStore("sessions",{keyPath:"id",autoIncrement:!0});n.createIndex("createdAt","createdAt",{unique:!1}),n.createIndex("tabId","tabId",{unique:!1})}if(!o.objectStoreNames.contains("messages")){const n=o.createObjectStore("messages",{keyPath:"id",autoIncrement:!0});n.createIndex("sessionId","sessionId",{unique:!1}),n.createIndex("createdAt","createdAt",{unique:!1})}o.objectStoreNames.contains("settings")||o.createObjectStore("settings",{keyPath:"key"})}})}async addSession(s,t,e,r){const o={title:s,tabId:t||null,pageUrl:e||"",pageTitle:r||"",createdAt:Date.now(),updatedAt:Date.now()};return this.add("sessions",o)}async updateSession(s,t){return this.db||await this.init(),new Promise((e,r)=>{const o=this.db.transaction(["sessions"],"readwrite"),a=o.objectStore("sessions"),n=a.get(s);n.onsuccess=()=>{const i=n.result;if(i){const h={...i,...t,updatedAt:Date.now()};a.put(h)}},o.oncomplete=()=>e(),o.onerror=()=>r(o.error)})}async getSessionByTabId(s){return this.db||await this.init(),new Promise((t,e)=>{const n=this.db.transaction(["sessions"],"readonly").objectStore("sessions").index("tabId").get(s);n.onsuccess=()=>t(n.result||null),n.onerror=()=>e(n.error)})}async getSession(s){return this.db||await this.init(),new Promise((t,e)=>{const a=this.db.transaction(["sessions"],"readonly").objectStore("sessions").get(s);a.onsuccess=()=>t(a.result||null),a.onerror=()=>e(a.error)})}async addMessage(s,t,e,r,o){const a={sessionId:s,role:t,content:e,blocks:r||[{type:"text",text:e}],think:o||"",createdAt:Date.now()};return this.add("messages",a)}async getMessages(s){return this.db||await this.init(),new Promise((t,e)=>{const n=this.db.transaction(["messages"],"readonly").objectStore("messages").index("sessionId").getAll(s);n.onsuccess=()=>t(n.result),n.onerror=()=>e(n.error)})}async getSessions(){return this.db||await this.init(),new Promise((s,t)=>{const o=this.db.transaction(["sessions"],"readonly").objectStore("sessions").getAll();o.onsuccess=()=>s(o.result),o.onerror=()=>t(o.error)})}async saveSetting(s,t){await this.put("settings",{key:s,value:t})}async getSetting(s){return this.db||await this.init(),new Promise((t,e)=>{const a=this.db.transaction(["settings"],"readonly").objectStore("settings").get(s);a.onsuccess=()=>{var n;return t((n=a.result)==null?void 0:n.value)},a.onerror=()=>e(a.error)})}async deleteSession(s){return this.db||await this.init(),new Promise((t,e)=>{const r=this.db.transaction(["sessions","messages"],"readwrite");r.objectStore("sessions").delete(s);const i=r.objectStore("messages").index("sessionId").openCursor(IDBKeyRange.only(s));i.onsuccess=h=>{const l=h.target.result;l&&(l.delete(),l.continue())},r.oncomplete=()=>t(),r.onerror=()=>e(r.error)})}async add(s,t){return this.db||await this.init(),new Promise((e,r)=>{const n=this.db.transaction([s],"readwrite").objectStore(s).add(t);n.onsuccess=()=>e(n.result),n.onerror=()=>r(n.error)})}async put(s,t){return this.db||await this.init(),new Promise((e,r)=>{const n=this.db.transaction([s],"readwrite").objectStore(s).put(t);n.onsuccess=()=>e(),n.onerror=()=>r(n.error)})}async getRetentionDays(){return await this.getSetting("retentionDays")??x.DEFAULT_RETENTION_DAYS}async setRetentionDays(s){await this.saveSetting("retentionDays",s)}async cleanExpiredSessions(){const s=await this.getRetentionDays(),t=Date.now()-s*24*60*60*1e3;return this.db||await this.init(),new Promise((e,r)=>{let o=0,a=0;const n=[],i=this.db.transaction(["sessions","messages"],"readwrite"),h=i.objectStore("sessions"),l=i.objectStore("messages"),g=h.openCursor();g.onsuccess=S=>{const m=S.target.result;if(m){const f=m.value;f.updatedAt<t&&(n.push(f.id),m.delete(),o++),m.continue()}else if(n.length>0){const f=l.openCursor();f.onsuccess=y=>{const u=y.target.result;u&&(n.includes(u.value.sessionId)&&(u.delete(),a++),u.continue())}}},i.oncomplete=()=>e({deletedSessions:o,deletedMessages:a}),i.onerror=()=>r(i.error)})}async exportSession(s){const t=await this.getSession(s);if(!t)return null;const e=await this.getMessages(s);return{session:t,messages:e,exportedAt:new Date().toISOString()}}async exportAllSessions(){const s=await this.getSessions();this.db||await this.init();const t=await new Promise((e,r)=>{const n=this.db.transaction(["messages"],"readonly").objectStore("messages").getAll();n.onsuccess=()=>e(n.result),n.onerror=()=>r(n.error)});return{sessions:s,messages:t,exportedAt:new Date().toISOString()}}async renameSession(s,t){await this.updateSession(s,{title:t})}};I(x,"DEFAULT_RETENTION_DAYS",90);let D=x;const d=new D,G={baseUrl:"http://localhost:8000"};class L{constructor(s=G){I(this,"config");this.config=s}updateConfig(s){this.config={...this.config,...s}}setToken(s){this.config.token=s}setBaseUrl(s){this.config.baseUrl=s}getHeaders(){const s={"Content-Type":"application/json"};return this.config.token&&(s.Authorization=`Bearer ${this.config.token}`),s}async getAgents(s,t){try{const e=new URLSearchParams;e.append("user_id",s),t&&e.append("tags",t);const r=await fetch(`${this.config.baseUrl}/api/v1/agent/list?${e}`,{headers:this.getHeaders()});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const o=await r.json();return{agents:(o.data||o||[]).map(i=>({id:i.agent_id||i.id,name:i.agent_name||i.name,description:i.agent_description||i.description||"",avatar:i.avatar,tags:i.tags,matchScore:i.match_score||i.matchScore})),recommended:o.recommended}}catch(e){return console.error("获取 Agent 列表失败:",e),{agents:[]}}}async chatStream(s,t,e,r){var o;try{const a=await fetch(`${this.config.baseUrl}/api/v1/agent/chat`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(s)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const n=(o=a.body)==null?void 0:o.getReader(),i=new TextDecoder;if(!n)throw new Error("无法获取响应流");let h="";for(;;){const{done:l,value:g}=await n.read();if(l)break;h+=i.decode(g,{stream:!0});const S=h.split(`
`);h=S.pop()||"";for(const m of S){const f=m.trim();if(!f||f.startsWith("event:"))continue;let y=f;if(f.startsWith("data:")&&(y=f.slice(5).trim()),!!y)try{const u=JSON.parse(y);if(u.message==="对话完成"){e();return}const b={};u.role&&(b.role=u.role),u.content&&(b.content=u.content),u.think&&(b.think=u.think),u.tool_call&&(b.toolCall=u.tool_call),u.answer&&(b.answer=u.answer),u.statistic&&(b.statistic=u.statistic),Object.keys(b).length>0&&t(b)}catch{console.warn("解析流式数据失败，跳过:",y)}}}if(h.trim()){let l=h.trim();if(l.startsWith("event:")){const g=l.match(/data:(.+)/);g?l=g[1].trim():l=""}else l.startsWith("data:")&&(l=l.slice(5).trim());if(l)try{const g=JSON.parse(l);if(g.message==="对话完成"){e();return}const S={};g.role&&(S.role=g.role),g.content&&(S.content=g.content),g.think&&(S.think=g.think),g.tool_call&&(S.toolCall=g.tool_call),g.answer&&(S.answer=g.answer),g.statistic&&(S.statistic=g.statistic),Object.keys(S).length>0&&t(S)}catch{}}e()}catch(a){r(a instanceof Error?a:new Error(String(a)))}}async getHistory(s,t=1,e=20){try{const r=await fetch(`${this.config.baseUrl}/api/sessions/${s}/history?page=${t}&pageSize=${e}`,{headers:this.getHeaders()});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return(await r.json()).data||{messages:[],total:0,hasMore:!1}}catch(r){return console.error("获取会话历史失败:",r),{messages:[],total:0,hasMore:!1}}}async recognizeIntent(s){try{const t=await fetch(`${this.config.baseUrl}/api/intent/recognize`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({url:s})});return t.ok?(await t.json()).data:null}catch(t){return console.error("意图识别失败:",t),null}}}const p=new L;function $(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{const s=Math.random()*16|0;return(c==="x"?s:s&3|8).toString(16)})}d.init().then(()=>{d.cleanExpiredSessions().then(c=>{c.deletedSessions>0&&console.log(`[Cleanup] 已清理 ${c.deletedSessions} 个过期会话，${c.deletedMessages} 条消息`)}).catch(console.error)}).catch(console.error);async function H(){const c=await d.getSetting("apiEndpoint"),s=await d.getSetting("apiKey");c&&p.setBaseUrl(c),s&&p.setToken(s)}H().catch(console.error);chrome.runtime.onMessage.addListener((c,s,t)=>(B(c,s).then(t),!0));const k=new Map;function N(c){return k.has(c)||k.set(c,$()),k.get(c)}chrome.runtime.onConnect.addListener(c=>{if(c.name==="chat-stream"){let s="",t="",e=[],r=null;c.onMessage.addListener(async o=>{const{agentId:a,sessionId:n,message:i,model:h,userId:l,role:g,currentPageInfo:S,browserTools:m}=o;r=n,s="",t="",e=[],g==="user"&&await d.addMessage(n,"user",i);const f=N(n);if(!a){c.postMessage({type:"error",error:"请先选择一个 Agent"});return}const y={message:i,role:g||"user",model:h||"claude-3-opus",agent_id:a,session_id:f,user_id:l||"default_user",current_page_info:S,browser_tools:m};await p.chatStream(y,u=>{u.content&&(s+=u.content),u.think&&u.think.reasoning_content&&(t=u.think.reasoning_content),c.postMessage({type:"data",data:u})},async()=>{r!==null&&(s&&e.push({type:"text",text:s}),await d.addMessage(r,"assistant",s,e,t)),c.postMessage({type:"done"})},u=>{c.postMessage({type:"error",error:u.message})})})}});async function B(c,s){var r;const{type:t,payload:e}=c;try{switch(t){case"TOGGLE_CHAT":return(r=s.tab)!=null&&r.id&&chrome.tabs.sendMessage(s.tab.id,{type:"TOGGLE_CHAT"}),{success:!0};case"SEND_MESSAGE":const{sessionId:o,content:a,agentId:n}=e;await d.addMessage(o,"user",a);let i;return n?i=await z(n,o,a,e.model,e.userId):i="请先选择一个 Agent 后再发送消息",await d.addMessage(o,"assistant",i),{success:!0,response:i};case"GET_MESSAGES":return{success:!0,data:await d.getMessages(e.sessionId)};case"GET_SESSIONS":return{success:!0,data:await d.getSessions()};case"CREATE_SESSION":return{success:!0,data:{id:await d.addSession(e.title||"新对话",e.tabId,e.pageUrl,e.pageTitle)}};case"GET_SESSION_BY_TAB":return{success:!0,data:await d.getSessionByTabId(e.tabId)};case"GET_SESSION":return{success:!0,data:await d.getSession(e.sessionId)};case"UPDATE_SESSION":return await d.updateSession(e.sessionId,e.updates),{success:!0};case"DELETE_SESSION":return await d.deleteSession(e.sessionId),{success:!0};case"SAVE_SETTING":return await d.saveSetting(e.key,e.value),e.key==="apiEndpoint"?p.setBaseUrl(e.value):e.key==="apiKey"&&p.setToken(e.value),{success:!0};case"GET_SETTING":return{success:!0,data:await d.getSetting(e.key)};case"RENAME_SESSION":return await d.renameSession(e.sessionId,e.title),{success:!0};case"EXPORT_SESSION":return{success:!0,data:await d.exportSession(e.sessionId)};case"EXPORT_ALL_SESSIONS":return{success:!0,data:await d.exportAllSessions()};case"GET_RETENTION_DAYS":return{success:!0,data:await d.getRetentionDays()};case"SET_RETENTION_DAYS":return await d.setRetentionDays(e.days),{success:!0};case"CLEAN_EXPIRED_SESSIONS":return{success:!0,data:await d.cleanExpiredSessions()};case"TOOL_RESPONSE":const{toolResponse:_,agentId:P,model:j,userId:M}=e,U=N(e.sessionId),C={message:JSON.stringify({tool_id:_.toolId,approved:_.approved,result:_.result||""}),role:"function",model:j||"claude-3-opus",agent_id:P||"",session_id:U,user_id:M||"default_user"};return new Promise(O=>{const T=[];let A="",R="",E=null;p.chatStream(C,w=>{w.content&&(A+=w.content),w.think&&!w.think.partial&&(R=w.think.reasoning_content),w.toolCall&&!w.toolCall.partial&&(E={type:"tool_use",id:`tool_${Date.now()}`,name:w.toolCall.tool_name,input:JSON.parse(w.toolCall.arguments||"{}"),status:"pending"})},()=>{A&&T.push({type:"text",text:A}),E&&T.push(E),O({success:!0,blocks:T,isComplete:!E,think:R})},w=>{O({success:!1,error:w.message})})});case"GET_AGENTS":return{success:!0,data:await p.getAgents((e==null?void 0:e.userId)||"default_user",e==null?void 0:e.tags)};case"GET_HISTORY":return{success:!0,data:await p.getHistory(e.sessionId,e.page,e.pageSize)};case"RECOGNIZE_INTENT":return{success:!0,data:await p.recognizeIntent(e.url)};default:return{success:!1,error:"Unknown message type"}}}catch(o){return console.error("Background error:",o),{success:!1,error:String(o)}}}async function z(c,s,t,e,r){return new Promise((o,a)=>{let n="";const i=N(s),h={message:t,role:"user",model:e||"claude-3-opus",agent_id:c,session_id:i,user_id:r||"default_user"};p.chatStream(h,l=>{l.content&&(n+=l.content)},()=>o(n),l=>a(l))})}chrome.runtime.onInstalled.addListener(async()=>{console.log("AI Chat Extension installed"),await d.init(),(await d.getSessions()).length===0&&await d.addSession("默认对话")});
