(function(){
'use strict';
const E=new Map,ve={priorities:{form:10,button:8,link:3,text:1,tab:7,menu:6,list:4},viewport:{visible:5,nearViewport:2,hidden:0},maxElements:30};function Ne(){return`e_${Date.now()}_${Math.random().toString(36).substr(2,6)}`}function Ce(e){return e.top>=0&&e.left>=0&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth}function Ie(e){return e.top>=-200&&e.left>=-200&&e.bottom<=window.innerHeight+200&&e.right<=window.innerWidth+200}function Se(e){const t=window.getComputedStyle(e);if(t.display==="none"||t.visibility==="hidden"||t.opacity==="0")return!1;const s=e.getBoundingClientRect();return!(s.width===0||s.height===0)}function xe(e){var s,n;if(e.id){const r=document.querySelector(`label[for="${e.id}"]`);if(r)return(s=r.textContent)==null?void 0:s.trim()}const t=e.closest("label");if(t){const r=t.cloneNode(!0);return r.querySelectorAll("input, select, textarea").forEach(c=>c.remove()),(n=r.textContent)==null?void 0:n.trim()}}function _e(e){var t;if(e.tagName==="BUTTON"||e.tagName==="A")return(t=e.textContent)==null?void 0:t.trim();if(e.tagName==="INPUT"){const s=e;if(s.type==="submit"||s.type==="button")return s.value}}function Oe(e){if(!Se(e))return null;const t=e.getBoundingClientRect(),s=Ne();E.set(s,e);const n={id:s,tag:e.tagName.toLowerCase(),rect:{x:t.x,y:t.y,width:t.width,height:t.height},visible:Ce(t),disabled:e.disabled||e.getAttribute("aria-disabled")==="true"};if(e.tagName==="INPUT"){const r=e;n.type=r.type,n.name=r.name||void 0,n.placeholder=r.placeholder||void 0,r.type!=="password"&&(n.value=r.value||void 0)}if(e.tagName==="TEXTAREA"){const r=e;n.name=r.name||void 0,n.placeholder=r.placeholder||void 0,n.value=r.value||void 0}if(e.tagName==="SELECT"){const r=e;n.name=r.name||void 0,n.value=r.value||void 0}return n.text=_e(e),n.label=xe(e),n.ariaLabel=e.getAttribute("aria-label")||void 0,n}function he(){E.clear(),console.log("[ElementCollector] 开始采集元素，已清空 elementMap");const e=[],t=['input:not([type="hidden"])',"textarea","select","button","a[href]",'[role="button"]','[role="link"]','[role="checkbox"]','[role="radio"]','[role="switch"]','[role="tab"]','[role="tabpanel"]','[role="listitem"]','[role="option"]','[role="menuitem"]','[role="treeitem"]','[role="gridcell"]','[role="cell"]','[class*="tab"]','[class*="Tab"]',"[data-tab]",'[data-role="tab"]',".nav-tabs > li",".tab-list > *",".tab-item",'[role="presentation"]',"li[onclick]","li[data-clickable]","li.clickable",'li[role="button"]','li[role="tab"]','li[role="menuitem"]',"ul[data-list] > li","ol[data-list] > li",".list-group-item",".menu-item",".dropdown-item",'[contenteditable="true"]',"[onclick]",'[tabindex]:not([tabindex="-1"])','input[type="date"]','input[type="datetime-local"]','input[type="time"]','input[type="month"]','input[type="week"]','input[type="file"]','input[type="color"]','input[type="range"]',"details","summary","label[for]"];return document.querySelectorAll(t.join(", ")).forEach(n=>{const r=Oe(n);r&&e.push(r)}),console.log(`[ElementCollector] 采集完成，共 ${e.length} 个元素，elementMap 大小: ${E.size}`),e}function l(e){const t=E.get(e);return console.log(`[ElementCollector] getElementById("${e}"):`,t?`找到 <${t.tagName.toLowerCase()}>`:"未找到"),t||console.log("[ElementCollector] 当前 elementMap 中的所有 ID:",Array.from(E.keys())),t||null}function Ae(e){const t=["帮我","请","把","将","给","在","到","的","和","然后","并且","接着"];let s=e;return t.forEach(r=>{s=s.replace(new RegExp(r,"g")," ")}),s.split(/[\s,，。.!！?？、]+/).filter(r=>r.length>0)}function Le(e,t,s){let n=0;const r=[e.text,e.placeholder,e.label,e.ariaLabel,e.name].filter(Boolean).join(" ");for(const c of t)r.toLowerCase().includes(c.toLowerCase())&&(n+=10);e.tag==="input"||e.tag==="textarea"?n+=s.priorities.form:e.tag==="button"||e.tag==="input"&&(e.type==="submit"||e.type==="button")?n+=s.priorities.button:e.tag==="select"?n+=s.priorities.form:e.tag==="a"?n+=s.priorities.link:(e.tag==="li"||e.tag==="details"||e.tag==="summary")&&(n+=s.priorities.list);const o=E.get(e.id);return o&&q(e,o)&&(n+=s.priorities.tab),e.visible?n+=s.viewport.visible:Ie(new DOMRect(e.rect.x,e.rect.y,e.rect.width,e.rect.height))&&(n+=s.viewport.nearViewport),e.disabled&&(n-=5),n}function ke(e,t,s=ve){const n=Ae(t);return e.map(o=>({element:o,score:Le(o,n,s)})).sort((o,c)=>c.score-o.score).slice(0,s.maxElements).map(o=>o.element)}function q(e,t){if(t.getAttribute("role")==="tab")return!0;const s=t.className||"";if(s.includes("tab")||s.includes("Tab")||t.hasAttribute("data-tab")||t.getAttribute("data-role")==="tab")return!0;const n=t.parentElement;return!!(n&&(n.className.includes("nav-tabs")||n.className.includes("tab-list")))}function Ue(e,t){var u;const s=[];let r={input:"输入框",textarea:"文本框",button:"按钮",a:"链接",select:"下拉框",li:"列表项",details:"详情展开",summary:"摘要标题"}[e.tag]||e.tag;if(t&&q(e,t)&&(r="Tab页签"),t){const i=t.getAttribute("role");if(i){const g={tab:"Tab页签",tabpanel:"Tab面板",switch:"开关按钮",menuitem:"菜单项",option:"下拉选项",listitem:"列表项",treeitem:"树节点",gridcell:"表格单元",radio:"单选按钮",checkbox:"复选框",button:"按钮",link:"链接"};g[i]&&(r=g[i])}}if(e.tag==="input"&&e.type){const i={password:"密码框",submit:"提交按钮",button:"按钮",checkbox:"复选框",radio:"单选框",search:"搜索框",email:"邮箱输入框",tel:"电话输入框",number:"数字输入框",url:"URL输入框",date:"日期选择器","datetime-local":"日期时间选择器",time:"时间选择器",month:"月份选择器",week:"周选择器",file:"文件上传",color:"颜色选择器",range:"滑块",hidden:"隐藏字段"};i[e.type]&&(r=i[e.type])}s.push(r);let o=e.label||e.text||e.placeholder||e.ariaLabel||e.name;if(!o&&t&&(o=t.getAttribute("title")||void 0),!o&&t&&r==="Tab页签"){const i=(u=t.textContent)==null?void 0:u.trim();i&&i.length<50&&(o=i)}o&&s.push(o);const c=[];e.placeholder&&e.placeholder!==o&&c.push(`placeholder:${e.placeholder}`),e.type&&!["text","submit","button"].includes(e.type)&&c.push(`type:${e.type}`),e.disabled&&c.push("禁用"),r==="Tab页签"&&t&&(t.classList.contains("active")||t.getAttribute("aria-selected")==="true")&&c.push("当前激活"),(e.type==="radio"||e.type==="checkbox")&&t&&t.checked&&c.push("已选中");let a=s.join(":");return c.length>0&&(a+=`(${c.join(",")})`),a}function be(e){return e.map(t=>{const s=E.get(t.id);return{id:t.id,desc:Ue(t,s)}})}function Me(e=""){var r;const t=he(),s=ke(t,e),n=be(s);return{url:window.location.href,title:document.title,elements:n,selectedText:((r=window.getSelection())==null?void 0:r.toString())||void 0}}function $e(e){let t=he();if(e.region&&(t=t.filter(s=>{const n=s.rect;switch(e.region){case"header":return n.y<150;case"footer":return n.y>window.innerHeight-200;case"sidebar":return n.x<250||n.x>window.innerWidth-250;case"below_viewport":return n.y>window.innerHeight;case"form":const r=document.querySelectorAll("form");return Array.from(r).some(u=>{const i=u.getBoundingClientRect();return n.x>=i.left&&n.x<=i.right&&n.y>=i.top&&n.y<=i.bottom});case"tab_panel":const o=document.querySelectorAll('[role="tabpanel"], .tab-content, .tab-pane');return Array.from(o).some(u=>{const i=u.getBoundingClientRect();return n.x>=i.left&&n.x<=i.right&&n.y>=i.top&&n.y<=i.bottom});case"modal":const c=document.querySelectorAll('[role="dialog"], .modal, .dialog, [class*="modal"], [class*="dialog"]');return Array.from(c).some(u=>{const i=u.getBoundingClientRect();return n.x>=i.left&&n.x<=i.right&&n.y>=i.top&&n.y<=i.bottom});case"menu":const a=document.querySelectorAll('[role="menu"], [role="menubar"], .menu, .dropdown-menu, .context-menu');return Array.from(a).some(u=>{const i=u.getBoundingClientRect();return n.x>=i.left&&n.x<=i.right&&n.y>=i.top&&n.y<=i.bottom});default:return!0}})),e.elementType&&e.elementType!=="all"&&(t=t.filter(s=>{const n=E.get(s.id);switch(e.elementType){case"input":return s.tag==="input"||s.tag==="textarea";case"button":return s.tag==="button"||s.tag==="input"&&(s.type==="submit"||s.type==="button");case"link":return s.tag==="a";case"select":return s.tag==="select";case"tab":return n?q(s,n):!1;case"menu":return n?n.getAttribute("role")==="menuitem"||n.classList.contains("menu-item")||n.classList.contains("dropdown-item"):!1;case"list":return s.tag==="li"||(n==null?void 0:n.getAttribute("role"))==="listitem"||(n==null?void 0:n.classList.contains("list-group-item"));case"radio":return s.type==="radio"||(n==null?void 0:n.getAttribute("role"))==="radio";case"checkbox":return s.type==="checkbox"||(n==null?void 0:n.getAttribute("role"))==="checkbox";default:return!0}})),e.keyword){const s=e.keyword.toLowerCase();t=t.filter(n=>[n.text,n.placeholder,n.label,n.ariaLabel,n.name].filter(Boolean).join(" ").toLowerCase().includes(s))}return be(t)}function M(e){return new Promise(t=>setTimeout(t,e))}function ce(e,t){e.focus(),e.value="",e.dispatchEvent(new Event("focus",{bubbles:!0})),e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))}function ae(e){e.focus(),e.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))}async function Re(e,t){if(console.log("[ActionExecutor] fillInput 调用:",{target:e,value:t}),!t)return{success:!1,message:"未提供填充值",error:"NO_VALUE"};const s=e.elementId?l(e.elementId):null;if(console.log("[ActionExecutor] 通过 elementId 查找结果:",s?`<${s.tagName}>`:"null"),!s){if(e.selector){const n=document.querySelector(e.selector);if(n&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"))return ce(n,t),{success:!0,message:`已填充: ${t}`}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return s.tagName!=="INPUT"&&s.tagName!=="TEXTAREA"?s.getAttribute("contenteditable")==="true"?(s.focus(),s.textContent=t,s.dispatchEvent(new Event("input",{bubbles:!0})),{success:!0,message:`已填充: ${t}`}):{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"}:(ce(s,t),{success:!0,message:`已填充: ${t}`})}async function De(e){var s;const t=e.elementId?l(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n)return ae(n),{success:!0,message:"已点击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return ae(t),{success:!0,message:`已点击: ${e.description||((s=t.textContent)==null?void 0:s.trim())||"元素"}`}}async function Pe(e,t){const s=t||"#ffeb3b",n=window.getSelection();if(n&&n.rangeCount>0&&!n.isCollapsed){const o=n.getRangeAt(0),c=document.createElement("span");c.className="ai-highlight",c.style.backgroundColor=s,c.style.padding="2px 0",c.style.borderRadius="2px";try{return o.surroundContents(c),n.removeAllRanges(),{success:!0,message:"已高亮选中文字"}}catch{return{success:!1,message:"无法高亮跨元素的选中内容",error:"CROSS_ELEMENT"}}}const r=e.elementId?l(e.elementId):null;return r?(r.style.backgroundColor=s,r.classList.add("ai-highlight"),{success:!0,message:"已高亮元素"}):{success:!1,message:"未找到要高亮的内容",error:"NO_TARGET"}}async function qe(e){const t=window.getSelection();if(t&&t.rangeCount>0&&!t.isCollapsed){const n=t.getRangeAt(0),r=document.createElement("span");r.className="ai-underline",r.style.textDecoration="underline",r.style.textDecorationColor="#1a73e8",r.style.textDecorationThickness="2px";try{return n.surroundContents(r),t.removeAllRanges(),{success:!0,message:"已添加下划线"}}catch{return{success:!1,message:"无法为跨元素的选中内容添加下划线",error:"CROSS_ELEMENT"}}}const s=e.elementId?l(e.elementId):null;return s?(s.style.textDecoration="underline",s.style.textDecorationColor="#1a73e8",s.classList.add("ai-underline"),{success:!0,message:"已添加下划线"}):{success:!1,message:"未找到要添加下划线的内容",error:"NO_TARGET"}}async function Xe(e,t){if(!t)return{success:!1,message:"未提供选择值",error:"NO_VALUE"};const s=e.elementId?l(e.elementId):null;if(!s||s.tagName!=="SELECT"){if(e.selector){const n=document.querySelector(e.selector);if(n&&n.tagName==="SELECT")return ie(n,t)}return{success:!1,message:"未找到下拉框元素",error:"ELEMENT_NOT_FOUND"}}return ie(s,t)}function ie(e,t){const s=Array.from(e.options).find(r=>r.value===t);if(s)return e.value=s.value,e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已选择: ${s.text}`};const n=Array.from(e.options).find(r=>r.text.toLowerCase().includes(t.toLowerCase()));return n?(e.value=n.value,e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已选择: ${n.text}`}):{success:!1,message:`未找到匹配的选项: ${t}`,error:"OPTION_NOT_FOUND"}}async function Be(e){const t=e.elementId?l(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n&&n.type==="checkbox")return n.checked=!n.checked,n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:n.checked?"已勾选":"已取消勾选"}}return{success:!1,message:"未找到复选框元素",error:"ELEMENT_NOT_FOUND"}}if(t.tagName!=="INPUT"||t.type!=="checkbox")return{success:!1,message:"目标元素不是复选框",error:"INVALID_ELEMENT"};const s=t;return s.checked=!s.checked,s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:s.checked?"已勾选":"已取消勾选"}}async function He(e){const t=window.innerHeight*.8;switch(e){case"up":return window.scrollBy({top:-t,behavior:"smooth"}),{success:!0,message:"已向上滚动"};case"down":return window.scrollBy({top:t,behavior:"smooth"}),{success:!0,message:"已向下滚动"};case"top":return window.scrollTo({top:0,behavior:"smooth"}),{success:!0,message:"已滚动到顶部"};case"bottom":return window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}),{success:!0,message:"已滚动到底部"};default:return window.scrollBy({top:t,behavior:"smooth"}),{success:!0,message:"已向下滚动"}}}async function Fe(e){var n,r;const t=e.elementId?l(e.elementId):null;if(!t){if(e.selector){const c=document.querySelector(e.selector);if(c)return{success:!0,message:"已读取内容",data:((n=c.textContent)==null?void 0:n.trim())||""}}const o=window.getSelection();return o&&!o.isCollapsed?{success:!0,message:"已读取选中内容",data:o.toString()}:{success:!1,message:"未找到要读取的内容",error:"NO_TARGET"}}return{success:!0,message:"已读取内容",data:((r=t.textContent)==null?void 0:r.trim())||""}}async function We(e){var n;const t=e.elementId?l(e.elementId):null;if(!t){if(e.selector){const r=document.querySelector(e.selector);if(r){const o=new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window});return r.dispatchEvent(o),{success:!0,message:"已悬停在元素上"}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const s=new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window});return t.dispatchEvent(s),{success:!0,message:`已悬停在: ${e.description||((n=t.textContent)==null?void 0:n.trim())||"元素"}上`}}async function ze(e,t,s){if(!t)return{success:!1,message:"未提供输入文本",error:"NO_TEXT"};const n=e.elementId?l(e.elementId):null;if(!n){if(e.selector){const r=document.querySelector(e.selector);if(r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"))return await ue(r,t,s||50),{success:!0,message:`已输入: ${t}`}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return n.tagName!=="INPUT"&&n.tagName!=="TEXTAREA"?{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"}:(await ue(n,t,s||50),{success:!0,message:`已输入: ${t}`})}async function ue(e,t,s){e.focus(),e.value="",e.dispatchEvent(new Event("focus",{bubbles:!0}));for(let n=0;n<t.length;n++)e.value+=t[n],e.dispatchEvent(new Event("input",{bubbles:!0})),await new Promise(r=>setTimeout(r,s));e.dispatchEvent(new Event("change",{bubbles:!0}))}async function Ge(e,t){if(!e)return{success:!1,message:"未提供按键",error:"NO_KEY"};const s=t?document.querySelector(t):document.activeElement;return s?(le(s,e),{success:!0,message:`已在元素上按下: ${e}`}):(le(document,e),{success:!0,message:`已发送按键: ${e}`})}function le(e,t){const s=new KeyboardEvent("keydown",{key:t,bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(s);const n=new KeyboardEvent("keypress",{key:t,bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(n);const r=new KeyboardEvent("keyup",{key:t,bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(r)}async function Ye(e,t){const s=e.elementId?l(e.elementId):null;if(!s)return{success:!1,message:"未找到源元素",error:"SOURCE_NOT_FOUND"};let n=null,r,o;if(t!=null&&t.selector){if(n=document.querySelector(t.selector),!n)return{success:!1,message:"未找到目标元素",error:"DESTINATION_NOT_FOUND"};const m=n.getBoundingClientRect();r=m.left+m.width/2,o=m.top+m.height/2}else if((t==null?void 0:t.x)!==void 0&&(t==null?void 0:t.y)!==void 0)r=t.x,o=t.y;else return{success:!1,message:"未提供目标位置",error:"NO_DESTINATION"};const c=s.getBoundingClientRect(),a=c.left+c.width/2,u=c.top+c.height/2;s.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window,clientX:a,clientY:u})),await M(100);const i=10;for(let m=1;m<=i;m++){const w=a+(r-a)*(m/i),v=u+(o-u)*(m/i);s.dispatchEvent(new MouseEvent("mousemove",{bubbles:!0,cancelable:!0,view:window,clientX:w,clientY:v})),await M(50)}return(document.elementFromPoint(r,o)||document.body).dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window,clientX:r,clientY:o})),{success:!0,message:"拖拽完成"}}async function Ve(e,t,s){const n=t||1e3,r=Date.now();if(e!=null&&e.elementId||e!=null&&e.selector){for(e.elementId?`${e.elementId}`:e.selector;Date.now()-r<n;){const o=e.elementId?l(e.elementId):document.querySelector(e.selector);if(o)if(s==="visible"){const c=o.getBoundingClientRect();if(c.width>0&&c.height>0)return{success:!0,message:"元素已可见"}}else if(s==="hidden"){const c=o.getBoundingClientRect();if(c.width===0||c.height===0)return{success:!0,message:"元素已隐藏"}}else return{success:!0,message:"元素已出现"};await M(100)}return{success:!1,message:`等待超时: ${n}ms`,error:"TIMEOUT"}}else return await M(n),{success:!0,message:`等待了 ${n}ms`}}async function Ke(e){var s;const t=e.elementId?l(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n)return n.focus(),{success:!0,message:"已聚焦元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return t.focus(),{success:!0,message:`已聚焦: ${e.description||((s=t.textContent)==null?void 0:s.trim())||"元素"}`}}async function je(e){var s;const t=e.elementId?l(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n)return n.blur(),{success:!0,message:"已失焦元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return t.blur(),{success:!0,message:`已失焦: ${e.description||((s=t.textContent)==null?void 0:s.trim())||"元素"}`}}async function Je(e){const t=e.elementId?l(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"))return n.value="",n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:"已清空输入框"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}if(t.tagName!=="INPUT"&&t.tagName!=="TEXTAREA")return{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"};const s=t;return s.value="",s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:"已清空输入框"}}async function Qe(e,t){if(!t)return{success:!1,message:"未提供属性名",error:"NO_ATTRIBUTE"};const s=e.elementId?l(e.elementId):null;if(!s){if(e.selector){const r=document.querySelector(e.selector);if(r){const o=r.getAttribute(t);return{success:!0,message:`获取属性 ${t}`,data:o}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const n=s.getAttribute(t);return{success:!0,message:`获取属性 ${t}`,data:n}}async function Ze(e,t){if(!t)return{success:!1,message:"未提供属性名",error:"NO_PROPERTY"};const s=e.elementId?l(e.elementId):null;if(!s){if(e.selector){const r=document.querySelector(e.selector);if(r){const o=r[t];return{success:!0,message:`获取属性值 ${t}`,data:o}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const n=s[t];return{success:!0,message:`获取属性值 ${t}`,data:n}}async function et(e,t){switch(e){case"goto":return t?(window.location.href=t,{success:!0,message:`导航到: ${t}`}):{success:!1,message:"未提供URL",error:"NO_URL"};case"back":return window.history.back(),{success:!0,message:"返回上一页"};case"forward":return window.history.forward(),{success:!0,message:"前进到下一页"};case"reload":return window.location.reload(),{success:!0,message:"刷新页面"};default:return{success:!1,message:"未知的导航操作",error:"UNKNOWN_ACTION"}}}async function tt(e,t,s){var r;const n=e.elementId?l(e.elementId):null;if(!n){if(e.selector){const o=document.querySelector(e.selector);if(o)return o.scrollIntoView({behavior:t||"smooth",block:s||"center"}),{success:!0,message:"已滚动到元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return n.scrollIntoView({behavior:t||"smooth",block:s||"center"}),{success:!0,message:`已滚动到: ${e.description||((r=n.textContent)==null?void 0:r.trim())||"元素"}`}}async function st(e){var s;if(!e)return{success:!0,message:"已切换回主文档"};const t=document.querySelector(e);if(!t)return{success:!1,message:"未找到iframe",error:"IFRAME_NOT_FOUND"};try{return t.contentDocument||((s=t.contentWindow)==null?void 0:s.document)?{success:!0,message:`已切换到iframe: ${e}`,data:{frameUrl:t.src}}:{success:!1,message:"无法访问iframe内容（跨域限制）",error:"CROSS_ORIGIN"}}catch{return{success:!1,message:"无法访问iframe内容",error:"ACCESS_ERROR"}}}async function nt(e,t){return{success:!0,message:`弹窗处理: ${e}`,data:{promptText:t}}}async function rt(e,t){try{return localStorage.setItem(e,t),{success:!0,message:`已设置 localStorage[${e}] = ${t}`}}catch(s){return{success:!1,message:"设置localStorage失败",error:String(s)}}}async function ot(e){try{const t=localStorage.getItem(e);return{success:!0,message:`获取 localStorage[${e}]`,data:t}}catch(t){return{success:!1,message:"获取localStorage失败",error:String(t)}}}async function ct(e){try{if(e){const t=[];for(let s=0;s<localStorage.length;s++){const n=localStorage.key(s);n&&n.startsWith(e)&&t.push(n)}return t.forEach(s=>localStorage.removeItem(s)),{success:!0,message:`已清除 ${t.length} 个localStorage项`}}else{const t=localStorage.length;return localStorage.clear(),{success:!0,message:`已清除所有 ${t} 个localStorage项`}}}catch(t){return{success:!1,message:"清除localStorage失败",error:String(t)}}}async function at(e,t,s){try{let n=`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(s!=null&&s.expires){const r=new Date(Date.now()+s.expires*1e3);n+=`;expires=${r.toUTCString()}`}return s!=null&&s.path&&(n+=`;path=${s.path}`),s!=null&&s.domain&&(n+=`;domain=${s.domain}`),s!=null&&s.secure&&(n+=";secure"),document.cookie=n,{success:!0,message:`已设置 Cookie: ${e}`}}catch(n){return{success:!1,message:"设置Cookie失败",error:String(n)}}}async function it(e){var t;try{if(e){const s=(t=document.cookie.split("; ").find(n=>n.startsWith(`${encodeURIComponent(e)}=`)))==null?void 0:t.split("=")[1];return{success:!0,message:`获取 Cookie: ${e}`,data:s?decodeURIComponent(s):null}}else return{success:!0,message:"获取所有Cookies",data:document.cookie}}catch(s){return{success:!1,message:"获取Cookie失败",error:String(s)}}}function de(e){const t=e.getBoundingClientRect(),s=t.left+t.width/2,n=t.top+t.height/2,r={bubbles:!0,cancelable:!0,view:window,clientX:s,clientY:n};e.focus(),e.dispatchEvent(new MouseEvent("mousedown",{...r,button:0,buttons:1})),e.dispatchEvent(new MouseEvent("mouseup",{...r,button:0,buttons:0})),e.dispatchEvent(new MouseEvent("click",{...r,button:0})),e.dispatchEvent(new MouseEvent("mousedown",{...r,button:0,buttons:1})),e.dispatchEvent(new MouseEvent("mouseup",{...r,button:0,buttons:0})),e.dispatchEvent(new MouseEvent("click",{...r,button:0})),e.dispatchEvent(new MouseEvent("dblclick",{...r,button:0}))}async function ut(e){var s;const t=e.elementId?l(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n)return de(n),{success:!0,message:"已双击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return de(t),{success:!0,message:`已双击: ${e.description||((s=t.textContent)==null?void 0:s.trim())||"元素"}`}}function me(e){const t=e.getBoundingClientRect(),s=t.left+t.width/2,n=t.top+t.height/2;e.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window,button:2,buttons:2,clientX:s,clientY:n})),e.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window,button:2,buttons:0,clientX:s,clientY:n})),e.dispatchEvent(new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,view:window,button:2,clientX:s,clientY:n}))}async function lt(e){var s;const t=e.elementId?l(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n)return me(n),{success:!0,message:"已右键点击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return me(t),{success:!0,message:`已右键点击: ${e.description||((s=t.textContent)==null?void 0:s.trim())||"元素"}`}}async function dt(e,t,s,n){const r=e.elementId?l(e.elementId):e.selector?document.querySelector(e.selector):null;if(!r)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const o=window.getSelection();if(!o)return{success:!1,message:"无法获取Selection对象",error:"NO_SELECTION"};o.removeAllRanges();const c=document.createRange();try{if(t){const u=mt(r,t);if(!u)return{success:!1,message:`未找到文本: ${t}`,error:"TEXT_NOT_FOUND"};const g=(u.textContent||"").indexOf(t);c.setStart(u,g),c.setEnd(u,g+t.length)}else if(s!==void 0&&n!==void 0){const u=r.firstChild;if(!u||u.nodeType!==Node.TEXT_NODE)return{success:!1,message:"元素没有文本节点",error:"NO_TEXT_NODE"};c.setStart(u,s),c.setEnd(u,n)}else c.selectNodeContents(r);o.addRange(c);const a=o.toString();return{success:!0,message:`已选中文本: ${a}`,data:a}}catch(a){return{success:!1,message:`选中文本失败: ${a}`,error:"SELECT_ERROR"}}}function mt(e,t){const s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);let n;for(;n=s.nextNode();)if(n.textContent&&n.textContent.includes(t))return n;return null}async function ft(e,t){var s;try{let n=t;if(!n){const r=window.getSelection();if(r&&!r.isCollapsed)n=r.toString();else if(e.elementId||e.selector){const o=e.elementId?l(e.elementId):document.querySelector(e.selector);o&&(n=((s=o.textContent)==null?void 0:s.trim())||"")}}return n?(await navigator.clipboard.writeText(n),{success:!0,message:`已复制到剪贴板: ${n.substring(0,50)}${n.length>50?"...":""}`}):{success:!1,message:"没有可复制的内容",error:"NO_CONTENT"}}catch(n){return{success:!1,message:`复制失败: ${n}`,error:"CLIPBOARD_ERROR"}}}async function pt(e){try{const t=await navigator.clipboard.readText();if(!t)return{success:!1,message:"剪贴板为空",error:"EMPTY_CLIPBOARD"};const s=e.elementId?l(e.elementId):e.selector?document.querySelector(e.selector):null;if(!s)return{success:!0,message:"已读取剪贴板内容",data:t};if(s.tagName==="INPUT"||s.tagName==="TEXTAREA"){const n=s;return n.focus(),n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已粘贴: ${t.substring(0,50)}${t.length>50?"...":""}`}}else if(s.getAttribute("contenteditable")==="true")return s.focus(),s.textContent=t,s.dispatchEvent(new Event("input",{bubbles:!0})),{success:!0,message:`已粘贴: ${t.substring(0,50)}${t.length>50?"...":""}`};return{success:!0,message:"已读取剪贴板内容",data:t}}catch(t){return{success:!1,message:`粘贴失败: ${t}`,error:"CLIPBOARD_ERROR"}}}async function gt(e,t){if(!t||t.length===0)return{success:!1,message:"未提供文件",error:"NO_FILES"};const s=e.elementId?l(e.elementId):e.selector?document.querySelector(e.selector):null;if(!s||s.tagName!=="INPUT"||s.type!=="file")return{success:!1,message:"目标元素不是文件输入框",error:"INVALID_ELEMENT"};const n=s;try{const r=new DataTransfer;for(const o of t){const c=atob(o.content),a=new Array(c.length);for(let m=0;m<c.length;m++)a[m]=c.charCodeAt(m);const u=new Uint8Array(a),i=new Blob([u],{type:o.type}),g=new File([i],o.name,{type:o.type});r.items.add(g)}return n.files=r.files,n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已上传 ${t.length} 个文件`}}catch(r){return{success:!1,message:`上传失败: ${r}`,error:"UPLOAD_ERROR"}}}async function ht(e){if(!e)return{success:!1,message:"未提供脚本",error:"NO_SCRIPT"};try{return{success:!0,message:"脚本执行成功",data:new Function(e)()}}catch(t){return{success:!1,message:`脚本执行失败: ${t}`,error:"SCRIPT_ERROR"}}}async function bt(e,t,s,n){var a,u;if(!s)return{success:!1,message:"未提供列表项内容",error:"NO_CONTENT"};let r=null;if(t)r=document.querySelector(t);else if(e.elementId||e.selector){const i=e.elementId?l(e.elementId):document.querySelector(e.selector);i&&(r=i.closest("ul, ol"))}if(!r)return{success:!1,message:"未找到列表容器",error:"LIST_NOT_FOUND"};const o=document.createElement("li");o.textContent=s;const c=e.elementId?l(e.elementId):e.selector?document.querySelector(e.selector):null;switch(n){case"before":c&&c.tagName==="LI"?(a=c.parentNode)==null||a.insertBefore(o,c):r.insertBefore(o,r.firstChild);break;case"after":c&&c.tagName==="LI"?(u=c.parentNode)==null||u.insertBefore(o,c.nextSibling):r.appendChild(o);break;case"first":r.insertBefore(o,r.firstChild);break;case"last":default:r.appendChild(o);break}return r.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已添加列表项: ${s}`}}async function Et(e,t){var o;let s=null;if(e.elementId||e.selector)s=e.elementId?l(e.elementId):document.querySelector(e.selector);else if(t!==void 0){const c=document.querySelectorAll("ul, ol");for(const a of c){const u=a.querySelectorAll(":scope > li");if(u[t]){s=u[t];break}}}if(!s||s.tagName!=="LI")return{success:!1,message:"未找到要删除的列表项",error:"ITEM_NOT_FOUND"};const n=((o=s.textContent)==null?void 0:o.trim())||"",r=s.parentNode;return s.remove(),r&&r.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已删除列表项: ${n}`}}async function wt(e,t){var r;if(!t)return{success:!1,message:"未提供新内容",error:"NO_CONTENT"};const s=e.elementId?l(e.elementId):e.selector?document.querySelector(e.selector):null;if(!s||s.tagName!=="LI")return{success:!1,message:"未找到列表项元素",error:"ITEM_NOT_FOUND"};const n=((r=s.textContent)==null?void 0:r.trim())||"";return s.textContent=t,s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已编辑列表项: "${n}" → "${t}"`}}async function yt(e,t){var r;if(t===void 0)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const s=e.elementId?l(e.elementId):e.selector?document.querySelector(e.selector):null;if(!s)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const n=((r=s.textContent)==null?void 0:r.trim())||"";return s.tagName==="INPUT"||s.tagName==="TEXTAREA"?s.value=t:(s.getAttribute("contenteditable"),s.textContent=t),s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已设置内容: "${n.substring(0,20)}..." → "${t.substring(0,20)}..."`}}async function Tt(e,t){if(!t)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const s=e.elementId?l(e.elementId):e.selector?document.querySelector(e.selector):null;if(!s)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};if(s.tagName==="INPUT"||s.tagName==="TEXTAREA"){const n=s;n.value+=t}else s.getAttribute("contenteditable")==="true"?s.textContent=(s.textContent||"")+t:s.appendChild(document.createTextNode(t));return s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已追加内容: "${t.substring(0,30)}${t.length>30?"...":""}"`}}async function vt(e,t){if(!t)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const s=e.elementId?l(e.elementId):e.selector?document.querySelector(e.selector):null;if(!s)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};if(s.tagName==="INPUT"||s.tagName==="TEXTAREA"){const n=s;n.value=t+n.value}else s.getAttribute("contenteditable")==="true"?s.textContent=t+(s.textContent||""):s.insertBefore(document.createTextNode(t),s.firstChild);return s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已前置内容: "${t.substring(0,30)}${t.length>30?"...":""}"`}}async function Nt(e,t,s){if(!t)return{success:!1,message:"未提供HTML内容",error:"NO_HTML"};const n=e.elementId?l(e.elementId):e.selector?document.querySelector(e.selector):null;if(!n)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const r=s||"beforeend";return n.insertAdjacentHTML(r,t),n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已在${{beforebegin:"元素之前",afterbegin:"元素内部开头",beforeend:"元素内部末尾",afterend:"元素之后"}[r]}插入HTML`}}async function Ct(e){try{if(e)return document.cookie=`${encodeURIComponent(e)}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`,{success:!0,message:`已清除 Cookie: ${e}`};{const t=document.cookie.split(";");return t.forEach(s=>{const[n]=s.split("="),r=n==null?void 0:n.trim();r&&(document.cookie=`${r}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`,document.cookie=`${r}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;domain=${window.location.hostname}`)}),{success:!0,message:`已清除 ${t.length} 个Cookies`}}}catch(t){return{success:!1,message:"清除Cookie失败",error:String(t)}}}async function Ee(e){var t,s,n,r,o,c,a,u,i,g,m,w,v,P,y,N,C,I,$,S,R,T,_,O,A,L,B,H,F,W,z,G,Y,V,K,j,J,Q,Z,ee,te,se,ne,re,oe;try{switch(e.action){case"fill":return await Re(e.target,(t=e.params)==null?void 0:t.value);case"click":return await De(e.target);case"highlight":return await Pe(e.target,(s=e.params)==null?void 0:s.color);case"underline":return await qe(e.target);case"select":return await Xe(e.target,(n=e.params)==null?void 0:n.value);case"check":return await Be(e.target);case"scroll":return await He((r=e.params)==null?void 0:r.direction);case"read":return await Fe(e.target);case"hover":return await We(e.target);case"type":return await ze(e.target,(o=e.params)==null?void 0:o.value,(c=e.params)==null?void 0:c.delay);case"press":return await Ge((a=e.params)==null?void 0:a.key,(u=e.target)==null?void 0:u.selector);case"drag":return await Ye(e.target,(i=e.params)==null?void 0:i.destination);case"wait":return await Ve(e.target,(g=e.params)==null?void 0:g.timeout,(m=e.params)==null?void 0:m.condition);case"focus":return await Ke(e.target);case"blur":return await je(e.target);case"clear":return await Je(e.target);case"getAttribute":return await Qe(e.target,(w=e.params)==null?void 0:w.attribute);case"getProperty":return await Ze(e.target,(v=e.params)==null?void 0:v.property);case"navigate":return await et((P=e.params)==null?void 0:P.navigateAction,(y=e.params)==null?void 0:y.url);case"scrollIntoView":return await tt(e.target,(N=e.params)==null?void 0:N.behavior,(C=e.params)==null?void 0:C.block);case"switchFrame":return await st((I=e.params)==null?void 0:I.frameSelector);case"handleDialog":return await nt(($=e.params)==null?void 0:$.dialogAction,(S=e.params)==null?void 0:S.promptText);case"setLocalStorage":return await rt((R=e.params)==null?void 0:R.key,(T=e.params)==null?void 0:T.value);case"getLocalStorage":return await ot((_=e.params)==null?void 0:_.key);case"clearLocalStorage":return await ct((O=e.params)==null?void 0:O.prefix);case"setCookie":return await at((A=e.params)==null?void 0:A.name,(L=e.params)==null?void 0:L.value,(B=e.params)==null?void 0:B.cookieOptions);case"getCookie":return await it((H=e.params)==null?void 0:H.name);case"clearCookies":return await Ct((F=e.params)==null?void 0:F.name);case"doubleClick":return await ut(e.target);case"rightClick":return await lt(e.target);case"selectText":return await dt(e.target,(W=e.params)==null?void 0:W.searchText,(z=e.params)==null?void 0:z.startOffset,(G=e.params)==null?void 0:G.endOffset);case"copyToClipboard":return await ft(e.target,(Y=e.params)==null?void 0:Y.text);case"pasteFromClipboard":return await pt(e.target);case"upload":return await gt(e.target,(V=e.params)==null?void 0:V.files);case"evaluate":return await ht((K=e.params)==null?void 0:K.script);case"addListItem":return await bt(e.target,(j=e.params)==null?void 0:j.listSelector,(J=e.params)==null?void 0:J.itemContent,(Q=e.params)==null?void 0:Q.position);case"removeListItem":return await Et(e.target,(Z=e.params)==null?void 0:Z.itemIndex);case"editListItem":return await wt(e.target,(ee=e.params)==null?void 0:ee.itemContent);case"setContent":return await yt(e.target,(te=e.params)==null?void 0:te.content);case"appendContent":return await Tt(e.target,(se=e.params)==null?void 0:se.content);case"prependContent":return await vt(e.target,(ne=e.params)==null?void 0:ne.content);case"insertHTML":return await Nt(e.target,(re=e.params)==null?void 0:re.html,(oe=e.params)==null?void 0:oe.insertPosition);default:return{success:!1,message:`不支持的操作类型: ${e.action}`,error:"UNSUPPORTED_ACTION"}}}catch(Te){return{success:!1,message:`执行操作时出错: ${Te}`,error:"EXECUTION_ERROR"}}}async function It(e){const t=[];let s=0;for(const r of e){const o=await Ee(r);t.push(o),o.success&&s++,await M(100)}const n=`执行了 ${e.length} 个操作，成功 ${s} 个，失败 ${e.length-s} 个`;return{success:s===e.length,results:t,summary:n}}function St(){document.querySelectorAll(".ai-highlight").forEach(e=>{const t=e.parentNode;t&&(t.replaceChild(document.createTextNode(e.textContent||""),e),t.normalize())}),document.querySelectorAll(".ai-underline").forEach(e=>{const t=e.parentNode;t&&(t.replaceChild(document.createTextNode(e.textContent||""),e),t.normalize())})}let d=null,f=null,k=null,h=!1,b=null,p=null,x=520;const xt=320,_t=1e3;let U=!1;function we(e){b&&(b.textContent=`
      /* 核心：缩小 html 宽度，让页面内容自然收缩 */
      html {
        width: calc(100% - ${e}px) !important;
        min-width: auto !important;
        overflow-x: hidden !important;
        position: relative !important;
      }

      /* 确保 body 跟随 html 宽度 */
      body {
        width: 100% !important;
        min-width: auto !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
        position: relative !important;
      }

      /* 确保聊天容器不受影响，固定在视口右侧 */
      #ai-chat-container {
        position: fixed !important;
        right: 0 !important;
        top: 0 !important;
        width: ${e}px !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box !important;
      }
    `)}function fe(){U=!1;const e=document.getElementById("ai-chat-resize-overlay");e&&e.remove(),p&&(p.style.background="transparent")}function Ot(){if(!p)return;let e=0,t=0;const s=o=>{o.preventDefault(),o.stopPropagation(),fe(),U=!0,e=o.clientX,t=x;const c=document.createElement("div");c.id="ai-chat-resize-overlay",c.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2147483646;
      cursor: ew-resize;
      background: transparent;
    `,document.body.appendChild(c),p&&(p.style.background="rgba(102, 126, 234, 0.5)"),document.addEventListener("mousemove",n),document.addEventListener("mouseup",r),document.addEventListener("mouseleave",r)},n=o=>{if(!U)return;const c=e-o.clientX;let a=t+c;a=Math.max(xt,Math.min(_t,a)),x=a,f&&(f.style.width=`${a}px`),we(a)},r=()=>{U&&(chrome.storage.local.set({chatWidth:x}),fe(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r),document.removeEventListener("mouseleave",r))};p.addEventListener("mousedown",s)}function X(){return{url:window.location.href,title:document.title}}async function At(e){const t=X();if(!e)return(await chrome.runtime.sendMessage({type:"CREATE_SESSION",payload:{title:t.title||"新对话",pageUrl:t.url,pageTitle:t.title}})).data.id;const s=await chrome.runtime.sendMessage({type:"GET_SESSION_BY_TAB",payload:{tabId:e}});return s.success&&s.data?(await chrome.runtime.sendMessage({type:"UPDATE_SESSION",payload:{sessionId:s.data.id,updates:{pageUrl:t.url,pageTitle:t.title}}}),s.data.id):(await chrome.runtime.sendMessage({type:"CREATE_SESSION",payload:{title:t.title||"新对话",tabId:e,pageUrl:t.url,pageTitle:t.title}})).data.id}function D(e){const t=X(),s=chrome.runtime.getURL(`chat.html?sessionId=${e}&pageUrl=${encodeURIComponent(t.url)}&pageTitle=${encodeURIComponent(t.title)}`);if(d){d.src=s,setTimeout(()=>{d!=null&&d.contentWindow&&d.contentWindow.postMessage({type:"PAGE_INFO",url:t.url,title:t.title},"*")},500);return}f=document.createElement("div"),f.id="ai-chat-container",f.style.cssText=`
    position: fixed;
    width: ${x}px;
    height: 100vh;
    right: 0;
    top: 0;
    z-index: 2147483647;
    background: white;
    border-left: 1px solid #e5e7eb;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  `,p=document.createElement("div"),p.id="ai-chat-resize-handle",p.style.cssText=`
    position: absolute;
    left: 0;
    top: 0;
    width: 6px;
    height: 100%;
    cursor: ew-resize;
    background: transparent;
    z-index: 2147483648;
    transition: background 0.2s;
  `,p.addEventListener("mouseenter",()=>{p&&(p.style.background="rgba(102, 126, 234, 0.3)")}),p.addEventListener("mouseleave",()=>{p&&!U&&(p.style.background="transparent")}),d=document.createElement("iframe"),d.src=s,d.style.cssText=`
    width: 100%;
    height: 100%;
    border: none;
  `,f.appendChild(p),f.appendChild(d),document.body.appendChild(f),Ot(),b=document.createElement("style"),b.id="ai-chat-layout-style",we(x),document.head.appendChild(b);const n=new ResizeObserver(()=>{f&&(f.style.height=`${window.innerHeight}px`)});n.observe(document.documentElement),f.__resizeObserver=n,window.addEventListener("message",kt),h&&chrome.storage.local.set({chatPinned:!0,chatSessionId:e})}let pe=window.location.href;const Lt=new MutationObserver(()=>{if(window.location.href!==pe&&(pe=window.location.href,d!=null&&d.contentWindow)){const e=X();d.contentWindow.postMessage({type:"PAGE_INFO",url:e.url,title:e.title},"*")}});Lt.observe(document.body,{childList:!0,subtree:!0});function kt(e){e.source===(d==null?void 0:d.contentWindow)&&(console.log("Received message from chat:",e.data),e.data.type==="CLOSE_CHAT"?ye():e.data.type==="PIN_CHAT"&&(console.log("Handling PIN_CHAT"),Ut()))}function Ut(){h=!h,console.log("togglePin called, new isPinned:",h),h?(chrome.storage.local.set({chatPinned:!0,chatSessionId:k},()=>{console.log("Saved pin state to storage")}),d!=null&&d.contentWindow&&(d.contentWindow.postMessage({type:"PIN_STATUS_CHANGED",isPinned:!0},"*"),console.log("Sent PIN_STATUS_CHANGED: true to chat"))):(chrome.storage.local.remove(["chatPinned","chatSessionId"],()=>{console.log("Removed pin state from storage")}),d!=null&&d.contentWindow&&(d.contentWindow.postMessage({type:"PIN_STATUS_CHANGED",isPinned:!1},"*"),console.log("Sent PIN_STATUS_CHANGED: false to chat")))}function ye(){if(f){const e=f.__resizeObserver;e&&e.disconnect(),f.remove(),f=null,d=null,p=null,b&&(b.remove(),b=null);const t=document.getElementById("ai-chat-resize-overlay");t&&t.remove(),h||chrome.storage.local.remove(["chatPinned","chatSessionId"])}}chrome.storage.local.get(["chatPinned","chatSessionId","chatWidth"],e=>{e.chatWidth&&(x=e.chatWidth),e.chatPinned&&e.chatSessionId&&(h=!0,k=e.chatSessionId,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{D(e.chatSessionId)}):D(e.chatSessionId))});chrome.runtime.onMessage.addListener((e,t,s)=>{var n,r,o;if(e.type==="OPEN_CHAT")if(e.sessionId)k=e.sessionId,f?d.src=chrome.runtime.getURL(`chat.html?sessionId=${e.sessionId}`):D(e.sessionId),s({success:!0});else{const c=e.tabId;return At(c).then(a=>{k=a,f?d.src=chrome.runtime.getURL(`chat.html?sessionId=${a}`):D(a),s({success:!0,sessionId:a})}).catch(a=>{console.error("Failed to get/create session:",a),s({success:!1,error:a.message})}),!0}else if(e.type==="CLOSE_CHAT")ye(),s({success:!0});else if(e.type==="CHECK_CHAT_STATUS")s({isOpen:!!f,isPinned:h,sessionId:k});else if(e.type==="GET_PAGE_CONTEXT"){const c=((n=e.payload)==null?void 0:n.userMessage)||"";console.log("[Content] GET_PAGE_CONTEXT 被调用，userMessage:",c);const a=Me(c);console.log("[Content] 返回的 context 元素数量:",(r=a.elements)==null?void 0:r.length),s({success:!0,data:a})}else if(e.type==="REQUEST_MORE_ELEMENTS"){const c=e.payload||{},a=$e(c);s({success:!0,data:a})}else if(e.type==="EXECUTE_PAGE_ACTION"){const c=e.payload;return console.log("[Content] EXECUTE_PAGE_ACTION 被调用:",JSON.stringify(c,null,2)),Ee(c).then(a=>{console.log("[Content] EXECUTE_PAGE_ACTION 结果:",a),s({success:a.success,data:a})}),!0}else if(e.type==="EXECUTE_BATCH_ACTIONS"){const c=e.payload;return console.log("[Content] EXECUTE_BATCH_ACTIONS 被调用，actions 数量:",c.length),It(c).then(a=>{console.log("[Content] EXECUTE_BATCH_ACTIONS 结果:",a),s({success:a.success,data:a})}),!0}else if(e.type==="CLEAR_AI_STYLES")St(),s({success:!0});else if(e.type==="GET_SELECTED_TEXT"){const c=((o=window.getSelection())==null?void 0:o.toString())||"";s({success:!0,data:c})}else{if(e.type==="CAPTURE_FULL_PAGE")return Mt(e.payload).then(c=>{s(c)}),!0;if(e.type==="COPY_IMAGE_TO_CLIPBOARD")return $t(e.payload.dataUrl).then(c=>{s(c)}),!0}return!0});async function Mt(e){try{const t=e.format||"png",s=e.quality||90,n=window.scrollY,r=window.scrollX,o=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),c=Math.max(document.body.scrollWidth,document.body.offsetWidth,document.documentElement.clientWidth,document.documentElement.scrollWidth,document.documentElement.offsetWidth),a=window.innerHeight,u=window.innerWidth;if(o<=a&&c<=u)return{success:!0,data:await ge(t,s)};const i=Math.ceil(o/a),g=Math.ceil(c/u),m=document.createElement("canvas"),w=m.getContext("2d");if(!w)return{success:!1,error:"无法创建 Canvas 上下文"};m.width=Math.min(c,16384),m.height=Math.min(o,16384);for(let y=0;y<i;y++)for(let N=0;N<g;N++){const C=N*u,I=y*a;window.scrollTo(C,I),await new Promise(S=>setTimeout(S,200));const $=await ge(t,s);await new Promise((S,R)=>{const T=new Image;T.onload=()=>{const _=C,O=I,A=Math.min(u,c-C,m.width-_),L=Math.min(a,o-I,m.height-O);w.drawImage(T,0,0,A,L,_,O,A,L),S()},T.onerror=R,T.src=$})}window.scrollTo(r,n);const v=t==="jpeg"?"image/jpeg":"image/png";return{success:!0,data:m.toDataURL(v,s/100)}}catch(t){return console.error("全页截图失败:",t),{success:!1,error:String(t)}}}function ge(e,t){return new Promise((s,n)=>{chrome.runtime.sendMessage({type:"CAPTURE_VISIBLE_TAB",payload:{format:e,quality:t}},r=>{r!=null&&r.success&&r.data?s(r.data):n(new Error((r==null?void 0:r.error)||"截图失败"))})})}async function $t(e){try{const s=await(await fetch(e)).blob();return await navigator.clipboard.write([new ClipboardItem({[s.type]:s})]),{success:!0}}catch(t){return console.error("复制到剪贴板失败:",t),{success:!1,error:String(t)}}}

})()