(function(){
'use strict';
const N=new Map,ve={priorities:{form:10,button:8,link:3,text:1,tab:7,menu:6,list:4},viewport:{visible:5,nearViewport:2,hidden:0},maxElements:30};function Ce(){return`e_${Date.now()}_${Math.random().toString(36).substr(2,6)}`}function Ne(e){return e.top>=0&&e.left>=0&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth}function xe(e){return e.top>=-200&&e.left>=-200&&e.bottom<=window.innerHeight+200&&e.right<=window.innerWidth+200}function Ie(e){const t=window.getComputedStyle(e);if(t.display==="none"||t.visibility==="hidden"||t.opacity==="0")return!1;const n=e.getBoundingClientRect();return!(n.width===0||n.height===0)}function Se(e){var n,s;if(e.id){const r=document.querySelector(`label[for="${e.id}"]`);if(r)return(n=r.textContent)==null?void 0:n.trim()}const t=e.closest("label");if(t){const r=t.cloneNode(!0);return r.querySelectorAll("input, select, textarea").forEach(o=>o.remove()),(s=r.textContent)==null?void 0:s.trim()}}function Ae(e){var c,o,a,l;const t=e.closest("fieldset");if(t){const i=t.querySelector("legend");if(i)return(c=i.textContent)==null?void 0:c.trim()}const n=e.closest('section, article, aside, [role="region"]');if(n){const i=n.querySelector("h1, h2, h3, h4, h5, h6");if(i)return(o=i.textContent)==null?void 0:o.trim()}const s=e.parentElement;if(s){const i=Array.from(s.children),h=i.indexOf(e);for(let u=h-1;u>=0;u--){const g=i[u];if(/^H[1-6]$/i.test(g.tagName))return(a=g.textContent)==null?void 0:a.trim()}}let r=e;for(;r&&r!==document.body;){const i=r.getAttribute("aria-label");if(i)return i;const h=r.getAttribute("title");if(h)return h;const u=r.className||"";if(u.includes("header")||u.includes("title")||u.includes("heading")){const g=(l=r.textContent)==null?void 0:l.trim();if(g&&g.length<100)return g}r=r.parentElement}}function _e(e){var c,o;const t=e.closest("form");if(!t)return;const n=t.querySelector("h1, h2, h3, h4, h5, h6");if(n)return(c=n.textContent)==null?void 0:c.trim();let s=t.previousElementSibling;for(;s;){if(/^H[1-6]$/i.test(s.tagName))return(o=s.textContent)==null?void 0:o.trim();s=s.previousElementSibling}const r=t.getAttribute("aria-label");if(r)return r}function Oe(e){var c,o;const t=e.parentElement;if(!t||Array.from(t.children).filter(a=>{var l;return a!==e&&((l=a.textContent)==null?void 0:l.trim())}).length===0)return;const s=Array.from(t.children).indexOf(e),r=[];for(let a=s-1;a>=Math.max(0,s-2);a--){const i=(c=t.children[a].textContent)==null?void 0:c.trim();i&&i.length<50&&r.unshift(i)}for(let a=s+1;a<Math.min(t.children.length,s+3);a++){const i=(o=t.children[a].textContent)==null?void 0:o.trim();i&&i.length<50&&r.push(i)}return r.length>0?r:void 0}function Le(e){var s,r,c,o,a,l,i,h;const t=[];let n=e.parentElement;for(;n&&n!==document.body;){let u;const g=n.tagName.toLowerCase();if(g==="form"){const f=((r=(s=n.querySelector("h1, h2, h3, h4, h5, h6"))==null?void 0:s.textContent)==null?void 0:r.trim())||n.getAttribute("aria-label")||n.getAttribute("name")||n.id;u=f?`表单:${f}`:"表单"}else if(g==="fieldset"){const f=(o=(c=n.querySelector("legend"))==null?void 0:c.textContent)==null?void 0:o.trim();u=f?`区域:${f}`:"区域"}else if(g==="section"||n.getAttribute("role")==="region"){const f=(l=(a=n.querySelector("h1, h2, h3, h4, h5, h6"))==null?void 0:a.textContent)==null?void 0:l.trim();u=f?`分组:${f}`:"分组"}else if(g==="tr"){const f=n.querySelector("td, th");if(f){const E=(i=f.textContent)==null?void 0:i.trim();E&&E.length<30&&(u=`行:${E}`)}}else if(g==="td"||g==="th"){const f=n.closest("table");if(f){const E=n.closest("tr"),w=Array.from((E==null?void 0:E.children)||[]).indexOf(n),y=f.querySelector("thead tr")||f.querySelector("tr");if(y){const T=y.querySelectorAll("th");T[w]&&(u=`列:${(h=T[w].textContent)==null?void 0:h.trim()}`)}}}if(u&&!t.includes(u)&&t.unshift(u),t.length>=3)break;n=n.parentElement}return t.length>0?t:void 0}function $e(e){var r,c;const t=e.parentElement;if(!t)return;if(t.tagName==="TD"||t.tagName==="TH"){const o=t.closest("tr");if(o){const a=o.querySelector("td, th");if(a&&a!==t){const l=(r=a.textContent)==null?void 0:r.trim();if(l&&l.length<30)return l}}}const n=Array.from(t.children),s=n.indexOf(e);for(let o=s-1;o>=0;o--){const a=n[o],l=(c=a.textContent)==null?void 0:c.trim();if(l&&l.length<30&&!a.querySelector("input, select, textarea"))return l}}function ke(e){var t;if(e.tagName==="BUTTON"||e.tagName==="A")return(t=e.textContent)==null?void 0:t.trim();if(e.tagName==="INPUT"){const n=e;if(n.type==="submit"||n.type==="button")return n.value}}function Me(e){if(!Ie(e))return null;const t=e.getBoundingClientRect(),n=Ce();N.set(n,e);const s={id:n,tag:e.tagName.toLowerCase(),rect:{x:t.x,y:t.y,width:t.width,height:t.height},visible:Ne(t),disabled:e.disabled||e.getAttribute("aria-disabled")==="true"};if(e.tagName==="INPUT"){const i=e;s.type=i.type,s.name=i.name||void 0,s.placeholder=i.placeholder||void 0,i.type!=="password"&&(s.value=i.value||void 0)}if(e.tagName==="TEXTAREA"){const i=e;s.name=i.name||void 0,s.placeholder=i.placeholder||void 0,s.value=i.value||void 0}if(e.tagName==="SELECT"){const i=e;s.name=i.name||void 0,s.value=i.value||void 0}s.text=ke(e),s.label=Se(e),s.ariaLabel=e.getAttribute("aria-label")||void 0;const r=Ae(e),c=_e(e),o=Oe(e),a=Le(e),l=$e(e);return(r||c||o||a||l)&&(s.context={sectionTitle:r,formTitle:c,nearElements:o,parentChain:a,rowLabel:l}),s}function pe(){N.clear(),console.log("[ElementCollector] 开始采集元素，已清空 elementMap");const e=[],t=['input:not([type="hidden"])',"textarea","select","button","a[href]",'[role="button"]','[role="link"]','[role="checkbox"]','[role="radio"]','[role="switch"]','[role="tab"]','[role="tabpanel"]','[role="listitem"]','[role="option"]','[role="menuitem"]','[role="treeitem"]','[role="gridcell"]','[role="cell"]','[class*="tab"]','[class*="Tab"]',"[data-tab]",'[data-role="tab"]',".nav-tabs > li",".tab-list > *",".tab-item",'[role="presentation"]',"li[onclick]","li[data-clickable]","li.clickable",'li[role="button"]','li[role="tab"]','li[role="menuitem"]',"ul[data-list] > li","ol[data-list] > li",".list-group-item",".menu-item",".dropdown-item",'[contenteditable="true"]',"[onclick]",'[tabindex]:not([tabindex="-1"])','input[type="date"]','input[type="datetime-local"]','input[type="time"]','input[type="month"]','input[type="week"]','input[type="file"]','input[type="color"]','input[type="range"]',"details","summary","label[for]"];return document.querySelectorAll(t.join(", ")).forEach(s=>{const r=Me(s);r&&e.push(r)}),console.log(`[ElementCollector] 采集完成，共 ${e.length} 个元素，elementMap 大小: ${N.size}`),e}function d(e){const t=N.get(e);return console.log(`[ElementCollector] getElementById("${e}"):`,t?`找到 <${t.tagName.toLowerCase()}>`:"未找到"),t||console.log("[ElementCollector] 当前 elementMap 中的所有 ID:",Array.from(N.keys())),t||null}function Ue(e){const t=["帮我","请","把","将","给","在","到","的","和","然后","并且","接着"];let n=e;return t.forEach(r=>{n=n.replace(new RegExp(r,"g")," ")}),n.split(/[\s,，。.!！?？、]+/).filter(r=>r.length>0)}function Re(e,t,n){let s=0;const r=[e.text,e.placeholder,e.label,e.ariaLabel,e.name].filter(Boolean).join(" ");for(const o of t)r.toLowerCase().includes(o.toLowerCase())&&(s+=10);e.tag==="input"||e.tag==="textarea"?s+=n.priorities.form:e.tag==="button"||e.tag==="input"&&(e.type==="submit"||e.type==="button")?s+=n.priorities.button:e.tag==="select"?s+=n.priorities.form:e.tag==="a"?s+=n.priorities.link:(e.tag==="li"||e.tag==="details"||e.tag==="summary")&&(s+=n.priorities.list);const c=N.get(e.id);return c&&q(e,c)&&(s+=n.priorities.tab),e.visible?s+=n.viewport.visible:xe(new DOMRect(e.rect.x,e.rect.y,e.rect.width,e.rect.height))&&(s+=n.viewport.nearViewport),e.disabled&&(s-=5),s}function De(e,t,n=ve){const s=Ue(t);return e.map(c=>({element:c,score:Re(c,s,n)})).sort((c,o)=>o.score-c.score).slice(0,n.maxElements).map(c=>c.element)}function q(e,t){if(t.getAttribute("role")==="tab")return!0;const n=t.className||"";if(n.includes("tab")||n.includes("Tab")||t.hasAttribute("data-tab")||t.getAttribute("data-role")==="tab")return!0;const s=t.parentElement;return!!(s&&(s.className.includes("nav-tabs")||s.className.includes("tab-list")))}function Pe(e,t){var l;const n=[];let r={input:"输入框",textarea:"文本框",button:"按钮",a:"链接",select:"下拉框",li:"列表项",details:"详情展开",summary:"摘要标题"}[e.tag]||e.tag;if(t&&q(e,t)&&(r="Tab页签"),t){const i=t.getAttribute("role");if(i){const h={tab:"Tab页签",tabpanel:"Tab面板",switch:"开关按钮",menuitem:"菜单项",option:"下拉选项",listitem:"列表项",treeitem:"树节点",gridcell:"表格单元",radio:"单选按钮",checkbox:"复选框",button:"按钮",link:"链接"};h[i]&&(r=h[i])}}if(e.tag==="input"&&e.type){const i={password:"密码框",submit:"提交按钮",button:"按钮",checkbox:"复选框",radio:"单选框",search:"搜索框",email:"邮箱输入框",tel:"电话输入框",number:"数字输入框",url:"URL输入框",date:"日期选择器","datetime-local":"日期时间选择器",time:"时间选择器",month:"月份选择器",week:"周选择器",file:"文件上传",color:"颜色选择器",range:"滑块",hidden:"隐藏字段"};i[e.type]&&(r=i[e.type])}n.push(r);let c=e.label||e.text||e.placeholder||e.ariaLabel||e.name;if(!c&&t&&(c=t.getAttribute("title")||void 0),!c&&t&&r==="Tab页签"){const i=(l=t.textContent)==null?void 0:l.trim();i&&i.length<50&&(c=i)}c&&n.push(c);const o=[];e.placeholder&&e.placeholder!==c&&o.push(`placeholder:${e.placeholder}`),e.type&&!["text","submit","button"].includes(e.type)&&o.push(`type:${e.type}`),e.disabled&&o.push("禁用"),r==="Tab页签"&&t&&(t.classList.contains("active")||t.getAttribute("aria-selected")==="true")&&o.push("当前激活"),(e.type==="radio"||e.type==="checkbox")&&t&&t.checked&&o.push("已选中");let a=n.join(":");return o.length>0&&(a+=`(${o.join(",")})`),a}function be(e){return e.map(t=>{const n=N.get(t.id),s={id:t.id,desc:Pe(t,n)};if(t.context){const r={};t.context.sectionTitle?r.section=t.context.sectionTitle:t.context.formTitle&&(r.section=t.context.formTitle),t.context.nearElements&&t.context.nearElements.length>0&&(r.nearby=t.context.nearElements.slice(0,2).join(", ")),t.context.rowLabel&&(r.nearby=r.nearby?`${t.context.rowLabel} | ${r.nearby}`:t.context.rowLabel),t.context.parentChain&&t.context.parentChain.length>0&&(r.path=t.context.parentChain.join(" > ")),Object.keys(r).length>0&&(s.ctx=r)}return s})}function qe(e=""){var r;const t=pe(),n=De(t,e),s=be(n);return{url:window.location.href,title:document.title,elements:s,selectedText:((r=window.getSelection())==null?void 0:r.toString())||void 0}}function He(e){let t=pe();if(e.region&&(t=t.filter(n=>{const s=n.rect;switch(e.region){case"header":return s.y<150;case"footer":return s.y>window.innerHeight-200;case"sidebar":return s.x<250||s.x>window.innerWidth-250;case"below_viewport":return s.y>window.innerHeight;case"form":const r=document.querySelectorAll("form");return Array.from(r).some(l=>{const i=l.getBoundingClientRect();return s.x>=i.left&&s.x<=i.right&&s.y>=i.top&&s.y<=i.bottom});case"tab_panel":const c=document.querySelectorAll('[role="tabpanel"], .tab-content, .tab-pane');return Array.from(c).some(l=>{const i=l.getBoundingClientRect();return s.x>=i.left&&s.x<=i.right&&s.y>=i.top&&s.y<=i.bottom});case"modal":const o=document.querySelectorAll('[role="dialog"], .modal, .dialog, [class*="modal"], [class*="dialog"]');return Array.from(o).some(l=>{const i=l.getBoundingClientRect();return s.x>=i.left&&s.x<=i.right&&s.y>=i.top&&s.y<=i.bottom});case"menu":const a=document.querySelectorAll('[role="menu"], [role="menubar"], .menu, .dropdown-menu, .context-menu');return Array.from(a).some(l=>{const i=l.getBoundingClientRect();return s.x>=i.left&&s.x<=i.right&&s.y>=i.top&&s.y<=i.bottom});default:return!0}})),e.elementType&&e.elementType!=="all"&&(t=t.filter(n=>{const s=N.get(n.id);switch(e.elementType){case"input":return n.tag==="input"||n.tag==="textarea";case"button":return n.tag==="button"||n.tag==="input"&&(n.type==="submit"||n.type==="button");case"link":return n.tag==="a";case"select":return n.tag==="select";case"tab":return s?q(n,s):!1;case"menu":return s?s.getAttribute("role")==="menuitem"||s.classList.contains("menu-item")||s.classList.contains("dropdown-item"):!1;case"list":return n.tag==="li"||(s==null?void 0:s.getAttribute("role"))==="listitem"||(s==null?void 0:s.classList.contains("list-group-item"));case"radio":return n.type==="radio"||(s==null?void 0:s.getAttribute("role"))==="radio";case"checkbox":return n.type==="checkbox"||(s==null?void 0:s.getAttribute("role"))==="checkbox";default:return!0}})),e.keyword){const n=e.keyword.toLowerCase();t=t.filter(s=>[s.text,s.placeholder,s.label,s.ariaLabel,s.name].filter(Boolean).join(" ").toLowerCase().includes(n))}return be(t)}function U(e){return new Promise(t=>setTimeout(t,e))}function ce(e,t){e.focus(),e.value="",e.dispatchEvent(new Event("focus",{bubbles:!0})),e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))}function ae(e){e.focus(),e.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))}async function Xe(e,t){if(console.log("[ActionExecutor] fillInput 调用:",{target:e,value:t}),!t)return{success:!1,message:"未提供填充值",error:"NO_VALUE"};const n=e.elementId?d(e.elementId):null;if(console.log("[ActionExecutor] 通过 elementId 查找结果:",n?`<${n.tagName}>`:"null"),!n){if(e.selector){const s=document.querySelector(e.selector);if(s&&(s.tagName==="INPUT"||s.tagName==="TEXTAREA"))return ce(s,t),{success:!0,message:`已填充: ${t}`}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return n.tagName!=="INPUT"&&n.tagName!=="TEXTAREA"?n.getAttribute("contenteditable")==="true"?(n.focus(),n.textContent=t,n.dispatchEvent(new Event("input",{bubbles:!0})),{success:!0,message:`已填充: ${t}`}):{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"}:(ce(n,t),{success:!0,message:`已填充: ${t}`})}async function Be(e){var n;const t=e.elementId?d(e.elementId):null;if(!t){if(e.selector){const s=document.querySelector(e.selector);if(s)return ae(s),{success:!0,message:"已点击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return ae(t),{success:!0,message:`已点击: ${e.description||((n=t.textContent)==null?void 0:n.trim())||"元素"}`}}async function Fe(e,t){const n=t||"#ffeb3b",s=window.getSelection();if(s&&s.rangeCount>0&&!s.isCollapsed){const c=s.getRangeAt(0),o=document.createElement("span");o.className="ai-highlight",o.style.backgroundColor=n,o.style.padding="2px 0",o.style.borderRadius="2px";try{return c.surroundContents(o),s.removeAllRanges(),{success:!0,message:"已高亮选中文字"}}catch{return{success:!1,message:"无法高亮跨元素的选中内容",error:"CROSS_ELEMENT"}}}const r=e.elementId?d(e.elementId):null;return r?(r.style.backgroundColor=n,r.classList.add("ai-highlight"),{success:!0,message:"已高亮元素"}):{success:!1,message:"未找到要高亮的内容",error:"NO_TARGET"}}async function We(e){const t=window.getSelection();if(t&&t.rangeCount>0&&!t.isCollapsed){const s=t.getRangeAt(0),r=document.createElement("span");r.className="ai-underline",r.style.textDecoration="underline",r.style.textDecorationColor="#1a73e8",r.style.textDecorationThickness="2px";try{return s.surroundContents(r),t.removeAllRanges(),{success:!0,message:"已添加下划线"}}catch{return{success:!1,message:"无法为跨元素的选中内容添加下划线",error:"CROSS_ELEMENT"}}}const n=e.elementId?d(e.elementId):null;return n?(n.style.textDecoration="underline",n.style.textDecorationColor="#1a73e8",n.classList.add("ai-underline"),{success:!0,message:"已添加下划线"}):{success:!1,message:"未找到要添加下划线的内容",error:"NO_TARGET"}}async function ze(e,t){if(!t)return{success:!1,message:"未提供选择值",error:"NO_VALUE"};const n=e.elementId?d(e.elementId):null;if(!n||n.tagName!=="SELECT"){if(e.selector){const s=document.querySelector(e.selector);if(s&&s.tagName==="SELECT")return ie(s,t)}return{success:!1,message:"未找到下拉框元素",error:"ELEMENT_NOT_FOUND"}}return ie(n,t)}function ie(e,t){const n=Array.from(e.options).find(r=>r.value===t);if(n)return e.value=n.value,e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已选择: ${n.text}`};const s=Array.from(e.options).find(r=>r.text.toLowerCase().includes(t.toLowerCase()));return s?(e.value=s.value,e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已选择: ${s.text}`}):{success:!1,message:`未找到匹配的选项: ${t}`,error:"OPTION_NOT_FOUND"}}async function Ge(e){const t=e.elementId?d(e.elementId):null;if(!t){if(e.selector){const s=document.querySelector(e.selector);if(s&&s.type==="checkbox")return s.checked=!s.checked,s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:s.checked?"已勾选":"已取消勾选"}}return{success:!1,message:"未找到复选框元素",error:"ELEMENT_NOT_FOUND"}}if(t.tagName!=="INPUT"||t.type!=="checkbox")return{success:!1,message:"目标元素不是复选框",error:"INVALID_ELEMENT"};const n=t;return n.checked=!n.checked,n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:n.checked?"已勾选":"已取消勾选"}}async function Ye(e){const t=window.innerHeight*.8;switch(e){case"up":return window.scrollBy({top:-t,behavior:"smooth"}),{success:!0,message:"已向上滚动"};case"down":return window.scrollBy({top:t,behavior:"smooth"}),{success:!0,message:"已向下滚动"};case"top":return window.scrollTo({top:0,behavior:"smooth"}),{success:!0,message:"已滚动到顶部"};case"bottom":return window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}),{success:!0,message:"已滚动到底部"};default:return window.scrollBy({top:t,behavior:"smooth"}),{success:!0,message:"已向下滚动"}}}async function Ve(e){var s,r;const t=e.elementId?d(e.elementId):null;if(!t){if(e.selector){const o=document.querySelector(e.selector);if(o)return{success:!0,message:"已读取内容",data:((s=o.textContent)==null?void 0:s.trim())||""}}const c=window.getSelection();return c&&!c.isCollapsed?{success:!0,message:"已读取选中内容",data:c.toString()}:{success:!1,message:"未找到要读取的内容",error:"NO_TARGET"}}return{success:!0,message:"已读取内容",data:((r=t.textContent)==null?void 0:r.trim())||""}}async function je(e){var s;const t=e.elementId?d(e.elementId):null;if(!t){if(e.selector){const r=document.querySelector(e.selector);if(r){const c=new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window});return r.dispatchEvent(c),{success:!0,message:"已悬停在元素上"}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const n=new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window});return t.dispatchEvent(n),{success:!0,message:`已悬停在: ${e.description||((s=t.textContent)==null?void 0:s.trim())||"元素"}上`}}async function Ke(e,t,n){if(!t)return{success:!1,message:"未提供输入文本",error:"NO_TEXT"};const s=e.elementId?d(e.elementId):null;if(!s){if(e.selector){const r=document.querySelector(e.selector);if(r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"))return await le(r,t,n||50),{success:!0,message:`已输入: ${t}`}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return s.tagName!=="INPUT"&&s.tagName!=="TEXTAREA"?{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"}:(await le(s,t,n||50),{success:!0,message:`已输入: ${t}`})}async function le(e,t,n){e.focus(),e.value="",e.dispatchEvent(new Event("focus",{bubbles:!0}));for(let s=0;s<t.length;s++)e.value+=t[s],e.dispatchEvent(new Event("input",{bubbles:!0})),await new Promise(r=>setTimeout(r,n));e.dispatchEvent(new Event("change",{bubbles:!0}))}async function Je(e,t){if(!e)return{success:!1,message:"未提供按键",error:"NO_KEY"};const n=t?document.querySelector(t):document.activeElement;return n?(ue(n,e),{success:!0,message:`已在元素上按下: ${e}`}):(ue(document,e),{success:!0,message:`已发送按键: ${e}`})}function ue(e,t){const n=new KeyboardEvent("keydown",{key:t,bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(n);const s=new KeyboardEvent("keypress",{key:t,bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(s);const r=new KeyboardEvent("keyup",{key:t,bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(r)}async function Qe(e,t){const n=e.elementId?d(e.elementId):null;if(!n)return{success:!1,message:"未找到源元素",error:"SOURCE_NOT_FOUND"};let s=null,r,c;if(t!=null&&t.selector){if(s=document.querySelector(t.selector),!s)return{success:!1,message:"未找到目标元素",error:"DESTINATION_NOT_FOUND"};const u=s.getBoundingClientRect();r=u.left+u.width/2,c=u.top+u.height/2}else if((t==null?void 0:t.x)!==void 0&&(t==null?void 0:t.y)!==void 0)r=t.x,c=t.y;else return{success:!1,message:"未提供目标位置",error:"NO_DESTINATION"};const o=n.getBoundingClientRect(),a=o.left+o.width/2,l=o.top+o.height/2;n.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window,clientX:a,clientY:l})),await U(100);const i=10;for(let u=1;u<=i;u++){const g=a+(r-a)*(u/i),f=l+(c-l)*(u/i);n.dispatchEvent(new MouseEvent("mousemove",{bubbles:!0,cancelable:!0,view:window,clientX:g,clientY:f})),await U(50)}return(document.elementFromPoint(r,c)||document.body).dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window,clientX:r,clientY:c})),{success:!0,message:"拖拽完成"}}async function Ze(e,t,n){const s=t||1e3,r=Date.now();if(e!=null&&e.elementId||e!=null&&e.selector){for(e.elementId?`${e.elementId}`:e.selector;Date.now()-r<s;){const c=e.elementId?d(e.elementId):document.querySelector(e.selector);if(c)if(n==="visible"){const o=c.getBoundingClientRect();if(o.width>0&&o.height>0)return{success:!0,message:"元素已可见"}}else if(n==="hidden"){const o=c.getBoundingClientRect();if(o.width===0||o.height===0)return{success:!0,message:"元素已隐藏"}}else return{success:!0,message:"元素已出现"};await U(100)}return{success:!1,message:`等待超时: ${s}ms`,error:"TIMEOUT"}}else return await U(s),{success:!0,message:`等待了 ${s}ms`}}async function et(e){var n;const t=e.elementId?d(e.elementId):null;if(!t){if(e.selector){const s=document.querySelector(e.selector);if(s)return s.focus(),{success:!0,message:"已聚焦元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return t.focus(),{success:!0,message:`已聚焦: ${e.description||((n=t.textContent)==null?void 0:n.trim())||"元素"}`}}async function tt(e){var n;const t=e.elementId?d(e.elementId):null;if(!t){if(e.selector){const s=document.querySelector(e.selector);if(s)return s.blur(),{success:!0,message:"已失焦元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return t.blur(),{success:!0,message:`已失焦: ${e.description||((n=t.textContent)==null?void 0:n.trim())||"元素"}`}}async function nt(e){const t=e.elementId?d(e.elementId):null;if(!t){if(e.selector){const s=document.querySelector(e.selector);if(s&&(s.tagName==="INPUT"||s.tagName==="TEXTAREA"))return s.value="",s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:"已清空输入框"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}if(t.tagName!=="INPUT"&&t.tagName!=="TEXTAREA")return{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"};const n=t;return n.value="",n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:"已清空输入框"}}async function st(e,t){if(!t)return{success:!1,message:"未提供属性名",error:"NO_ATTRIBUTE"};const n=e.elementId?d(e.elementId):null;if(!n){if(e.selector){const r=document.querySelector(e.selector);if(r){const c=r.getAttribute(t);return{success:!0,message:`获取属性 ${t}`,data:c}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const s=n.getAttribute(t);return{success:!0,message:`获取属性 ${t}`,data:s}}async function rt(e,t){if(!t)return{success:!1,message:"未提供属性名",error:"NO_PROPERTY"};const n=e.elementId?d(e.elementId):null;if(!n){if(e.selector){const r=document.querySelector(e.selector);if(r){const c=r[t];return{success:!0,message:`获取属性值 ${t}`,data:c}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const s=n[t];return{success:!0,message:`获取属性值 ${t}`,data:s}}async function ot(e,t){switch(e){case"goto":return t?(window.location.href=t,{success:!0,message:`导航到: ${t}`}):{success:!1,message:"未提供URL",error:"NO_URL"};case"back":return window.history.back(),{success:!0,message:"返回上一页"};case"forward":return window.history.forward(),{success:!0,message:"前进到下一页"};case"reload":return window.location.reload(),{success:!0,message:"刷新页面"};default:return{success:!1,message:"未知的导航操作",error:"UNKNOWN_ACTION"}}}async function ct(e,t,n){var r;const s=e.elementId?d(e.elementId):null;if(!s){if(e.selector){const c=document.querySelector(e.selector);if(c)return c.scrollIntoView({behavior:t||"smooth",block:n||"center"}),{success:!0,message:"已滚动到元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return s.scrollIntoView({behavior:t||"smooth",block:n||"center"}),{success:!0,message:`已滚动到: ${e.description||((r=s.textContent)==null?void 0:r.trim())||"元素"}`}}async function at(e){var n;if(!e)return{success:!0,message:"已切换回主文档"};const t=document.querySelector(e);if(!t)return{success:!1,message:"未找到iframe",error:"IFRAME_NOT_FOUND"};try{return t.contentDocument||((n=t.contentWindow)==null?void 0:n.document)?{success:!0,message:`已切换到iframe: ${e}`,data:{frameUrl:t.src}}:{success:!1,message:"无法访问iframe内容（跨域限制）",error:"CROSS_ORIGIN"}}catch{return{success:!1,message:"无法访问iframe内容",error:"ACCESS_ERROR"}}}async function it(e,t){return{success:!0,message:`弹窗处理: ${e}`,data:{promptText:t}}}async function lt(e,t){try{return localStorage.setItem(e,t),{success:!0,message:`已设置 localStorage[${e}] = ${t}`}}catch(n){return{success:!1,message:"设置localStorage失败",error:String(n)}}}async function ut(e){try{const t=localStorage.getItem(e);return{success:!0,message:`获取 localStorage[${e}]`,data:t}}catch(t){return{success:!1,message:"获取localStorage失败",error:String(t)}}}async function dt(e){try{if(e){const t=[];for(let n=0;n<localStorage.length;n++){const s=localStorage.key(n);s&&s.startsWith(e)&&t.push(s)}return t.forEach(n=>localStorage.removeItem(n)),{success:!0,message:`已清除 ${t.length} 个localStorage项`}}else{const t=localStorage.length;return localStorage.clear(),{success:!0,message:`已清除所有 ${t} 个localStorage项`}}}catch(t){return{success:!1,message:"清除localStorage失败",error:String(t)}}}async function mt(e,t,n){try{let s=`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(n!=null&&n.expires){const r=new Date(Date.now()+n.expires*1e3);s+=`;expires=${r.toUTCString()}`}return n!=null&&n.path&&(s+=`;path=${n.path}`),n!=null&&n.domain&&(s+=`;domain=${n.domain}`),n!=null&&n.secure&&(s+=";secure"),document.cookie=s,{success:!0,message:`已设置 Cookie: ${e}`}}catch(s){return{success:!1,message:"设置Cookie失败",error:String(s)}}}async function ft(e){var t;try{if(e){const n=(t=document.cookie.split("; ").find(s=>s.startsWith(`${encodeURIComponent(e)}=`)))==null?void 0:t.split("=")[1];return{success:!0,message:`获取 Cookie: ${e}`,data:n?decodeURIComponent(n):null}}else return{success:!0,message:"获取所有Cookies",data:document.cookie}}catch(n){return{success:!1,message:"获取Cookie失败",error:String(n)}}}function de(e){const t=e.getBoundingClientRect(),n=t.left+t.width/2,s=t.top+t.height/2,r={bubbles:!0,cancelable:!0,view:window,clientX:n,clientY:s};e.focus(),e.dispatchEvent(new MouseEvent("mousedown",{...r,button:0,buttons:1})),e.dispatchEvent(new MouseEvent("mouseup",{...r,button:0,buttons:0})),e.dispatchEvent(new MouseEvent("click",{...r,button:0})),e.dispatchEvent(new MouseEvent("mousedown",{...r,button:0,buttons:1})),e.dispatchEvent(new MouseEvent("mouseup",{...r,button:0,buttons:0})),e.dispatchEvent(new MouseEvent("click",{...r,button:0})),e.dispatchEvent(new MouseEvent("dblclick",{...r,button:0}))}async function ht(e){var n;const t=e.elementId?d(e.elementId):null;if(!t){if(e.selector){const s=document.querySelector(e.selector);if(s)return de(s),{success:!0,message:"已双击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return de(t),{success:!0,message:`已双击: ${e.description||((n=t.textContent)==null?void 0:n.trim())||"元素"}`}}function me(e){const t=e.getBoundingClientRect(),n=t.left+t.width/2,s=t.top+t.height/2;e.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window,button:2,buttons:2,clientX:n,clientY:s})),e.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window,button:2,buttons:0,clientX:n,clientY:s})),e.dispatchEvent(new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,view:window,button:2,clientX:n,clientY:s}))}async function gt(e){var n;const t=e.elementId?d(e.elementId):null;if(!t){if(e.selector){const s=document.querySelector(e.selector);if(s)return me(s),{success:!0,message:"已右键点击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return me(t),{success:!0,message:`已右键点击: ${e.description||((n=t.textContent)==null?void 0:n.trim())||"元素"}`}}async function pt(e,t,n,s){const r=e.elementId?d(e.elementId):e.selector?document.querySelector(e.selector):null;if(!r)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const c=window.getSelection();if(!c)return{success:!1,message:"无法获取Selection对象",error:"NO_SELECTION"};c.removeAllRanges();const o=document.createRange();try{if(t){const l=bt(r,t);if(!l)return{success:!1,message:`未找到文本: ${t}`,error:"TEXT_NOT_FOUND"};const h=(l.textContent||"").indexOf(t);o.setStart(l,h),o.setEnd(l,h+t.length)}else if(n!==void 0&&s!==void 0){const l=r.firstChild;if(!l||l.nodeType!==Node.TEXT_NODE)return{success:!1,message:"元素没有文本节点",error:"NO_TEXT_NODE"};o.setStart(l,n),o.setEnd(l,s)}else o.selectNodeContents(r);c.addRange(o);const a=c.toString();return{success:!0,message:`已选中文本: ${a}`,data:a}}catch(a){return{success:!1,message:`选中文本失败: ${a}`,error:"SELECT_ERROR"}}}function bt(e,t){const n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);let s;for(;s=n.nextNode();)if(s.textContent&&s.textContent.includes(t))return s;return null}async function Et(e,t){var n;try{let s=t;if(!s){const r=window.getSelection();if(r&&!r.isCollapsed)s=r.toString();else if(e.elementId||e.selector){const c=e.elementId?d(e.elementId):document.querySelector(e.selector);c&&(s=((n=c.textContent)==null?void 0:n.trim())||"")}}return s?(await navigator.clipboard.writeText(s),{success:!0,message:`已复制到剪贴板: ${s.substring(0,50)}${s.length>50?"...":""}`}):{success:!1,message:"没有可复制的内容",error:"NO_CONTENT"}}catch(s){return{success:!1,message:`复制失败: ${s}`,error:"CLIPBOARD_ERROR"}}}async function wt(e){try{const t=await navigator.clipboard.readText();if(!t)return{success:!1,message:"剪贴板为空",error:"EMPTY_CLIPBOARD"};const n=e.elementId?d(e.elementId):e.selector?document.querySelector(e.selector):null;if(!n)return{success:!0,message:"已读取剪贴板内容",data:t};if(n.tagName==="INPUT"||n.tagName==="TEXTAREA"){const s=n;return s.focus(),s.value=t,s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已粘贴: ${t.substring(0,50)}${t.length>50?"...":""}`}}else if(n.getAttribute("contenteditable")==="true")return n.focus(),n.textContent=t,n.dispatchEvent(new Event("input",{bubbles:!0})),{success:!0,message:`已粘贴: ${t.substring(0,50)}${t.length>50?"...":""}`};return{success:!0,message:"已读取剪贴板内容",data:t}}catch(t){return{success:!1,message:`粘贴失败: ${t}`,error:"CLIPBOARD_ERROR"}}}async function yt(e,t){if(!t||t.length===0)return{success:!1,message:"未提供文件",error:"NO_FILES"};const n=e.elementId?d(e.elementId):e.selector?document.querySelector(e.selector):null;if(!n||n.tagName!=="INPUT"||n.type!=="file")return{success:!1,message:"目标元素不是文件输入框",error:"INVALID_ELEMENT"};const s=n;try{const r=new DataTransfer;for(const c of t){const o=atob(c.content),a=new Array(o.length);for(let u=0;u<o.length;u++)a[u]=o.charCodeAt(u);const l=new Uint8Array(a),i=new Blob([l],{type:c.type}),h=new File([i],c.name,{type:c.type});r.items.add(h)}return s.files=r.files,s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已上传 ${t.length} 个文件`}}catch(r){return{success:!1,message:`上传失败: ${r}`,error:"UPLOAD_ERROR"}}}async function Tt(e){if(!e)return{success:!1,message:"未提供脚本",error:"NO_SCRIPT"};try{return{success:!0,message:"脚本执行成功",data:new Function(e)()}}catch(t){return{success:!1,message:`脚本执行失败: ${t}`,error:"SCRIPT_ERROR"}}}async function vt(e,t,n,s){var a,l;if(!n)return{success:!1,message:"未提供列表项内容",error:"NO_CONTENT"};let r=null;if(t)r=document.querySelector(t);else if(e.elementId||e.selector){const i=e.elementId?d(e.elementId):document.querySelector(e.selector);i&&(r=i.closest("ul, ol"))}if(!r)return{success:!1,message:"未找到列表容器",error:"LIST_NOT_FOUND"};const c=document.createElement("li");c.textContent=n;const o=e.elementId?d(e.elementId):e.selector?document.querySelector(e.selector):null;switch(s){case"before":o&&o.tagName==="LI"?(a=o.parentNode)==null||a.insertBefore(c,o):r.insertBefore(c,r.firstChild);break;case"after":o&&o.tagName==="LI"?(l=o.parentNode)==null||l.insertBefore(c,o.nextSibling):r.appendChild(c);break;case"first":r.insertBefore(c,r.firstChild);break;case"last":default:r.appendChild(c);break}return r.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已添加列表项: ${n}`}}async function Ct(e,t){var c;let n=null;if(e.elementId||e.selector)n=e.elementId?d(e.elementId):document.querySelector(e.selector);else if(t!==void 0){const o=document.querySelectorAll("ul, ol");for(const a of o){const l=a.querySelectorAll(":scope > li");if(l[t]){n=l[t];break}}}if(!n||n.tagName!=="LI")return{success:!1,message:"未找到要删除的列表项",error:"ITEM_NOT_FOUND"};const s=((c=n.textContent)==null?void 0:c.trim())||"",r=n.parentNode;return n.remove(),r&&r.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已删除列表项: ${s}`}}async function Nt(e,t){var r;if(!t)return{success:!1,message:"未提供新内容",error:"NO_CONTENT"};const n=e.elementId?d(e.elementId):e.selector?document.querySelector(e.selector):null;if(!n||n.tagName!=="LI")return{success:!1,message:"未找到列表项元素",error:"ITEM_NOT_FOUND"};const s=((r=n.textContent)==null?void 0:r.trim())||"";return n.textContent=t,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已编辑列表项: "${s}" → "${t}"`}}async function xt(e,t){var r;if(t===void 0)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const n=e.elementId?d(e.elementId):e.selector?document.querySelector(e.selector):null;if(!n)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const s=((r=n.textContent)==null?void 0:r.trim())||"";return n.tagName==="INPUT"||n.tagName==="TEXTAREA"?n.value=t:(n.getAttribute("contenteditable"),n.textContent=t),n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已设置内容: "${s.substring(0,20)}..." → "${t.substring(0,20)}..."`}}async function It(e,t){if(!t)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const n=e.elementId?d(e.elementId):e.selector?document.querySelector(e.selector):null;if(!n)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};if(n.tagName==="INPUT"||n.tagName==="TEXTAREA"){const s=n;s.value+=t}else n.getAttribute("contenteditable")==="true"?n.textContent=(n.textContent||"")+t:n.appendChild(document.createTextNode(t));return n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已追加内容: "${t.substring(0,30)}${t.length>30?"...":""}"`}}async function St(e,t){if(!t)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const n=e.elementId?d(e.elementId):e.selector?document.querySelector(e.selector):null;if(!n)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};if(n.tagName==="INPUT"||n.tagName==="TEXTAREA"){const s=n;s.value=t+s.value}else n.getAttribute("contenteditable")==="true"?n.textContent=t+(n.textContent||""):n.insertBefore(document.createTextNode(t),n.firstChild);return n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已前置内容: "${t.substring(0,30)}${t.length>30?"...":""}"`}}async function At(e,t,n){if(!t)return{success:!1,message:"未提供HTML内容",error:"NO_HTML"};const s=e.elementId?d(e.elementId):e.selector?document.querySelector(e.selector):null;if(!s)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const r=n||"beforeend";return s.insertAdjacentHTML(r,t),s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已在${{beforebegin:"元素之前",afterbegin:"元素内部开头",beforeend:"元素内部末尾",afterend:"元素之后"}[r]}插入HTML`}}async function _t(e){try{if(e)return document.cookie=`${encodeURIComponent(e)}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`,{success:!0,message:`已清除 Cookie: ${e}`};{const t=document.cookie.split(";");return t.forEach(n=>{const[s]=n.split("="),r=s==null?void 0:s.trim();r&&(document.cookie=`${r}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`,document.cookie=`${r}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;domain=${window.location.hostname}`)}),{success:!0,message:`已清除 ${t.length} 个Cookies`}}}catch(t){return{success:!1,message:"清除Cookie失败",error:String(t)}}}async function Ee(e){var t,n,s,r,c,o,a,l,i,h,u,g,f,E,w,y,T,I,R,S,D,x,_,O,L,$,X,B,F,W,z,G,Y,V,j,K,J,Q,Z,ee,te,ne,se,re,oe;try{switch(e.action){case"fill":return await Xe(e.target,(t=e.params)==null?void 0:t.value);case"click":return await Be(e.target);case"highlight":return await Fe(e.target,(n=e.params)==null?void 0:n.color);case"underline":return await We(e.target);case"select":return await ze(e.target,(s=e.params)==null?void 0:s.value);case"check":return await Ge(e.target);case"scroll":return await Ye((r=e.params)==null?void 0:r.direction);case"read":return await Ve(e.target);case"hover":return await je(e.target);case"type":return await Ke(e.target,(c=e.params)==null?void 0:c.value,(o=e.params)==null?void 0:o.delay);case"press":return await Je((a=e.params)==null?void 0:a.key,(l=e.target)==null?void 0:l.selector);case"drag":return await Qe(e.target,(i=e.params)==null?void 0:i.destination);case"wait":return await Ze(e.target,(h=e.params)==null?void 0:h.timeout,(u=e.params)==null?void 0:u.condition);case"focus":return await et(e.target);case"blur":return await tt(e.target);case"clear":return await nt(e.target);case"getAttribute":return await st(e.target,(g=e.params)==null?void 0:g.attribute);case"getProperty":return await rt(e.target,(f=e.params)==null?void 0:f.property);case"navigate":return await ot((E=e.params)==null?void 0:E.navigateAction,(w=e.params)==null?void 0:w.url);case"scrollIntoView":return await ct(e.target,(y=e.params)==null?void 0:y.behavior,(T=e.params)==null?void 0:T.block);case"switchFrame":return await at((I=e.params)==null?void 0:I.frameSelector);case"handleDialog":return await it((R=e.params)==null?void 0:R.dialogAction,(S=e.params)==null?void 0:S.promptText);case"setLocalStorage":return await lt((D=e.params)==null?void 0:D.key,(x=e.params)==null?void 0:x.value);case"getLocalStorage":return await ut((_=e.params)==null?void 0:_.key);case"clearLocalStorage":return await dt((O=e.params)==null?void 0:O.prefix);case"setCookie":return await mt((L=e.params)==null?void 0:L.name,($=e.params)==null?void 0:$.value,(X=e.params)==null?void 0:X.cookieOptions);case"getCookie":return await ft((B=e.params)==null?void 0:B.name);case"clearCookies":return await _t((F=e.params)==null?void 0:F.name);case"doubleClick":return await ht(e.target);case"rightClick":return await gt(e.target);case"selectText":return await pt(e.target,(W=e.params)==null?void 0:W.searchText,(z=e.params)==null?void 0:z.startOffset,(G=e.params)==null?void 0:G.endOffset);case"copyToClipboard":return await Et(e.target,(Y=e.params)==null?void 0:Y.text);case"pasteFromClipboard":return await wt(e.target);case"upload":return await yt(e.target,(V=e.params)==null?void 0:V.files);case"evaluate":return await Tt((j=e.params)==null?void 0:j.script);case"addListItem":return await vt(e.target,(K=e.params)==null?void 0:K.listSelector,(J=e.params)==null?void 0:J.itemContent,(Q=e.params)==null?void 0:Q.position);case"removeListItem":return await Ct(e.target,(Z=e.params)==null?void 0:Z.itemIndex);case"editListItem":return await Nt(e.target,(ee=e.params)==null?void 0:ee.itemContent);case"setContent":return await xt(e.target,(te=e.params)==null?void 0:te.content);case"appendContent":return await It(e.target,(ne=e.params)==null?void 0:ne.content);case"prependContent":return await St(e.target,(se=e.params)==null?void 0:se.content);case"insertHTML":return await At(e.target,(re=e.params)==null?void 0:re.html,(oe=e.params)==null?void 0:oe.insertPosition);default:return{success:!1,message:`不支持的操作类型: ${e.action}`,error:"UNSUPPORTED_ACTION"}}}catch(Te){return{success:!1,message:`执行操作时出错: ${Te}`,error:"EXECUTION_ERROR"}}}async function Ot(e){const t=[];let n=0;for(const r of e){const c=await Ee(r);t.push(c),c.success&&n++,await U(100)}const s=`执行了 ${e.length} 个操作，成功 ${n} 个，失败 ${e.length-n} 个`;return{success:n===e.length,results:t,summary:s}}function Lt(){document.querySelectorAll(".ai-highlight").forEach(e=>{const t=e.parentNode;t&&(t.replaceChild(document.createTextNode(e.textContent||""),e),t.normalize())}),document.querySelectorAll(".ai-underline").forEach(e=>{const t=e.parentNode;t&&(t.replaceChild(document.createTextNode(e.textContent||""),e),t.normalize())})}let m=null,p=null,k=null,v=!1,C=null,b=null,A=520;const $t=320,kt=1e3;let M=!1;function we(e){C&&(C.textContent=`
      /* 核心：缩小 html 宽度，让页面内容自然收缩 */
      html {
        width: calc(100% - ${e}px) !important;
        min-width: auto !important;
        overflow-x: hidden !important;
        position: relative !important;
      }

      /* 确保 body 跟随 html 宽度 */
      body {
        width: 100% !important;
        min-width: auto !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
        position: relative !important;
      }

      /* 确保聊天容器不受影响，固定在视口右侧 */
      #ai-chat-container {
        position: fixed !important;
        right: 0 !important;
        top: 0 !important;
        width: ${e}px !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box !important;
      }
    `)}function fe(){M=!1;const e=document.getElementById("ai-chat-resize-overlay");e&&e.remove(),b&&(b.style.background="transparent")}function Mt(){if(!b)return;let e=0,t=0;const n=c=>{c.preventDefault(),c.stopPropagation(),fe(),M=!0,e=c.clientX,t=A;const o=document.createElement("div");o.id="ai-chat-resize-overlay",o.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2147483646;
      cursor: ew-resize;
      background: transparent;
    `,document.body.appendChild(o),b&&(b.style.background="rgba(102, 126, 234, 0.5)"),document.addEventListener("mousemove",s),document.addEventListener("mouseup",r),document.addEventListener("mouseleave",r)},s=c=>{if(!M)return;const o=e-c.clientX;let a=t+o;a=Math.max($t,Math.min(kt,a)),A=a,p&&(p.style.width=`${a}px`),we(a)},r=()=>{M&&(chrome.storage.local.set({chatWidth:A}),fe(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",r),document.removeEventListener("mouseleave",r))};b.addEventListener("mousedown",n)}function H(){return{url:window.location.href,title:document.title}}async function Ut(e){const t=H();if(!e)return(await chrome.runtime.sendMessage({type:"CREATE_SESSION",payload:{title:t.title||"新对话",pageUrl:t.url,pageTitle:t.title}})).data.id;const n=await chrome.runtime.sendMessage({type:"GET_SESSION_BY_TAB",payload:{tabId:e}});return n.success&&n.data?(await chrome.runtime.sendMessage({type:"UPDATE_SESSION",payload:{sessionId:n.data.id,updates:{pageUrl:t.url,pageTitle:t.title}}}),n.data.id):(await chrome.runtime.sendMessage({type:"CREATE_SESSION",payload:{title:t.title||"新对话",tabId:e,pageUrl:t.url,pageTitle:t.title}})).data.id}function P(e){const t=H(),n=chrome.runtime.getURL(`chat.html?sessionId=${e}&pageUrl=${encodeURIComponent(t.url)}&pageTitle=${encodeURIComponent(t.title)}`);if(m){m.src=n,setTimeout(()=>{m!=null&&m.contentWindow&&m.contentWindow.postMessage({type:"PAGE_INFO",url:t.url,title:t.title},"*")},500);return}p=document.createElement("div"),p.id="ai-chat-container",p.style.cssText=`
    position: fixed;
    width: ${A}px;
    height: 100vh;
    right: 0;
    top: 0;
    z-index: 2147483647;
    background: white;
    border-left: 1px solid #e5e7eb;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  `,b=document.createElement("div"),b.id="ai-chat-resize-handle",b.style.cssText=`
    position: absolute;
    left: 0;
    top: 0;
    width: 6px;
    height: 100%;
    cursor: ew-resize;
    background: transparent;
    z-index: 2147483648;
    transition: background 0.2s;
  `,b.addEventListener("mouseenter",()=>{b&&(b.style.background="rgba(102, 126, 234, 0.3)")}),b.addEventListener("mouseleave",()=>{b&&!M&&(b.style.background="transparent")}),m=document.createElement("iframe"),m.src=n,m.style.cssText=`
    width: 100%;
    height: 100%;
    border: none;
  `,p.appendChild(b),p.appendChild(m),document.body.appendChild(p),Mt(),C=document.createElement("style"),C.id="ai-chat-layout-style",we(A),document.head.appendChild(C);const s=new ResizeObserver(()=>{p&&(p.style.height=`${window.innerHeight}px`)});s.observe(document.documentElement),p.__resizeObserver=s,window.addEventListener("message",Dt),v&&chrome.storage.local.set({chatPinned:!0,chatSessionId:e})}let he=window.location.href;const Rt=new MutationObserver(()=>{if(window.location.href!==he&&(he=window.location.href,m!=null&&m.contentWindow)){const e=H();m.contentWindow.postMessage({type:"PAGE_INFO",url:e.url,title:e.title},"*")}});Rt.observe(document.body,{childList:!0,subtree:!0});function Dt(e){e.source===(m==null?void 0:m.contentWindow)&&(console.log("Received message from chat:",e.data),e.data.type==="CLOSE_CHAT"?ye():e.data.type==="PIN_CHAT"&&(console.log("Handling PIN_CHAT"),Pt()))}function Pt(){v=!v,console.log("togglePin called, new isPinned:",v),v?(chrome.storage.local.set({chatPinned:!0,chatSessionId:k},()=>{console.log("Saved pin state to storage")}),m!=null&&m.contentWindow&&(m.contentWindow.postMessage({type:"PIN_STATUS_CHANGED",isPinned:!0},"*"),console.log("Sent PIN_STATUS_CHANGED: true to chat"))):(chrome.storage.local.remove(["chatPinned","chatSessionId"],()=>{console.log("Removed pin state from storage")}),m!=null&&m.contentWindow&&(m.contentWindow.postMessage({type:"PIN_STATUS_CHANGED",isPinned:!1},"*"),console.log("Sent PIN_STATUS_CHANGED: false to chat")))}function ye(){if(p){const e=p.__resizeObserver;e&&e.disconnect(),p.remove(),p=null,m=null,b=null,C&&(C.remove(),C=null);const t=document.getElementById("ai-chat-resize-overlay");t&&t.remove(),v||chrome.storage.local.remove(["chatPinned","chatSessionId"])}}chrome.storage.local.get(["chatPinned","chatSessionId","chatWidth"],e=>{e.chatWidth&&(A=e.chatWidth),e.chatPinned&&e.chatSessionId&&(v=!0,k=e.chatSessionId,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{P(e.chatSessionId)}):P(e.chatSessionId))});chrome.runtime.onMessage.addListener((e,t,n)=>{var s,r,c;if(e.type==="OPEN_CHAT")if(e.sessionId)k=e.sessionId,p?m.src=chrome.runtime.getURL(`chat.html?sessionId=${e.sessionId}`):P(e.sessionId),n({success:!0});else{const o=e.tabId;return Ut(o).then(a=>{k=a,p?m.src=chrome.runtime.getURL(`chat.html?sessionId=${a}`):P(a),n({success:!0,sessionId:a})}).catch(a=>{console.error("Failed to get/create session:",a),n({success:!1,error:a.message})}),!0}else if(e.type==="CLOSE_CHAT")ye(),n({success:!0});else if(e.type==="CHECK_CHAT_STATUS")n({isOpen:!!p,isPinned:v,sessionId:k});else if(e.type==="GET_PAGE_CONTEXT"){const o=((s=e.payload)==null?void 0:s.userMessage)||"";console.log("[Content] GET_PAGE_CONTEXT 被调用，userMessage:",o);const a=qe(o);console.log("[Content] 返回的 context 元素数量:",(r=a.elements)==null?void 0:r.length),n({success:!0,data:a})}else if(e.type==="REQUEST_MORE_ELEMENTS"){const o=e.payload||{},a=He(o);n({success:!0,data:a})}else if(e.type==="EXECUTE_PAGE_ACTION"){const o=e.payload;return console.log("[Content] EXECUTE_PAGE_ACTION 被调用:",JSON.stringify(o,null,2)),Ee(o).then(a=>{console.log("[Content] EXECUTE_PAGE_ACTION 结果:",a),n({success:a.success,data:a})}),!0}else if(e.type==="EXECUTE_BATCH_ACTIONS"){const o=e.payload;return console.log("[Content] EXECUTE_BATCH_ACTIONS 被调用，actions 数量:",o.length),Ot(o).then(a=>{console.log("[Content] EXECUTE_BATCH_ACTIONS 结果:",a),n({success:a.success,data:a})}),!0}else if(e.type==="CLEAR_AI_STYLES")Lt(),n({success:!0});else if(e.type==="GET_SELECTED_TEXT"){const o=((c=window.getSelection())==null?void 0:c.toString())||"";n({success:!0,data:o})}else{if(e.type==="CAPTURE_FULL_PAGE")return qt(e.payload).then(o=>{n(o)}),!0;if(e.type==="COPY_IMAGE_TO_CLIPBOARD")return Ht(e.payload.dataUrl).then(o=>{n(o)}),!0}return!0});async function qt(e){try{const t=e.format||"png",n=e.quality||90,s=window.scrollY,r=window.scrollX,c=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),o=Math.max(document.body.scrollWidth,document.body.offsetWidth,document.documentElement.clientWidth,document.documentElement.scrollWidth,document.documentElement.offsetWidth),a=window.innerHeight,l=window.innerWidth;if(c<=a&&o<=l)return{success:!0,data:await ge(t,n)};const i=Math.ceil(c/a),h=Math.ceil(o/l),u=document.createElement("canvas"),g=u.getContext("2d");if(!g)return{success:!1,error:"无法创建 Canvas 上下文"};u.width=Math.min(o,16384),u.height=Math.min(c,16384);for(let w=0;w<i;w++)for(let y=0;y<h;y++){const T=y*l,I=w*a;window.scrollTo(T,I),await new Promise(S=>setTimeout(S,200));const R=await ge(t,n);await new Promise((S,D)=>{const x=new Image;x.onload=()=>{const _=T,O=I,L=Math.min(l,o-T,u.width-_),$=Math.min(a,c-I,u.height-O);g.drawImage(x,0,0,L,$,_,O,L,$),S()},x.onerror=D,x.src=R})}window.scrollTo(r,s);const f=t==="jpeg"?"image/jpeg":"image/png";return{success:!0,data:u.toDataURL(f,n/100)}}catch(t){return console.error("全页截图失败:",t),{success:!1,error:String(t)}}}function ge(e,t){return new Promise((n,s)=>{chrome.runtime.sendMessage({type:"CAPTURE_VISIBLE_TAB",payload:{format:e,quality:t}},r=>{r!=null&&r.success&&r.data?n(r.data):s(new Error((r==null?void 0:r.error)||"截图失败"))})})}async function Ht(e){try{const n=await(await fetch(e)).blob();return await navigator.clipboard.write([new ClipboardItem({[n.type]:n})]),{success:!0}}catch(t){return console.error("复制到剪贴板失败:",t),{success:!1,error:String(t)}}}

})()