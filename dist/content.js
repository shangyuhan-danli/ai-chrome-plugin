(function(){
'use strict';
const G=new Map,Be={priorities:{form:10,button:8,link:3,text:1,tab:7,menu:6,list:4},viewport:{visible:5,nearViewport:2,hidden:0},maxElements:30};function He(){return`e_${Date.now()}_${Math.random().toString(36).substr(2,6)}`}function qe(t){return t.top>=0&&t.left>=0&&t.bottom<=window.innerHeight&&t.right<=window.innerWidth}function Ge(t){return t.top>=-200&&t.left>=-200&&t.bottom<=window.innerHeight+200&&t.right<=window.innerWidth+200}function We(t){const n=window.getComputedStyle(t);if(n.display==="none"||n.visibility==="hidden"||n.opacity==="0")return!1;const e=t.getBoundingClientRect();return!(e.width===0||e.height===0)}function Xe(t){var e,r;if(t.id){const s=document.querySelector(`label[for="${t.id}"]`);if(s)return(e=s.textContent)==null?void 0:e.trim()}const n=t.closest("label");if(n){const s=n.cloneNode(!0);return s.querySelectorAll("input, select, textarea").forEach(a=>a.remove()),(r=s.textContent)==null?void 0:r.trim()}}function Fe(t){var i,a,o,l;const n=t.closest("fieldset");if(n){const c=n.querySelector("legend");if(c)return(i=c.textContent)==null?void 0:i.trim()}const e=t.closest('section, article, aside, [role="region"]');if(e){const c=e.querySelector("h1, h2, h3, h4, h5, h6");if(c)return(a=c.textContent)==null?void 0:a.trim()}const r=t.parentElement;if(r){const c=Array.from(r.children),m=c.indexOf(t);for(let u=m-1;u>=0;u--){const h=c[u];if(/^H[1-6]$/i.test(h.tagName))return(o=h.textContent)==null?void 0:o.trim()}}let s=t;for(;s&&s!==document.body;){const c=s.getAttribute("aria-label");if(c)return c;const m=s.getAttribute("title");if(m)return m;const u=s.className||"";if(u.includes("header")||u.includes("title")||u.includes("heading")){const h=(l=s.textContent)==null?void 0:l.trim();if(h&&h.length<100)return h}s=s.parentElement}}function Ve(t){var i,a;const n=t.closest("form");if(!n)return;const e=n.querySelector("h1, h2, h3, h4, h5, h6");if(e)return(i=e.textContent)==null?void 0:i.trim();let r=n.previousElementSibling;for(;r;){if(/^H[1-6]$/i.test(r.tagName))return(a=r.textContent)==null?void 0:a.trim();r=r.previousElementSibling}const s=n.getAttribute("aria-label");if(s)return s}function je(t){var i,a;const n=t.parentElement;if(!n||Array.from(n.children).filter(o=>{var l;return o!==t&&((l=o.textContent)==null?void 0:l.trim())}).length===0)return;const r=Array.from(n.children).indexOf(t),s=[];for(let o=r-1;o>=Math.max(0,r-2);o--){const c=(i=n.children[o].textContent)==null?void 0:i.trim();c&&c.length<50&&s.unshift(c)}for(let o=r+1;o<Math.min(n.children.length,r+3);o++){const c=(a=n.children[o].textContent)==null?void 0:a.trim();c&&c.length<50&&s.push(c)}return s.length>0?s:void 0}function Ye(t){var r,s,i,a,o,l,c,m;const n=[];let e=t.parentElement;for(;e&&e!==document.body;){let u;const h=e.tagName.toLowerCase();if(h==="form"){const d=((s=(r=e.querySelector("h1, h2, h3, h4, h5, h6"))==null?void 0:r.textContent)==null?void 0:s.trim())||e.getAttribute("aria-label")||e.getAttribute("name")||e.id;u=d?`表单:${d}`:"表单"}else if(h==="fieldset"){const d=(a=(i=e.querySelector("legend"))==null?void 0:i.textContent)==null?void 0:a.trim();u=d?`区域:${d}`:"区域"}else if(h==="section"||e.getAttribute("role")==="region"){const d=(l=(o=e.querySelector("h1, h2, h3, h4, h5, h6"))==null?void 0:o.textContent)==null?void 0:l.trim();u=d?`分组:${d}`:"分组"}else if(h==="tr"){const d=e.querySelector("td, th");if(d){const f=(c=d.textContent)==null?void 0:c.trim();f&&f.length<30&&(u=`行:${f}`)}}else if(h==="td"||h==="th"){const d=e.closest("table");if(d){const f=e.closest("tr"),y=Array.from((f==null?void 0:f.children)||[]).indexOf(e),v=d.querySelector("thead tr")||d.querySelector("tr");if(v){const _=v.querySelectorAll("th");_[y]&&(u=`列:${(m=_[y].textContent)==null?void 0:m.trim()}`)}}}if(u&&!n.includes(u)&&n.unshift(u),n.length>=3)break;e=e.parentElement}return n.length>0?n:void 0}function ze(t){var s,i;const n=t.parentElement;if(!n)return;if(n.tagName==="TD"||n.tagName==="TH"){const a=n.closest("tr");if(a){const o=a.querySelector("td, th");if(o&&o!==n){const l=(s=o.textContent)==null?void 0:s.trim();if(l&&l.length<30)return l}}}const e=Array.from(n.children),r=e.indexOf(t);for(let a=r-1;a>=0;a--){const o=e[a],l=(i=o.textContent)==null?void 0:i.trim();if(l&&l.length<30&&!o.querySelector("input, select, textarea"))return l}}function Ke(t){var n;if(t.tagName==="BUTTON"||t.tagName==="A")return(n=t.textContent)==null?void 0:n.trim();if(t.tagName==="INPUT"){const e=t;if(e.type==="submit"||e.type==="button")return e.value}}function Je(t){if(!We(t))return null;const n=t.getBoundingClientRect(),e=He();G.set(e,t);const r={id:e,tag:t.tagName.toLowerCase(),rect:{x:n.x,y:n.y,width:n.width,height:n.height},visible:qe(n),disabled:t.disabled||t.getAttribute("aria-disabled")==="true"};if(t.tagName==="INPUT"){const c=t;r.type=c.type,r.name=c.name||void 0,r.placeholder=c.placeholder||void 0,c.type!=="password"&&(r.value=c.value||void 0)}if(t.tagName==="TEXTAREA"){const c=t;r.name=c.name||void 0,r.placeholder=c.placeholder||void 0,r.value=c.value||void 0}if(t.tagName==="SELECT"){const c=t;r.name=c.name||void 0,r.value=c.value||void 0}r.text=Ke(t),r.label=Xe(t),r.ariaLabel=t.getAttribute("aria-label")||void 0;const s=Fe(t),i=Ve(t),a=je(t),o=Ye(t),l=ze(t);return(s||i||a||o||l)&&(r.context={sectionTitle:s,formTitle:i,nearElements:a,parentChain:o,rowLabel:l}),r}function Re(){G.clear(),console.log("[ElementCollector] 开始采集元素，已清空 elementMap");const t=[],n=['input:not([type="hidden"])',"textarea","select","button","a[href]",'[role="button"]','[role="link"]','[role="checkbox"]','[role="radio"]','[role="switch"]','[role="tab"]','[role="tabpanel"]','[role="listitem"]','[role="option"]','[role="menuitem"]','[role="treeitem"]','[role="gridcell"]','[role="cell"]','[class*="tab"]','[class*="Tab"]',"[data-tab]",'[data-role="tab"]',".nav-tabs > li",".tab-list > *",".tab-item",'[role="presentation"]',"li[onclick]","li[data-clickable]","li.clickable",'li[role="button"]','li[role="tab"]','li[role="menuitem"]',"ul[data-list] > li","ol[data-list] > li",".list-group-item",".menu-item",".dropdown-item",'[contenteditable="true"]',"[onclick]",'[tabindex]:not([tabindex="-1"])','input[type="date"]','input[type="datetime-local"]','input[type="time"]','input[type="month"]','input[type="week"]','input[type="file"]','input[type="color"]','input[type="range"]',"details","summary","label[for]"];return document.querySelectorAll(n.join(", ")).forEach(r=>{const s=Je(r);s&&t.push(s)}),console.log(`[ElementCollector] 采集完成，共 ${t.length} 个元素，elementMap 大小: ${G.size}`),t}function b(t){const n=G.get(t);return console.log(`[ElementCollector] getElementById("${t}"):`,n?`找到 <${n.tagName.toLowerCase()}>`:"未找到"),n||console.log("[ElementCollector] 当前 elementMap 中的所有 ID:",Array.from(G.keys())),n||null}function Qe(t){const n=["帮我","请","把","将","给","在","到","的","和","然后","并且","接着"];let e=t;return n.forEach(s=>{e=e.replace(new RegExp(s,"g")," ")}),e.split(/[\s,，。.!！?？、]+/).filter(s=>s.length>0)}function Ze(t,n,e){var o,l,c;let r=0;const i=[t.text,t.placeholder,t.label,t.ariaLabel,t.name,(o=t.context)==null?void 0:o.sectionTitle,(l=t.context)==null?void 0:l.formTitle,(c=t.context)==null?void 0:c.rowLabel].filter(Boolean).join(" ").toLowerCase();for(const m of n){const u=m.toLowerCase();if(i===u)r+=20;else if(i.includes(u))r+=10;else if(u.length>2){const h=et(i,u);r+=h*5}}t.tag==="input"||t.tag==="textarea"?r+=e.priorities.form:t.tag==="button"||t.tag==="input"&&(t.type==="submit"||t.type==="button")?r+=e.priorities.button:t.tag==="select"?r+=e.priorities.form:t.tag==="a"?r+=e.priorities.link:(t.tag==="li"||t.tag==="details"||t.tag==="summary")&&(r+=e.priorities.list);const a=G.get(t.id);return a&&fe(t,a)&&(r+=e.priorities.tab),t.context&&(t.context.sectionTitle&&(r+=3),t.context.formTitle&&(r+=3),t.context.parentChain&&t.context.parentChain.length>0&&(r+=2),t.context.rowLabel&&(r+=2)),t.visible?r+=e.viewport.visible:Ge(new DOMRect(t.rect.x,t.rect.y,t.rect.width,t.rect.height))&&(r+=e.viewport.nearViewport),t.disabled&&(r-=5),r}function et(t,n){if(!t||!n)return 0;const e=new Set(t.split("")),r=new Set(n.split(""));let s=0;e.forEach(a=>{r.has(a)&&s++});const i=Math.max(e.size,r.size);return i>0?s/i:0}function tt(t,n,e=Be){const r=Qe(n);return t.map(i=>({element:i,score:Ze(i,r,e)})).sort((i,a)=>a.score-i.score).slice(0,e.maxElements).map(i=>i.element)}function fe(t,n){if(n.getAttribute("role")==="tab")return!0;const e=n.className||"";if(e.includes("tab")||e.includes("Tab")||n.hasAttribute("data-tab")||n.getAttribute("data-role")==="tab")return!0;const r=n.parentElement;return!!(r&&(r.className.includes("nav-tabs")||r.className.includes("tab-list")))}function rt(t,n){var l;const e=[];let s={input:"输入框",textarea:"文本框",button:"按钮",a:"链接",select:"下拉框",li:"列表项",details:"详情展开",summary:"摘要标题"}[t.tag]||t.tag;if(n&&fe(t,n)&&(s="Tab页签"),n){const c=n.getAttribute("role");if(c){const m={tab:"Tab页签",tabpanel:"Tab面板",switch:"开关按钮",menuitem:"菜单项",option:"下拉选项",listitem:"列表项",treeitem:"树节点",gridcell:"表格单元",radio:"单选按钮",checkbox:"复选框",button:"按钮",link:"链接"};m[c]&&(s=m[c])}}if(t.tag==="input"&&t.type){const c={password:"密码框",submit:"提交按钮",button:"按钮",checkbox:"复选框",radio:"单选框",search:"搜索框",email:"邮箱输入框",tel:"电话输入框",number:"数字输入框",url:"URL输入框",date:"日期选择器","datetime-local":"日期时间选择器",time:"时间选择器",month:"月份选择器",week:"周选择器",file:"文件上传",color:"颜色选择器",range:"滑块",hidden:"隐藏字段"};c[t.type]&&(s=c[t.type])}e.push(s);let i=t.label||t.text||t.placeholder||t.ariaLabel||t.name;if(!i&&n&&(i=n.getAttribute("title")||void 0),!i&&n&&s==="Tab页签"){const c=(l=n.textContent)==null?void 0:l.trim();c&&c.length<50&&(i=c)}i&&e.push(i);const a=[];t.placeholder&&t.placeholder!==i&&a.push(`placeholder:${t.placeholder}`),t.type&&!["text","submit","button"].includes(t.type)&&a.push(`type:${t.type}`),t.disabled&&a.push("禁用"),s==="Tab页签"&&n&&(n.classList.contains("active")||n.getAttribute("aria-selected")==="true")&&a.push("当前激活"),(t.type==="radio"||t.type==="checkbox")&&n&&n.checked&&a.push("已选中");let o=e.join(":");return a.length>0&&(o+=`(${a.join(",")})`),o}function Oe(t){return t.map(n=>{const e=G.get(n.id),r={id:n.id,desc:rt(n,e)};if(n.context){const s={};n.context.sectionTitle?s.section=n.context.sectionTitle:n.context.formTitle&&(s.section=n.context.formTitle),n.context.nearElements&&n.context.nearElements.length>0&&(s.nearby=n.context.nearElements.slice(0,2).join(", ")),n.context.rowLabel&&(s.nearby=s.nearby?`${n.context.rowLabel} | ${s.nearby}`:n.context.rowLabel),n.context.parentChain&&n.context.parentChain.length>0&&(s.path=n.context.parentChain.join(" > ")),Object.keys(s).length>0&&(r.ctx=s)}return r})}function st(t=""){var s;const n=Re(),e=tt(n,t),r=Oe(e);return{url:window.location.href,title:document.title,elements:r,selectedText:((s=window.getSelection())==null?void 0:s.toString())||void 0}}function nt(t){let n=Re();if(t.region&&(n=n.filter(e=>{const r=e.rect;switch(t.region){case"header":return r.y<150;case"footer":return r.y>window.innerHeight-200;case"sidebar":return r.x<250||r.x>window.innerWidth-250;case"below_viewport":return r.y>window.innerHeight;case"form":const s=document.querySelectorAll("form");return Array.from(s).some(l=>{const c=l.getBoundingClientRect();return r.x>=c.left&&r.x<=c.right&&r.y>=c.top&&r.y<=c.bottom});case"tab_panel":const i=document.querySelectorAll('[role="tabpanel"], .tab-content, .tab-pane');return Array.from(i).some(l=>{const c=l.getBoundingClientRect();return r.x>=c.left&&r.x<=c.right&&r.y>=c.top&&r.y<=c.bottom});case"modal":const a=document.querySelectorAll('[role="dialog"], .modal, .dialog, [class*="modal"], [class*="dialog"]');return Array.from(a).some(l=>{const c=l.getBoundingClientRect();return r.x>=c.left&&r.x<=c.right&&r.y>=c.top&&r.y<=c.bottom});case"menu":const o=document.querySelectorAll('[role="menu"], [role="menubar"], .menu, .dropdown-menu, .context-menu');return Array.from(o).some(l=>{const c=l.getBoundingClientRect();return r.x>=c.left&&r.x<=c.right&&r.y>=c.top&&r.y<=c.bottom});default:return!0}})),t.elementType&&t.elementType!=="all"&&(n=n.filter(e=>{const r=G.get(e.id);switch(t.elementType){case"input":return e.tag==="input"||e.tag==="textarea";case"button":return e.tag==="button"||e.tag==="input"&&(e.type==="submit"||e.type==="button");case"link":return e.tag==="a";case"select":return e.tag==="select";case"tab":return r?fe(e,r):!1;case"menu":return r?r.getAttribute("role")==="menuitem"||r.classList.contains("menu-item")||r.classList.contains("dropdown-item"):!1;case"list":return e.tag==="li"||(r==null?void 0:r.getAttribute("role"))==="listitem"||(r==null?void 0:r.classList.contains("list-group-item"));case"radio":return e.type==="radio"||(r==null?void 0:r.getAttribute("role"))==="radio";case"checkbox":return e.type==="checkbox"||(r==null?void 0:r.getAttribute("role"))==="checkbox";default:return!0}})),t.keyword){const e=t.keyword.toLowerCase();n=n.filter(r=>[r.text,r.placeholder,r.label,r.ariaLabel,r.name].filter(Boolean).join(" ").toLowerCase().includes(e))}return Oe(n)}function se(t){return new Promise(n=>setTimeout(n,t))}function it(t,n){t.focus(),t.value="",t.dispatchEvent(new Event("focus",{bubbles:!0})),t.value=n,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))}function ye(t){t.focus(),t.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))}async function at(t,n){if(console.log("[ActionExecutor] fillInput 调用:",{target:t,value:n}),!n)return{success:!1,message:"未提供填充值",error:"NO_VALUE"};let e=t.elementId?b(t.elementId):null;if(!e&&(console.log("[ActionExecutor] elementId 查找失败，尝试智能重定位"),t.selector&&(e=document.querySelector(t.selector)),!e&&t.description)){const r=Array.from(document.querySelectorAll("input, textarea"));for(const s of r)if([s.placeholder,s.getAttribute("aria-label"),s.name,ot(s)].filter(Boolean).join(" ").toLowerCase().includes(t.description.toLowerCase())){e=s;break}}return e?e.tagName!=="INPUT"&&e.tagName!=="TEXTAREA"?e.getAttribute("contenteditable")==="true"?(e.focus(),e.textContent=n,e.dispatchEvent(new Event("input",{bubbles:!0})),{success:!0,message:`已填充: ${n}`}):{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"}:(it(e,n),{success:!0,message:`已填充: ${n}`}):{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}function ot(t){var e,r;if(t.id){const s=document.querySelector(`label[for="${t.id}"]`);if(s)return(e=s.textContent)==null?void 0:e.trim()}const n=t.closest("label");if(n){const s=n.cloneNode(!0);return s.querySelectorAll("input, select, textarea").forEach(a=>a.remove()),(r=s.textContent)==null?void 0:r.trim()}}async function lt(t){var e;const n=t.elementId?b(t.elementId):null;if(!n){if(t.selector){const r=document.querySelector(t.selector);if(r)return ye(r),{success:!0,message:"已点击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return ye(n),{success:!0,message:`已点击: ${t.description||((e=n.textContent)==null?void 0:e.trim())||"元素"}`}}async function ct(t,n){const e=n||"#ffeb3b",r=window.getSelection();if(r&&r.rangeCount>0&&!r.isCollapsed){const i=r.getRangeAt(0),a=document.createElement("span");a.className="ai-highlight",a.style.backgroundColor=e,a.style.padding="2px 0",a.style.borderRadius="2px";try{return i.surroundContents(a),r.removeAllRanges(),{success:!0,message:"已高亮选中文字"}}catch{return{success:!1,message:"无法高亮跨元素的选中内容",error:"CROSS_ELEMENT"}}}const s=t.elementId?b(t.elementId):null;return s?(s.style.backgroundColor=e,s.classList.add("ai-highlight"),{success:!0,message:"已高亮元素"}):{success:!1,message:"未找到要高亮的内容",error:"NO_TARGET"}}async function ut(t){const n=window.getSelection();if(n&&n.rangeCount>0&&!n.isCollapsed){const r=n.getRangeAt(0),s=document.createElement("span");s.className="ai-underline",s.style.textDecoration="underline",s.style.textDecorationColor="#1a73e8",s.style.textDecorationThickness="2px";try{return r.surroundContents(s),n.removeAllRanges(),{success:!0,message:"已添加下划线"}}catch{return{success:!1,message:"无法为跨元素的选中内容添加下划线",error:"CROSS_ELEMENT"}}}const e=t.elementId?b(t.elementId):null;return e?(e.style.textDecoration="underline",e.style.textDecorationColor="#1a73e8",e.classList.add("ai-underline"),{success:!0,message:"已添加下划线"}):{success:!1,message:"未找到要添加下划线的内容",error:"NO_TARGET"}}async function ht(t,n){if(!n)return{success:!1,message:"未提供选择值",error:"NO_VALUE"};const e=t.elementId?b(t.elementId):null;if(!e||e.tagName!=="SELECT"){if(t.selector){const r=document.querySelector(t.selector);if(r&&r.tagName==="SELECT")return ve(r,n)}return{success:!1,message:"未找到下拉框元素",error:"ELEMENT_NOT_FOUND"}}return ve(e,n)}function ve(t,n){const e=Array.from(t.options).find(s=>s.value===n);if(e)return t.value=e.value,t.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已选择: ${e.text}`};const r=Array.from(t.options).find(s=>s.text.toLowerCase().includes(n.toLowerCase()));return r?(t.value=r.value,t.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已选择: ${r.text}`}):{success:!1,message:`未找到匹配的选项: ${n}`,error:"OPTION_NOT_FOUND"}}async function mt(t){const n=t.elementId?b(t.elementId):null;if(!n){if(t.selector){const r=document.querySelector(t.selector);if(r&&r.type==="checkbox")return r.checked=!r.checked,r.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:r.checked?"已勾选":"已取消勾选"}}return{success:!1,message:"未找到复选框元素",error:"ELEMENT_NOT_FOUND"}}if(n.tagName!=="INPUT"||n.type!=="checkbox")return{success:!1,message:"目标元素不是复选框",error:"INVALID_ELEMENT"};const e=n;return e.checked=!e.checked,e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:e.checked?"已勾选":"已取消勾选"}}async function dt(t){const n=window.innerHeight*.8;switch(t){case"up":return window.scrollBy({top:-n,behavior:"smooth"}),{success:!0,message:"已向上滚动"};case"down":return window.scrollBy({top:n,behavior:"smooth"}),{success:!0,message:"已向下滚动"};case"top":return window.scrollTo({top:0,behavior:"smooth"}),{success:!0,message:"已滚动到顶部"};case"bottom":return window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}),{success:!0,message:"已滚动到底部"};default:return window.scrollBy({top:n,behavior:"smooth"}),{success:!0,message:"已向下滚动"}}}async function ft(t){var r,s;const n=t.elementId?b(t.elementId):null;if(!n){if(t.selector){const a=document.querySelector(t.selector);if(a)return{success:!0,message:"已读取内容",data:((r=a.textContent)==null?void 0:r.trim())||""}}const i=window.getSelection();return i&&!i.isCollapsed?{success:!0,message:"已读取选中内容",data:i.toString()}:{success:!1,message:"未找到要读取的内容",error:"NO_TARGET"}}return{success:!0,message:"已读取内容",data:((s=n.textContent)==null?void 0:s.trim())||""}}async function gt(t){var r;const n=t.elementId?b(t.elementId):null;if(!n){if(t.selector){const s=document.querySelector(t.selector);if(s){const i=new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window});return s.dispatchEvent(i),{success:!0,message:"已悬停在元素上"}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const e=new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window});return n.dispatchEvent(e),{success:!0,message:`已悬停在: ${t.description||((r=n.textContent)==null?void 0:r.trim())||"元素"}上`}}async function pt(t,n,e){if(!n)return{success:!1,message:"未提供输入文本",error:"NO_TEXT"};const r=t.elementId?b(t.elementId):null;if(!r){if(t.selector){const s=document.querySelector(t.selector);if(s&&(s.tagName==="INPUT"||s.tagName==="TEXTAREA"))return await _e(s,n,e||50),{success:!0,message:`已输入: ${n}`}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return r.tagName!=="INPUT"&&r.tagName!=="TEXTAREA"?{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"}:(await _e(r,n,e||50),{success:!0,message:`已输入: ${n}`})}async function _e(t,n,e){t.focus(),t.value="",t.dispatchEvent(new Event("focus",{bubbles:!0}));for(let r=0;r<n.length;r++)t.value+=n[r],t.dispatchEvent(new Event("input",{bubbles:!0})),await new Promise(s=>setTimeout(s,e));t.dispatchEvent(new Event("change",{bubbles:!0}))}async function bt(t,n){if(!t)return{success:!1,message:"未提供按键",error:"NO_KEY"};const e=n?document.querySelector(n):document.activeElement;return e?(Ne(e,t),{success:!0,message:`已在元素上按下: ${t}`}):(Ne(document,t),{success:!0,message:`已发送按键: ${t}`})}function Ne(t,n){const e=new KeyboardEvent("keydown",{key:n,bubbles:!0,cancelable:!0,view:window});t.dispatchEvent(e);const r=new KeyboardEvent("keypress",{key:n,bubbles:!0,cancelable:!0,view:window});t.dispatchEvent(r);const s=new KeyboardEvent("keyup",{key:n,bubbles:!0,cancelable:!0,view:window});t.dispatchEvent(s)}async function Et(t,n){const e=t.elementId?b(t.elementId):null;if(!e)return{success:!1,message:"未找到源元素",error:"SOURCE_NOT_FOUND"};let r=null,s,i;if(n!=null&&n.selector){if(r=document.querySelector(n.selector),!r)return{success:!1,message:"未找到目标元素",error:"DESTINATION_NOT_FOUND"};const u=r.getBoundingClientRect();s=u.left+u.width/2,i=u.top+u.height/2}else if((n==null?void 0:n.x)!==void 0&&(n==null?void 0:n.y)!==void 0)s=n.x,i=n.y;else return{success:!1,message:"未提供目标位置",error:"NO_DESTINATION"};const a=e.getBoundingClientRect(),o=a.left+a.width/2,l=a.top+a.height/2;e.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window,clientX:o,clientY:l})),await se(100);const c=10;for(let u=1;u<=c;u++){const h=o+(s-o)*(u/c),d=l+(i-l)*(u/c);e.dispatchEvent(new MouseEvent("mousemove",{bubbles:!0,cancelable:!0,view:window,clientX:h,clientY:d})),await se(50)}return(document.elementFromPoint(s,i)||document.body).dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window,clientX:s,clientY:i})),{success:!0,message:"拖拽完成"}}async function yt(t,n,e){const r=n||1e3,s=Date.now();if(t!=null&&t.elementId||t!=null&&t.selector){for(t.elementId?`${t.elementId}`:t.selector;Date.now()-s<r;){const i=t.elementId?b(t.elementId):document.querySelector(t.selector);if(i)if(e==="visible"){const a=i.getBoundingClientRect();if(a.width>0&&a.height>0)return{success:!0,message:"元素已可见"}}else if(e==="hidden"){const a=i.getBoundingClientRect();if(a.width===0||a.height===0)return{success:!0,message:"元素已隐藏"}}else return{success:!0,message:"元素已出现"};await se(100)}return{success:!1,message:`等待超时: ${r}ms`,error:"TIMEOUT"}}else return await se(r),{success:!0,message:`等待了 ${r}ms`}}async function vt(t){var e;const n=t.elementId?b(t.elementId):null;if(!n){if(t.selector){const r=document.querySelector(t.selector);if(r)return r.focus(),{success:!0,message:"已聚焦元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return n.focus(),{success:!0,message:`已聚焦: ${t.description||((e=n.textContent)==null?void 0:e.trim())||"元素"}`}}async function _t(t){var e;const n=t.elementId?b(t.elementId):null;if(!n){if(t.selector){const r=document.querySelector(t.selector);if(r)return r.blur(),{success:!0,message:"已失焦元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return n.blur(),{success:!0,message:`已失焦: ${t.description||((e=n.textContent)==null?void 0:e.trim())||"元素"}`}}async function Nt(t){const n=t.elementId?b(t.elementId):null;if(!n){if(t.selector){const r=document.querySelector(t.selector);if(r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"))return r.value="",r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:"已清空输入框"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}if(n.tagName!=="INPUT"&&n.tagName!=="TEXTAREA")return{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"};const e=n;return e.value="",e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:"已清空输入框"}}async function Tt(t,n){if(!n)return{success:!1,message:"未提供属性名",error:"NO_ATTRIBUTE"};const e=t.elementId?b(t.elementId):null;if(!e){if(t.selector){const s=document.querySelector(t.selector);if(s){const i=s.getAttribute(n);return{success:!0,message:`获取属性 ${n}`,data:i}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const r=e.getAttribute(n);return{success:!0,message:`获取属性 ${n}`,data:r}}async function wt(t,n){if(!n)return{success:!1,message:"未提供属性名",error:"NO_PROPERTY"};const e=t.elementId?b(t.elementId):null;if(!e){if(t.selector){const s=document.querySelector(t.selector);if(s){const i=s[n];return{success:!0,message:`获取属性值 ${n}`,data:i}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const r=e[n];return{success:!0,message:`获取属性值 ${n}`,data:r}}async function At(t,n){switch(t){case"goto":return n?(window.location.href=n,{success:!0,message:`导航到: ${n}`}):{success:!1,message:"未提供URL",error:"NO_URL"};case"back":return window.history.back(),{success:!0,message:"返回上一页"};case"forward":return window.history.forward(),{success:!0,message:"前进到下一页"};case"reload":return window.location.reload(),{success:!0,message:"刷新页面"};default:return{success:!1,message:"未知的导航操作",error:"UNKNOWN_ACTION"}}}async function St(t,n,e){var s;const r=t.elementId?b(t.elementId):null;if(!r){if(t.selector){const i=document.querySelector(t.selector);if(i)return i.scrollIntoView({behavior:n||"smooth",block:e||"center"}),{success:!0,message:"已滚动到元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return r.scrollIntoView({behavior:n||"smooth",block:e||"center"}),{success:!0,message:`已滚动到: ${t.description||((s=r.textContent)==null?void 0:s.trim())||"元素"}`}}async function xt(t){var e;if(!t)return{success:!0,message:"已切换回主文档"};const n=document.querySelector(t);if(!n)return{success:!1,message:"未找到iframe",error:"IFRAME_NOT_FOUND"};try{return n.contentDocument||((e=n.contentWindow)==null?void 0:e.document)?{success:!0,message:`已切换到iframe: ${t}`,data:{frameUrl:n.src}}:{success:!1,message:"无法访问iframe内容（跨域限制）",error:"CROSS_ORIGIN"}}catch{return{success:!1,message:"无法访问iframe内容",error:"ACCESS_ERROR"}}}async function Ct(t,n){return{success:!0,message:`弹窗处理: ${t}`,data:{promptText:n}}}async function It(t,n){try{return localStorage.setItem(t,n),{success:!0,message:`已设置 localStorage[${t}] = ${n}`}}catch(e){return{success:!1,message:"设置localStorage失败",error:String(e)}}}async function Lt(t){try{const n=localStorage.getItem(t);return{success:!0,message:`获取 localStorage[${t}]`,data:n}}catch(n){return{success:!1,message:"获取localStorage失败",error:String(n)}}}async function Rt(t){try{if(t){const n=[];for(let e=0;e<localStorage.length;e++){const r=localStorage.key(e);r&&r.startsWith(t)&&n.push(r)}return n.forEach(e=>localStorage.removeItem(e)),{success:!0,message:`已清除 ${n.length} 个localStorage项`}}else{const n=localStorage.length;return localStorage.clear(),{success:!0,message:`已清除所有 ${n} 个localStorage项`}}}catch(n){return{success:!1,message:"清除localStorage失败",error:String(n)}}}async function Ot(t,n,e){try{let r=`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(e!=null&&e.expires){const s=new Date(Date.now()+e.expires*1e3);r+=`;expires=${s.toUTCString()}`}return e!=null&&e.path&&(r+=`;path=${e.path}`),e!=null&&e.domain&&(r+=`;domain=${e.domain}`),e!=null&&e.secure&&(r+=";secure"),document.cookie=r,{success:!0,message:`已设置 Cookie: ${t}`}}catch(r){return{success:!1,message:"设置Cookie失败",error:String(r)}}}async function Dt(t){var n;try{if(t){const e=(n=document.cookie.split("; ").find(r=>r.startsWith(`${encodeURIComponent(t)}=`)))==null?void 0:n.split("=")[1];return{success:!0,message:`获取 Cookie: ${t}`,data:e?decodeURIComponent(e):null}}else return{success:!0,message:"获取所有Cookies",data:document.cookie}}catch(e){return{success:!1,message:"获取Cookie失败",error:String(e)}}}function Te(t){const n=t.getBoundingClientRect(),e=n.left+n.width/2,r=n.top+n.height/2,s={bubbles:!0,cancelable:!0,view:window,clientX:e,clientY:r};t.focus(),t.dispatchEvent(new MouseEvent("mousedown",{...s,button:0,buttons:1})),t.dispatchEvent(new MouseEvent("mouseup",{...s,button:0,buttons:0})),t.dispatchEvent(new MouseEvent("click",{...s,button:0})),t.dispatchEvent(new MouseEvent("mousedown",{...s,button:0,buttons:1})),t.dispatchEvent(new MouseEvent("mouseup",{...s,button:0,buttons:0})),t.dispatchEvent(new MouseEvent("click",{...s,button:0})),t.dispatchEvent(new MouseEvent("dblclick",{...s,button:0}))}async function Pt(t){var e;const n=t.elementId?b(t.elementId):null;if(!n){if(t.selector){const r=document.querySelector(t.selector);if(r)return Te(r),{success:!0,message:"已双击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return Te(n),{success:!0,message:`已双击: ${t.description||((e=n.textContent)==null?void 0:e.trim())||"元素"}`}}function we(t){const n=t.getBoundingClientRect(),e=n.left+n.width/2,r=n.top+n.height/2;t.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window,button:2,buttons:2,clientX:e,clientY:r})),t.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window,button:2,buttons:0,clientX:e,clientY:r})),t.dispatchEvent(new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,view:window,button:2,clientX:e,clientY:r}))}async function Mt(t){var e;const n=t.elementId?b(t.elementId):null;if(!n){if(t.selector){const r=document.querySelector(t.selector);if(r)return we(r),{success:!0,message:"已右键点击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return we(n),{success:!0,message:`已右键点击: ${t.description||((e=n.textContent)==null?void 0:e.trim())||"元素"}`}}async function kt(t,n,e,r){const s=t.elementId?b(t.elementId):t.selector?document.querySelector(t.selector):null;if(!s)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const i=window.getSelection();if(!i)return{success:!1,message:"无法获取Selection对象",error:"NO_SELECTION"};i.removeAllRanges();const a=document.createRange();try{if(n){const l=Ut(s,n);if(!l)return{success:!1,message:`未找到文本: ${n}`,error:"TEXT_NOT_FOUND"};const m=(l.textContent||"").indexOf(n);a.setStart(l,m),a.setEnd(l,m+n.length)}else if(e!==void 0&&r!==void 0){const l=s.firstChild;if(!l||l.nodeType!==Node.TEXT_NODE)return{success:!1,message:"元素没有文本节点",error:"NO_TEXT_NODE"};a.setStart(l,e),a.setEnd(l,r)}else a.selectNodeContents(s);i.addRange(a);const o=i.toString();return{success:!0,message:`已选中文本: ${o}`,data:o}}catch(o){return{success:!1,message:`选中文本失败: ${o}`,error:"SELECT_ERROR"}}}function Ut(t,n){const e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null);let r;for(;r=e.nextNode();)if(r.textContent&&r.textContent.includes(n))return r;return null}async function $t(t,n){var e;try{let r=n;if(!r){const s=window.getSelection();if(s&&!s.isCollapsed)r=s.toString();else if(t.elementId||t.selector){const i=t.elementId?b(t.elementId):document.querySelector(t.selector);i&&(r=((e=i.textContent)==null?void 0:e.trim())||"")}}return r?(await navigator.clipboard.writeText(r),{success:!0,message:`已复制到剪贴板: ${r.substring(0,50)}${r.length>50?"...":""}`}):{success:!1,message:"没有可复制的内容",error:"NO_CONTENT"}}catch(r){return{success:!1,message:`复制失败: ${r}`,error:"CLIPBOARD_ERROR"}}}async function Bt(t){try{const n=await navigator.clipboard.readText();if(!n)return{success:!1,message:"剪贴板为空",error:"EMPTY_CLIPBOARD"};const e=t.elementId?b(t.elementId):t.selector?document.querySelector(t.selector):null;if(!e)return{success:!0,message:"已读取剪贴板内容",data:n};if(e.tagName==="INPUT"||e.tagName==="TEXTAREA"){const r=e;return r.focus(),r.value=n,r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已粘贴: ${n.substring(0,50)}${n.length>50?"...":""}`}}else if(e.getAttribute("contenteditable")==="true")return e.focus(),e.textContent=n,e.dispatchEvent(new Event("input",{bubbles:!0})),{success:!0,message:`已粘贴: ${n.substring(0,50)}${n.length>50?"...":""}`};return{success:!0,message:"已读取剪贴板内容",data:n}}catch(n){return{success:!1,message:`粘贴失败: ${n}`,error:"CLIPBOARD_ERROR"}}}async function Ht(t,n){if(!n||n.length===0)return{success:!1,message:"未提供文件",error:"NO_FILES"};const e=t.elementId?b(t.elementId):t.selector?document.querySelector(t.selector):null;if(!e||e.tagName!=="INPUT"||e.type!=="file")return{success:!1,message:"目标元素不是文件输入框",error:"INVALID_ELEMENT"};const r=e;try{const s=new DataTransfer;for(const i of n){const a=atob(i.content),o=new Array(a.length);for(let u=0;u<a.length;u++)o[u]=a.charCodeAt(u);const l=new Uint8Array(o),c=new Blob([l],{type:i.type}),m=new File([c],i.name,{type:i.type});s.items.add(m)}return r.files=s.files,r.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已上传 ${n.length} 个文件`}}catch(s){return{success:!1,message:`上传失败: ${s}`,error:"UPLOAD_ERROR"}}}async function qt(t){if(!t)return{success:!1,message:"未提供脚本",error:"NO_SCRIPT"};try{return{success:!0,message:"脚本执行成功",data:new Function(t)()}}catch(n){return{success:!1,message:`脚本执行失败: ${n}`,error:"SCRIPT_ERROR"}}}async function Gt(t,n,e,r){var o,l;if(!e)return{success:!1,message:"未提供列表项内容",error:"NO_CONTENT"};let s=null;if(n)s=document.querySelector(n);else if(t.elementId||t.selector){const c=t.elementId?b(t.elementId):document.querySelector(t.selector);c&&(s=c.closest("ul, ol"))}if(!s)return{success:!1,message:"未找到列表容器",error:"LIST_NOT_FOUND"};const i=document.createElement("li");i.textContent=e;const a=t.elementId?b(t.elementId):t.selector?document.querySelector(t.selector):null;switch(r){case"before":a&&a.tagName==="LI"?(o=a.parentNode)==null||o.insertBefore(i,a):s.insertBefore(i,s.firstChild);break;case"after":a&&a.tagName==="LI"?(l=a.parentNode)==null||l.insertBefore(i,a.nextSibling):s.appendChild(i);break;case"first":s.insertBefore(i,s.firstChild);break;case"last":default:s.appendChild(i);break}return s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已添加列表项: ${e}`}}async function Wt(t,n){var i;let e=null;if(t.elementId||t.selector)e=t.elementId?b(t.elementId):document.querySelector(t.selector);else if(n!==void 0){const a=document.querySelectorAll("ul, ol");for(const o of a){const l=o.querySelectorAll(":scope > li");if(l[n]){e=l[n];break}}}if(!e||e.tagName!=="LI")return{success:!1,message:"未找到要删除的列表项",error:"ITEM_NOT_FOUND"};const r=((i=e.textContent)==null?void 0:i.trim())||"",s=e.parentNode;return e.remove(),s&&s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已删除列表项: ${r}`}}async function Xt(t,n){var s;if(!n)return{success:!1,message:"未提供新内容",error:"NO_CONTENT"};const e=t.elementId?b(t.elementId):t.selector?document.querySelector(t.selector):null;if(!e||e.tagName!=="LI")return{success:!1,message:"未找到列表项元素",error:"ITEM_NOT_FOUND"};const r=((s=e.textContent)==null?void 0:s.trim())||"";return e.textContent=n,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已编辑列表项: "${r}" → "${n}"`}}async function Ft(t,n){var s;if(n===void 0)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const e=t.elementId?b(t.elementId):t.selector?document.querySelector(t.selector):null;if(!e)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const r=((s=e.textContent)==null?void 0:s.trim())||"";return e.tagName==="INPUT"||e.tagName==="TEXTAREA"?e.value=n:(e.getAttribute("contenteditable"),e.textContent=n),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已设置内容: "${r.substring(0,20)}..." → "${n.substring(0,20)}..."`}}async function Vt(t,n){if(!n)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const e=t.elementId?b(t.elementId):t.selector?document.querySelector(t.selector):null;if(!e)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};if(e.tagName==="INPUT"||e.tagName==="TEXTAREA"){const r=e;r.value+=n}else e.getAttribute("contenteditable")==="true"?e.textContent=(e.textContent||"")+n:e.appendChild(document.createTextNode(n));return e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已追加内容: "${n.substring(0,30)}${n.length>30?"...":""}"`}}async function jt(t,n){if(!n)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const e=t.elementId?b(t.elementId):t.selector?document.querySelector(t.selector):null;if(!e)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};if(e.tagName==="INPUT"||e.tagName==="TEXTAREA"){const r=e;r.value=n+r.value}else e.getAttribute("contenteditable")==="true"?e.textContent=n+(e.textContent||""):e.insertBefore(document.createTextNode(n),e.firstChild);return e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已前置内容: "${n.substring(0,30)}${n.length>30?"...":""}"`}}async function Yt(t,n,e){if(!n)return{success:!1,message:"未提供HTML内容",error:"NO_HTML"};const r=t.elementId?b(t.elementId):t.selector?document.querySelector(t.selector):null;if(!r)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const s=e||"beforeend";return r.insertAdjacentHTML(s,n),r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已在${{beforebegin:"元素之前",afterbegin:"元素内部开头",beforeend:"元素内部末尾",afterend:"元素之后"}[s]}插入HTML`}}async function zt(t){try{if(t)return document.cookie=`${encodeURIComponent(t)}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`,{success:!0,message:`已清除 Cookie: ${t}`};{const n=document.cookie.split(";");return n.forEach(e=>{const[r]=e.split("="),s=r==null?void 0:r.trim();s&&(document.cookie=`${s}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`,document.cookie=`${s}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;domain=${window.location.hostname}`)}),{success:!0,message:`已清除 ${n.length} 个Cookies`}}}catch(n){return{success:!1,message:"清除Cookie失败",error:String(n)}}}async function De(t){var n,e,r,s,i,a,o,l,c,m,u,h,d,f,y,v,_,S,x,L,P,T,O,R,D,g,M,p,w,U,F,V,j,Y,ne,J,I,ie,z,W,Q,N,$,Z,ee;try{switch(t.action){case"fill":return await at(t.target,(n=t.params)==null?void 0:n.value);case"click":return await lt(t.target);case"highlight":return await ct(t.target,(e=t.params)==null?void 0:e.color);case"underline":return await ut(t.target);case"select":return await ht(t.target,(r=t.params)==null?void 0:r.value);case"check":return await mt(t.target);case"scroll":return await dt((s=t.params)==null?void 0:s.direction);case"read":return await ft(t.target);case"hover":return await gt(t.target);case"type":return await pt(t.target,(i=t.params)==null?void 0:i.value,(a=t.params)==null?void 0:a.delay);case"press":return await bt((o=t.params)==null?void 0:o.key,(l=t.target)==null?void 0:l.selector);case"drag":return await Et(t.target,(c=t.params)==null?void 0:c.destination);case"wait":return await yt(t.target,(m=t.params)==null?void 0:m.timeout,(u=t.params)==null?void 0:u.condition);case"focus":return await vt(t.target);case"blur":return await _t(t.target);case"clear":return await Nt(t.target);case"getAttribute":return await Tt(t.target,(h=t.params)==null?void 0:h.attribute);case"getProperty":return await wt(t.target,(d=t.params)==null?void 0:d.property);case"navigate":return await At((f=t.params)==null?void 0:f.navigateAction,(y=t.params)==null?void 0:y.url);case"scrollIntoView":return await St(t.target,(v=t.params)==null?void 0:v.behavior,(_=t.params)==null?void 0:_.block);case"switchFrame":return await xt((S=t.params)==null?void 0:S.frameSelector);case"handleDialog":return await Ct((x=t.params)==null?void 0:x.dialogAction,(L=t.params)==null?void 0:L.promptText);case"setLocalStorage":return await It((P=t.params)==null?void 0:P.key,(T=t.params)==null?void 0:T.value);case"getLocalStorage":return await Lt((O=t.params)==null?void 0:O.key);case"clearLocalStorage":return await Rt((R=t.params)==null?void 0:R.prefix);case"setCookie":return await Ot((D=t.params)==null?void 0:D.name,(g=t.params)==null?void 0:g.value,(M=t.params)==null?void 0:M.cookieOptions);case"getCookie":return await Dt((p=t.params)==null?void 0:p.name);case"clearCookies":return await zt((w=t.params)==null?void 0:w.name);case"doubleClick":return await Pt(t.target);case"rightClick":return await Mt(t.target);case"selectText":return await kt(t.target,(U=t.params)==null?void 0:U.searchText,(F=t.params)==null?void 0:F.startOffset,(V=t.params)==null?void 0:V.endOffset);case"copyToClipboard":return await $t(t.target,(j=t.params)==null?void 0:j.text);case"pasteFromClipboard":return await Bt(t.target);case"upload":return await Ht(t.target,(Y=t.params)==null?void 0:Y.files);case"evaluate":return await qt((ne=t.params)==null?void 0:ne.script);case"addListItem":return await Gt(t.target,(J=t.params)==null?void 0:J.listSelector,(I=t.params)==null?void 0:I.itemContent,(ie=t.params)==null?void 0:ie.position);case"removeListItem":return await Wt(t.target,(z=t.params)==null?void 0:z.itemIndex);case"editListItem":return await Xt(t.target,(W=t.params)==null?void 0:W.itemContent);case"setContent":return await Ft(t.target,(Q=t.params)==null?void 0:Q.content);case"appendContent":return await Vt(t.target,(N=t.params)==null?void 0:N.content);case"prependContent":return await jt(t.target,($=t.params)==null?void 0:$.content);case"insertHTML":return await Yt(t.target,(Z=t.params)==null?void 0:Z.html,(ee=t.params)==null?void 0:ee.insertPosition);default:return{success:!1,message:`不支持的操作类型: ${t.action}`,error:"UNSUPPORTED_ACTION"}}}catch(ae){return{success:!1,message:`执行操作时出错: ${ae}`,error:"EXECUTION_ERROR"}}}async function Kt(t){const n=[];let e=0;for(const s of t){const i=await De(s);n.push(i),i.success&&e++,await se(100)}const r=`执行了 ${t.length} 个操作，成功 ${e} 个，失败 ${t.length-e} 个`;return{success:e===t.length,results:n,summary:r}}function Jt(){document.querySelectorAll(".ai-highlight").forEach(t=>{const n=t.parentNode;n&&(n.replaceChild(document.createTextNode(t.textContent||""),t),n.normalize())}),document.querySelectorAll(".ai-underline").forEach(t=>{const n=t.parentNode;n&&(n.replaceChild(document.createTextNode(t.textContent||""),t),n.normalize())})}var Pe={exports:{}};(function(t){function n(e,r){if(r&&r.documentElement)e=r,r=arguments[2];else if(!e||!e.documentElement)throw new Error("First argument to Readability constructor should be a document object.");if(r=r||{},this._doc=e,this._docJSDOMParser=this._doc.firstChild.__JSDOMParser__,this._articleTitle=null,this._articleByline=null,this._articleDir=null,this._articleSiteName=null,this._attempts=[],this._metadata={},this._debug=!!r.debug,this._maxElemsToParse=r.maxElemsToParse||this.DEFAULT_MAX_ELEMS_TO_PARSE,this._nbTopCandidates=r.nbTopCandidates||this.DEFAULT_N_TOP_CANDIDATES,this._charThreshold=r.charThreshold||this.DEFAULT_CHAR_THRESHOLD,this._classesToPreserve=this.CLASSES_TO_PRESERVE.concat(r.classesToPreserve||[]),this._keepClasses=!!r.keepClasses,this._serializer=r.serializer||function(s){return s.innerHTML},this._disableJSONLD=!!r.disableJSONLD,this._allowedVideoRegex=r.allowedVideoRegex||this.REGEXPS.videos,this._linkDensityModifier=r.linkDensityModifier||0,this._flags=this.FLAG_STRIP_UNLIKELYS|this.FLAG_WEIGHT_CLASSES|this.FLAG_CLEAN_CONDITIONALLY,this._debug){let s=function(i){if(i.nodeType==i.TEXT_NODE)return`${i.nodeName} ("${i.textContent}")`;let a=Array.from(i.attributes||[],function(o){return`${o.name}="${o.value}"`}).join(" ");return`<${i.localName} ${a}>`};this.log=function(){if(typeof console<"u"){let a=Array.from(arguments,o=>o&&o.nodeType==this.ELEMENT_NODE?s(o):o);a.unshift("Reader: (Readability)"),console.log(...a)}else if(typeof dump<"u"){var i=Array.prototype.map.call(arguments,function(a){return a&&a.nodeName?s(a):a}).join(" ");dump("Reader: (Readability) "+i+`
`)}}}else this.log=function(){}}n.prototype={FLAG_STRIP_UNLIKELYS:1,FLAG_WEIGHT_CLASSES:2,FLAG_CLEAN_CONDITIONALLY:4,ELEMENT_NODE:1,TEXT_NODE:3,DEFAULT_MAX_ELEMS_TO_PARSE:0,DEFAULT_N_TOP_CANDIDATES:5,DEFAULT_TAGS_TO_SCORE:"section,h2,h3,h4,h5,h6,p,td,pre".toUpperCase().split(","),DEFAULT_CHAR_THRESHOLD:500,REGEXPS:{unlikelyCandidates:/-ad-|ai2html|banner|breadcrumbs|combx|comment|community|cover-wrap|disqus|extra|footer|gdpr|header|legends|menu|related|remark|replies|rss|shoutbox|sidebar|skyscraper|social|sponsor|supplemental|ad-break|agegate|pagination|pager|popup|yom-remote/i,okMaybeItsACandidate:/and|article|body|column|content|main|shadow/i,positive:/article|body|content|entry|hentry|h-entry|main|page|pagination|post|text|blog|story/i,negative:/-ad-|hidden|^hid$| hid$| hid |^hid |banner|combx|comment|com-|contact|footer|gdpr|masthead|media|meta|outbrain|promo|related|scroll|share|shoutbox|sidebar|skyscraper|sponsor|shopping|tags|widget/i,extraneous:/print|archive|comment|discuss|e[\-]?mail|share|reply|all|login|sign|single|utility/i,byline:/byline|author|dateline|writtenby|p-author/i,replaceFonts:/<(\/?)font[^>]*>/gi,normalize:/\s{2,}/g,videos:/\/\/(www\.)?((dailymotion|youtube|youtube-nocookie|player\.vimeo|v\.qq)\.com|(archive|upload\.wikimedia)\.org|player\.twitch\.tv)/i,shareElements:/(\b|_)(share|sharedaddy)(\b|_)/i,nextLink:/(next|weiter|continue|>([^\|]|$)|»([^\|]|$))/i,prevLink:/(prev|earl|old|new|<|«)/i,tokenize:/\W+/g,whitespace:/^\s*$/,hasContent:/\S$/,hashUrl:/^#.+/,srcsetUrl:/(\S+)(\s+[\d.]+[xw])?(\s*(?:,|$))/g,b64DataUrl:/^data:\s*([^\s;,]+)\s*;\s*base64\s*,/i,commas:/\u002C|\u060C|\uFE50|\uFE10|\uFE11|\u2E41|\u2E34|\u2E32|\uFF0C/g,jsonLdArticleTypes:/^Article|AdvertiserContentArticle|NewsArticle|AnalysisNewsArticle|AskPublicNewsArticle|BackgroundNewsArticle|OpinionNewsArticle|ReportageNewsArticle|ReviewNewsArticle|Report|SatiricalArticle|ScholarlyArticle|MedicalScholarlyArticle|SocialMediaPosting|BlogPosting|LiveBlogPosting|DiscussionForumPosting|TechArticle|APIReference$/,adWords:/^(ad(vertising|vertisement)?|pub(licité)?|werb(ung)?|广告|Реклама|Anuncio)$/iu,loadingWords:/^((loading|正在加载|Загрузка|chargement|cargando)(…|\.\.\.)?)$/iu},UNLIKELY_ROLES:["menu","menubar","complementary","navigation","alert","alertdialog","dialog"],DIV_TO_P_ELEMS:new Set(["BLOCKQUOTE","DL","DIV","IMG","OL","P","PRE","TABLE","UL"]),ALTER_TO_DIV_EXCEPTIONS:["DIV","ARTICLE","SECTION","P","OL","UL"],PRESENTATIONAL_ATTRIBUTES:["align","background","bgcolor","border","cellpadding","cellspacing","frame","hspace","rules","style","valign","vspace"],DEPRECATED_SIZE_ATTRIBUTE_ELEMS:["TABLE","TH","TD","HR","PRE"],PHRASING_ELEMS:["ABBR","AUDIO","B","BDO","BR","BUTTON","CITE","CODE","DATA","DATALIST","DFN","EM","EMBED","I","IMG","INPUT","KBD","LABEL","MARK","MATH","METER","NOSCRIPT","OBJECT","OUTPUT","PROGRESS","Q","RUBY","SAMP","SCRIPT","SELECT","SMALL","SPAN","STRONG","SUB","SUP","TEXTAREA","TIME","VAR","WBR"],CLASSES_TO_PRESERVE:["page"],HTML_ESCAPE_MAP:{lt:"<",gt:">",amp:"&",quot:'"',apos:"'"},_postProcessContent(e){this._fixRelativeUris(e),this._simplifyNestedElements(e),this._keepClasses||this._cleanClasses(e)},_removeNodes(e,r){if(this._docJSDOMParser&&e._isLiveNodeList)throw new Error("Do not pass live node lists to _removeNodes");for(var s=e.length-1;s>=0;s--){var i=e[s],a=i.parentNode;a&&(!r||r.call(this,i,s,e))&&a.removeChild(i)}},_replaceNodeTags(e,r){if(this._docJSDOMParser&&e._isLiveNodeList)throw new Error("Do not pass live node lists to _replaceNodeTags");for(const s of e)this._setNodeTag(s,r)},_forEachNode(e,r){Array.prototype.forEach.call(e,r,this)},_findNode(e,r){return Array.prototype.find.call(e,r,this)},_someNode(e,r){return Array.prototype.some.call(e,r,this)},_everyNode(e,r){return Array.prototype.every.call(e,r,this)},_getAllNodesWithTag(e,r){return e.querySelectorAll?e.querySelectorAll(r.join(",")):[].concat.apply([],r.map(function(s){var i=e.getElementsByTagName(s);return Array.isArray(i)?i:Array.from(i)}))},_cleanClasses(e){var r=this._classesToPreserve,s=(e.getAttribute("class")||"").split(/\s+/).filter(i=>r.includes(i)).join(" ");for(s?e.setAttribute("class",s):e.removeAttribute("class"),e=e.firstElementChild;e;e=e.nextElementSibling)this._cleanClasses(e)},_isUrl(e){try{return new URL(e),!0}catch{return!1}},_fixRelativeUris(e){var r=this._doc.baseURI,s=this._doc.documentURI;function i(l){if(r==s&&l.charAt(0)=="#")return l;try{return new URL(l,r).href}catch{}return l}var a=this._getAllNodesWithTag(e,["a"]);this._forEachNode(a,function(l){var c=l.getAttribute("href");if(c)if(c.indexOf("javascript:")===0)if(l.childNodes.length===1&&l.childNodes[0].nodeType===this.TEXT_NODE){var m=this._doc.createTextNode(l.textContent);l.parentNode.replaceChild(m,l)}else{for(var u=this._doc.createElement("span");l.firstChild;)u.appendChild(l.firstChild);l.parentNode.replaceChild(u,l)}else l.setAttribute("href",i(c))});var o=this._getAllNodesWithTag(e,["img","picture","figure","video","audio","source"]);this._forEachNode(o,function(l){var c=l.getAttribute("src"),m=l.getAttribute("poster"),u=l.getAttribute("srcset");if(c&&l.setAttribute("src",i(c)),m&&l.setAttribute("poster",i(m)),u){var h=u.replace(this.REGEXPS.srcsetUrl,function(d,f,y,v){return i(f)+(y||"")+v});l.setAttribute("srcset",h)}})},_simplifyNestedElements(e){for(var r=e;r;){if(r.parentNode&&["DIV","SECTION"].includes(r.tagName)&&!(r.id&&r.id.startsWith("readability"))){if(this._isElementWithoutContent(r)){r=this._removeAndGetNext(r);continue}else if(this._hasSingleTagInsideElement(r,"DIV")||this._hasSingleTagInsideElement(r,"SECTION")){for(var s=r.children[0],i=0;i<r.attributes.length;i++)s.setAttributeNode(r.attributes[i].cloneNode());r.parentNode.replaceChild(s,r),r=s;continue}}r=this._getNextNode(r)}},_getArticleTitle(){var e=this._doc,r="",s="";try{r=s=e.title.trim(),typeof r!="string"&&(r=s=this._getInnerText(e.getElementsByTagName("title")[0]))}catch{}var i=!1;function a(h){return h.split(/\s+/).length}if(/ [\|\-\\\/>»] /.test(r)){i=/ [\\\/>»] /.test(r);let h=Array.from(s.matchAll(/ [\|\-\\\/>»] /gi));r=s.substring(0,h.pop().index),a(r)<3&&(r=s.replace(/^[^\|\-\\\/>»]*[\|\-\\\/>»]/gi,""))}else if(r.includes(": ")){var o=this._getAllNodesWithTag(e,["h1","h2"]),l=r.trim(),c=this._someNode(o,function(h){return h.textContent.trim()===l});c||(r=s.substring(s.lastIndexOf(":")+1),a(r)<3?r=s.substring(s.indexOf(":")+1):a(s.substr(0,s.indexOf(":")))>5&&(r=s))}else if(r.length>150||r.length<15){var m=e.getElementsByTagName("h1");m.length===1&&(r=this._getInnerText(m[0]))}r=r.trim().replace(this.REGEXPS.normalize," ");var u=a(r);return u<=4&&(!i||u!=a(s.replace(/[\|\-\\\/>»]+/g,""))-1)&&(r=s),r},_prepDocument(){var e=this._doc;this._removeNodes(this._getAllNodesWithTag(e,["style"])),e.body&&this._replaceBrs(e.body),this._replaceNodeTags(this._getAllNodesWithTag(e,["font"]),"SPAN")},_nextNode(e){for(var r=e;r&&r.nodeType!=this.ELEMENT_NODE&&this.REGEXPS.whitespace.test(r.textContent);)r=r.nextSibling;return r},_replaceBrs(e){this._forEachNode(this._getAllNodesWithTag(e,["br"]),function(r){for(var s=r.nextSibling,i=!1;(s=this._nextNode(s))&&s.tagName=="BR";){i=!0;var a=s.nextSibling;s.remove(),s=a}if(i){var o=this._doc.createElement("p");for(r.parentNode.replaceChild(o,r),s=o.nextSibling;s;){if(s.tagName=="BR"){var l=this._nextNode(s.nextSibling);if(l&&l.tagName=="BR")break}if(!this._isPhrasingContent(s))break;var c=s.nextSibling;o.appendChild(s),s=c}for(;o.lastChild&&this._isWhitespace(o.lastChild);)o.lastChild.remove();o.parentNode.tagName==="P"&&this._setNodeTag(o.parentNode,"DIV")}})},_setNodeTag(e,r){if(this.log("_setNodeTag",e,r),this._docJSDOMParser)return e.localName=r.toLowerCase(),e.tagName=r.toUpperCase(),e;for(var s=e.ownerDocument.createElement(r);e.firstChild;)s.appendChild(e.firstChild);e.parentNode.replaceChild(s,e),e.readability&&(s.readability=e.readability);for(var i=0;i<e.attributes.length;i++)s.setAttributeNode(e.attributes[i].cloneNode());return s},_prepArticle(e){this._cleanStyles(e),this._markDataTables(e),this._fixLazyImages(e),this._cleanConditionally(e,"form"),this._cleanConditionally(e,"fieldset"),this._clean(e,"object"),this._clean(e,"embed"),this._clean(e,"footer"),this._clean(e,"link"),this._clean(e,"aside");var r=this.DEFAULT_CHAR_THRESHOLD;this._forEachNode(e.children,function(s){this._cleanMatchedNodes(s,function(i,a){return this.REGEXPS.shareElements.test(a)&&i.textContent.length<r})}),this._clean(e,"iframe"),this._clean(e,"input"),this._clean(e,"textarea"),this._clean(e,"select"),this._clean(e,"button"),this._cleanHeaders(e),this._cleanConditionally(e,"table"),this._cleanConditionally(e,"ul"),this._cleanConditionally(e,"div"),this._replaceNodeTags(this._getAllNodesWithTag(e,["h1"]),"h2"),this._removeNodes(this._getAllNodesWithTag(e,["p"]),function(s){var i=this._getAllNodesWithTag(s,["img","embed","object","iframe"]).length;return i===0&&!this._getInnerText(s,!1)}),this._forEachNode(this._getAllNodesWithTag(e,["br"]),function(s){var i=this._nextNode(s.nextSibling);i&&i.tagName=="P"&&s.remove()}),this._forEachNode(this._getAllNodesWithTag(e,["table"]),function(s){var i=this._hasSingleTagInsideElement(s,"TBODY")?s.firstElementChild:s;if(this._hasSingleTagInsideElement(i,"TR")){var a=i.firstElementChild;if(this._hasSingleTagInsideElement(a,"TD")){var o=a.firstElementChild;o=this._setNodeTag(o,this._everyNode(o.childNodes,this._isPhrasingContent)?"P":"DIV"),s.parentNode.replaceChild(o,s)}}})},_initializeNode(e){switch(e.readability={contentScore:0},e.tagName){case"DIV":e.readability.contentScore+=5;break;case"PRE":case"TD":case"BLOCKQUOTE":e.readability.contentScore+=3;break;case"ADDRESS":case"OL":case"UL":case"DL":case"DD":case"DT":case"LI":case"FORM":e.readability.contentScore-=3;break;case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"TH":e.readability.contentScore-=5;break}e.readability.contentScore+=this._getClassWeight(e)},_removeAndGetNext(e){var r=this._getNextNode(e,!0);return e.remove(),r},_getNextNode(e,r){if(!r&&e.firstElementChild)return e.firstElementChild;if(e.nextElementSibling)return e.nextElementSibling;do e=e.parentNode;while(e&&!e.nextElementSibling);return e&&e.nextElementSibling},_textSimilarity(e,r){var s=e.toLowerCase().split(this.REGEXPS.tokenize).filter(Boolean),i=r.toLowerCase().split(this.REGEXPS.tokenize).filter(Boolean);if(!s.length||!i.length)return 0;var a=i.filter(l=>!s.includes(l)),o=a.join(" ").length/i.join(" ").length;return 1-o},_isValidByline(e,r){var s=e.getAttribute("rel"),i=e.getAttribute("itemprop"),a=e.textContent.trim().length;return(s==="author"||i&&i.includes("author")||this.REGEXPS.byline.test(r))&&!!a&&a<100},_getNodeAncestors(e,r){r=r||0;for(var s=0,i=[];e.parentNode&&(i.push(e.parentNode),!(r&&++s===r));)e=e.parentNode;return i},_grabArticle(e){this.log("**** grabArticle ****");var r=this._doc,s=e!==null;if(e=e||this._doc.body,!e)return this.log("No body found in document. Abort."),null;for(var i=e.innerHTML;;){this.log("Starting grabArticle loop");var a=this._flagIsActive(this.FLAG_STRIP_UNLIKELYS),o=[],l=this._doc.documentElement;let be=!0;for(;l;){l.tagName==="HTML"&&(this._articleLang=l.getAttribute("lang"));var c=l.className+" "+l.id;if(!this._isProbablyVisible(l)){this.log("Removing hidden node - "+c),l=this._removeAndGetNext(l);continue}if(l.getAttribute("aria-modal")=="true"&&l.getAttribute("role")=="dialog"){l=this._removeAndGetNext(l);continue}if(!this._articleByline&&!this._metadata.byline&&this._isValidByline(l,c)){for(var m=this._getNextNode(l,!0),u=this._getNextNode(l),h=null;u&&u!=m;){var d=u.getAttribute("itemprop");if(d&&d.includes("name")){h=u;break}else u=this._getNextNode(u)}this._articleByline=(h??l).textContent.trim(),l=this._removeAndGetNext(l);continue}if(be&&this._headerDuplicatesTitle(l)){this.log("Removing header: ",l.textContent.trim(),this._articleTitle.trim()),be=!1,l=this._removeAndGetNext(l);continue}if(a){if(this.REGEXPS.unlikelyCandidates.test(c)&&!this.REGEXPS.okMaybeItsACandidate.test(c)&&!this._hasAncestorTag(l,"table")&&!this._hasAncestorTag(l,"code")&&l.tagName!=="BODY"&&l.tagName!=="A"){this.log("Removing unlikely candidate - "+c),l=this._removeAndGetNext(l);continue}if(this.UNLIKELY_ROLES.includes(l.getAttribute("role"))){this.log("Removing content with role "+l.getAttribute("role")+" - "+c),l=this._removeAndGetNext(l);continue}}if((l.tagName==="DIV"||l.tagName==="SECTION"||l.tagName==="HEADER"||l.tagName==="H1"||l.tagName==="H2"||l.tagName==="H3"||l.tagName==="H4"||l.tagName==="H5"||l.tagName==="H6")&&this._isElementWithoutContent(l)){l=this._removeAndGetNext(l);continue}if(this.DEFAULT_TAGS_TO_SCORE.includes(l.tagName)&&o.push(l),l.tagName==="DIV"){for(var f=null,y=l.firstChild;y;){var v=y.nextSibling;if(this._isPhrasingContent(y))f!==null?f.appendChild(y):this._isWhitespace(y)||(f=r.createElement("p"),l.replaceChild(f,y),f.appendChild(y));else if(f!==null){for(;f.lastChild&&this._isWhitespace(f.lastChild);)f.lastChild.remove();f=null}y=v}if(this._hasSingleTagInsideElement(l,"P")&&this._getLinkDensity(l)<.25){var _=l.children[0];l.parentNode.replaceChild(_,l),l=_,o.push(l)}else this._hasChildBlockElement(l)||(l=this._setNodeTag(l,"P"),o.push(l))}l=this._getNextNode(l)}var S=[];this._forEachNode(o,function(k){if(!(!k.parentNode||typeof k.parentNode.tagName>"u")){var B=this._getInnerText(k);if(!(B.length<25)){var Ee=this._getNodeAncestors(k,5);if(Ee.length!==0){var le=0;le+=1,le+=B.split(this.REGEXPS.commas).length,le+=Math.min(Math.floor(B.length/100),3),this._forEachNode(Ee,function(X,me){if(!(!X.tagName||!X.parentNode||typeof X.parentNode.tagName>"u")){if(typeof X.readability>"u"&&(this._initializeNode(X),S.push(X)),me===0)var de=1;else me===1?de=2:de=me*3;X.readability.contentScore+=le/de}})}}}});for(var x=[],L=0,P=S.length;L<P;L+=1){var T=S[L],O=T.readability.contentScore*(1-this._getLinkDensity(T));T.readability.contentScore=O,this.log("Candidate:",T,"with score "+O);for(var R=0;R<this._nbTopCandidates;R++){var D=x[R];if(!D||O>D.readability.contentScore){x.splice(R,0,T),x.length>this._nbTopCandidates&&x.pop();break}}}var g=x[0]||null,M=!1,p;if(g===null||g.tagName==="BODY"){for(g=r.createElement("DIV"),M=!0;e.firstChild;)this.log("Moving child out:",e.firstChild),g.appendChild(e.firstChild);e.appendChild(g),this._initializeNode(g)}else if(g){for(var w=[],U=1;U<x.length;U++)x[U].readability.contentScore/g.readability.contentScore>=.75&&w.push(this._getNodeAncestors(x[U]));var F=3;if(w.length>=F)for(p=g.parentNode;p.tagName!=="BODY";){for(var V=0,j=0;j<w.length&&V<F;j++)V+=Number(w[j].includes(p));if(V>=F){g=p;break}p=p.parentNode}g.readability||this._initializeNode(g),p=g.parentNode;for(var Y=g.readability.contentScore,ne=Y/3;p.tagName!=="BODY";){if(!p.readability){p=p.parentNode;continue}var J=p.readability.contentScore;if(J<ne)break;if(J>Y){g=p;break}Y=p.readability.contentScore,p=p.parentNode}for(p=g.parentNode;p.tagName!="BODY"&&p.children.length==1;)g=p,p=g.parentNode;g.readability||this._initializeNode(g)}var I=r.createElement("DIV");s&&(I.id="readability-content");var ie=Math.max(10,g.readability.contentScore*.2);p=g.parentNode;for(var z=p.children,W=0,Q=z.length;W<Q;W++){var N=z[W],$=!1;if(this.log("Looking at sibling node:",N,N.readability?"with score "+N.readability.contentScore:""),this.log("Sibling has score",N.readability?N.readability.contentScore:"Unknown"),N===g)$=!0;else{var Z=0;if(N.className===g.className&&g.className!==""&&(Z+=g.readability.contentScore*.2),N.readability&&N.readability.contentScore+Z>=ie)$=!0;else if(N.nodeName==="P"){var ee=this._getLinkDensity(N),ae=this._getInnerText(N),ue=ae.length;(ue>80&&ee<.25||ue<80&&ue>0&&ee===0&&ae.search(/\.( |$)/)!==-1)&&($=!0)}}$&&(this.log("Appending node:",N),this.ALTER_TO_DIV_EXCEPTIONS.includes(N.nodeName)||(this.log("Altering sibling:",N,"to div."),N=this._setNodeTag(N,"DIV")),I.appendChild(N),z=p.children,W-=1,Q-=1)}if(this._debug&&this.log("Article content pre-prep: "+I.innerHTML),this._prepArticle(I),this._debug&&this.log("Article content post-prep: "+I.innerHTML),M)g.id="readability-page-1",g.className="page";else{var oe=r.createElement("DIV");for(oe.id="readability-page-1",oe.className="page";I.firstChild;)oe.appendChild(I.firstChild);I.appendChild(oe)}this._debug&&this.log("Article content after paging: "+I.innerHTML);var he=!0,pe=this._getInnerText(I,!0).length;if(pe<this._charThreshold)if(he=!1,e.innerHTML=i,this._attempts.push({articleContent:I,textLength:pe}),this._flagIsActive(this.FLAG_STRIP_UNLIKELYS))this._removeFlag(this.FLAG_STRIP_UNLIKELYS);else if(this._flagIsActive(this.FLAG_WEIGHT_CLASSES))this._removeFlag(this.FLAG_WEIGHT_CLASSES);else if(this._flagIsActive(this.FLAG_CLEAN_CONDITIONALLY))this._removeFlag(this.FLAG_CLEAN_CONDITIONALLY);else{if(this._attempts.sort(function(k,B){return B.textLength-k.textLength}),!this._attempts[0].textLength)return null;I=this._attempts[0].articleContent,he=!0}if(he){var $e=[p,g].concat(this._getNodeAncestors(p));return this._someNode($e,function(k){if(!k.tagName)return!1;var B=k.getAttribute("dir");return B?(this._articleDir=B,!0):!1}),I}}},_unescapeHtmlEntities(e){if(!e)return e;var r=this.HTML_ESCAPE_MAP;return e.replace(/&(quot|amp|apos|lt|gt);/g,function(s,i){return r[i]}).replace(/&#(?:x([0-9a-f]+)|([0-9]+));/gi,function(s,i,a){var o=parseInt(i||a,i?16:10);return(o==0||o>1114111||o>=55296&&o<=57343)&&(o=65533),String.fromCodePoint(o)})},_getJSONLD(e){var r=this._getAllNodesWithTag(e,["script"]),s;return this._forEachNode(r,function(i){if(!s&&i.getAttribute("type")==="application/ld+json")try{var a=i.textContent.replace(/^\s*<!\[CDATA\[|\]\]>\s*$/g,""),o=JSON.parse(a);if(Array.isArray(o)&&(o=o.find(d=>d["@type"]&&d["@type"].match(this.REGEXPS.jsonLdArticleTypes)),!o))return;var l=/^https?\:\/\/schema\.org\/?$/,c=typeof o["@context"]=="string"&&o["@context"].match(l)||typeof o["@context"]=="object"&&typeof o["@context"]["@vocab"]=="string"&&o["@context"]["@vocab"].match(l);if(!c||(!o["@type"]&&Array.isArray(o["@graph"])&&(o=o["@graph"].find(d=>(d["@type"]||"").match(this.REGEXPS.jsonLdArticleTypes))),!o||!o["@type"]||!o["@type"].match(this.REGEXPS.jsonLdArticleTypes)))return;if(s={},typeof o.name=="string"&&typeof o.headline=="string"&&o.name!==o.headline){var m=this._getArticleTitle(),u=this._textSimilarity(o.name,m)>.75,h=this._textSimilarity(o.headline,m)>.75;h&&!u?s.title=o.headline:s.title=o.name}else typeof o.name=="string"?s.title=o.name.trim():typeof o.headline=="string"&&(s.title=o.headline.trim());o.author&&(typeof o.author.name=="string"?s.byline=o.author.name.trim():Array.isArray(o.author)&&o.author[0]&&typeof o.author[0].name=="string"&&(s.byline=o.author.filter(function(d){return d&&typeof d.name=="string"}).map(function(d){return d.name.trim()}).join(", "))),typeof o.description=="string"&&(s.excerpt=o.description.trim()),o.publisher&&typeof o.publisher.name=="string"&&(s.siteName=o.publisher.name.trim()),typeof o.datePublished=="string"&&(s.datePublished=o.datePublished.trim())}catch(d){this.log(d.message)}}),s||{}},_getArticleMetadata(e){var r={},s={},i=this._doc.getElementsByTagName("meta"),a=/\s*(article|dc|dcterm|og|twitter)\s*:\s*(author|creator|description|published_time|title|site_name)\s*/gi,o=/^\s*(?:(dc|dcterm|og|twitter|parsely|weibo:(article|webpage))\s*[-\.:]\s*)?(author|creator|pub-date|description|title|site_name)\s*$/i;this._forEachNode(i,function(c){var m=c.getAttribute("name"),u=c.getAttribute("property"),h=c.getAttribute("content");if(h){var d=null,f=null;u&&(d=u.match(a),d&&(f=d[0].toLowerCase().replace(/\s/g,""),s[f]=h.trim())),!d&&m&&o.test(m)&&(f=m,h&&(f=f.toLowerCase().replace(/\s/g,"").replace(/\./g,":"),s[f]=h.trim()))}}),r.title=e.title||s["dc:title"]||s["dcterm:title"]||s["og:title"]||s["weibo:article:title"]||s["weibo:webpage:title"]||s.title||s["twitter:title"]||s["parsely-title"],r.title||(r.title=this._getArticleTitle());const l=typeof s["article:author"]=="string"&&!this._isUrl(s["article:author"])?s["article:author"]:void 0;return r.byline=e.byline||s["dc:creator"]||s["dcterm:creator"]||s.author||s["parsely-author"]||l,r.excerpt=e.excerpt||s["dc:description"]||s["dcterm:description"]||s["og:description"]||s["weibo:article:description"]||s["weibo:webpage:description"]||s.description||s["twitter:description"],r.siteName=e.siteName||s["og:site_name"],r.publishedTime=e.datePublished||s["article:published_time"]||s["parsely-pub-date"]||null,r.title=this._unescapeHtmlEntities(r.title),r.byline=this._unescapeHtmlEntities(r.byline),r.excerpt=this._unescapeHtmlEntities(r.excerpt),r.siteName=this._unescapeHtmlEntities(r.siteName),r.publishedTime=this._unescapeHtmlEntities(r.publishedTime),r},_isSingleImage(e){for(;e;){if(e.tagName==="IMG")return!0;if(e.children.length!==1||e.textContent.trim()!=="")return!1;e=e.children[0]}return!1},_unwrapNoscriptImages(e){var r=Array.from(e.getElementsByTagName("img"));this._forEachNode(r,function(i){for(var a=0;a<i.attributes.length;a++){var o=i.attributes[a];switch(o.name){case"src":case"srcset":case"data-src":case"data-srcset":return}if(/\.(jpg|jpeg|png|webp)/i.test(o.value))return}i.remove()});var s=Array.from(e.getElementsByTagName("noscript"));this._forEachNode(s,function(i){if(this._isSingleImage(i)){var a=e.createElement("div");a.innerHTML=i.innerHTML;var o=i.previousElementSibling;if(o&&this._isSingleImage(o)){var l=o;l.tagName!=="IMG"&&(l=o.getElementsByTagName("img")[0]);for(var c=a.getElementsByTagName("img")[0],m=0;m<l.attributes.length;m++){var u=l.attributes[m];if(u.value!==""&&(u.name==="src"||u.name==="srcset"||/\.(jpg|jpeg|png|webp)/i.test(u.value))){if(c.getAttribute(u.name)===u.value)continue;var h=u.name;c.hasAttribute(h)&&(h="data-old-"+h),c.setAttribute(h,u.value)}}i.parentNode.replaceChild(a.firstElementChild,o)}}})},_removeScripts(e){this._removeNodes(this._getAllNodesWithTag(e,["script","noscript"]))},_hasSingleTagInsideElement(e,r){return e.children.length!=1||e.children[0].tagName!==r?!1:!this._someNode(e.childNodes,function(s){return s.nodeType===this.TEXT_NODE&&this.REGEXPS.hasContent.test(s.textContent)})},_isElementWithoutContent(e){return e.nodeType===this.ELEMENT_NODE&&!e.textContent.trim().length&&(!e.children.length||e.children.length==e.getElementsByTagName("br").length+e.getElementsByTagName("hr").length)},_hasChildBlockElement(e){return this._someNode(e.childNodes,function(r){return this.DIV_TO_P_ELEMS.has(r.tagName)||this._hasChildBlockElement(r)})},_isPhrasingContent(e){return e.nodeType===this.TEXT_NODE||this.PHRASING_ELEMS.includes(e.tagName)||(e.tagName==="A"||e.tagName==="DEL"||e.tagName==="INS")&&this._everyNode(e.childNodes,this._isPhrasingContent)},_isWhitespace(e){return e.nodeType===this.TEXT_NODE&&e.textContent.trim().length===0||e.nodeType===this.ELEMENT_NODE&&e.tagName==="BR"},_getInnerText(e,r){r=typeof r>"u"?!0:r;var s=e.textContent.trim();return r?s.replace(this.REGEXPS.normalize," "):s},_getCharCount(e,r){return r=r||",",this._getInnerText(e).split(r).length-1},_cleanStyles(e){if(!(!e||e.tagName.toLowerCase()==="svg")){for(var r=0;r<this.PRESENTATIONAL_ATTRIBUTES.length;r++)e.removeAttribute(this.PRESENTATIONAL_ATTRIBUTES[r]);this.DEPRECATED_SIZE_ATTRIBUTE_ELEMS.includes(e.tagName)&&(e.removeAttribute("width"),e.removeAttribute("height"));for(var s=e.firstElementChild;s!==null;)this._cleanStyles(s),s=s.nextElementSibling}},_getLinkDensity(e){var r=this._getInnerText(e).length;if(r===0)return 0;var s=0;return this._forEachNode(e.getElementsByTagName("a"),function(i){var a=i.getAttribute("href"),o=a&&this.REGEXPS.hashUrl.test(a)?.3:1;s+=this._getInnerText(i).length*o}),s/r},_getClassWeight(e){if(!this._flagIsActive(this.FLAG_WEIGHT_CLASSES))return 0;var r=0;return typeof e.className=="string"&&e.className!==""&&(this.REGEXPS.negative.test(e.className)&&(r-=25),this.REGEXPS.positive.test(e.className)&&(r+=25)),typeof e.id=="string"&&e.id!==""&&(this.REGEXPS.negative.test(e.id)&&(r-=25),this.REGEXPS.positive.test(e.id)&&(r+=25)),r},_clean(e,r){var s=["object","embed","iframe"].includes(r);this._removeNodes(this._getAllNodesWithTag(e,[r]),function(i){if(s){for(var a=0;a<i.attributes.length;a++)if(this._allowedVideoRegex.test(i.attributes[a].value))return!1;if(i.tagName==="object"&&this._allowedVideoRegex.test(i.innerHTML))return!1}return!0})},_hasAncestorTag(e,r,s,i){s=s||3,r=r.toUpperCase();for(var a=0;e.parentNode;){if(s>0&&a>s)return!1;if(e.parentNode.tagName===r&&(!i||i(e.parentNode)))return!0;e=e.parentNode,a++}return!1},_getRowAndColumnCount(e){for(var r=0,s=0,i=e.getElementsByTagName("tr"),a=0;a<i.length;a++){var o=i[a].getAttribute("rowspan")||0;o&&(o=parseInt(o,10)),r+=o||1;for(var l=0,c=i[a].getElementsByTagName("td"),m=0;m<c.length;m++){var u=c[m].getAttribute("colspan")||0;u&&(u=parseInt(u,10)),l+=u||1}s=Math.max(s,l)}return{rows:r,columns:s}},_markDataTables(e){for(var r=e.getElementsByTagName("table"),s=0;s<r.length;s++){var i=r[s],a=i.getAttribute("role");if(a=="presentation"){i._readabilityDataTable=!1;continue}var o=i.getAttribute("datatable");if(o=="0"){i._readabilityDataTable=!1;continue}var l=i.getAttribute("summary");if(l){i._readabilityDataTable=!0;continue}var c=i.getElementsByTagName("caption")[0];if(c&&c.childNodes.length){i._readabilityDataTable=!0;continue}var m=["col","colgroup","tfoot","thead","th"],u=function(d){return!!i.getElementsByTagName(d)[0]};if(m.some(u)){this.log("Data table because found data-y descendant"),i._readabilityDataTable=!0;continue}if(i.getElementsByTagName("table")[0]){i._readabilityDataTable=!1;continue}var h=this._getRowAndColumnCount(i);if(h.columns==1||h.rows==1){i._readabilityDataTable=!1;continue}if(h.rows>=10||h.columns>4){i._readabilityDataTable=!0;continue}i._readabilityDataTable=h.rows*h.columns>10}},_fixLazyImages(e){this._forEachNode(this._getAllNodesWithTag(e,["img","picture","figure"]),function(r){if(r.src&&this.REGEXPS.b64DataUrl.test(r.src)){var s=this.REGEXPS.b64DataUrl.exec(r.src);if(s[1]==="image/svg+xml")return;for(var i=!1,a=0;a<r.attributes.length;a++){var o=r.attributes[a];if(o.name!=="src"&&/\.(jpg|jpeg|png|webp)/i.test(o.value)){i=!0;break}}if(i){var l=s[0].length,c=r.src.length-l;c<133&&r.removeAttribute("src")}}if(!((r.src||r.srcset&&r.srcset!="null")&&!r.className.toLowerCase().includes("lazy"))){for(var m=0;m<r.attributes.length;m++)if(o=r.attributes[m],!(o.name==="src"||o.name==="srcset"||o.name==="alt")){var u=null;if(/\.(jpg|jpeg|png|webp)\s+\d/.test(o.value)?u="srcset":/^\s*\S+\.(jpg|jpeg|png|webp)\S*\s*$/.test(o.value)&&(u="src"),u){if(r.tagName==="IMG"||r.tagName==="PICTURE")r.setAttribute(u,o.value);else if(r.tagName==="FIGURE"&&!this._getAllNodesWithTag(r,["img","picture"]).length){var h=this._doc.createElement("img");h.setAttribute(u,o.value),r.appendChild(h)}}}}})},_getTextDensity(e,r){var s=this._getInnerText(e,!0).length;if(s===0)return 0;var i=0,a=this._getAllNodesWithTag(e,r);return this._forEachNode(a,o=>i+=this._getInnerText(o,!0).length),i/s},_cleanConditionally(e,r){this._flagIsActive(this.FLAG_CLEAN_CONDITIONALLY)&&this._removeNodes(this._getAllNodesWithTag(e,[r]),function(s){var i=function(p){return p._readabilityDataTable},a=r==="ul"||r==="ol";if(!a){var o=0,l=this._getAllNodesWithTag(s,["ul","ol"]);this._forEachNode(l,p=>o+=this._getInnerText(p).length),a=o/this._getInnerText(s).length>.9}if(r==="table"&&i(s)||this._hasAncestorTag(s,"table",-1,i)||this._hasAncestorTag(s,"code")||[...s.getElementsByTagName("table")].some(p=>p._readabilityDataTable))return!1;var c=this._getClassWeight(s);this.log("Cleaning Conditionally",s);var m=0;if(c+m<0)return!0;if(this._getCharCount(s,",")<10){for(var u=s.getElementsByTagName("p").length,h=s.getElementsByTagName("img").length,d=s.getElementsByTagName("li").length-100,f=s.getElementsByTagName("input").length,y=this._getTextDensity(s,["h1","h2","h3","h4","h5","h6"]),v=0,_=this._getAllNodesWithTag(s,["object","embed","iframe"]),S=0;S<_.length;S++){for(var x=0;x<_[S].attributes.length;x++)if(this._allowedVideoRegex.test(_[S].attributes[x].value))return!1;if(_[S].tagName==="object"&&this._allowedVideoRegex.test(_[S].innerHTML))return!1;v++}var L=this._getInnerText(s);if(this.REGEXPS.adWords.test(L)||this.REGEXPS.loadingWords.test(L))return!0;var P=L.length,T=this._getLinkDensity(s),O=["SPAN","LI","TD"].concat(Array.from(this.DIV_TO_P_ELEMS)),R=this._getTextDensity(s,O),D=this._hasAncestorTag(s,"figure"),g=(()=>{const w=[];return!D&&h>1&&u/h<.5&&w.push(`Bad p to img ratio (img=${h}, p=${u})`),!a&&d>u&&w.push(`Too many li's outside of a list. (li=${d} > p=${u})`),f>Math.floor(u/3)&&w.push(`Too many inputs per p. (input=${f}, p=${u})`),!a&&!D&&y<.9&&P<25&&(h===0||h>2)&&T>0&&w.push(`Suspiciously short. (headingDensity=${y}, img=${h}, linkDensity=${T})`),!a&&c<25&&T>.2+this._linkDensityModifier&&w.push(`Low weight and a little linky. (linkDensity=${T})`),c>=25&&T>.5+this._linkDensityModifier&&w.push(`High weight and mostly links. (linkDensity=${T})`),(v===1&&P<75||v>1)&&w.push(`Suspicious embed. (embedCount=${v}, contentLength=${P})`),h===0&&R===0&&w.push(`No useful content. (img=${h}, textDensity=${R})`),w.length?(this.log("Checks failed",w),!0):!1})();if(a&&g){for(var M=0;M<s.children.length;M++)if(s.children[M].children.length>1)return g;let w=s.getElementsByTagName("li").length;if(h==w)return!1}return g}return!1})},_cleanMatchedNodes(e,r){for(var s=this._getNextNode(e,!0),i=this._getNextNode(e);i&&i!=s;)r.call(this,i,i.className+" "+i.id)?i=this._removeAndGetNext(i):i=this._getNextNode(i)},_cleanHeaders(e){let r=this._getAllNodesWithTag(e,["h1","h2"]);this._removeNodes(r,function(s){let i=this._getClassWeight(s)<0;return i&&this.log("Removing header with low class weight:",s),i})},_headerDuplicatesTitle(e){if(e.tagName!="H1"&&e.tagName!="H2")return!1;var r=this._getInnerText(e,!1);return this.log("Evaluating similarity of header:",r,this._articleTitle),this._textSimilarity(this._articleTitle,r)>.75},_flagIsActive(e){return(this._flags&e)>0},_removeFlag(e){this._flags=this._flags&~e},_isProbablyVisible(e){return(!e.style||e.style.display!="none")&&(!e.style||e.style.visibility!="hidden")&&!e.hasAttribute("hidden")&&(!e.hasAttribute("aria-hidden")||e.getAttribute("aria-hidden")!="true"||e.className&&e.className.includes&&e.className.includes("fallback-image"))},parse(){if(this._maxElemsToParse>0){var e=this._doc.getElementsByTagName("*").length;if(e>this._maxElemsToParse)throw new Error("Aborting parsing document; "+e+" elements found")}this._unwrapNoscriptImages(this._doc);var r=this._disableJSONLD?{}:this._getJSONLD(this._doc);this._removeScripts(this._doc),this._prepDocument();var s=this._getArticleMetadata(r);this._metadata=s,this._articleTitle=s.title;var i=this._grabArticle();if(!i)return null;if(this.log("Grabbed: "+i.innerHTML),this._postProcessContent(i),!s.excerpt){var a=i.getElementsByTagName("p");a.length&&(s.excerpt=a[0].textContent.trim())}var o=i.textContent;return{title:this._articleTitle,byline:s.byline||this._articleByline,dir:this._articleDir,lang:this._articleLang,content:this._serializer(i),textContent:o,length:o.length,excerpt:s.excerpt,siteName:s.siteName||this._articleSiteName,publishedTime:s.publishedTime}}},t.exports=n})(Pe);var Qt=Pe.exports,Zt={exports:{}};(function(t){var n={unlikelyCandidates:/-ad-|ai2html|banner|breadcrumbs|combx|comment|community|cover-wrap|disqus|extra|footer|gdpr|header|legends|menu|related|remark|replies|rss|shoutbox|sidebar|skyscraper|social|sponsor|supplemental|ad-break|agegate|pagination|pager|popup|yom-remote/i,okMaybeItsACandidate:/and|article|body|column|content|main|shadow/i};function e(s){return(!s.style||s.style.display!="none")&&!s.hasAttribute("hidden")&&(!s.hasAttribute("aria-hidden")||s.getAttribute("aria-hidden")!="true"||s.className&&s.className.includes&&s.className.includes("fallback-image"))}function r(s,i={}){typeof i=="function"&&(i={visibilityChecker:i});var a={minScore:20,minContentLength:140,visibilityChecker:e};i=Object.assign(a,i);var o=s.querySelectorAll("p, pre, article"),l=s.querySelectorAll("div > br");if(l.length){var c=new Set(o);[].forEach.call(l,function(u){c.add(u.parentNode)}),o=Array.from(c)}var m=0;return[].some.call(o,function(u){if(!i.visibilityChecker(u))return!1;var h=u.className+" "+u.id;if(n.unlikelyCandidates.test(h)&&!n.okMaybeItsACandidate.test(h)||u.matches("li p"))return!1;var d=u.textContent.trim().length;return d<i.minContentLength?!1:(m+=Math.sqrt(d-i.minContentLength),m>i.minScore)})}t.exports=r})(Zt);var er=Qt,Ae={Readability:er};function tr(){try{if(Ae.Readability){const t=document.cloneNode(!0),e=new Ae.Readability(t,{debug:!1,maxElemsToDivideToDivs:5,nbTopCandidates:5,charThreshold:500,classesToPreserve:["ai-chat-container","ai-highlight","ai-underline"]}).parse();if(e)return{title:e.title||document.title,content:e.textContent||e.content||"",excerpt:e.excerpt||"",byline:e.byline||void 0,length:e.length||0,siteName:e.siteName||void 0}}return Se()}catch(t){return console.error("页面总结失败:",t),Se()}}function Se(){var s,i;const t=document.querySelector('main, article, [role="main"], .content, #content')||document.body,n=rr(t),e=((i=(s=document.querySelector("h1"))==null?void 0:s.textContent)==null?void 0:i.trim())||document.title,r=n.substring(0,500).replace(/\s+/g," ").trim();return{title:e,content:n,excerpt:r,length:n.length}}function rr(t){var e;const n=t.cloneNode(!0);return n.querySelectorAll("script, style, noscript, iframe, embed, object").forEach(r=>r.remove()),n.querySelectorAll('[hidden], [style*="display: none"], [style*="visibility: hidden"]').forEach(r=>r.remove()),((e=n.textContent)==null?void 0:e.replace(/\s+/g," ").trim())||""}function sr(){const t=[];document.querySelectorAll('script[type="application/ld+json"]').forEach(r=>{try{const s=JSON.parse(r.textContent||"{}");Array.isArray(s)?t.push(...s):t.push(s)}catch(s){console.warn("解析 JSON-LD 失败:",s)}});const e=nr();return e.length>0&&t.push(...e),t}function nr(){const t=[];return document.querySelectorAll("[itemscope]").forEach(e=>{const r=e.getAttribute("itemtype"),s={};r&&(s["@type"]=r),e.querySelectorAll("[itemprop]").forEach(i=>{var l;const a=i.getAttribute("itemprop");if(!a)return;let o;i.hasAttribute("itemscope")?o=ir(i):i.tagName==="META"?o=i.getAttribute("content"):i.tagName==="IMG"?o=i.src:i.tagName==="A"?o=i.href:o=(l=i.textContent)==null?void 0:l.trim(),o&&(s[a]?(Array.isArray(s[a])||(s[a]=[s[a]]),s[a].push(o)):s[a]=o)}),Object.keys(s).length>0&&t.push(s)}),t}function ir(t){const n={},e=t.getAttribute("itemtype");return e&&(n["@type"]=e),t.querySelectorAll("[itemprop]").forEach(r=>{var i;const s=r.getAttribute("itemprop");s&&(n[s]=((i=r.textContent)==null?void 0:i.trim())||r.getAttribute("content"))}),n}function ar(){const t={title:document.title,url:window.location.href,description:"",keywords:[],author:"",og:{},twitter:{}};return document.querySelectorAll("meta").forEach(e=>{const r=e.getAttribute("name")||e.getAttribute("property"),s=e.getAttribute("content");!r||!s||(r==="description"?t.description=s:r==="keywords"?t.keywords=s.split(",").map(i=>i.trim()):r==="author"?t.author=s:r.startsWith("og:")?t.og[r.replace("og:","")]=s:r.startsWith("twitter:")&&(t.twitter[r.replace("twitter:","")]=s))}),t}function or(t){const{selector:n,dataType:e="all",fields:r}=t,s=n?document.querySelector(n):document.body;if(!s)return{type:"mixed",data:[],count:0};const i=[];if(e==="all"||e==="table"){const a=lr(s,r);a.count>0&&i.push(a)}if(e==="all"||e==="list"){const a=Me(s);a.count>0&&i.push(a)}if(e==="all"||e==="cards"){const a=cr(s);a.count>0&&i.push(a)}if(e==="all"||e==="form"){const a=mr(s);a.count>0&&i.push(a)}return i.length===0?{type:"mixed",data:[],count:0}:i.length===1?i[0]:{type:"mixed",data:i.flatMap(a=>a.data),count:i.reduce((a,o)=>a+o.count,0)}}function lr(t,n){const e=t.querySelectorAll("table"),r=[];return e.forEach(s=>{const i=Array.from(s.querySelectorAll("tr"));if(i.length===0)return;const a=s.querySelector("thead tr")||i[0],o=Array.from(a.querySelectorAll("th, td")).map(m=>{var u;return((u=m.textContent)==null?void 0:u.trim())||""});if(o.length===0)return;const l=n||o;(s.querySelector("thead"),i.slice(1)).forEach(m=>{const u=Array.from(m.querySelectorAll("td, th"));if(u.length===0)return;const h={};o.forEach((d,f)=>{var y;if(l.includes(d)&&u[f]){h[d]=((y=u[f].textContent)==null?void 0:y.trim())||"";const v=u[f].querySelector("a");v&&(h[`${d}_link`]=v.href);const _=u[f].querySelector("img");_&&(h[`${d}_image`]=_.src)}}),Object.keys(h).length>0&&r.push(h)})}),{type:"table",data:r,fields:n||Array.from(new Set(r.flatMap(s=>Object.keys(s)))),count:r.length}}function Me(t){const n=t.querySelectorAll('ul, ol, [role="list"]'),e=[];return n.forEach(r=>{Array.from(r.querySelectorAll(':scope > li, :scope > [role="listitem"]')).forEach((i,a)=>{var u,h;const o={index:a+1,text:((u=i.textContent)==null?void 0:u.trim())||""},l=i.querySelector("a");l&&(o.link=l.href,o.linkText=(h=l.textContent)==null?void 0:h.trim());const c=i.querySelector("img");c&&(o.image=c.src,o.imageAlt=c.alt);const m=i.querySelector("ul, ol");m&&(o.children=Me(m).data),e.push(o)})}),{type:"list",data:e,count:e.length}}function cr(t){const n=[".card",".product",".item",'[class*="card"]','[class*="Card"]','[class*="product"]','[class*="Product"]','[class*="item"]','[class*="Item"]'],e=[];if(n.forEach(s=>{t.querySelectorAll(s).forEach(a=>{e.includes(a)||e.push(a)})}),e.length===0){const s=ur(t);e.push(...s)}const r=e.map(s=>{var u,h,d,f;const i={},a=s.querySelector('h1, h2, h3, h4, h5, h6, [class*="title"], [class*="Title"], .title');a&&(i.title=(u=a.textContent)==null?void 0:u.trim());const o=s.querySelector('[class*="desc"], [class*="Desc"], .description, p');o&&(i.description=(h=o.textContent)==null?void 0:h.trim());const l=s.querySelector("img");l&&(i.image=l.src,i.imageAlt=l.alt);const c=s.querySelector("a");c&&(i.link=c.href);const m=(d=s.textContent)==null?void 0:d.match(/[\$¥€£]\s*[\d,]+\.?\d*/);return m&&(i.price=m[0]),i.text=(f=s.textContent)==null?void 0:f.trim(),i});return{type:"cards",data:r,count:r.length}}function ur(t){const n=[],e=Array.from(t.children);if(e.length>=2){const r=e[0],s=xe(r),i=e.filter(a=>{const o=xe(a);return hr(s,o)>.7});i.length>=2&&n.push(...i)}return n}function xe(t){const n=t.tagName.toLowerCase(),e=Array.from(t.children).map(r=>r.tagName.toLowerCase()).join(",");return`${n}[${e}]`}function hr(t,n){if(t===n)return 1;const e=t.split(/[\[\],]/),r=n.split(/[\[\],]/);return e.filter(i=>r.includes(i)).length/Math.max(e.length,r.length)}function mr(t){const n=t.querySelectorAll("form"),e=[];return n.forEach(r=>{const s={action:r.action||"",method:r.method||"get"},i={};r.querySelectorAll("input, textarea, select").forEach(a=>{const o=a.name,l=a.type||"text",c=a.value,m=a.placeholder,u=dr(a);o?i[o]={type:l,value:l==="password"?void 0:c,placeholder:m,label:u}:u&&(i[u]={type:l,value:l==="password"?void 0:c,placeholder:m})}),s.fields=i,e.push(s)}),{type:"form",data:e,count:e.length}}function dr(t){var r,s,i;if(t.id){const a=document.querySelector(`label[for="${t.id}"]`);if(a)return(r=a.textContent)==null?void 0:r.trim()}const n=t.closest("label");if(n){const a=n.cloneNode(!0);return a.querySelectorAll("input, textarea, select").forEach(o=>o.remove()),(s=a.textContent)==null?void 0:s.trim()}let e=t.previousElementSibling;for(;e;){if(e.tagName==="LABEL")return(i=e.textContent)==null?void 0:i.trim();e=e.previousElementSibling}}let E=null,A=null,te=null,H=!1,q=null,C=null,K=520;const fr=320,gr=1e3;let re=!1;function ke(t){q&&(q.textContent=`
      /* 核心：缩小 html 宽度，让页面内容自然收缩 */
      html {
        width: calc(100% - ${t}px) !important;
        min-width: auto !important;
        overflow-x: hidden !important;
        position: relative !important;
      }

      /* 确保 body 跟随 html 宽度 */
      body {
        width: 100% !important;
        min-width: auto !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
        position: relative !important;
      }

      /* 确保聊天容器不受影响，固定在视口右侧 */
      #ai-chat-container {
        position: fixed !important;
        right: 0 !important;
        top: 0 !important;
        width: ${t}px !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box !important;
      }
    `)}function Ce(){re=!1;const t=document.getElementById("ai-chat-resize-overlay");t&&t.remove(),C&&(C.style.background="transparent")}function pr(){if(!C)return;let t=0,n=0;const e=i=>{i.preventDefault(),i.stopPropagation(),Ce(),re=!0,t=i.clientX,n=K;const a=document.createElement("div");a.id="ai-chat-resize-overlay",a.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2147483646;
      cursor: ew-resize;
      background: transparent;
    `,document.body.appendChild(a),C&&(C.style.background="rgba(102, 126, 234, 0.5)"),document.addEventListener("mousemove",r),document.addEventListener("mouseup",s),document.addEventListener("mouseleave",s)},r=i=>{if(!re)return;const a=t-i.clientX;let o=n+a;o=Math.max(fr,Math.min(gr,o)),K=o,A&&(A.style.width=`${o}px`),ke(o)},s=()=>{re&&(chrome.storage.local.set({chatWidth:K}),Ce(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",s),document.removeEventListener("mouseleave",s))};C.addEventListener("mousedown",e)}function ge(){return{url:window.location.href,title:document.title}}async function br(t){const n=ge();if(!t)return(await chrome.runtime.sendMessage({type:"CREATE_SESSION",payload:{title:n.title||"新对话",pageUrl:n.url,pageTitle:n.title}})).data.id;const e=await chrome.runtime.sendMessage({type:"GET_SESSION_BY_TAB",payload:{tabId:t}});return e.success&&e.data?(await chrome.runtime.sendMessage({type:"UPDATE_SESSION",payload:{sessionId:e.data.id,updates:{pageUrl:n.url,pageTitle:n.title}}}),e.data.id):(await chrome.runtime.sendMessage({type:"CREATE_SESSION",payload:{title:n.title||"新对话",tabId:t,pageUrl:n.url,pageTitle:n.title}})).data.id}function ce(t){const n=ge(),e=chrome.runtime.getURL(`chat.html?sessionId=${t}&pageUrl=${encodeURIComponent(n.url)}&pageTitle=${encodeURIComponent(n.title)}`);if(E){E.src=e,setTimeout(()=>{E!=null&&E.contentWindow&&E.contentWindow.postMessage({type:"PAGE_INFO",url:n.url,title:n.title},"*")},500);return}A=document.createElement("div"),A.id="ai-chat-container",A.style.cssText=`
    position: fixed;
    width: ${K}px;
    height: 100vh;
    right: 0;
    top: 0;
    z-index: 2147483647;
    background: white;
    border-left: 1px solid #e5e7eb;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  `,C=document.createElement("div"),C.id="ai-chat-resize-handle",C.style.cssText=`
    position: absolute;
    left: 0;
    top: 0;
    width: 6px;
    height: 100%;
    cursor: ew-resize;
    background: transparent;
    z-index: 2147483648;
    transition: background 0.2s;
  `,C.addEventListener("mouseenter",()=>{C&&(C.style.background="rgba(102, 126, 234, 0.3)")}),C.addEventListener("mouseleave",()=>{C&&!re&&(C.style.background="transparent")}),E=document.createElement("iframe"),E.src=e,E.style.cssText=`
    width: 100%;
    height: 100%;
    border: none;
  `,A.appendChild(C),A.appendChild(E),document.body.appendChild(A),pr(),q=document.createElement("style"),q.id="ai-chat-layout-style",ke(K),document.head.appendChild(q);const r=new ResizeObserver(()=>{A&&(A.style.height=`${window.innerHeight}px`)});r.observe(document.documentElement),A.__resizeObserver=r,window.addEventListener("message",yr),H&&chrome.storage.local.set({chatPinned:!0,chatSessionId:t})}let Ie=window.location.href;const Er=new MutationObserver(()=>{if(window.location.href!==Ie&&(Ie=window.location.href,E!=null&&E.contentWindow)){const t=ge();E.contentWindow.postMessage({type:"PAGE_INFO",url:t.url,title:t.title},"*")}});Er.observe(document.body,{childList:!0,subtree:!0});function yr(t){t.source===(E==null?void 0:E.contentWindow)&&(console.log("Received message from chat:",t.data),t.data.type==="CLOSE_CHAT"?Ue():t.data.type==="PIN_CHAT"&&(console.log("Handling PIN_CHAT"),vr()))}function vr(){H=!H,console.log("togglePin called, new isPinned:",H),H?(chrome.storage.local.set({chatPinned:!0,chatSessionId:te},()=>{console.log("Saved pin state to storage")}),E!=null&&E.contentWindow&&(E.contentWindow.postMessage({type:"PIN_STATUS_CHANGED",isPinned:!0},"*"),console.log("Sent PIN_STATUS_CHANGED: true to chat"))):(chrome.storage.local.remove(["chatPinned","chatSessionId"],()=>{console.log("Removed pin state from storage")}),E!=null&&E.contentWindow&&(E.contentWindow.postMessage({type:"PIN_STATUS_CHANGED",isPinned:!1},"*"),console.log("Sent PIN_STATUS_CHANGED: false to chat")))}function Ue(){if(A){const t=A.__resizeObserver;t&&t.disconnect(),A.remove(),A=null,E=null,C=null,q&&(q.remove(),q=null);const n=document.getElementById("ai-chat-resize-overlay");n&&n.remove(),H||chrome.storage.local.remove(["chatPinned","chatSessionId"])}}chrome.storage.local.get(["chatPinned","chatSessionId","chatWidth"],t=>{t.chatWidth&&(K=t.chatWidth),t.chatPinned&&t.chatSessionId&&(H=!0,te=t.chatSessionId,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{ce(t.chatSessionId)}):ce(t.chatSessionId))});chrome.runtime.onMessage.addListener((t,n,e)=>{var r,s,i;if(t.type==="OPEN_CHAT")if(t.sessionId)te=t.sessionId,A?E.src=chrome.runtime.getURL(`chat.html?sessionId=${t.sessionId}`):ce(t.sessionId),e({success:!0});else{const a=t.tabId;return br(a).then(o=>{te=o,A?E.src=chrome.runtime.getURL(`chat.html?sessionId=${o}`):ce(o),e({success:!0,sessionId:o})}).catch(o=>{console.error("Failed to get/create session:",o),e({success:!1,error:o.message})}),!0}else if(t.type==="CLOSE_CHAT")Ue(),e({success:!0});else if(t.type==="CHECK_CHAT_STATUS")e({isOpen:!!A,isPinned:H,sessionId:te});else if(t.type==="GET_PAGE_CONTEXT"){const a=((r=t.payload)==null?void 0:r.userMessage)||"";console.log("[Content] GET_PAGE_CONTEXT 被调用，userMessage:",a);const o=st(a);console.log("[Content] 返回的 context 元素数量:",(s=o.elements)==null?void 0:s.length),e({success:!0,data:o})}else if(t.type==="REQUEST_MORE_ELEMENTS"){const a=t.payload||{},o=nt(a);e({success:!0,data:o})}else if(t.type==="EXECUTE_PAGE_ACTION"){const a=t.payload;return console.log("[Content] EXECUTE_PAGE_ACTION 被调用:",JSON.stringify(a,null,2)),De(a).then(o=>{console.log("[Content] EXECUTE_PAGE_ACTION 结果:",o),e({success:o.success,data:o})}),!0}else if(t.type==="EXECUTE_BATCH_ACTIONS"){const a=t.payload;return console.log("[Content] EXECUTE_BATCH_ACTIONS 被调用，actions 数量:",a.length),Kt(a).then(o=>{console.log("[Content] EXECUTE_BATCH_ACTIONS 结果:",o),e({success:o.success,data:o})}),!0}else if(t.type==="CLEAR_AI_STYLES")Jt(),e({success:!0});else if(t.type==="GET_SELECTED_TEXT"){const a=((i=window.getSelection())==null?void 0:i.toString())||"";e({success:!0,data:a})}else{if(t.type==="CAPTURE_FULL_PAGE")return _r(t.payload).then(a=>{e(a)}),!0;if(t.type==="COPY_IMAGE_TO_CLIPBOARD")return Nr(t.payload.dataUrl).then(a=>{e(a)}),!0;if(t.type==="SUMMARIZE_PAGE"){const a=t.payload||{},o=tr(),l={success:!!o};o?(l.summary=o,a.includeStructuredData&&(l.structuredData=sr()),a.includeMetadata&&(l.metadata=ar())):l.error="无法提取页面内容",e({success:!0,data:l})}else if(t.type==="EXTRACT_DATA"){const a=t.payload||{},o=or(a);e({success:!0,data:o})}}return!0});async function _r(t){try{const n=t.format||"png",e=t.quality||90,r=window.scrollY,s=window.scrollX,i=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),a=Math.max(document.body.scrollWidth,document.body.offsetWidth,document.documentElement.clientWidth,document.documentElement.scrollWidth,document.documentElement.offsetWidth),o=window.innerHeight,l=window.innerWidth;if(i<=o&&a<=l)return{success:!0,data:await Le(n,e)};const c=Math.ceil(i/o),m=Math.ceil(a/l),u=document.createElement("canvas"),h=u.getContext("2d");if(!h)return{success:!1,error:"无法创建 Canvas 上下文"};u.width=Math.min(a,16384),u.height=Math.min(i,16384);for(let y=0;y<c;y++)for(let v=0;v<m;v++){const _=v*l,S=y*o;window.scrollTo(_,S),await new Promise(L=>setTimeout(L,200));const x=await Le(n,e);await new Promise((L,P)=>{const T=new Image;T.onload=()=>{const O=_,R=S,D=Math.min(l,a-_,u.width-O),g=Math.min(o,i-S,u.height-R);h.drawImage(T,0,0,D,g,O,R,D,g),L()},T.onerror=P,T.src=x})}window.scrollTo(s,r);const d=n==="jpeg"?"image/jpeg":"image/png";return{success:!0,data:u.toDataURL(d,e/100)}}catch(n){return console.error("全页截图失败:",n),{success:!1,error:String(n)}}}function Le(t,n){return new Promise((e,r)=>{chrome.runtime.sendMessage({type:"CAPTURE_VISIBLE_TAB",payload:{format:t,quality:n}},s=>{s!=null&&s.success&&s.data?e(s.data):r(new Error((s==null?void 0:s.error)||"截图失败"))})})}async function Nr(t){try{const e=await(await fetch(t)).blob();return await navigator.clipboard.write([new ClipboardItem({[e.type]:e})]),{success:!0}}catch(n){return console.error("复制到剪贴板失败:",n),{success:!1,error:String(n)}}}

})()