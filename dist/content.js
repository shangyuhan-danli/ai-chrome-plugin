(function(){
'use strict';
function He(t,i){const e=[],r=i.getAttribute("role");r&&e.push({priority:10,type:"role",value:r}),t.label&&e.push({priority:9,type:"label",value:t.label}),t.text&&t.text.length<100&&e.push({priority:8,type:"text",value:t.text}),t.placeholder&&e.push({priority:7,type:"placeholder",value:t.placeholder}),t.ariaLabel&&e.push({priority:6,type:"aria-label",value:t.ariaLabel}),t.name&&e.push({priority:5,type:"name",value:t.name});const s=qe(i);return s&&e.push({priority:4,type:"selector",value:s}),e.sort((n,a)=>a.priority-n.priority)}function qe(t){var s,n;const i=[];if(t.id&&!t.id.match(/^(id|uid|uuid|random|temp|tmp)/i))return`#${t.id}`;const e=t.tagName.toLowerCase();if(t.getAttribute("name")&&i.push(`${e}[name="${t.getAttribute("name")}"]`),t.getAttribute("type")&&i.push(`${e}[type="${t.getAttribute("type")}"]`),t.getAttribute("data-testid"))return`${e}[data-testid="${t.getAttribute("data-testid")}"]`;if(t.getAttribute("data-id"))return`${e}[data-id="${t.getAttribute("data-id")}"]`;if(t.getAttribute("role")&&i.push(`${e}[role="${t.getAttribute("role")}"]`),t.getAttribute("aria-label")&&i.push(`${e}[aria-label="${t.getAttribute("aria-label")}"]`),i.length>0)return i.join("");const r=t.parentElement;if(r){const a=r.tagName.toLowerCase();if(a==="form"&&r.id)return`form#${r.id} > ${e}`;if(a==="fieldset"&&r.querySelector("legend")){const o=(n=(s=r.querySelector("legend"))==null?void 0:s.textContent)==null?void 0:n.trim();if(o)return`fieldset:has(legend:contains("${o}")) > ${e}`}}return null}const L=new Map,ve=new WeakMap,Ge={priorities:{form:10,button:8,link:3,text:1,tab:7,menu:6,list:4},viewport:{visible:5,nearViewport:2,hidden:0},maxElements:30};function We(){return`e_${Date.now()}_${Math.random().toString(36).substr(2,6)}`}function Xe(t){return t.top>=0&&t.left>=0&&t.bottom<=window.innerHeight&&t.right<=window.innerWidth}function Fe(t){return t.top>=-200&&t.left>=-200&&t.bottom<=window.innerHeight+200&&t.right<=window.innerWidth+200}function Re(t){const i=window.getComputedStyle(t);if(i.display==="none"||i.visibility==="hidden"||i.opacity==="0")return!1;const e=t.getBoundingClientRect();return!(e.width===0||e.height===0)}function Ve(t){var e,r;if(t.id){const s=document.querySelector(`label[for="${t.id}"]`);if(s)return(e=s.textContent)==null?void 0:e.trim()}const i=t.closest("label");if(i){const s=i.cloneNode(!0);return s.querySelectorAll("input, select, textarea").forEach(a=>a.remove()),(r=s.textContent)==null?void 0:r.trim()}}function je(t){var n,a,o,l;const i=t.closest("fieldset");if(i){const c=i.querySelector("legend");if(c)return(n=c.textContent)==null?void 0:n.trim()}const e=t.closest('section, article, aside, [role="region"]');if(e){const c=e.querySelector("h1, h2, h3, h4, h5, h6");if(c)return(a=c.textContent)==null?void 0:a.trim()}const r=t.parentElement;if(r){const c=Array.from(r.children),m=c.indexOf(t);for(let u=m-1;u>=0;u--){const h=c[u];if(/^H[1-6]$/i.test(h.tagName))return(o=h.textContent)==null?void 0:o.trim()}}let s=t;for(;s&&s!==document.body;){const c=s.getAttribute("aria-label");if(c)return c;const m=s.getAttribute("title");if(m)return m;const u=s.className||"";if(u.includes("header")||u.includes("title")||u.includes("heading")){const h=(l=s.textContent)==null?void 0:l.trim();if(h&&h.length<100)return h}s=s.parentElement}}function Ye(t){var n,a;const i=t.closest("form");if(!i)return;const e=i.querySelector("h1, h2, h3, h4, h5, h6");if(e)return(n=e.textContent)==null?void 0:n.trim();let r=i.previousElementSibling;for(;r;){if(/^H[1-6]$/i.test(r.tagName))return(a=r.textContent)==null?void 0:a.trim();r=r.previousElementSibling}const s=i.getAttribute("aria-label");if(s)return s}function ze(t){var n,a;const i=t.parentElement;if(!i||Array.from(i.children).filter(o=>{var l;return o!==t&&((l=o.textContent)==null?void 0:l.trim())}).length===0)return;const r=Array.from(i.children).indexOf(t),s=[];for(let o=r-1;o>=Math.max(0,r-2);o--){const c=(n=i.children[o].textContent)==null?void 0:n.trim();c&&c.length<50&&s.unshift(c)}for(let o=r+1;o<Math.min(i.children.length,r+3);o++){const c=(a=i.children[o].textContent)==null?void 0:a.trim();c&&c.length<50&&s.push(c)}return s.length>0?s:void 0}function Ke(t){var r,s,n,a,o,l,c,m;const i=[];let e=t.parentElement;for(;e&&e!==document.body;){let u;const h=e.tagName.toLowerCase();if(h==="form"){const f=((s=(r=e.querySelector("h1, h2, h3, h4, h5, h6"))==null?void 0:r.textContent)==null?void 0:s.trim())||e.getAttribute("aria-label")||e.getAttribute("name")||e.id;u=f?`表单:${f}`:"表单"}else if(h==="fieldset"){const f=(a=(n=e.querySelector("legend"))==null?void 0:n.textContent)==null?void 0:a.trim();u=f?`区域:${f}`:"区域"}else if(h==="section"||e.getAttribute("role")==="region"){const f=(l=(o=e.querySelector("h1, h2, h3, h4, h5, h6"))==null?void 0:o.textContent)==null?void 0:l.trim();u=f?`分组:${f}`:"分组"}else if(h==="tr"){const f=e.querySelector("td, th");if(f){const d=(c=f.textContent)==null?void 0:c.trim();d&&d.length<30&&(u=`行:${d}`)}}else if(h==="td"||h==="th"){const f=e.closest("table");if(f){const d=e.closest("tr"),E=Array.from((d==null?void 0:d.children)||[]).indexOf(e),v=f.querySelector("thead tr")||f.querySelector("tr");if(v){const _=v.querySelectorAll("th");_[E]&&(u=`列:${(m=_[E].textContent)==null?void 0:m.trim()}`)}}}if(u&&!i.includes(u)&&i.unshift(u),i.length>=3)break;e=e.parentElement}return i.length>0?i:void 0}function Je(t){var s,n;const i=t.parentElement;if(!i)return;if(i.tagName==="TD"||i.tagName==="TH"){const a=i.closest("tr");if(a){const o=a.querySelector("td, th");if(o&&o!==i){const l=(s=o.textContent)==null?void 0:s.trim();if(l&&l.length<30)return l}}}const e=Array.from(i.children),r=e.indexOf(t);for(let a=r-1;a>=0;a--){const o=e[a],l=(n=o.textContent)==null?void 0:n.trim();if(l&&l.length<30&&!o.querySelector("input, select, textarea"))return l}}function Qe(t){var i;if(t.tagName==="BUTTON"||t.tagName==="A")return(i=t.textContent)==null?void 0:i.trim();if(t.tagName==="INPUT"){const e=t;if(e.type==="submit"||e.type==="button")return e.value}}function Ze(t){if(!Re(t))return null;const i=t.getBoundingClientRect();let e=ve.get(t);e?(!L.has(e)||L.get(e)!==t)&&L.set(e,t):(e=We(),L.set(e,t),ve.set(t,e));const r={id:e,tag:t.tagName.toLowerCase(),rect:{x:i.x,y:i.y,width:i.width,height:i.height},visible:Xe(i),disabled:t.disabled||t.getAttribute("aria-disabled")==="true"};if(t.tagName==="INPUT"){const c=t;r.type=c.type,r.name=c.name||void 0,r.placeholder=c.placeholder||void 0,c.type!=="password"&&(r.value=c.value||void 0)}if(t.tagName==="TEXTAREA"){const c=t;r.name=c.name||void 0,r.placeholder=c.placeholder||void 0,r.value=c.value||void 0}if(t.tagName==="SELECT"){const c=t;r.name=c.name||void 0,r.value=c.value||void 0}r.text=Qe(t),r.label=Ve(t),r.ariaLabel=t.getAttribute("aria-label")||void 0;const s=je(t),n=Ye(t),a=ze(t),o=Ke(t),l=Je(t);return(s||n||a||o||l)&&(r.context={sectionTitle:s,formTitle:n,nearElements:a,parentChain:o,rowLabel:l}),r}function et(){const t=[];L.forEach((i,e)=>{document.contains(i)||t.push(e)}),t.forEach(i=>{L.delete(i)}),t.length>0&&console.log(`[ElementCollector] 清理了 ${t.length} 个无效元素`)}function Oe(){et(),console.log(`[ElementCollector] 开始采集元素，当前 elementMap 大小: ${L.size}`);const t=[],i=new Set,e=['input:not([type="hidden"])',"textarea","select","button","a[href]",'[role="button"]','[role="link"]','[role="checkbox"]','[role="radio"]','[role="switch"]','[role="tab"]','[role="tabpanel"]','[role="listitem"]','[role="option"]','[role="menuitem"]','[role="treeitem"]','[role="gridcell"]','[role="cell"]','[class*="tab"]','[class*="Tab"]',"[data-tab]",'[data-role="tab"]',".nav-tabs > li",".tab-list > *",".tab-item",'[role="presentation"]',"li[onclick]","li[data-clickable]","li.clickable",'li[role="button"]','li[role="tab"]','li[role="menuitem"]',"ul[data-list] > li","ol[data-list] > li",".list-group-item",".menu-item",".dropdown-item",'[contenteditable="true"]',"[onclick]",'[tabindex]:not([tabindex="-1"])','input[type="date"]','input[type="datetime-local"]','input[type="time"]','input[type="month"]','input[type="week"]','input[type="file"]','input[type="color"]','input[type="range"]',"details","summary","label[for]"];document.querySelectorAll(e.join(", ")).forEach(n=>{const a=Ze(n);a&&(t.push(a),i.add(a.id))});const s=[];return L.forEach((n,a)=>{i.has(a)||(!document.contains(n)||!Re(n))&&s.push(a)}),s.forEach(n=>{L.delete(n)}),s.length>0&&console.log(`[ElementCollector] 清理了 ${s.length} 个过时元素`),console.log(`[ElementCollector] 采集完成，共 ${t.length} 个元素，elementMap 大小: ${L.size}`),t}function y(t){const i=L.get(t);return console.log(`[ElementCollector] getElementById("${t}"):`,i?`找到 <${i.tagName.toLowerCase()}>`:"未找到"),i||console.log("[ElementCollector] 当前 elementMap 中的所有 ID:",Array.from(L.keys())),i||null}function tt(t){const i=["帮我","请","把","将","给","在","到","的","和","然后","并且","接着"];let e=t;return i.forEach(s=>{e=e.replace(new RegExp(s,"g")," ")}),e.split(/[\s,，。.!！?？、]+/).filter(s=>s.length>0)}function rt(t,i,e){var o,l,c;let r=0;const n=[t.text,t.placeholder,t.label,t.ariaLabel,t.name,(o=t.context)==null?void 0:o.sectionTitle,(l=t.context)==null?void 0:l.formTitle,(c=t.context)==null?void 0:c.rowLabel].filter(Boolean).join(" ").toLowerCase();for(const m of i){const u=m.toLowerCase();if(n===u)r+=20;else if(n.includes(u))r+=10;else if(u.length>2){const h=st(n,u);r+=h*5}}t.tag==="input"||t.tag==="textarea"?r+=e.priorities.form:t.tag==="button"||t.tag==="input"&&(t.type==="submit"||t.type==="button")?r+=e.priorities.button:t.tag==="select"?r+=e.priorities.form:t.tag==="a"?r+=e.priorities.link:(t.tag==="li"||t.tag==="details"||t.tag==="summary")&&(r+=e.priorities.list);const a=L.get(t.id);return a&&ge(t,a)&&(r+=e.priorities.tab),t.context&&(t.context.sectionTitle&&(r+=3),t.context.formTitle&&(r+=3),t.context.parentChain&&t.context.parentChain.length>0&&(r+=2),t.context.rowLabel&&(r+=2)),t.visible?r+=e.viewport.visible:Fe(new DOMRect(t.rect.x,t.rect.y,t.rect.width,t.rect.height))&&(r+=e.viewport.nearViewport),t.disabled&&(r-=5),r}function st(t,i){if(!t||!i)return 0;const e=new Set(t.split("")),r=new Set(i.split(""));let s=0;e.forEach(a=>{r.has(a)&&s++});const n=Math.max(e.size,r.size);return n>0?s/n:0}function it(t,i,e=Ge){const r=tt(i);return t.map(n=>({element:n,score:rt(n,r,e)})).sort((n,a)=>a.score-n.score).slice(0,e.maxElements).map(n=>n.element)}function ge(t,i){if(i.getAttribute("role")==="tab")return!0;const e=i.className||"";if(e.includes("tab")||e.includes("Tab")||i.hasAttribute("data-tab")||i.getAttribute("data-role")==="tab")return!0;const r=i.parentElement;return!!(r&&(r.className.includes("nav-tabs")||r.className.includes("tab-list")))}function nt(t,i){var l;const e=[];let s={input:"输入框",textarea:"文本框",button:"按钮",a:"链接",select:"下拉框",li:"列表项",details:"详情展开",summary:"摘要标题"}[t.tag]||t.tag;if(i&&ge(t,i)&&(s="Tab页签"),i){const c=i.getAttribute("role");if(c){const m={tab:"Tab页签",tabpanel:"Tab面板",switch:"开关按钮",menuitem:"菜单项",option:"下拉选项",listitem:"列表项",treeitem:"树节点",gridcell:"表格单元",radio:"单选按钮",checkbox:"复选框",button:"按钮",link:"链接"};m[c]&&(s=m[c])}}if(t.tag==="input"&&t.type){const c={password:"密码框",submit:"提交按钮",button:"按钮",checkbox:"复选框",radio:"单选框",search:"搜索框",email:"邮箱输入框",tel:"电话输入框",number:"数字输入框",url:"URL输入框",date:"日期选择器","datetime-local":"日期时间选择器",time:"时间选择器",month:"月份选择器",week:"周选择器",file:"文件上传",color:"颜色选择器",range:"滑块",hidden:"隐藏字段"};c[t.type]&&(s=c[t.type])}e.push(s);let n=t.label||t.text||t.placeholder||t.ariaLabel||t.name;if(!n&&i&&(n=i.getAttribute("title")||void 0),!n&&i&&s==="Tab页签"){const c=(l=i.textContent)==null?void 0:l.trim();c&&c.length<50&&(n=c)}n&&e.push(n);const a=[];t.placeholder&&t.placeholder!==n&&a.push(`placeholder:${t.placeholder}`),t.type&&!["text","submit","button"].includes(t.type)&&a.push(`type:${t.type}`),t.disabled&&a.push("禁用"),s==="Tab页签"&&i&&(i.classList.contains("active")||i.getAttribute("aria-selected")==="true")&&a.push("当前激活"),(t.type==="radio"||t.type==="checkbox")&&i&&i.checked&&a.push("已选中");let o=e.join(":");return a.length>0&&(o+=`(${a.join(",")})`),o}function De(t){return t.map(i=>{const e=L.get(i.id),r={id:i.id,desc:nt(i,e)};if(e){const n=He(i,e).find(a=>a.type==="selector");n?r.selector=n.value:i.name?r.selector=`${i.tag}[name="${i.name}"]`:i.ariaLabel?r.selector=`${i.tag}[aria-label="${i.ariaLabel}"]`:i.type&&i.tag==="input"&&(r.selector=`input[type="${i.type}"]`)}if(i.context){const s={};i.context.sectionTitle?s.section=i.context.sectionTitle:i.context.formTitle&&(s.section=i.context.formTitle),i.context.nearElements&&i.context.nearElements.length>0&&(s.nearby=i.context.nearElements.slice(0,2).join(", ")),i.context.rowLabel&&(s.nearby=s.nearby?`${i.context.rowLabel} | ${s.nearby}`:i.context.rowLabel),i.context.parentChain&&i.context.parentChain.length>0&&(s.path=i.context.parentChain.join(" > ")),Object.keys(s).length>0&&(r.ctx=s)}return r})}function at(t=""){var s;const i=Oe(),e=it(i,t),r=De(e);return{url:window.location.href,title:document.title,elements:r,selectedText:((s=window.getSelection())==null?void 0:s.toString())||void 0}}function ot(t){let i=Oe();if(t.region&&(i=i.filter(e=>{const r=e.rect;switch(t.region){case"header":return r.y<150;case"footer":return r.y>window.innerHeight-200;case"sidebar":return r.x<250||r.x>window.innerWidth-250;case"below_viewport":return r.y>window.innerHeight;case"form":const s=document.querySelectorAll("form");return Array.from(s).some(l=>{const c=l.getBoundingClientRect();return r.x>=c.left&&r.x<=c.right&&r.y>=c.top&&r.y<=c.bottom});case"tab_panel":const n=document.querySelectorAll('[role="tabpanel"], .tab-content, .tab-pane');return Array.from(n).some(l=>{const c=l.getBoundingClientRect();return r.x>=c.left&&r.x<=c.right&&r.y>=c.top&&r.y<=c.bottom});case"modal":const a=document.querySelectorAll('[role="dialog"], .modal, .dialog, [class*="modal"], [class*="dialog"]');return Array.from(a).some(l=>{const c=l.getBoundingClientRect();return r.x>=c.left&&r.x<=c.right&&r.y>=c.top&&r.y<=c.bottom});case"menu":const o=document.querySelectorAll('[role="menu"], [role="menubar"], .menu, .dropdown-menu, .context-menu');return Array.from(o).some(l=>{const c=l.getBoundingClientRect();return r.x>=c.left&&r.x<=c.right&&r.y>=c.top&&r.y<=c.bottom});default:return!0}})),t.elementType&&t.elementType!=="all"&&(i=i.filter(e=>{const r=L.get(e.id);switch(t.elementType){case"input":return e.tag==="input"||e.tag==="textarea";case"button":return e.tag==="button"||e.tag==="input"&&(e.type==="submit"||e.type==="button");case"link":return e.tag==="a";case"select":return e.tag==="select";case"tab":return r?ge(e,r):!1;case"menu":return r?r.getAttribute("role")==="menuitem"||r.classList.contains("menu-item")||r.classList.contains("dropdown-item"):!1;case"list":return e.tag==="li"||(r==null?void 0:r.getAttribute("role"))==="listitem"||(r==null?void 0:r.classList.contains("list-group-item"));case"radio":return e.type==="radio"||(r==null?void 0:r.getAttribute("role"))==="radio";case"checkbox":return e.type==="checkbox"||(r==null?void 0:r.getAttribute("role"))==="checkbox";default:return!0}})),t.keyword){const e=t.keyword.toLowerCase();i=i.filter(r=>[r.text,r.placeholder,r.label,r.ariaLabel,r.name].filter(Boolean).join(" ").toLowerCase().includes(e))}return De(i)}function ie(t){return new Promise(i=>setTimeout(i,t))}function lt(t,i){t.focus(),t.value="",t.dispatchEvent(new Event("focus",{bubbles:!0})),t.value=i,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))}function ct(t){t.focus(),t.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))}async function ut(t,i){if(console.log("[ActionExecutor] fillInput 调用:",{target:t,value:i}),!i)return{success:!1,message:"未提供填充值",error:"NO_VALUE"};const e=U(t,"input");return e?e.tagName!=="INPUT"&&e.tagName!=="TEXTAREA"?e.getAttribute("contenteditable")==="true"?(e.focus(),e.textContent=i,e.dispatchEvent(new Event("input",{bubbles:!0})),{success:!0,message:`已填充: ${i}`}):{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"}:(lt(e,i),{success:!0,message:`已填充: ${i}`}):{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}function ht(t){var e,r;if(t.id){const s=document.querySelector(`label[for="${t.id}"]`);if(s)return(e=s.textContent)==null?void 0:e.trim()}const i=t.closest("label");if(i){const s=i.cloneNode(!0);return s.querySelectorAll("input, select, textarea").forEach(a=>a.remove()),(r=s.textContent)==null?void 0:r.trim()}}function U(t,i){var e;if(t.elementId){const r=y(t.elementId);if(r){if(document.contains(r))return r;console.log("[ActionExecutor] elementId 对应的元素已不在DOM中")}else console.log("[ActionExecutor] elementId 查找失败，尝试其他方式")}if(t.selector)try{const r=document.querySelector(t.selector);if(r){if(!i||r.tagName.toLowerCase()===i)return r;console.log(`[ActionExecutor] selector找到的元素标签不匹配: 期望${i}, 实际${r.tagName.toLowerCase()}`)}}catch(r){console.warn("[ActionExecutor] selector 查询失败:",r)}if(t.description){const r=i||"input, textarea, button, a, select",s=Array.from(document.querySelectorAll(r));for(const n of s){const a=window.getComputedStyle(n);if(a.display==="none"||a.visibility==="hidden")continue;const o=[n.placeholder,n.getAttribute("aria-label"),n.name,(e=n.textContent)==null?void 0:e.trim(),ht(n)].filter(Boolean).join(" ").toLowerCase(),l=t.description.toLowerCase();if(o.includes(l))return n;const c=l.split(/[\s,，。.!！?？、]+/).filter(u=>u.length>1);if(c.filter(u=>o.includes(u)).length>=c.length*.5)return n}}return null}async function mt(t){var e;const i=U(t);return i?(ct(i),{success:!0,message:`已点击: ${t.description||((e=i.textContent)==null?void 0:e.trim())||"元素"}`}):{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}async function ft(t,i){const e=i||"#ffeb3b",r=window.getSelection();if(r&&r.rangeCount>0&&!r.isCollapsed){const n=r.getRangeAt(0),a=document.createElement("span");a.className="ai-highlight",a.style.backgroundColor=e,a.style.padding="2px 0",a.style.borderRadius="2px";try{return n.surroundContents(a),r.removeAllRanges(),{success:!0,message:"已高亮选中文字"}}catch{return{success:!1,message:"无法高亮跨元素的选中内容",error:"CROSS_ELEMENT"}}}const s=U(t);return s?(s.style.backgroundColor=e,s.classList.add("ai-highlight"),{success:!0,message:"已高亮元素"}):{success:!1,message:"未找到要高亮的内容",error:"NO_TARGET"}}async function dt(t){const i=window.getSelection();if(i&&i.rangeCount>0&&!i.isCollapsed){const r=i.getRangeAt(0),s=document.createElement("span");s.className="ai-underline",s.style.textDecoration="underline",s.style.textDecorationColor="#1a73e8",s.style.textDecorationThickness="2px";try{return r.surroundContents(s),i.removeAllRanges(),{success:!0,message:"已添加下划线"}}catch{return{success:!1,message:"无法为跨元素的选中内容添加下划线",error:"CROSS_ELEMENT"}}}const e=U(t);return e?(e.style.textDecoration="underline",e.style.textDecorationColor="#1a73e8",e.classList.add("ai-underline"),{success:!0,message:"已添加下划线"}):{success:!1,message:"未找到要添加下划线的内容",error:"NO_TARGET"}}async function gt(t,i){if(!i)return{success:!1,message:"未提供选择值",error:"NO_VALUE"};const e=U(t,"select");return!e||e.tagName!=="SELECT"?{success:!1,message:"未找到下拉框元素",error:"ELEMENT_NOT_FOUND"}:pt(e,i)}function pt(t,i){const e=Array.from(t.options).find(s=>s.value===i);if(e)return t.value=e.value,t.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已选择: ${e.text}`};const r=Array.from(t.options).find(s=>s.text.toLowerCase().includes(i.toLowerCase()));return r?(t.value=r.value,t.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已选择: ${r.text}`}):{success:!1,message:`未找到匹配的选项: ${i}`,error:"OPTION_NOT_FOUND"}}async function bt(t){const i=U(t,"input");if(!i)return{success:!1,message:"未找到复选框元素",error:"ELEMENT_NOT_FOUND"};if(i.tagName!=="INPUT"||i.type!=="checkbox")return{success:!1,message:"目标元素不是复选框",error:"INVALID_ELEMENT"};const e=i;return e.checked=!e.checked,e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:e.checked?"已勾选":"已取消勾选"}}async function Et(t){const i=window.innerHeight*.8;switch(t){case"up":return window.scrollBy({top:-i,behavior:"smooth"}),{success:!0,message:"已向上滚动"};case"down":return window.scrollBy({top:i,behavior:"smooth"}),{success:!0,message:"已向下滚动"};case"top":return window.scrollTo({top:0,behavior:"smooth"}),{success:!0,message:"已滚动到顶部"};case"bottom":return window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}),{success:!0,message:"已滚动到底部"};default:return window.scrollBy({top:i,behavior:"smooth"}),{success:!0,message:"已向下滚动"}}}async function yt(t){var r,s;const i=t.elementId?y(t.elementId):null;if(!i){if(t.selector){const a=document.querySelector(t.selector);if(a)return{success:!0,message:"已读取内容",data:((r=a.textContent)==null?void 0:r.trim())||""}}const n=window.getSelection();return n&&!n.isCollapsed?{success:!0,message:"已读取选中内容",data:n.toString()}:{success:!1,message:"未找到要读取的内容",error:"NO_TARGET"}}return{success:!0,message:"已读取内容",data:((s=i.textContent)==null?void 0:s.trim())||""}}async function vt(t){var r;const i=t.elementId?y(t.elementId):null;if(!i){if(t.selector){const s=document.querySelector(t.selector);if(s){const n=new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window});return s.dispatchEvent(n),{success:!0,message:"已悬停在元素上"}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const e=new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window});return i.dispatchEvent(e),{success:!0,message:`已悬停在: ${t.description||((r=i.textContent)==null?void 0:r.trim())||"元素"}上`}}async function _t(t,i,e){if(!i)return{success:!1,message:"未提供输入文本",error:"NO_TEXT"};const r=t.elementId?y(t.elementId):null;if(!r){if(t.selector){const s=document.querySelector(t.selector);if(s&&(s.tagName==="INPUT"||s.tagName==="TEXTAREA"))return await _e(s,i,e||50),{success:!0,message:`已输入: ${i}`}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return r.tagName!=="INPUT"&&r.tagName!=="TEXTAREA"?{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"}:(await _e(r,i,e||50),{success:!0,message:`已输入: ${i}`})}async function _e(t,i,e){t.focus(),t.value="",t.dispatchEvent(new Event("focus",{bubbles:!0}));for(let r=0;r<i.length;r++)t.value+=i[r],t.dispatchEvent(new Event("input",{bubbles:!0})),await new Promise(s=>setTimeout(s,e));t.dispatchEvent(new Event("change",{bubbles:!0}))}async function Nt(t,i){if(!t)return{success:!1,message:"未提供按键",error:"NO_KEY"};const e=i?document.querySelector(i):document.activeElement;return e?(Ne(e,t),{success:!0,message:`已在元素上按下: ${t}`}):(Ne(document,t),{success:!0,message:`已发送按键: ${t}`})}function Ne(t,i){const e=new KeyboardEvent("keydown",{key:i,bubbles:!0,cancelable:!0,view:window});t.dispatchEvent(e);const r=new KeyboardEvent("keypress",{key:i,bubbles:!0,cancelable:!0,view:window});t.dispatchEvent(r);const s=new KeyboardEvent("keyup",{key:i,bubbles:!0,cancelable:!0,view:window});t.dispatchEvent(s)}async function Tt(t,i){const e=t.elementId?y(t.elementId):null;if(!e)return{success:!1,message:"未找到源元素",error:"SOURCE_NOT_FOUND"};let r=null,s,n;if(i!=null&&i.selector){if(r=document.querySelector(i.selector),!r)return{success:!1,message:"未找到目标元素",error:"DESTINATION_NOT_FOUND"};const u=r.getBoundingClientRect();s=u.left+u.width/2,n=u.top+u.height/2}else if((i==null?void 0:i.x)!==void 0&&(i==null?void 0:i.y)!==void 0)s=i.x,n=i.y;else return{success:!1,message:"未提供目标位置",error:"NO_DESTINATION"};const a=e.getBoundingClientRect(),o=a.left+a.width/2,l=a.top+a.height/2;e.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window,clientX:o,clientY:l})),await ie(100);const c=10;for(let u=1;u<=c;u++){const h=o+(s-o)*(u/c),f=l+(n-l)*(u/c);e.dispatchEvent(new MouseEvent("mousemove",{bubbles:!0,cancelable:!0,view:window,clientX:h,clientY:f})),await ie(50)}return(document.elementFromPoint(s,n)||document.body).dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window,clientX:s,clientY:n})),{success:!0,message:"拖拽完成"}}async function wt(t,i,e){const r=i||1e3,s=Date.now();if(t!=null&&t.elementId||t!=null&&t.selector){for(t.elementId?`${t.elementId}`:t.selector;Date.now()-s<r;){const n=t.elementId?y(t.elementId):document.querySelector(t.selector);if(n)if(e==="visible"){const a=n.getBoundingClientRect();if(a.width>0&&a.height>0)return{success:!0,message:"元素已可见"}}else if(e==="hidden"){const a=n.getBoundingClientRect();if(a.width===0||a.height===0)return{success:!0,message:"元素已隐藏"}}else return{success:!0,message:"元素已出现"};await ie(100)}return{success:!1,message:`等待超时: ${r}ms`,error:"TIMEOUT"}}else return await ie(r),{success:!0,message:`等待了 ${r}ms`}}async function At(t){var e;const i=U(t);return i?(i.focus(),{success:!0,message:`已聚焦: ${t.description||((e=i.textContent)==null?void 0:e.trim())||"元素"}`}):{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}async function St(t){var e;const i=U(t);return i?(i.blur(),{success:!0,message:`已失焦: ${t.description||((e=i.textContent)==null?void 0:e.trim())||"元素"}`}):{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}async function xt(t){const i=U(t,"input");if(!i)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};if(i.tagName!=="INPUT"&&i.tagName!=="TEXTAREA")return{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"};const e=i;return e.value="",e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:"已清空输入框"}}async function Ct(t,i){if(!i)return{success:!1,message:"未提供属性名",error:"NO_ATTRIBUTE"};const e=t.elementId?y(t.elementId):null;if(!e){if(t.selector){const s=document.querySelector(t.selector);if(s){const n=s.getAttribute(i);return{success:!0,message:`获取属性 ${i}`,data:n}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const r=e.getAttribute(i);return{success:!0,message:`获取属性 ${i}`,data:r}}async function It(t,i){if(!i)return{success:!1,message:"未提供属性名",error:"NO_PROPERTY"};const e=t.elementId?y(t.elementId):null;if(!e){if(t.selector){const s=document.querySelector(t.selector);if(s){const n=s[i];return{success:!0,message:`获取属性值 ${i}`,data:n}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const r=e[i];return{success:!0,message:`获取属性值 ${i}`,data:r}}async function Lt(t,i){switch(t){case"goto":return i?(window.location.href=i,{success:!0,message:`导航到: ${i}`}):{success:!1,message:"未提供URL",error:"NO_URL"};case"back":return window.history.back(),{success:!0,message:"返回上一页"};case"forward":return window.history.forward(),{success:!0,message:"前进到下一页"};case"reload":return window.location.reload(),{success:!0,message:"刷新页面"};default:return{success:!1,message:"未知的导航操作",error:"UNKNOWN_ACTION"}}}async function Rt(t,i,e){var s;const r=t.elementId?y(t.elementId):null;if(!r){if(t.selector){const n=document.querySelector(t.selector);if(n)return n.scrollIntoView({behavior:i||"smooth",block:e||"center"}),{success:!0,message:"已滚动到元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return r.scrollIntoView({behavior:i||"smooth",block:e||"center"}),{success:!0,message:`已滚动到: ${t.description||((s=r.textContent)==null?void 0:s.trim())||"元素"}`}}async function Ot(t){var e;if(!t)return{success:!0,message:"已切换回主文档"};const i=document.querySelector(t);if(!i)return{success:!1,message:"未找到iframe",error:"IFRAME_NOT_FOUND"};try{return i.contentDocument||((e=i.contentWindow)==null?void 0:e.document)?{success:!0,message:`已切换到iframe: ${t}`,data:{frameUrl:i.src}}:{success:!1,message:"无法访问iframe内容（跨域限制）",error:"CROSS_ORIGIN"}}catch{return{success:!1,message:"无法访问iframe内容",error:"ACCESS_ERROR"}}}async function Dt(t,i){return{success:!0,message:`弹窗处理: ${t}`,data:{promptText:i}}}async function Pt(t,i){try{return localStorage.setItem(t,i),{success:!0,message:`已设置 localStorage[${t}] = ${i}`}}catch(e){return{success:!1,message:"设置localStorage失败",error:String(e)}}}async function Mt(t){try{const i=localStorage.getItem(t);return{success:!0,message:`获取 localStorage[${t}]`,data:i}}catch(i){return{success:!1,message:"获取localStorage失败",error:String(i)}}}async function kt(t){try{if(t){const i=[];for(let e=0;e<localStorage.length;e++){const r=localStorage.key(e);r&&r.startsWith(t)&&i.push(r)}return i.forEach(e=>localStorage.removeItem(e)),{success:!0,message:`已清除 ${i.length} 个localStorage项`}}else{const i=localStorage.length;return localStorage.clear(),{success:!0,message:`已清除所有 ${i} 个localStorage项`}}}catch(i){return{success:!1,message:"清除localStorage失败",error:String(i)}}}async function $t(t,i,e){try{let r=`${encodeURIComponent(t)}=${encodeURIComponent(i)}`;if(e!=null&&e.expires){const s=new Date(Date.now()+e.expires*1e3);r+=`;expires=${s.toUTCString()}`}return e!=null&&e.path&&(r+=`;path=${e.path}`),e!=null&&e.domain&&(r+=`;domain=${e.domain}`),e!=null&&e.secure&&(r+=";secure"),document.cookie=r,{success:!0,message:`已设置 Cookie: ${t}`}}catch(r){return{success:!1,message:"设置Cookie失败",error:String(r)}}}async function Ut(t){var i;try{if(t){const e=(i=document.cookie.split("; ").find(r=>r.startsWith(`${encodeURIComponent(t)}=`)))==null?void 0:i.split("=")[1];return{success:!0,message:`获取 Cookie: ${t}`,data:e?decodeURIComponent(e):null}}else return{success:!0,message:"获取所有Cookies",data:document.cookie}}catch(e){return{success:!1,message:"获取Cookie失败",error:String(e)}}}function Te(t){const i=t.getBoundingClientRect(),e=i.left+i.width/2,r=i.top+i.height/2,s={bubbles:!0,cancelable:!0,view:window,clientX:e,clientY:r};t.focus(),t.dispatchEvent(new MouseEvent("mousedown",{...s,button:0,buttons:1})),t.dispatchEvent(new MouseEvent("mouseup",{...s,button:0,buttons:0})),t.dispatchEvent(new MouseEvent("click",{...s,button:0})),t.dispatchEvent(new MouseEvent("mousedown",{...s,button:0,buttons:1})),t.dispatchEvent(new MouseEvent("mouseup",{...s,button:0,buttons:0})),t.dispatchEvent(new MouseEvent("click",{...s,button:0})),t.dispatchEvent(new MouseEvent("dblclick",{...s,button:0}))}async function Bt(t){var e;const i=t.elementId?y(t.elementId):null;if(!i){if(t.selector){const r=document.querySelector(t.selector);if(r)return Te(r),{success:!0,message:"已双击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return Te(i),{success:!0,message:`已双击: ${t.description||((e=i.textContent)==null?void 0:e.trim())||"元素"}`}}function we(t){const i=t.getBoundingClientRect(),e=i.left+i.width/2,r=i.top+i.height/2;t.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window,button:2,buttons:2,clientX:e,clientY:r})),t.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window,button:2,buttons:0,clientX:e,clientY:r})),t.dispatchEvent(new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,view:window,button:2,clientX:e,clientY:r}))}async function Ht(t){var e;const i=t.elementId?y(t.elementId):null;if(!i){if(t.selector){const r=document.querySelector(t.selector);if(r)return we(r),{success:!0,message:"已右键点击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return we(i),{success:!0,message:`已右键点击: ${t.description||((e=i.textContent)==null?void 0:e.trim())||"元素"}`}}async function qt(t,i,e,r){const s=t.elementId?y(t.elementId):t.selector?document.querySelector(t.selector):null;if(!s)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const n=window.getSelection();if(!n)return{success:!1,message:"无法获取Selection对象",error:"NO_SELECTION"};n.removeAllRanges();const a=document.createRange();try{if(i){const l=Gt(s,i);if(!l)return{success:!1,message:`未找到文本: ${i}`,error:"TEXT_NOT_FOUND"};const m=(l.textContent||"").indexOf(i);a.setStart(l,m),a.setEnd(l,m+i.length)}else if(e!==void 0&&r!==void 0){const l=s.firstChild;if(!l||l.nodeType!==Node.TEXT_NODE)return{success:!1,message:"元素没有文本节点",error:"NO_TEXT_NODE"};a.setStart(l,e),a.setEnd(l,r)}else a.selectNodeContents(s);n.addRange(a);const o=n.toString();return{success:!0,message:`已选中文本: ${o}`,data:o}}catch(o){return{success:!1,message:`选中文本失败: ${o}`,error:"SELECT_ERROR"}}}function Gt(t,i){const e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null);let r;for(;r=e.nextNode();)if(r.textContent&&r.textContent.includes(i))return r;return null}async function Wt(t,i){var e;try{let r=i;if(!r){const s=window.getSelection();if(s&&!s.isCollapsed)r=s.toString();else if(t.elementId||t.selector){const n=t.elementId?y(t.elementId):document.querySelector(t.selector);n&&(r=((e=n.textContent)==null?void 0:e.trim())||"")}}return r?(await navigator.clipboard.writeText(r),{success:!0,message:`已复制到剪贴板: ${r.substring(0,50)}${r.length>50?"...":""}`}):{success:!1,message:"没有可复制的内容",error:"NO_CONTENT"}}catch(r){return{success:!1,message:`复制失败: ${r}`,error:"CLIPBOARD_ERROR"}}}async function Xt(t){try{const i=await navigator.clipboard.readText();if(!i)return{success:!1,message:"剪贴板为空",error:"EMPTY_CLIPBOARD"};const e=t.elementId?y(t.elementId):t.selector?document.querySelector(t.selector):null;if(!e)return{success:!0,message:"已读取剪贴板内容",data:i};if(e.tagName==="INPUT"||e.tagName==="TEXTAREA"){const r=e;return r.focus(),r.value=i,r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已粘贴: ${i.substring(0,50)}${i.length>50?"...":""}`}}else if(e.getAttribute("contenteditable")==="true")return e.focus(),e.textContent=i,e.dispatchEvent(new Event("input",{bubbles:!0})),{success:!0,message:`已粘贴: ${i.substring(0,50)}${i.length>50?"...":""}`};return{success:!0,message:"已读取剪贴板内容",data:i}}catch(i){return{success:!1,message:`粘贴失败: ${i}`,error:"CLIPBOARD_ERROR"}}}async function Ft(t,i){if(!i||i.length===0)return{success:!1,message:"未提供文件",error:"NO_FILES"};const e=t.elementId?y(t.elementId):t.selector?document.querySelector(t.selector):null;if(!e||e.tagName!=="INPUT"||e.type!=="file")return{success:!1,message:"目标元素不是文件输入框",error:"INVALID_ELEMENT"};const r=e;try{const s=new DataTransfer;for(const n of i){const a=atob(n.content),o=new Array(a.length);for(let u=0;u<a.length;u++)o[u]=a.charCodeAt(u);const l=new Uint8Array(o),c=new Blob([l],{type:n.type}),m=new File([c],n.name,{type:n.type});s.items.add(m)}return r.files=s.files,r.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已上传 ${i.length} 个文件`}}catch(s){return{success:!1,message:`上传失败: ${s}`,error:"UPLOAD_ERROR"}}}async function Vt(t){if(!t)return{success:!1,message:"未提供脚本",error:"NO_SCRIPT"};try{return{success:!0,message:"脚本执行成功",data:new Function(t)()}}catch(i){return{success:!1,message:`脚本执行失败: ${i}`,error:"SCRIPT_ERROR"}}}async function jt(t,i,e,r){var o,l;if(!e)return{success:!1,message:"未提供列表项内容",error:"NO_CONTENT"};let s=null;if(i)s=document.querySelector(i);else if(t.elementId||t.selector){const c=t.elementId?y(t.elementId):document.querySelector(t.selector);c&&(s=c.closest("ul, ol"))}if(!s)return{success:!1,message:"未找到列表容器",error:"LIST_NOT_FOUND"};const n=document.createElement("li");n.textContent=e;const a=t.elementId?y(t.elementId):t.selector?document.querySelector(t.selector):null;switch(r){case"before":a&&a.tagName==="LI"?(o=a.parentNode)==null||o.insertBefore(n,a):s.insertBefore(n,s.firstChild);break;case"after":a&&a.tagName==="LI"?(l=a.parentNode)==null||l.insertBefore(n,a.nextSibling):s.appendChild(n);break;case"first":s.insertBefore(n,s.firstChild);break;case"last":default:s.appendChild(n);break}return s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已添加列表项: ${e}`}}async function Yt(t,i){var n;let e=null;if(t.elementId||t.selector)e=t.elementId?y(t.elementId):document.querySelector(t.selector);else if(i!==void 0){const a=document.querySelectorAll("ul, ol");for(const o of a){const l=o.querySelectorAll(":scope > li");if(l[i]){e=l[i];break}}}if(!e||e.tagName!=="LI")return{success:!1,message:"未找到要删除的列表项",error:"ITEM_NOT_FOUND"};const r=((n=e.textContent)==null?void 0:n.trim())||"",s=e.parentNode;return e.remove(),s&&s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已删除列表项: ${r}`}}async function zt(t,i){var s;if(!i)return{success:!1,message:"未提供新内容",error:"NO_CONTENT"};const e=t.elementId?y(t.elementId):t.selector?document.querySelector(t.selector):null;if(!e||e.tagName!=="LI")return{success:!1,message:"未找到列表项元素",error:"ITEM_NOT_FOUND"};const r=((s=e.textContent)==null?void 0:s.trim())||"";return e.textContent=i,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已编辑列表项: "${r}" → "${i}"`}}async function Kt(t,i){var s;if(i===void 0)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const e=t.elementId?y(t.elementId):t.selector?document.querySelector(t.selector):null;if(!e)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const r=((s=e.textContent)==null?void 0:s.trim())||"";return e.tagName==="INPUT"||e.tagName==="TEXTAREA"?e.value=i:(e.getAttribute("contenteditable"),e.textContent=i),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已设置内容: "${r.substring(0,20)}..." → "${i.substring(0,20)}..."`}}async function Jt(t,i){if(!i)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const e=t.elementId?y(t.elementId):t.selector?document.querySelector(t.selector):null;if(!e)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};if(e.tagName==="INPUT"||e.tagName==="TEXTAREA"){const r=e;r.value+=i}else e.getAttribute("contenteditable")==="true"?e.textContent=(e.textContent||"")+i:e.appendChild(document.createTextNode(i));return e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已追加内容: "${i.substring(0,30)}${i.length>30?"...":""}"`}}async function Qt(t,i){if(!i)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const e=t.elementId?y(t.elementId):t.selector?document.querySelector(t.selector):null;if(!e)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};if(e.tagName==="INPUT"||e.tagName==="TEXTAREA"){const r=e;r.value=i+r.value}else e.getAttribute("contenteditable")==="true"?e.textContent=i+(e.textContent||""):e.insertBefore(document.createTextNode(i),e.firstChild);return e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已前置内容: "${i.substring(0,30)}${i.length>30?"...":""}"`}}async function Zt(t,i,e){if(!i)return{success:!1,message:"未提供HTML内容",error:"NO_HTML"};const r=t.elementId?y(t.elementId):t.selector?document.querySelector(t.selector):null;if(!r)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const s=e||"beforeend";return r.insertAdjacentHTML(s,i),r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已在${{beforebegin:"元素之前",afterbegin:"元素内部开头",beforeend:"元素内部末尾",afterend:"元素之后"}[s]}插入HTML`}}async function er(t){try{if(t)return document.cookie=`${encodeURIComponent(t)}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`,{success:!0,message:`已清除 Cookie: ${t}`};{const i=document.cookie.split(";");return i.forEach(e=>{const[r]=e.split("="),s=r==null?void 0:r.trim();s&&(document.cookie=`${s}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`,document.cookie=`${s}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;domain=${window.location.hostname}`)}),{success:!0,message:`已清除 ${i.length} 个Cookies`}}}catch(i){return{success:!1,message:"清除Cookie失败",error:String(i)}}}async function Pe(t){var i,e,r,s,n,a,o,l,c,m,u,h,f,d,E,v,_,S,x,R,M,T,D,O,P,g,k,p,w,B,V,j,Y,z,ne,Q,I,ae,K,X,Z,N,H,ee,te;try{switch(t.action){case"fill":return await ut(t.target,(i=t.params)==null?void 0:i.value);case"click":return await mt(t.target);case"highlight":return await ft(t.target,(e=t.params)==null?void 0:e.color);case"underline":return await dt(t.target);case"select":return await gt(t.target,(r=t.params)==null?void 0:r.value);case"check":return await bt(t.target);case"scroll":return await Et((s=t.params)==null?void 0:s.direction);case"read":return await yt(t.target);case"hover":return await vt(t.target);case"type":return await _t(t.target,(n=t.params)==null?void 0:n.value,(a=t.params)==null?void 0:a.delay);case"press":return await Nt((o=t.params)==null?void 0:o.key,(l=t.target)==null?void 0:l.selector);case"drag":return await Tt(t.target,(c=t.params)==null?void 0:c.destination);case"wait":return await wt(t.target,(m=t.params)==null?void 0:m.timeout,(u=t.params)==null?void 0:u.condition);case"focus":return await At(t.target);case"blur":return await St(t.target);case"clear":return await xt(t.target);case"getAttribute":return await Ct(t.target,(h=t.params)==null?void 0:h.attribute);case"getProperty":return await It(t.target,(f=t.params)==null?void 0:f.property);case"navigate":return await Lt((d=t.params)==null?void 0:d.navigateAction,(E=t.params)==null?void 0:E.url);case"scrollIntoView":return await Rt(t.target,(v=t.params)==null?void 0:v.behavior,(_=t.params)==null?void 0:_.block);case"switchFrame":return await Ot((S=t.params)==null?void 0:S.frameSelector);case"handleDialog":return await Dt((x=t.params)==null?void 0:x.dialogAction,(R=t.params)==null?void 0:R.promptText);case"setLocalStorage":return await Pt((M=t.params)==null?void 0:M.key,(T=t.params)==null?void 0:T.value);case"getLocalStorage":return await Mt((D=t.params)==null?void 0:D.key);case"clearLocalStorage":return await kt((O=t.params)==null?void 0:O.prefix);case"setCookie":return await $t((P=t.params)==null?void 0:P.name,(g=t.params)==null?void 0:g.value,(k=t.params)==null?void 0:k.cookieOptions);case"getCookie":return await Ut((p=t.params)==null?void 0:p.name);case"clearCookies":return await er((w=t.params)==null?void 0:w.name);case"doubleClick":return await Bt(t.target);case"rightClick":return await Ht(t.target);case"selectText":return await qt(t.target,(B=t.params)==null?void 0:B.searchText,(V=t.params)==null?void 0:V.startOffset,(j=t.params)==null?void 0:j.endOffset);case"copyToClipboard":return await Wt(t.target,(Y=t.params)==null?void 0:Y.text);case"pasteFromClipboard":return await Xt(t.target);case"upload":return await Ft(t.target,(z=t.params)==null?void 0:z.files);case"evaluate":return await Vt((ne=t.params)==null?void 0:ne.script);case"addListItem":return await jt(t.target,(Q=t.params)==null?void 0:Q.listSelector,(I=t.params)==null?void 0:I.itemContent,(ae=t.params)==null?void 0:ae.position);case"removeListItem":return await Yt(t.target,(K=t.params)==null?void 0:K.itemIndex);case"editListItem":return await zt(t.target,(X=t.params)==null?void 0:X.itemContent);case"setContent":return await Kt(t.target,(Z=t.params)==null?void 0:Z.content);case"appendContent":return await Jt(t.target,(N=t.params)==null?void 0:N.content);case"prependContent":return await Qt(t.target,(H=t.params)==null?void 0:H.content);case"insertHTML":return await Zt(t.target,(ee=t.params)==null?void 0:ee.html,(te=t.params)==null?void 0:te.insertPosition);default:return{success:!1,message:`不支持的操作类型: ${t.action}`,error:"UNSUPPORTED_ACTION"}}}catch(oe){return{success:!1,message:`执行操作时出错: ${oe}`,error:"EXECUTION_ERROR"}}}async function tr(t){const i=[];let e=0;for(const s of t){const n=await Pe(s);i.push(n),n.success&&e++,await ie(100)}const r=`执行了 ${t.length} 个操作，成功 ${e} 个，失败 ${t.length-e} 个`;return{success:e===t.length,results:i,summary:r}}function rr(){document.querySelectorAll(".ai-highlight").forEach(t=>{const i=t.parentNode;i&&(i.replaceChild(document.createTextNode(t.textContent||""),t),i.normalize())}),document.querySelectorAll(".ai-underline").forEach(t=>{const i=t.parentNode;i&&(i.replaceChild(document.createTextNode(t.textContent||""),t),i.normalize())})}var Me={exports:{}};(function(t){function i(e,r){if(r&&r.documentElement)e=r,r=arguments[2];else if(!e||!e.documentElement)throw new Error("First argument to Readability constructor should be a document object.");if(r=r||{},this._doc=e,this._docJSDOMParser=this._doc.firstChild.__JSDOMParser__,this._articleTitle=null,this._articleByline=null,this._articleDir=null,this._articleSiteName=null,this._attempts=[],this._metadata={},this._debug=!!r.debug,this._maxElemsToParse=r.maxElemsToParse||this.DEFAULT_MAX_ELEMS_TO_PARSE,this._nbTopCandidates=r.nbTopCandidates||this.DEFAULT_N_TOP_CANDIDATES,this._charThreshold=r.charThreshold||this.DEFAULT_CHAR_THRESHOLD,this._classesToPreserve=this.CLASSES_TO_PRESERVE.concat(r.classesToPreserve||[]),this._keepClasses=!!r.keepClasses,this._serializer=r.serializer||function(s){return s.innerHTML},this._disableJSONLD=!!r.disableJSONLD,this._allowedVideoRegex=r.allowedVideoRegex||this.REGEXPS.videos,this._linkDensityModifier=r.linkDensityModifier||0,this._flags=this.FLAG_STRIP_UNLIKELYS|this.FLAG_WEIGHT_CLASSES|this.FLAG_CLEAN_CONDITIONALLY,this._debug){let s=function(n){if(n.nodeType==n.TEXT_NODE)return`${n.nodeName} ("${n.textContent}")`;let a=Array.from(n.attributes||[],function(o){return`${o.name}="${o.value}"`}).join(" ");return`<${n.localName} ${a}>`};this.log=function(){if(typeof console<"u"){let a=Array.from(arguments,o=>o&&o.nodeType==this.ELEMENT_NODE?s(o):o);a.unshift("Reader: (Readability)"),console.log(...a)}else if(typeof dump<"u"){var n=Array.prototype.map.call(arguments,function(a){return a&&a.nodeName?s(a):a}).join(" ");dump("Reader: (Readability) "+n+`
`)}}}else this.log=function(){}}i.prototype={FLAG_STRIP_UNLIKELYS:1,FLAG_WEIGHT_CLASSES:2,FLAG_CLEAN_CONDITIONALLY:4,ELEMENT_NODE:1,TEXT_NODE:3,DEFAULT_MAX_ELEMS_TO_PARSE:0,DEFAULT_N_TOP_CANDIDATES:5,DEFAULT_TAGS_TO_SCORE:"section,h2,h3,h4,h5,h6,p,td,pre".toUpperCase().split(","),DEFAULT_CHAR_THRESHOLD:500,REGEXPS:{unlikelyCandidates:/-ad-|ai2html|banner|breadcrumbs|combx|comment|community|cover-wrap|disqus|extra|footer|gdpr|header|legends|menu|related|remark|replies|rss|shoutbox|sidebar|skyscraper|social|sponsor|supplemental|ad-break|agegate|pagination|pager|popup|yom-remote/i,okMaybeItsACandidate:/and|article|body|column|content|main|shadow/i,positive:/article|body|content|entry|hentry|h-entry|main|page|pagination|post|text|blog|story/i,negative:/-ad-|hidden|^hid$| hid$| hid |^hid |banner|combx|comment|com-|contact|footer|gdpr|masthead|media|meta|outbrain|promo|related|scroll|share|shoutbox|sidebar|skyscraper|sponsor|shopping|tags|widget/i,extraneous:/print|archive|comment|discuss|e[\-]?mail|share|reply|all|login|sign|single|utility/i,byline:/byline|author|dateline|writtenby|p-author/i,replaceFonts:/<(\/?)font[^>]*>/gi,normalize:/\s{2,}/g,videos:/\/\/(www\.)?((dailymotion|youtube|youtube-nocookie|player\.vimeo|v\.qq)\.com|(archive|upload\.wikimedia)\.org|player\.twitch\.tv)/i,shareElements:/(\b|_)(share|sharedaddy)(\b|_)/i,nextLink:/(next|weiter|continue|>([^\|]|$)|»([^\|]|$))/i,prevLink:/(prev|earl|old|new|<|«)/i,tokenize:/\W+/g,whitespace:/^\s*$/,hasContent:/\S$/,hashUrl:/^#.+/,srcsetUrl:/(\S+)(\s+[\d.]+[xw])?(\s*(?:,|$))/g,b64DataUrl:/^data:\s*([^\s;,]+)\s*;\s*base64\s*,/i,commas:/\u002C|\u060C|\uFE50|\uFE10|\uFE11|\u2E41|\u2E34|\u2E32|\uFF0C/g,jsonLdArticleTypes:/^Article|AdvertiserContentArticle|NewsArticle|AnalysisNewsArticle|AskPublicNewsArticle|BackgroundNewsArticle|OpinionNewsArticle|ReportageNewsArticle|ReviewNewsArticle|Report|SatiricalArticle|ScholarlyArticle|MedicalScholarlyArticle|SocialMediaPosting|BlogPosting|LiveBlogPosting|DiscussionForumPosting|TechArticle|APIReference$/,adWords:/^(ad(vertising|vertisement)?|pub(licité)?|werb(ung)?|广告|Реклама|Anuncio)$/iu,loadingWords:/^((loading|正在加载|Загрузка|chargement|cargando)(…|\.\.\.)?)$/iu},UNLIKELY_ROLES:["menu","menubar","complementary","navigation","alert","alertdialog","dialog"],DIV_TO_P_ELEMS:new Set(["BLOCKQUOTE","DL","DIV","IMG","OL","P","PRE","TABLE","UL"]),ALTER_TO_DIV_EXCEPTIONS:["DIV","ARTICLE","SECTION","P","OL","UL"],PRESENTATIONAL_ATTRIBUTES:["align","background","bgcolor","border","cellpadding","cellspacing","frame","hspace","rules","style","valign","vspace"],DEPRECATED_SIZE_ATTRIBUTE_ELEMS:["TABLE","TH","TD","HR","PRE"],PHRASING_ELEMS:["ABBR","AUDIO","B","BDO","BR","BUTTON","CITE","CODE","DATA","DATALIST","DFN","EM","EMBED","I","IMG","INPUT","KBD","LABEL","MARK","MATH","METER","NOSCRIPT","OBJECT","OUTPUT","PROGRESS","Q","RUBY","SAMP","SCRIPT","SELECT","SMALL","SPAN","STRONG","SUB","SUP","TEXTAREA","TIME","VAR","WBR"],CLASSES_TO_PRESERVE:["page"],HTML_ESCAPE_MAP:{lt:"<",gt:">",amp:"&",quot:'"',apos:"'"},_postProcessContent(e){this._fixRelativeUris(e),this._simplifyNestedElements(e),this._keepClasses||this._cleanClasses(e)},_removeNodes(e,r){if(this._docJSDOMParser&&e._isLiveNodeList)throw new Error("Do not pass live node lists to _removeNodes");for(var s=e.length-1;s>=0;s--){var n=e[s],a=n.parentNode;a&&(!r||r.call(this,n,s,e))&&a.removeChild(n)}},_replaceNodeTags(e,r){if(this._docJSDOMParser&&e._isLiveNodeList)throw new Error("Do not pass live node lists to _replaceNodeTags");for(const s of e)this._setNodeTag(s,r)},_forEachNode(e,r){Array.prototype.forEach.call(e,r,this)},_findNode(e,r){return Array.prototype.find.call(e,r,this)},_someNode(e,r){return Array.prototype.some.call(e,r,this)},_everyNode(e,r){return Array.prototype.every.call(e,r,this)},_getAllNodesWithTag(e,r){return e.querySelectorAll?e.querySelectorAll(r.join(",")):[].concat.apply([],r.map(function(s){var n=e.getElementsByTagName(s);return Array.isArray(n)?n:Array.from(n)}))},_cleanClasses(e){var r=this._classesToPreserve,s=(e.getAttribute("class")||"").split(/\s+/).filter(n=>r.includes(n)).join(" ");for(s?e.setAttribute("class",s):e.removeAttribute("class"),e=e.firstElementChild;e;e=e.nextElementSibling)this._cleanClasses(e)},_isUrl(e){try{return new URL(e),!0}catch{return!1}},_fixRelativeUris(e){var r=this._doc.baseURI,s=this._doc.documentURI;function n(l){if(r==s&&l.charAt(0)=="#")return l;try{return new URL(l,r).href}catch{}return l}var a=this._getAllNodesWithTag(e,["a"]);this._forEachNode(a,function(l){var c=l.getAttribute("href");if(c)if(c.indexOf("javascript:")===0)if(l.childNodes.length===1&&l.childNodes[0].nodeType===this.TEXT_NODE){var m=this._doc.createTextNode(l.textContent);l.parentNode.replaceChild(m,l)}else{for(var u=this._doc.createElement("span");l.firstChild;)u.appendChild(l.firstChild);l.parentNode.replaceChild(u,l)}else l.setAttribute("href",n(c))});var o=this._getAllNodesWithTag(e,["img","picture","figure","video","audio","source"]);this._forEachNode(o,function(l){var c=l.getAttribute("src"),m=l.getAttribute("poster"),u=l.getAttribute("srcset");if(c&&l.setAttribute("src",n(c)),m&&l.setAttribute("poster",n(m)),u){var h=u.replace(this.REGEXPS.srcsetUrl,function(f,d,E,v){return n(d)+(E||"")+v});l.setAttribute("srcset",h)}})},_simplifyNestedElements(e){for(var r=e;r;){if(r.parentNode&&["DIV","SECTION"].includes(r.tagName)&&!(r.id&&r.id.startsWith("readability"))){if(this._isElementWithoutContent(r)){r=this._removeAndGetNext(r);continue}else if(this._hasSingleTagInsideElement(r,"DIV")||this._hasSingleTagInsideElement(r,"SECTION")){for(var s=r.children[0],n=0;n<r.attributes.length;n++)s.setAttributeNode(r.attributes[n].cloneNode());r.parentNode.replaceChild(s,r),r=s;continue}}r=this._getNextNode(r)}},_getArticleTitle(){var e=this._doc,r="",s="";try{r=s=e.title.trim(),typeof r!="string"&&(r=s=this._getInnerText(e.getElementsByTagName("title")[0]))}catch{}var n=!1;function a(h){return h.split(/\s+/).length}if(/ [\|\-\\\/>»] /.test(r)){n=/ [\\\/>»] /.test(r);let h=Array.from(s.matchAll(/ [\|\-\\\/>»] /gi));r=s.substring(0,h.pop().index),a(r)<3&&(r=s.replace(/^[^\|\-\\\/>»]*[\|\-\\\/>»]/gi,""))}else if(r.includes(": ")){var o=this._getAllNodesWithTag(e,["h1","h2"]),l=r.trim(),c=this._someNode(o,function(h){return h.textContent.trim()===l});c||(r=s.substring(s.lastIndexOf(":")+1),a(r)<3?r=s.substring(s.indexOf(":")+1):a(s.substr(0,s.indexOf(":")))>5&&(r=s))}else if(r.length>150||r.length<15){var m=e.getElementsByTagName("h1");m.length===1&&(r=this._getInnerText(m[0]))}r=r.trim().replace(this.REGEXPS.normalize," ");var u=a(r);return u<=4&&(!n||u!=a(s.replace(/[\|\-\\\/>»]+/g,""))-1)&&(r=s),r},_prepDocument(){var e=this._doc;this._removeNodes(this._getAllNodesWithTag(e,["style"])),e.body&&this._replaceBrs(e.body),this._replaceNodeTags(this._getAllNodesWithTag(e,["font"]),"SPAN")},_nextNode(e){for(var r=e;r&&r.nodeType!=this.ELEMENT_NODE&&this.REGEXPS.whitespace.test(r.textContent);)r=r.nextSibling;return r},_replaceBrs(e){this._forEachNode(this._getAllNodesWithTag(e,["br"]),function(r){for(var s=r.nextSibling,n=!1;(s=this._nextNode(s))&&s.tagName=="BR";){n=!0;var a=s.nextSibling;s.remove(),s=a}if(n){var o=this._doc.createElement("p");for(r.parentNode.replaceChild(o,r),s=o.nextSibling;s;){if(s.tagName=="BR"){var l=this._nextNode(s.nextSibling);if(l&&l.tagName=="BR")break}if(!this._isPhrasingContent(s))break;var c=s.nextSibling;o.appendChild(s),s=c}for(;o.lastChild&&this._isWhitespace(o.lastChild);)o.lastChild.remove();o.parentNode.tagName==="P"&&this._setNodeTag(o.parentNode,"DIV")}})},_setNodeTag(e,r){if(this.log("_setNodeTag",e,r),this._docJSDOMParser)return e.localName=r.toLowerCase(),e.tagName=r.toUpperCase(),e;for(var s=e.ownerDocument.createElement(r);e.firstChild;)s.appendChild(e.firstChild);e.parentNode.replaceChild(s,e),e.readability&&(s.readability=e.readability);for(var n=0;n<e.attributes.length;n++)s.setAttributeNode(e.attributes[n].cloneNode());return s},_prepArticle(e){this._cleanStyles(e),this._markDataTables(e),this._fixLazyImages(e),this._cleanConditionally(e,"form"),this._cleanConditionally(e,"fieldset"),this._clean(e,"object"),this._clean(e,"embed"),this._clean(e,"footer"),this._clean(e,"link"),this._clean(e,"aside");var r=this.DEFAULT_CHAR_THRESHOLD;this._forEachNode(e.children,function(s){this._cleanMatchedNodes(s,function(n,a){return this.REGEXPS.shareElements.test(a)&&n.textContent.length<r})}),this._clean(e,"iframe"),this._clean(e,"input"),this._clean(e,"textarea"),this._clean(e,"select"),this._clean(e,"button"),this._cleanHeaders(e),this._cleanConditionally(e,"table"),this._cleanConditionally(e,"ul"),this._cleanConditionally(e,"div"),this._replaceNodeTags(this._getAllNodesWithTag(e,["h1"]),"h2"),this._removeNodes(this._getAllNodesWithTag(e,["p"]),function(s){var n=this._getAllNodesWithTag(s,["img","embed","object","iframe"]).length;return n===0&&!this._getInnerText(s,!1)}),this._forEachNode(this._getAllNodesWithTag(e,["br"]),function(s){var n=this._nextNode(s.nextSibling);n&&n.tagName=="P"&&s.remove()}),this._forEachNode(this._getAllNodesWithTag(e,["table"]),function(s){var n=this._hasSingleTagInsideElement(s,"TBODY")?s.firstElementChild:s;if(this._hasSingleTagInsideElement(n,"TR")){var a=n.firstElementChild;if(this._hasSingleTagInsideElement(a,"TD")){var o=a.firstElementChild;o=this._setNodeTag(o,this._everyNode(o.childNodes,this._isPhrasingContent)?"P":"DIV"),s.parentNode.replaceChild(o,s)}}})},_initializeNode(e){switch(e.readability={contentScore:0},e.tagName){case"DIV":e.readability.contentScore+=5;break;case"PRE":case"TD":case"BLOCKQUOTE":e.readability.contentScore+=3;break;case"ADDRESS":case"OL":case"UL":case"DL":case"DD":case"DT":case"LI":case"FORM":e.readability.contentScore-=3;break;case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"TH":e.readability.contentScore-=5;break}e.readability.contentScore+=this._getClassWeight(e)},_removeAndGetNext(e){var r=this._getNextNode(e,!0);return e.remove(),r},_getNextNode(e,r){if(!r&&e.firstElementChild)return e.firstElementChild;if(e.nextElementSibling)return e.nextElementSibling;do e=e.parentNode;while(e&&!e.nextElementSibling);return e&&e.nextElementSibling},_textSimilarity(e,r){var s=e.toLowerCase().split(this.REGEXPS.tokenize).filter(Boolean),n=r.toLowerCase().split(this.REGEXPS.tokenize).filter(Boolean);if(!s.length||!n.length)return 0;var a=n.filter(l=>!s.includes(l)),o=a.join(" ").length/n.join(" ").length;return 1-o},_isValidByline(e,r){var s=e.getAttribute("rel"),n=e.getAttribute("itemprop"),a=e.textContent.trim().length;return(s==="author"||n&&n.includes("author")||this.REGEXPS.byline.test(r))&&!!a&&a<100},_getNodeAncestors(e,r){r=r||0;for(var s=0,n=[];e.parentNode&&(n.push(e.parentNode),!(r&&++s===r));)e=e.parentNode;return n},_grabArticle(e){this.log("**** grabArticle ****");var r=this._doc,s=e!==null;if(e=e||this._doc.body,!e)return this.log("No body found in document. Abort."),null;for(var n=e.innerHTML;;){this.log("Starting grabArticle loop");var a=this._flagIsActive(this.FLAG_STRIP_UNLIKELYS),o=[],l=this._doc.documentElement;let Ee=!0;for(;l;){l.tagName==="HTML"&&(this._articleLang=l.getAttribute("lang"));var c=l.className+" "+l.id;if(!this._isProbablyVisible(l)){this.log("Removing hidden node - "+c),l=this._removeAndGetNext(l);continue}if(l.getAttribute("aria-modal")=="true"&&l.getAttribute("role")=="dialog"){l=this._removeAndGetNext(l);continue}if(!this._articleByline&&!this._metadata.byline&&this._isValidByline(l,c)){for(var m=this._getNextNode(l,!0),u=this._getNextNode(l),h=null;u&&u!=m;){var f=u.getAttribute("itemprop");if(f&&f.includes("name")){h=u;break}else u=this._getNextNode(u)}this._articleByline=(h??l).textContent.trim(),l=this._removeAndGetNext(l);continue}if(Ee&&this._headerDuplicatesTitle(l)){this.log("Removing header: ",l.textContent.trim(),this._articleTitle.trim()),Ee=!1,l=this._removeAndGetNext(l);continue}if(a){if(this.REGEXPS.unlikelyCandidates.test(c)&&!this.REGEXPS.okMaybeItsACandidate.test(c)&&!this._hasAncestorTag(l,"table")&&!this._hasAncestorTag(l,"code")&&l.tagName!=="BODY"&&l.tagName!=="A"){this.log("Removing unlikely candidate - "+c),l=this._removeAndGetNext(l);continue}if(this.UNLIKELY_ROLES.includes(l.getAttribute("role"))){this.log("Removing content with role "+l.getAttribute("role")+" - "+c),l=this._removeAndGetNext(l);continue}}if((l.tagName==="DIV"||l.tagName==="SECTION"||l.tagName==="HEADER"||l.tagName==="H1"||l.tagName==="H2"||l.tagName==="H3"||l.tagName==="H4"||l.tagName==="H5"||l.tagName==="H6")&&this._isElementWithoutContent(l)){l=this._removeAndGetNext(l);continue}if(this.DEFAULT_TAGS_TO_SCORE.includes(l.tagName)&&o.push(l),l.tagName==="DIV"){for(var d=null,E=l.firstChild;E;){var v=E.nextSibling;if(this._isPhrasingContent(E))d!==null?d.appendChild(E):this._isWhitespace(E)||(d=r.createElement("p"),l.replaceChild(d,E),d.appendChild(E));else if(d!==null){for(;d.lastChild&&this._isWhitespace(d.lastChild);)d.lastChild.remove();d=null}E=v}if(this._hasSingleTagInsideElement(l,"P")&&this._getLinkDensity(l)<.25){var _=l.children[0];l.parentNode.replaceChild(_,l),l=_,o.push(l)}else this._hasChildBlockElement(l)||(l=this._setNodeTag(l,"P"),o.push(l))}l=this._getNextNode(l)}var S=[];this._forEachNode(o,function($){if(!(!$.parentNode||typeof $.parentNode.tagName>"u")){var q=this._getInnerText($);if(!(q.length<25)){var ye=this._getNodeAncestors($,5);if(ye.length!==0){var ce=0;ce+=1,ce+=q.split(this.REGEXPS.commas).length,ce+=Math.min(Math.floor(q.length/100),3),this._forEachNode(ye,function(F,fe){if(!(!F.tagName||!F.parentNode||typeof F.parentNode.tagName>"u")){if(typeof F.readability>"u"&&(this._initializeNode(F),S.push(F)),fe===0)var de=1;else fe===1?de=2:de=fe*3;F.readability.contentScore+=ce/de}})}}}});for(var x=[],R=0,M=S.length;R<M;R+=1){var T=S[R],D=T.readability.contentScore*(1-this._getLinkDensity(T));T.readability.contentScore=D,this.log("Candidate:",T,"with score "+D);for(var O=0;O<this._nbTopCandidates;O++){var P=x[O];if(!P||D>P.readability.contentScore){x.splice(O,0,T),x.length>this._nbTopCandidates&&x.pop();break}}}var g=x[0]||null,k=!1,p;if(g===null||g.tagName==="BODY"){for(g=r.createElement("DIV"),k=!0;e.firstChild;)this.log("Moving child out:",e.firstChild),g.appendChild(e.firstChild);e.appendChild(g),this._initializeNode(g)}else if(g){for(var w=[],B=1;B<x.length;B++)x[B].readability.contentScore/g.readability.contentScore>=.75&&w.push(this._getNodeAncestors(x[B]));var V=3;if(w.length>=V)for(p=g.parentNode;p.tagName!=="BODY";){for(var j=0,Y=0;Y<w.length&&j<V;Y++)j+=Number(w[Y].includes(p));if(j>=V){g=p;break}p=p.parentNode}g.readability||this._initializeNode(g),p=g.parentNode;for(var z=g.readability.contentScore,ne=z/3;p.tagName!=="BODY";){if(!p.readability){p=p.parentNode;continue}var Q=p.readability.contentScore;if(Q<ne)break;if(Q>z){g=p;break}z=p.readability.contentScore,p=p.parentNode}for(p=g.parentNode;p.tagName!="BODY"&&p.children.length==1;)g=p,p=g.parentNode;g.readability||this._initializeNode(g)}var I=r.createElement("DIV");s&&(I.id="readability-content");var ae=Math.max(10,g.readability.contentScore*.2);p=g.parentNode;for(var K=p.children,X=0,Z=K.length;X<Z;X++){var N=K[X],H=!1;if(this.log("Looking at sibling node:",N,N.readability?"with score "+N.readability.contentScore:""),this.log("Sibling has score",N.readability?N.readability.contentScore:"Unknown"),N===g)H=!0;else{var ee=0;if(N.className===g.className&&g.className!==""&&(ee+=g.readability.contentScore*.2),N.readability&&N.readability.contentScore+ee>=ae)H=!0;else if(N.nodeName==="P"){var te=this._getLinkDensity(N),oe=this._getInnerText(N),he=oe.length;(he>80&&te<.25||he<80&&he>0&&te===0&&oe.search(/\.( |$)/)!==-1)&&(H=!0)}}H&&(this.log("Appending node:",N),this.ALTER_TO_DIV_EXCEPTIONS.includes(N.nodeName)||(this.log("Altering sibling:",N,"to div."),N=this._setNodeTag(N,"DIV")),I.appendChild(N),K=p.children,X-=1,Z-=1)}if(this._debug&&this.log("Article content pre-prep: "+I.innerHTML),this._prepArticle(I),this._debug&&this.log("Article content post-prep: "+I.innerHTML),k)g.id="readability-page-1",g.className="page";else{var le=r.createElement("DIV");for(le.id="readability-page-1",le.className="page";I.firstChild;)le.appendChild(I.firstChild);I.appendChild(le)}this._debug&&this.log("Article content after paging: "+I.innerHTML);var me=!0,be=this._getInnerText(I,!0).length;if(be<this._charThreshold)if(me=!1,e.innerHTML=n,this._attempts.push({articleContent:I,textLength:be}),this._flagIsActive(this.FLAG_STRIP_UNLIKELYS))this._removeFlag(this.FLAG_STRIP_UNLIKELYS);else if(this._flagIsActive(this.FLAG_WEIGHT_CLASSES))this._removeFlag(this.FLAG_WEIGHT_CLASSES);else if(this._flagIsActive(this.FLAG_CLEAN_CONDITIONALLY))this._removeFlag(this.FLAG_CLEAN_CONDITIONALLY);else{if(this._attempts.sort(function($,q){return q.textLength-$.textLength}),!this._attempts[0].textLength)return null;I=this._attempts[0].articleContent,me=!0}if(me){var Be=[p,g].concat(this._getNodeAncestors(p));return this._someNode(Be,function($){if(!$.tagName)return!1;var q=$.getAttribute("dir");return q?(this._articleDir=q,!0):!1}),I}}},_unescapeHtmlEntities(e){if(!e)return e;var r=this.HTML_ESCAPE_MAP;return e.replace(/&(quot|amp|apos|lt|gt);/g,function(s,n){return r[n]}).replace(/&#(?:x([0-9a-f]+)|([0-9]+));/gi,function(s,n,a){var o=parseInt(n||a,n?16:10);return(o==0||o>1114111||o>=55296&&o<=57343)&&(o=65533),String.fromCodePoint(o)})},_getJSONLD(e){var r=this._getAllNodesWithTag(e,["script"]),s;return this._forEachNode(r,function(n){if(!s&&n.getAttribute("type")==="application/ld+json")try{var a=n.textContent.replace(/^\s*<!\[CDATA\[|\]\]>\s*$/g,""),o=JSON.parse(a);if(Array.isArray(o)&&(o=o.find(f=>f["@type"]&&f["@type"].match(this.REGEXPS.jsonLdArticleTypes)),!o))return;var l=/^https?\:\/\/schema\.org\/?$/,c=typeof o["@context"]=="string"&&o["@context"].match(l)||typeof o["@context"]=="object"&&typeof o["@context"]["@vocab"]=="string"&&o["@context"]["@vocab"].match(l);if(!c||(!o["@type"]&&Array.isArray(o["@graph"])&&(o=o["@graph"].find(f=>(f["@type"]||"").match(this.REGEXPS.jsonLdArticleTypes))),!o||!o["@type"]||!o["@type"].match(this.REGEXPS.jsonLdArticleTypes)))return;if(s={},typeof o.name=="string"&&typeof o.headline=="string"&&o.name!==o.headline){var m=this._getArticleTitle(),u=this._textSimilarity(o.name,m)>.75,h=this._textSimilarity(o.headline,m)>.75;h&&!u?s.title=o.headline:s.title=o.name}else typeof o.name=="string"?s.title=o.name.trim():typeof o.headline=="string"&&(s.title=o.headline.trim());o.author&&(typeof o.author.name=="string"?s.byline=o.author.name.trim():Array.isArray(o.author)&&o.author[0]&&typeof o.author[0].name=="string"&&(s.byline=o.author.filter(function(f){return f&&typeof f.name=="string"}).map(function(f){return f.name.trim()}).join(", "))),typeof o.description=="string"&&(s.excerpt=o.description.trim()),o.publisher&&typeof o.publisher.name=="string"&&(s.siteName=o.publisher.name.trim()),typeof o.datePublished=="string"&&(s.datePublished=o.datePublished.trim())}catch(f){this.log(f.message)}}),s||{}},_getArticleMetadata(e){var r={},s={},n=this._doc.getElementsByTagName("meta"),a=/\s*(article|dc|dcterm|og|twitter)\s*:\s*(author|creator|description|published_time|title|site_name)\s*/gi,o=/^\s*(?:(dc|dcterm|og|twitter|parsely|weibo:(article|webpage))\s*[-\.:]\s*)?(author|creator|pub-date|description|title|site_name)\s*$/i;this._forEachNode(n,function(c){var m=c.getAttribute("name"),u=c.getAttribute("property"),h=c.getAttribute("content");if(h){var f=null,d=null;u&&(f=u.match(a),f&&(d=f[0].toLowerCase().replace(/\s/g,""),s[d]=h.trim())),!f&&m&&o.test(m)&&(d=m,h&&(d=d.toLowerCase().replace(/\s/g,"").replace(/\./g,":"),s[d]=h.trim()))}}),r.title=e.title||s["dc:title"]||s["dcterm:title"]||s["og:title"]||s["weibo:article:title"]||s["weibo:webpage:title"]||s.title||s["twitter:title"]||s["parsely-title"],r.title||(r.title=this._getArticleTitle());const l=typeof s["article:author"]=="string"&&!this._isUrl(s["article:author"])?s["article:author"]:void 0;return r.byline=e.byline||s["dc:creator"]||s["dcterm:creator"]||s.author||s["parsely-author"]||l,r.excerpt=e.excerpt||s["dc:description"]||s["dcterm:description"]||s["og:description"]||s["weibo:article:description"]||s["weibo:webpage:description"]||s.description||s["twitter:description"],r.siteName=e.siteName||s["og:site_name"],r.publishedTime=e.datePublished||s["article:published_time"]||s["parsely-pub-date"]||null,r.title=this._unescapeHtmlEntities(r.title),r.byline=this._unescapeHtmlEntities(r.byline),r.excerpt=this._unescapeHtmlEntities(r.excerpt),r.siteName=this._unescapeHtmlEntities(r.siteName),r.publishedTime=this._unescapeHtmlEntities(r.publishedTime),r},_isSingleImage(e){for(;e;){if(e.tagName==="IMG")return!0;if(e.children.length!==1||e.textContent.trim()!=="")return!1;e=e.children[0]}return!1},_unwrapNoscriptImages(e){var r=Array.from(e.getElementsByTagName("img"));this._forEachNode(r,function(n){for(var a=0;a<n.attributes.length;a++){var o=n.attributes[a];switch(o.name){case"src":case"srcset":case"data-src":case"data-srcset":return}if(/\.(jpg|jpeg|png|webp)/i.test(o.value))return}n.remove()});var s=Array.from(e.getElementsByTagName("noscript"));this._forEachNode(s,function(n){if(this._isSingleImage(n)){var a=e.createElement("div");a.innerHTML=n.innerHTML;var o=n.previousElementSibling;if(o&&this._isSingleImage(o)){var l=o;l.tagName!=="IMG"&&(l=o.getElementsByTagName("img")[0]);for(var c=a.getElementsByTagName("img")[0],m=0;m<l.attributes.length;m++){var u=l.attributes[m];if(u.value!==""&&(u.name==="src"||u.name==="srcset"||/\.(jpg|jpeg|png|webp)/i.test(u.value))){if(c.getAttribute(u.name)===u.value)continue;var h=u.name;c.hasAttribute(h)&&(h="data-old-"+h),c.setAttribute(h,u.value)}}n.parentNode.replaceChild(a.firstElementChild,o)}}})},_removeScripts(e){this._removeNodes(this._getAllNodesWithTag(e,["script","noscript"]))},_hasSingleTagInsideElement(e,r){return e.children.length!=1||e.children[0].tagName!==r?!1:!this._someNode(e.childNodes,function(s){return s.nodeType===this.TEXT_NODE&&this.REGEXPS.hasContent.test(s.textContent)})},_isElementWithoutContent(e){return e.nodeType===this.ELEMENT_NODE&&!e.textContent.trim().length&&(!e.children.length||e.children.length==e.getElementsByTagName("br").length+e.getElementsByTagName("hr").length)},_hasChildBlockElement(e){return this._someNode(e.childNodes,function(r){return this.DIV_TO_P_ELEMS.has(r.tagName)||this._hasChildBlockElement(r)})},_isPhrasingContent(e){return e.nodeType===this.TEXT_NODE||this.PHRASING_ELEMS.includes(e.tagName)||(e.tagName==="A"||e.tagName==="DEL"||e.tagName==="INS")&&this._everyNode(e.childNodes,this._isPhrasingContent)},_isWhitespace(e){return e.nodeType===this.TEXT_NODE&&e.textContent.trim().length===0||e.nodeType===this.ELEMENT_NODE&&e.tagName==="BR"},_getInnerText(e,r){r=typeof r>"u"?!0:r;var s=e.textContent.trim();return r?s.replace(this.REGEXPS.normalize," "):s},_getCharCount(e,r){return r=r||",",this._getInnerText(e).split(r).length-1},_cleanStyles(e){if(!(!e||e.tagName.toLowerCase()==="svg")){for(var r=0;r<this.PRESENTATIONAL_ATTRIBUTES.length;r++)e.removeAttribute(this.PRESENTATIONAL_ATTRIBUTES[r]);this.DEPRECATED_SIZE_ATTRIBUTE_ELEMS.includes(e.tagName)&&(e.removeAttribute("width"),e.removeAttribute("height"));for(var s=e.firstElementChild;s!==null;)this._cleanStyles(s),s=s.nextElementSibling}},_getLinkDensity(e){var r=this._getInnerText(e).length;if(r===0)return 0;var s=0;return this._forEachNode(e.getElementsByTagName("a"),function(n){var a=n.getAttribute("href"),o=a&&this.REGEXPS.hashUrl.test(a)?.3:1;s+=this._getInnerText(n).length*o}),s/r},_getClassWeight(e){if(!this._flagIsActive(this.FLAG_WEIGHT_CLASSES))return 0;var r=0;return typeof e.className=="string"&&e.className!==""&&(this.REGEXPS.negative.test(e.className)&&(r-=25),this.REGEXPS.positive.test(e.className)&&(r+=25)),typeof e.id=="string"&&e.id!==""&&(this.REGEXPS.negative.test(e.id)&&(r-=25),this.REGEXPS.positive.test(e.id)&&(r+=25)),r},_clean(e,r){var s=["object","embed","iframe"].includes(r);this._removeNodes(this._getAllNodesWithTag(e,[r]),function(n){if(s){for(var a=0;a<n.attributes.length;a++)if(this._allowedVideoRegex.test(n.attributes[a].value))return!1;if(n.tagName==="object"&&this._allowedVideoRegex.test(n.innerHTML))return!1}return!0})},_hasAncestorTag(e,r,s,n){s=s||3,r=r.toUpperCase();for(var a=0;e.parentNode;){if(s>0&&a>s)return!1;if(e.parentNode.tagName===r&&(!n||n(e.parentNode)))return!0;e=e.parentNode,a++}return!1},_getRowAndColumnCount(e){for(var r=0,s=0,n=e.getElementsByTagName("tr"),a=0;a<n.length;a++){var o=n[a].getAttribute("rowspan")||0;o&&(o=parseInt(o,10)),r+=o||1;for(var l=0,c=n[a].getElementsByTagName("td"),m=0;m<c.length;m++){var u=c[m].getAttribute("colspan")||0;u&&(u=parseInt(u,10)),l+=u||1}s=Math.max(s,l)}return{rows:r,columns:s}},_markDataTables(e){for(var r=e.getElementsByTagName("table"),s=0;s<r.length;s++){var n=r[s],a=n.getAttribute("role");if(a=="presentation"){n._readabilityDataTable=!1;continue}var o=n.getAttribute("datatable");if(o=="0"){n._readabilityDataTable=!1;continue}var l=n.getAttribute("summary");if(l){n._readabilityDataTable=!0;continue}var c=n.getElementsByTagName("caption")[0];if(c&&c.childNodes.length){n._readabilityDataTable=!0;continue}var m=["col","colgroup","tfoot","thead","th"],u=function(f){return!!n.getElementsByTagName(f)[0]};if(m.some(u)){this.log("Data table because found data-y descendant"),n._readabilityDataTable=!0;continue}if(n.getElementsByTagName("table")[0]){n._readabilityDataTable=!1;continue}var h=this._getRowAndColumnCount(n);if(h.columns==1||h.rows==1){n._readabilityDataTable=!1;continue}if(h.rows>=10||h.columns>4){n._readabilityDataTable=!0;continue}n._readabilityDataTable=h.rows*h.columns>10}},_fixLazyImages(e){this._forEachNode(this._getAllNodesWithTag(e,["img","picture","figure"]),function(r){if(r.src&&this.REGEXPS.b64DataUrl.test(r.src)){var s=this.REGEXPS.b64DataUrl.exec(r.src);if(s[1]==="image/svg+xml")return;for(var n=!1,a=0;a<r.attributes.length;a++){var o=r.attributes[a];if(o.name!=="src"&&/\.(jpg|jpeg|png|webp)/i.test(o.value)){n=!0;break}}if(n){var l=s[0].length,c=r.src.length-l;c<133&&r.removeAttribute("src")}}if(!((r.src||r.srcset&&r.srcset!="null")&&!r.className.toLowerCase().includes("lazy"))){for(var m=0;m<r.attributes.length;m++)if(o=r.attributes[m],!(o.name==="src"||o.name==="srcset"||o.name==="alt")){var u=null;if(/\.(jpg|jpeg|png|webp)\s+\d/.test(o.value)?u="srcset":/^\s*\S+\.(jpg|jpeg|png|webp)\S*\s*$/.test(o.value)&&(u="src"),u){if(r.tagName==="IMG"||r.tagName==="PICTURE")r.setAttribute(u,o.value);else if(r.tagName==="FIGURE"&&!this._getAllNodesWithTag(r,["img","picture"]).length){var h=this._doc.createElement("img");h.setAttribute(u,o.value),r.appendChild(h)}}}}})},_getTextDensity(e,r){var s=this._getInnerText(e,!0).length;if(s===0)return 0;var n=0,a=this._getAllNodesWithTag(e,r);return this._forEachNode(a,o=>n+=this._getInnerText(o,!0).length),n/s},_cleanConditionally(e,r){this._flagIsActive(this.FLAG_CLEAN_CONDITIONALLY)&&this._removeNodes(this._getAllNodesWithTag(e,[r]),function(s){var n=function(p){return p._readabilityDataTable},a=r==="ul"||r==="ol";if(!a){var o=0,l=this._getAllNodesWithTag(s,["ul","ol"]);this._forEachNode(l,p=>o+=this._getInnerText(p).length),a=o/this._getInnerText(s).length>.9}if(r==="table"&&n(s)||this._hasAncestorTag(s,"table",-1,n)||this._hasAncestorTag(s,"code")||[...s.getElementsByTagName("table")].some(p=>p._readabilityDataTable))return!1;var c=this._getClassWeight(s);this.log("Cleaning Conditionally",s);var m=0;if(c+m<0)return!0;if(this._getCharCount(s,",")<10){for(var u=s.getElementsByTagName("p").length,h=s.getElementsByTagName("img").length,f=s.getElementsByTagName("li").length-100,d=s.getElementsByTagName("input").length,E=this._getTextDensity(s,["h1","h2","h3","h4","h5","h6"]),v=0,_=this._getAllNodesWithTag(s,["object","embed","iframe"]),S=0;S<_.length;S++){for(var x=0;x<_[S].attributes.length;x++)if(this._allowedVideoRegex.test(_[S].attributes[x].value))return!1;if(_[S].tagName==="object"&&this._allowedVideoRegex.test(_[S].innerHTML))return!1;v++}var R=this._getInnerText(s);if(this.REGEXPS.adWords.test(R)||this.REGEXPS.loadingWords.test(R))return!0;var M=R.length,T=this._getLinkDensity(s),D=["SPAN","LI","TD"].concat(Array.from(this.DIV_TO_P_ELEMS)),O=this._getTextDensity(s,D),P=this._hasAncestorTag(s,"figure"),g=(()=>{const w=[];return!P&&h>1&&u/h<.5&&w.push(`Bad p to img ratio (img=${h}, p=${u})`),!a&&f>u&&w.push(`Too many li's outside of a list. (li=${f} > p=${u})`),d>Math.floor(u/3)&&w.push(`Too many inputs per p. (input=${d}, p=${u})`),!a&&!P&&E<.9&&M<25&&(h===0||h>2)&&T>0&&w.push(`Suspiciously short. (headingDensity=${E}, img=${h}, linkDensity=${T})`),!a&&c<25&&T>.2+this._linkDensityModifier&&w.push(`Low weight and a little linky. (linkDensity=${T})`),c>=25&&T>.5+this._linkDensityModifier&&w.push(`High weight and mostly links. (linkDensity=${T})`),(v===1&&M<75||v>1)&&w.push(`Suspicious embed. (embedCount=${v}, contentLength=${M})`),h===0&&O===0&&w.push(`No useful content. (img=${h}, textDensity=${O})`),w.length?(this.log("Checks failed",w),!0):!1})();if(a&&g){for(var k=0;k<s.children.length;k++)if(s.children[k].children.length>1)return g;let w=s.getElementsByTagName("li").length;if(h==w)return!1}return g}return!1})},_cleanMatchedNodes(e,r){for(var s=this._getNextNode(e,!0),n=this._getNextNode(e);n&&n!=s;)r.call(this,n,n.className+" "+n.id)?n=this._removeAndGetNext(n):n=this._getNextNode(n)},_cleanHeaders(e){let r=this._getAllNodesWithTag(e,["h1","h2"]);this._removeNodes(r,function(s){let n=this._getClassWeight(s)<0;return n&&this.log("Removing header with low class weight:",s),n})},_headerDuplicatesTitle(e){if(e.tagName!="H1"&&e.tagName!="H2")return!1;var r=this._getInnerText(e,!1);return this.log("Evaluating similarity of header:",r,this._articleTitle),this._textSimilarity(this._articleTitle,r)>.75},_flagIsActive(e){return(this._flags&e)>0},_removeFlag(e){this._flags=this._flags&~e},_isProbablyVisible(e){return(!e.style||e.style.display!="none")&&(!e.style||e.style.visibility!="hidden")&&!e.hasAttribute("hidden")&&(!e.hasAttribute("aria-hidden")||e.getAttribute("aria-hidden")!="true"||e.className&&e.className.includes&&e.className.includes("fallback-image"))},parse(){if(this._maxElemsToParse>0){var e=this._doc.getElementsByTagName("*").length;if(e>this._maxElemsToParse)throw new Error("Aborting parsing document; "+e+" elements found")}this._unwrapNoscriptImages(this._doc);var r=this._disableJSONLD?{}:this._getJSONLD(this._doc);this._removeScripts(this._doc),this._prepDocument();var s=this._getArticleMetadata(r);this._metadata=s,this._articleTitle=s.title;var n=this._grabArticle();if(!n)return null;if(this.log("Grabbed: "+n.innerHTML),this._postProcessContent(n),!s.excerpt){var a=n.getElementsByTagName("p");a.length&&(s.excerpt=a[0].textContent.trim())}var o=n.textContent;return{title:this._articleTitle,byline:s.byline||this._articleByline,dir:this._articleDir,lang:this._articleLang,content:this._serializer(n),textContent:o,length:o.length,excerpt:s.excerpt,siteName:s.siteName||this._articleSiteName,publishedTime:s.publishedTime}}},t.exports=i})(Me);var sr=Me.exports,ir={exports:{}};(function(t){var i={unlikelyCandidates:/-ad-|ai2html|banner|breadcrumbs|combx|comment|community|cover-wrap|disqus|extra|footer|gdpr|header|legends|menu|related|remark|replies|rss|shoutbox|sidebar|skyscraper|social|sponsor|supplemental|ad-break|agegate|pagination|pager|popup|yom-remote/i,okMaybeItsACandidate:/and|article|body|column|content|main|shadow/i};function e(s){return(!s.style||s.style.display!="none")&&!s.hasAttribute("hidden")&&(!s.hasAttribute("aria-hidden")||s.getAttribute("aria-hidden")!="true"||s.className&&s.className.includes&&s.className.includes("fallback-image"))}function r(s,n={}){typeof n=="function"&&(n={visibilityChecker:n});var a={minScore:20,minContentLength:140,visibilityChecker:e};n=Object.assign(a,n);var o=s.querySelectorAll("p, pre, article"),l=s.querySelectorAll("div > br");if(l.length){var c=new Set(o);[].forEach.call(l,function(u){c.add(u.parentNode)}),o=Array.from(c)}var m=0;return[].some.call(o,function(u){if(!n.visibilityChecker(u))return!1;var h=u.className+" "+u.id;if(i.unlikelyCandidates.test(h)&&!i.okMaybeItsACandidate.test(h)||u.matches("li p"))return!1;var f=u.textContent.trim().length;return f<n.minContentLength?!1:(m+=Math.sqrt(f-n.minContentLength),m>n.minScore)})}t.exports=r})(ir);var nr=sr,Ae={Readability:nr};function ar(){try{if(Ae.Readability){const t=document.cloneNode(!0),e=new Ae.Readability(t,{debug:!1,maxElemsToDivideToDivs:5,nbTopCandidates:5,charThreshold:500,classesToPreserve:["ai-chat-container","ai-highlight","ai-underline"]}).parse();if(e)return{title:e.title||document.title,content:e.textContent||e.content||"",excerpt:e.excerpt||"",byline:e.byline||void 0,length:e.length||0,siteName:e.siteName||void 0}}return Se()}catch(t){return console.error("页面总结失败:",t),Se()}}function Se(){var s,n;const t=document.querySelector('main, article, [role="main"], .content, #content')||document.body,i=or(t),e=((n=(s=document.querySelector("h1"))==null?void 0:s.textContent)==null?void 0:n.trim())||document.title,r=i.substring(0,500).replace(/\s+/g," ").trim();return{title:e,content:i,excerpt:r,length:i.length}}function or(t){var e;const i=t.cloneNode(!0);return i.querySelectorAll("script, style, noscript, iframe, embed, object").forEach(r=>r.remove()),i.querySelectorAll('[hidden], [style*="display: none"], [style*="visibility: hidden"]').forEach(r=>r.remove()),((e=i.textContent)==null?void 0:e.replace(/\s+/g," ").trim())||""}function lr(){const t=[];document.querySelectorAll('script[type="application/ld+json"]').forEach(r=>{try{const s=JSON.parse(r.textContent||"{}");Array.isArray(s)?t.push(...s):t.push(s)}catch(s){console.warn("解析 JSON-LD 失败:",s)}});const e=cr();return e.length>0&&t.push(...e),t}function cr(){const t=[];return document.querySelectorAll("[itemscope]").forEach(e=>{const r=e.getAttribute("itemtype"),s={};r&&(s["@type"]=r),e.querySelectorAll("[itemprop]").forEach(n=>{var l;const a=n.getAttribute("itemprop");if(!a)return;let o;n.hasAttribute("itemscope")?o=ur(n):n.tagName==="META"?o=n.getAttribute("content"):n.tagName==="IMG"?o=n.src:n.tagName==="A"?o=n.href:o=(l=n.textContent)==null?void 0:l.trim(),o&&(s[a]?(Array.isArray(s[a])||(s[a]=[s[a]]),s[a].push(o)):s[a]=o)}),Object.keys(s).length>0&&t.push(s)}),t}function ur(t){const i={},e=t.getAttribute("itemtype");return e&&(i["@type"]=e),t.querySelectorAll("[itemprop]").forEach(r=>{var n;const s=r.getAttribute("itemprop");s&&(i[s]=((n=r.textContent)==null?void 0:n.trim())||r.getAttribute("content"))}),i}function hr(){const t={title:document.title,url:window.location.href,description:"",keywords:[],author:"",og:{},twitter:{}};return document.querySelectorAll("meta").forEach(e=>{const r=e.getAttribute("name")||e.getAttribute("property"),s=e.getAttribute("content");!r||!s||(r==="description"?t.description=s:r==="keywords"?t.keywords=s.split(",").map(n=>n.trim()):r==="author"?t.author=s:r.startsWith("og:")?t.og[r.replace("og:","")]=s:r.startsWith("twitter:")&&(t.twitter[r.replace("twitter:","")]=s))}),t}function mr(t){const{selector:i,dataType:e="all",fields:r}=t,s=i?document.querySelector(i):document.body;if(!s)return{type:"mixed",data:[],count:0};const n=[];if(e==="all"||e==="table"){const a=fr(s,r);a.count>0&&n.push(a)}if(e==="all"||e==="list"){const a=ke(s);a.count>0&&n.push(a)}if(e==="all"||e==="cards"){const a=dr(s);a.count>0&&n.push(a)}if(e==="all"||e==="form"){const a=br(s);a.count>0&&n.push(a)}return n.length===0?{type:"mixed",data:[],count:0}:n.length===1?n[0]:{type:"mixed",data:n.flatMap(a=>a.data),count:n.reduce((a,o)=>a+o.count,0)}}function fr(t,i){const e=t.querySelectorAll("table"),r=[];return e.forEach(s=>{const n=Array.from(s.querySelectorAll("tr"));if(n.length===0)return;const a=s.querySelector("thead tr")||n[0],o=Array.from(a.querySelectorAll("th, td")).map(m=>{var u;return((u=m.textContent)==null?void 0:u.trim())||""});if(o.length===0)return;const l=i||o;(s.querySelector("thead"),n.slice(1)).forEach(m=>{const u=Array.from(m.querySelectorAll("td, th"));if(u.length===0)return;const h={};o.forEach((f,d)=>{var E;if(l.includes(f)&&u[d]){h[f]=((E=u[d].textContent)==null?void 0:E.trim())||"";const v=u[d].querySelector("a");v&&(h[`${f}_link`]=v.href);const _=u[d].querySelector("img");_&&(h[`${f}_image`]=_.src)}}),Object.keys(h).length>0&&r.push(h)})}),{type:"table",data:r,fields:i||Array.from(new Set(r.flatMap(s=>Object.keys(s)))),count:r.length}}function ke(t){const i=t.querySelectorAll('ul, ol, [role="list"]'),e=[];return i.forEach(r=>{Array.from(r.querySelectorAll(':scope > li, :scope > [role="listitem"]')).forEach((n,a)=>{var u,h;const o={index:a+1,text:((u=n.textContent)==null?void 0:u.trim())||""},l=n.querySelector("a");l&&(o.link=l.href,o.linkText=(h=l.textContent)==null?void 0:h.trim());const c=n.querySelector("img");c&&(o.image=c.src,o.imageAlt=c.alt);const m=n.querySelector("ul, ol");m&&(o.children=ke(m).data),e.push(o)})}),{type:"list",data:e,count:e.length}}function dr(t){const i=[".card",".product",".item",'[class*="card"]','[class*="Card"]','[class*="product"]','[class*="Product"]','[class*="item"]','[class*="Item"]'],e=[];if(i.forEach(s=>{t.querySelectorAll(s).forEach(a=>{e.includes(a)||e.push(a)})}),e.length===0){const s=gr(t);e.push(...s)}const r=e.map(s=>{var u,h,f,d;const n={},a=s.querySelector('h1, h2, h3, h4, h5, h6, [class*="title"], [class*="Title"], .title');a&&(n.title=(u=a.textContent)==null?void 0:u.trim());const o=s.querySelector('[class*="desc"], [class*="Desc"], .description, p');o&&(n.description=(h=o.textContent)==null?void 0:h.trim());const l=s.querySelector("img");l&&(n.image=l.src,n.imageAlt=l.alt);const c=s.querySelector("a");c&&(n.link=c.href);const m=(f=s.textContent)==null?void 0:f.match(/[\$¥€£]\s*[\d,]+\.?\d*/);return m&&(n.price=m[0]),n.text=(d=s.textContent)==null?void 0:d.trim(),n});return{type:"cards",data:r,count:r.length}}function gr(t){const i=[],e=Array.from(t.children);if(e.length>=2){const r=e[0],s=xe(r),n=e.filter(a=>{const o=xe(a);return pr(s,o)>.7});n.length>=2&&i.push(...n)}return i}function xe(t){const i=t.tagName.toLowerCase(),e=Array.from(t.children).map(r=>r.tagName.toLowerCase()).join(",");return`${i}[${e}]`}function pr(t,i){if(t===i)return 1;const e=t.split(/[\[\],]/),r=i.split(/[\[\],]/);return e.filter(n=>r.includes(n)).length/Math.max(e.length,r.length)}function br(t){const i=t.querySelectorAll("form"),e=[];return i.forEach(r=>{const s={action:r.action||"",method:r.method||"get"},n={};r.querySelectorAll("input, textarea, select").forEach(a=>{const o=a.name,l=a.type||"text",c=a.value,m=a.placeholder,u=Er(a);o?n[o]={type:l,value:l==="password"?void 0:c,placeholder:m,label:u}:u&&(n[u]={type:l,value:l==="password"?void 0:c,placeholder:m})}),s.fields=n,e.push(s)}),{type:"form",data:e,count:e.length}}function Er(t){var r,s,n;if(t.id){const a=document.querySelector(`label[for="${t.id}"]`);if(a)return(r=a.textContent)==null?void 0:r.trim()}const i=t.closest("label");if(i){const a=i.cloneNode(!0);return a.querySelectorAll("input, textarea, select").forEach(o=>o.remove()),(s=a.textContent)==null?void 0:s.trim()}let e=t.previousElementSibling;for(;e;){if(e.tagName==="LABEL")return(n=e.textContent)==null?void 0:n.trim();e=e.previousElementSibling}}let b=null,A=null,re=null,G=!1,W=null,C=null,J=520;const yr=320,vr=1e3;let se=!1;function $e(t){W&&(W.textContent=`
      /* 核心：缩小 html 宽度，让页面内容自然收缩 */
      html {
        width: calc(100% - ${t}px) !important;
        min-width: auto !important;
        overflow-x: hidden !important;
        position: relative !important;
      }

      /* 确保 body 跟随 html 宽度 */
      body {
        width: 100% !important;
        min-width: auto !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
        position: relative !important;
      }

      /* 确保聊天容器不受影响，固定在视口右侧 */
      #ai-chat-container {
        position: fixed !important;
        right: 0 !important;
        top: 0 !important;
        width: ${t}px !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box !important;
      }
    `)}function Ce(){se=!1;const t=document.getElementById("ai-chat-resize-overlay");t&&t.remove(),C&&(C.style.background="transparent")}function _r(){if(!C)return;let t=0,i=0;const e=n=>{n.preventDefault(),n.stopPropagation(),Ce(),se=!0,t=n.clientX,i=J;const a=document.createElement("div");a.id="ai-chat-resize-overlay",a.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2147483646;
      cursor: ew-resize;
      background: transparent;
    `,document.body.appendChild(a),C&&(C.style.background="rgba(102, 126, 234, 0.5)"),document.addEventListener("mousemove",r),document.addEventListener("mouseup",s),document.addEventListener("mouseleave",s)},r=n=>{if(!se)return;const a=t-n.clientX;let o=i+a;o=Math.max(yr,Math.min(vr,o)),J=o,A&&(A.style.width=`${o}px`),$e(o)},s=()=>{se&&(chrome.storage.local.set({chatWidth:J}),Ce(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",s),document.removeEventListener("mouseleave",s))};C.addEventListener("mousedown",e)}function pe(){return{url:window.location.href,title:document.title}}async function Nr(t){const i=pe();if(!t)return(await chrome.runtime.sendMessage({type:"CREATE_SESSION",payload:{title:i.title||"新对话",pageUrl:i.url,pageTitle:i.title}})).data.id;const e=await chrome.runtime.sendMessage({type:"GET_SESSION_BY_TAB",payload:{tabId:t}});return e.success&&e.data?(await chrome.runtime.sendMessage({type:"UPDATE_SESSION",payload:{sessionId:e.data.id,updates:{pageUrl:i.url,pageTitle:i.title}}}),e.data.id):(await chrome.runtime.sendMessage({type:"CREATE_SESSION",payload:{title:i.title||"新对话",tabId:t,pageUrl:i.url,pageTitle:i.title}})).data.id}function ue(t){const i=pe(),e=chrome.runtime.getURL(`chat.html?sessionId=${t}&pageUrl=${encodeURIComponent(i.url)}&pageTitle=${encodeURIComponent(i.title)}`);if(b){b.src=e,setTimeout(()=>{b!=null&&b.contentWindow&&b.contentWindow.postMessage({type:"PAGE_INFO",url:i.url,title:i.title},"*")},500);return}A=document.createElement("div"),A.id="ai-chat-container",A.style.cssText=`
    position: fixed;
    width: ${J}px;
    height: 100vh;
    right: 0;
    top: 0;
    z-index: 2147483647;
    background: white;
    border-left: 1px solid #e5e7eb;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  `,C=document.createElement("div"),C.id="ai-chat-resize-handle",C.style.cssText=`
    position: absolute;
    left: 0;
    top: 0;
    width: 6px;
    height: 100%;
    cursor: ew-resize;
    background: transparent;
    z-index: 2147483648;
    transition: background 0.2s;
  `,C.addEventListener("mouseenter",()=>{C&&(C.style.background="rgba(102, 126, 234, 0.3)")}),C.addEventListener("mouseleave",()=>{C&&!se&&(C.style.background="transparent")}),b=document.createElement("iframe"),b.src=e,b.style.cssText=`
    width: 100%;
    height: 100%;
    border: none;
  `,A.appendChild(C),A.appendChild(b),document.body.appendChild(A),_r(),W=document.createElement("style"),W.id="ai-chat-layout-style",$e(J),document.head.appendChild(W);const r=new ResizeObserver(()=>{A&&(A.style.height=`${window.innerHeight}px`)});r.observe(document.documentElement),A.__resizeObserver=r,window.addEventListener("message",wr),G&&chrome.storage.local.set({chatPinned:!0,chatSessionId:t})}let Ie=window.location.href;const Tr=new MutationObserver(()=>{if(window.location.href!==Ie&&(Ie=window.location.href,b!=null&&b.contentWindow)){const t=pe();b.contentWindow.postMessage({type:"PAGE_INFO",url:t.url,title:t.title},"*")}});Tr.observe(document.body,{childList:!0,subtree:!0});function wr(t){t.source===(b==null?void 0:b.contentWindow)&&(console.log("Received message from chat:",t.data),t.data.type==="CLOSE_CHAT"?Ue():t.data.type==="PIN_CHAT"&&(console.log("Handling PIN_CHAT"),Ar()))}function Ar(){G=!G,console.log("togglePin called, new isPinned:",G),G?(chrome.storage.local.set({chatPinned:!0,chatSessionId:re},()=>{console.log("Saved pin state to storage")}),b!=null&&b.contentWindow&&(b.contentWindow.postMessage({type:"PIN_STATUS_CHANGED",isPinned:!0},"*"),console.log("Sent PIN_STATUS_CHANGED: true to chat"))):(chrome.storage.local.remove(["chatPinned","chatSessionId"],()=>{console.log("Removed pin state from storage")}),b!=null&&b.contentWindow&&(b.contentWindow.postMessage({type:"PIN_STATUS_CHANGED",isPinned:!1},"*"),console.log("Sent PIN_STATUS_CHANGED: false to chat")))}function Ue(){if(A){const t=A.__resizeObserver;t&&t.disconnect(),A.remove(),A=null,b=null,C=null,W&&(W.remove(),W=null);const i=document.getElementById("ai-chat-resize-overlay");i&&i.remove(),G||chrome.storage.local.remove(["chatPinned","chatSessionId"])}}chrome.storage.local.get(["chatPinned","chatSessionId","chatWidth"],t=>{t.chatWidth&&(J=t.chatWidth),t.chatPinned&&t.chatSessionId&&(G=!0,re=t.chatSessionId,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{ue(t.chatSessionId)}):ue(t.chatSessionId))});chrome.runtime.onMessage.addListener((t,i,e)=>{var r,s,n;if(t.type==="OPEN_CHAT")if(t.sessionId)re=t.sessionId,A?b.src=chrome.runtime.getURL(`chat.html?sessionId=${t.sessionId}`):ue(t.sessionId),e({success:!0});else{const a=t.tabId;return Nr(a).then(o=>{re=o,A?b.src=chrome.runtime.getURL(`chat.html?sessionId=${o}`):ue(o),e({success:!0,sessionId:o})}).catch(o=>{console.error("Failed to get/create session:",o),e({success:!1,error:o.message})}),!0}else if(t.type==="CLOSE_CHAT")Ue(),e({success:!0});else if(t.type==="CHECK_CHAT_STATUS")e({isOpen:!!A,isPinned:G,sessionId:re});else if(t.type==="GET_PAGE_CONTEXT")try{const a=((r=t.payload)==null?void 0:r.userMessage)||"";console.log("[Content] GET_PAGE_CONTEXT 被调用，userMessage:",a,"当前URL:",window.location.href);const o=at(a);console.log("[Content] 返回的 context:",{url:o.url,title:o.title,elementsCount:((s=o.elements)==null?void 0:s.length)||0,selectedText:o.selectedText?"有选中文本":"无选中文本"}),e({success:!0,data:o});return}catch(a){console.error("[Content] GET_PAGE_CONTEXT 处理失败:",a),e({success:!1,error:String(a)});return}else if(t.type==="REQUEST_MORE_ELEMENTS"){const a=t.payload||{},o=ot(a);e({success:!0,data:o})}else if(t.type==="EXECUTE_PAGE_ACTION"){const a=t.payload;return console.log("[Content] EXECUTE_PAGE_ACTION 被调用:",JSON.stringify(a,null,2)),Pe(a).then(o=>{console.log("[Content] EXECUTE_PAGE_ACTION 结果:",o),e({success:o.success,data:o})}),!0}else if(t.type==="EXECUTE_BATCH_ACTIONS"){const a=t.payload;return console.log("[Content] EXECUTE_BATCH_ACTIONS 被调用，actions 数量:",a.length),tr(a).then(o=>{console.log("[Content] EXECUTE_BATCH_ACTIONS 结果:",o),e({success:o.success,data:o})}),!0}else if(t.type==="CLEAR_AI_STYLES")rr(),e({success:!0});else if(t.type==="GET_SELECTED_TEXT"){const a=((n=window.getSelection())==null?void 0:n.toString())||"";e({success:!0,data:a})}else{if(t.type==="CAPTURE_FULL_PAGE")return Sr(t.payload).then(a=>{e(a)}),!0;if(t.type==="COPY_IMAGE_TO_CLIPBOARD")return xr(t.payload.dataUrl).then(a=>{e(a)}),!0;if(t.type==="SUMMARIZE_PAGE"){const a=t.payload||{},o=ar(),l={success:!!o};o?(l.summary=o,a.includeStructuredData&&(l.structuredData=lr()),a.includeMetadata&&(l.metadata=hr())):l.error="无法提取页面内容",e({success:!0,data:l})}else if(t.type==="EXTRACT_DATA"){const a=t.payload||{},o=mr(a);e({success:!0,data:o})}}return!0});async function Sr(t){try{const i=t.format||"png",e=t.quality||90,r=window.scrollY,s=window.scrollX,n=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),a=Math.max(document.body.scrollWidth,document.body.offsetWidth,document.documentElement.clientWidth,document.documentElement.scrollWidth,document.documentElement.offsetWidth),o=window.innerHeight,l=window.innerWidth;if(n<=o&&a<=l)return{success:!0,data:await Le(i,e)};const c=Math.ceil(n/o),m=Math.ceil(a/l),u=document.createElement("canvas"),h=u.getContext("2d");if(!h)return{success:!1,error:"无法创建 Canvas 上下文"};u.width=Math.min(a,16384),u.height=Math.min(n,16384);for(let E=0;E<c;E++)for(let v=0;v<m;v++){const _=v*l,S=E*o;window.scrollTo(_,S),await new Promise(R=>setTimeout(R,200));const x=await Le(i,e);await new Promise((R,M)=>{const T=new Image;T.onload=()=>{const D=_,O=S,P=Math.min(l,a-_,u.width-D),g=Math.min(o,n-S,u.height-O);h.drawImage(T,0,0,P,g,D,O,P,g),R()},T.onerror=M,T.src=x})}window.scrollTo(s,r);const f=i==="jpeg"?"image/jpeg":"image/png";return{success:!0,data:u.toDataURL(f,e/100)}}catch(i){return console.error("全页截图失败:",i),{success:!1,error:String(i)}}}function Le(t,i){return new Promise((e,r)=>{chrome.runtime.sendMessage({type:"CAPTURE_VISIBLE_TAB",payload:{format:t,quality:i}},s=>{s!=null&&s.success&&s.data?e(s.data):r(new Error((s==null?void 0:s.error)||"截图失败"))})})}async function xr(t){try{const e=await(await fetch(t)).blob();return await navigator.clipboard.write([new ClipboardItem({[e.type]:e})]),{success:!0}}catch(i){return console.error("复制到剪贴板失败:",i),{success:!1,error:String(i)}}}

})()