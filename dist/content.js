(function(){
'use strict';
const C=new Map,we={priorities:{form:10,button:8,link:3,text:1},viewport:{visible:5,nearViewport:2,hidden:0},maxElements:30};function ye(){return`e_${Date.now()}_${Math.random().toString(36).substr(2,6)}`}function ve(e){return e.top>=0&&e.left>=0&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth}function Te(e){return e.top>=-200&&e.left>=-200&&e.bottom<=window.innerHeight+200&&e.right<=window.innerWidth+200}function Ne(e){const t=window.getComputedStyle(e);if(t.display==="none"||t.visibility==="hidden"||t.opacity==="0")return!1;const s=e.getBoundingClientRect();return!(s.width===0||s.height===0)}function Ie(e){var s,n;if(e.id){const r=document.querySelector(`label[for="${e.id}"]`);if(r)return(s=r.textContent)==null?void 0:s.trim()}const t=e.closest("label");if(t){const r=t.cloneNode(!0);return r.querySelectorAll("input, select, textarea").forEach(o=>o.remove()),(n=r.textContent)==null?void 0:n.trim()}}function Ce(e){var t;if(e.tagName==="BUTTON"||e.tagName==="A")return(t=e.textContent)==null?void 0:t.trim();if(e.tagName==="INPUT"){const s=e;if(s.type==="submit"||s.type==="button")return s.value}}function Se(e){if(!Ne(e))return null;const t=e.getBoundingClientRect(),s=ye();C.set(s,e);const n={id:s,tag:e.tagName.toLowerCase(),rect:{x:t.x,y:t.y,width:t.width,height:t.height},visible:ve(t),disabled:e.disabled||e.getAttribute("aria-disabled")==="true"};if(e.tagName==="INPUT"){const r=e;n.type=r.type,n.name=r.name||void 0,n.placeholder=r.placeholder||void 0,r.type!=="password"&&(n.value=r.value||void 0)}if(e.tagName==="TEXTAREA"){const r=e;n.name=r.name||void 0,n.placeholder=r.placeholder||void 0,n.value=r.value||void 0}if(e.tagName==="SELECT"){const r=e;n.name=r.name||void 0,n.value=r.value||void 0}return n.text=Ce(e),n.label=Ie(e),n.ariaLabel=e.getAttribute("aria-label")||void 0,n}function fe(){C.clear();const e=[],t=['input:not([type="hidden"])',"textarea","button","a[href]","select",'[role="button"]','[role="link"]','[role="checkbox"]','[role="radio"]','[role="listitem"]','[role="option"]','[contenteditable="true"]',"[onclick]",'[tabindex]:not([tabindex="-1"])',"li[onclick]","li[data-clickable]","li.clickable","ul[data-list] > li","ol[data-list] > li"];return document.querySelectorAll(t.join(", ")).forEach(n=>{const r=Se(n);r&&e.push(r)}),e}function a(e){return C.get(e)||null}function xe(e){const t=["帮我","请","把","将","给","在","到","的","和","然后","并且","接着"];let s=e;return t.forEach(r=>{s=s.replace(new RegExp(r,"g")," ")}),s.split(/[\s,，。.!！?？、]+/).filter(r=>r.length>0)}function Oe(e,t,s){let n=0;const r=[e.text,e.placeholder,e.label,e.ariaLabel,e.name].filter(Boolean).join(" ");for(const c of t)r.toLowerCase().includes(c.toLowerCase())&&(n+=10);return e.tag==="input"||e.tag==="textarea"?n+=s.priorities.form:e.tag==="button"||e.tag==="input"&&(e.type==="submit"||e.type==="button")?n+=s.priorities.button:e.tag==="select"?n+=s.priorities.form:e.tag==="a"&&(n+=s.priorities.link),e.visible?n+=s.viewport.visible:Te(new DOMRect(e.rect.x,e.rect.y,e.rect.width,e.rect.height))&&(n+=s.viewport.nearViewport),e.disabled&&(n-=5),n}function _e(e,t,s=we){const n=xe(t);return e.map(c=>({element:c,score:Oe(c,n,s)})).sort((c,o)=>o.score-c.score).slice(0,s.maxElements).map(c=>c.element)}function Ae(e){const t=[];let n={input:"输入框",textarea:"文本框",button:"按钮",a:"链接",select:"下拉框",li:"列表项"}[e.tag]||e.tag;e.tag==="input"&&e.type&&(e.type==="password"?n="密码框":e.type==="submit"?n="提交按钮":e.type==="checkbox"?n="复选框":e.type==="radio"?n="单选框":e.type==="search"?n="搜索框":e.type==="email"&&(n="邮箱输入框")),t.push(n);const r=e.label||e.text||e.placeholder||e.ariaLabel||e.name;r&&t.push(r);const c=[];e.placeholder&&e.placeholder!==r&&c.push(`placeholder:${e.placeholder}`),e.type&&!["text","submit","button"].includes(e.type)&&c.push(`type:${e.type}`),e.disabled&&c.push("禁用");let o=t.join(":");return c.length>0&&(o+=`(${c.join(",")})`),o}function pe(e){return e.map(t=>({id:t.id,desc:Ae(t)}))}function Le(e=""){var r;const t=fe(),s=_e(t,e),n=pe(s);return{url:window.location.href,title:document.title,elements:n,selectedText:((r=window.getSelection())==null?void 0:r.toString())||void 0}}function $e(e){let t=fe();if(e.region&&(t=t.filter(s=>{const n=s.rect;switch(e.region){case"header":return n.y<150;case"footer":return n.y>window.innerHeight-200;case"sidebar":return n.x<250||n.x>window.innerWidth-250;case"below_viewport":return n.y>window.innerHeight;case"form":const r=document.querySelectorAll("form");return Array.from(r).some(c=>{const o=c.getBoundingClientRect();return n.x>=o.left&&n.x<=o.right&&n.y>=o.top&&n.y<=o.bottom});default:return!0}})),e.elementType&&e.elementType!=="all"&&(t=t.filter(s=>{switch(e.elementType){case"input":return s.tag==="input"||s.tag==="textarea";case"button":return s.tag==="button"||s.tag==="input"&&(s.type==="submit"||s.type==="button");case"link":return s.tag==="a";case"select":return s.tag==="select";default:return!0}})),e.keyword){const s=e.keyword.toLowerCase();t=t.filter(n=>[n.text,n.placeholder,n.label,n.ariaLabel,n.name].filter(Boolean).join(" ").toLowerCase().includes(s))}return pe(t)}function y(e){return new Promise(t=>setTimeout(t,e))}function ce(e,t){e.focus(),e.value="",e.dispatchEvent(new Event("focus",{bubbles:!0})),e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))}function oe(e){e.focus(),e.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))}async function ke(e,t){if(!t)return{success:!1,message:"未提供填充值",error:"NO_VALUE"};const s=e.elementId?a(e.elementId):null;if(!s){if(e.selector){const n=document.querySelector(e.selector);if(n&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"))return ce(n,t),{success:!0,message:`已填充: ${t}`}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return s.tagName!=="INPUT"&&s.tagName!=="TEXTAREA"?s.getAttribute("contenteditable")==="true"?(s.focus(),s.textContent=t,s.dispatchEvent(new Event("input",{bubbles:!0})),{success:!0,message:`已填充: ${t}`}):{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"}:(ce(s,t),{success:!0,message:`已填充: ${t}`})}async function Re(e){var s;const t=e.elementId?a(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n)return oe(n),{success:!0,message:"已点击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return oe(t),{success:!0,message:`已点击: ${e.description||((s=t.textContent)==null?void 0:s.trim())||"元素"}`}}async function Ue(e,t){const s=t||"#ffeb3b",n=window.getSelection();if(n&&n.rangeCount>0&&!n.isCollapsed){const c=n.getRangeAt(0),o=document.createElement("span");o.className="ai-highlight",o.style.backgroundColor=s,o.style.padding="2px 0",o.style.borderRadius="2px";try{return c.surroundContents(o),n.removeAllRanges(),{success:!0,message:"已高亮选中文字"}}catch{return{success:!1,message:"无法高亮跨元素的选中内容",error:"CROSS_ELEMENT"}}}const r=e.elementId?a(e.elementId):null;return r?(r.style.backgroundColor=s,r.classList.add("ai-highlight"),{success:!0,message:"已高亮元素"}):{success:!1,message:"未找到要高亮的内容",error:"NO_TARGET"}}async function Me(e){const t=window.getSelection();if(t&&t.rangeCount>0&&!t.isCollapsed){const n=t.getRangeAt(0),r=document.createElement("span");r.className="ai-underline",r.style.textDecoration="underline",r.style.textDecorationColor="#1a73e8",r.style.textDecorationThickness="2px";try{return n.surroundContents(r),t.removeAllRanges(),{success:!0,message:"已添加下划线"}}catch{return{success:!1,message:"无法为跨元素的选中内容添加下划线",error:"CROSS_ELEMENT"}}}const s=e.elementId?a(e.elementId):null;return s?(s.style.textDecoration="underline",s.style.textDecorationColor="#1a73e8",s.classList.add("ai-underline"),{success:!0,message:"已添加下划线"}):{success:!1,message:"未找到要添加下划线的内容",error:"NO_TARGET"}}async function De(e,t){if(!t)return{success:!1,message:"未提供选择值",error:"NO_VALUE"};const s=e.elementId?a(e.elementId):null;if(!s||s.tagName!=="SELECT"){if(e.selector){const n=document.querySelector(e.selector);if(n&&n.tagName==="SELECT")return ae(n,t)}return{success:!1,message:"未找到下拉框元素",error:"ELEMENT_NOT_FOUND"}}return ae(s,t)}function ae(e,t){const s=Array.from(e.options).find(r=>r.value===t);if(s)return e.value=s.value,e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已选择: ${s.text}`};const n=Array.from(e.options).find(r=>r.text.toLowerCase().includes(t.toLowerCase()));return n?(e.value=n.value,e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已选择: ${n.text}`}):{success:!1,message:`未找到匹配的选项: ${t}`,error:"OPTION_NOT_FOUND"}}async function Pe(e){const t=e.elementId?a(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n&&n.type==="checkbox")return n.checked=!n.checked,n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:n.checked?"已勾选":"已取消勾选"}}return{success:!1,message:"未找到复选框元素",error:"ELEMENT_NOT_FOUND"}}if(t.tagName!=="INPUT"||t.type!=="checkbox")return{success:!1,message:"目标元素不是复选框",error:"INVALID_ELEMENT"};const s=t;return s.checked=!s.checked,s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:s.checked?"已勾选":"已取消勾选"}}async function qe(e){const t=window.innerHeight*.8;switch(e){case"up":return window.scrollBy({top:-t,behavior:"smooth"}),{success:!0,message:"已向上滚动"};case"down":return window.scrollBy({top:t,behavior:"smooth"}),{success:!0,message:"已向下滚动"};case"top":return window.scrollTo({top:0,behavior:"smooth"}),{success:!0,message:"已滚动到顶部"};case"bottom":return window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}),{success:!0,message:"已滚动到底部"};default:return window.scrollBy({top:t,behavior:"smooth"}),{success:!0,message:"已向下滚动"}}}async function Fe(e){var n,r;const t=e.elementId?a(e.elementId):null;if(!t){if(e.selector){const o=document.querySelector(e.selector);if(o)return{success:!0,message:"已读取内容",data:((n=o.textContent)==null?void 0:n.trim())||""}}const c=window.getSelection();return c&&!c.isCollapsed?{success:!0,message:"已读取选中内容",data:c.toString()}:{success:!1,message:"未找到要读取的内容",error:"NO_TARGET"}}return{success:!0,message:"已读取内容",data:((r=t.textContent)==null?void 0:r.trim())||""}}async function Be(e){var n;const t=e.elementId?a(e.elementId):null;if(!t){if(e.selector){const r=document.querySelector(e.selector);if(r){const c=new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window});return r.dispatchEvent(c),{success:!0,message:"已悬停在元素上"}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const s=new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window});return t.dispatchEvent(s),{success:!0,message:`已悬停在: ${e.description||((n=t.textContent)==null?void 0:n.trim())||"元素"}上`}}async function Xe(e,t,s){if(!t)return{success:!1,message:"未提供输入文本",error:"NO_TEXT"};const n=e.elementId?a(e.elementId):null;if(!n){if(e.selector){const r=document.querySelector(e.selector);if(r&&(r.tagName==="INPUT"||r.tagName==="TEXTAREA"))return await ue(r,t,s||50),{success:!0,message:`已输入: ${t}`}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return n.tagName!=="INPUT"&&n.tagName!=="TEXTAREA"?{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"}:(await ue(n,t,s||50),{success:!0,message:`已输入: ${t}`})}async function ue(e,t,s){e.focus(),e.value="",e.dispatchEvent(new Event("focus",{bubbles:!0}));for(let n=0;n<t.length;n++)e.value+=t[n],e.dispatchEvent(new Event("input",{bubbles:!0})),await new Promise(r=>setTimeout(r,s));e.dispatchEvent(new Event("change",{bubbles:!0}))}async function He(e,t){if(!e)return{success:!1,message:"未提供按键",error:"NO_KEY"};const s=t?document.querySelector(t):document.activeElement;return s?(ie(s,e),{success:!0,message:`已在元素上按下: ${e}`}):(ie(document,e),{success:!0,message:`已发送按键: ${e}`})}function ie(e,t){const s=new KeyboardEvent("keydown",{key:t,bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(s);const n=new KeyboardEvent("keypress",{key:t,bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(n);const r=new KeyboardEvent("keyup",{key:t,bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(r)}async function We(e,t){const s=e.elementId?a(e.elementId):null;if(!s)return{success:!1,message:"未找到源元素",error:"SOURCE_NOT_FOUND"};let n=null,r,c;if(t!=null&&t.selector){if(n=document.querySelector(t.selector),!n)return{success:!1,message:"未找到目标元素",error:"DESTINATION_NOT_FOUND"};const m=n.getBoundingClientRect();r=m.left+m.width/2,c=m.top+m.height/2}else if((t==null?void 0:t.x)!==void 0&&(t==null?void 0:t.y)!==void 0)r=t.x,c=t.y;else return{success:!1,message:"未提供目标位置",error:"NO_DESTINATION"};const o=s.getBoundingClientRect(),i=o.left+o.width/2,l=o.top+o.height/2;s.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window,clientX:i,clientY:l})),await y(100);const p=10;for(let m=1;m<=p;m++){const v=i+(r-i)*(m/p),T=l+(c-l)*(m/p);s.dispatchEvent(new MouseEvent("mousemove",{bubbles:!0,cancelable:!0,view:window,clientX:v,clientY:T})),await y(50)}return(document.elementFromPoint(r,c)||document.body).dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window,clientX:r,clientY:c})),{success:!0,message:"拖拽完成"}}async function ze(e,t,s){const n=t||1e3,r=Date.now();if(e!=null&&e.elementId||e!=null&&e.selector){for(e.elementId?`${e.elementId}`:e.selector;Date.now()-r<n;){const c=e.elementId?a(e.elementId):document.querySelector(e.selector);if(c)if(s==="visible"){const o=c.getBoundingClientRect();if(o.width>0&&o.height>0)return{success:!0,message:"元素已可见"}}else if(s==="hidden"){const o=c.getBoundingClientRect();if(o.width===0||o.height===0)return{success:!0,message:"元素已隐藏"}}else return{success:!0,message:"元素已出现"};await y(100)}return{success:!1,message:`等待超时: ${n}ms`,error:"TIMEOUT"}}else return await y(n),{success:!0,message:`等待了 ${n}ms`}}async function Ve(e){var s;const t=e.elementId?a(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n)return n.focus(),{success:!0,message:"已聚焦元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return t.focus(),{success:!0,message:`已聚焦: ${e.description||((s=t.textContent)==null?void 0:s.trim())||"元素"}`}}async function Ge(e){var s;const t=e.elementId?a(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n)return n.blur(),{success:!0,message:"已失焦元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return t.blur(),{success:!0,message:`已失焦: ${e.description||((s=t.textContent)==null?void 0:s.trim())||"元素"}`}}async function Ye(e){const t=e.elementId?a(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"))return n.value="",n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:"已清空输入框"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}if(t.tagName!=="INPUT"&&t.tagName!=="TEXTAREA")return{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"};const s=t;return s.value="",s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:"已清空输入框"}}async function Ke(e,t){if(!t)return{success:!1,message:"未提供属性名",error:"NO_ATTRIBUTE"};const s=e.elementId?a(e.elementId):null;if(!s){if(e.selector){const r=document.querySelector(e.selector);if(r){const c=r.getAttribute(t);return{success:!0,message:`获取属性 ${t}`,data:c}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const n=s.getAttribute(t);return{success:!0,message:`获取属性 ${t}`,data:n}}async function je(e,t){if(!t)return{success:!1,message:"未提供属性名",error:"NO_PROPERTY"};const s=e.elementId?a(e.elementId):null;if(!s){if(e.selector){const r=document.querySelector(e.selector);if(r){const c=r[t];return{success:!0,message:`获取属性值 ${t}`,data:c}}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}const n=s[t];return{success:!0,message:`获取属性值 ${t}`,data:n}}async function Je(e,t){switch(e){case"goto":return t?(window.location.href=t,{success:!0,message:`导航到: ${t}`}):{success:!1,message:"未提供URL",error:"NO_URL"};case"back":return window.history.back(),{success:!0,message:"返回上一页"};case"forward":return window.history.forward(),{success:!0,message:"前进到下一页"};case"reload":return window.location.reload(),{success:!0,message:"刷新页面"};default:return{success:!1,message:"未知的导航操作",error:"UNKNOWN_ACTION"}}}async function Qe(e,t,s){var r;const n=e.elementId?a(e.elementId):null;if(!n){if(e.selector){const c=document.querySelector(e.selector);if(c)return c.scrollIntoView({behavior:t||"smooth",block:s||"center"}),{success:!0,message:"已滚动到元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return n.scrollIntoView({behavior:t||"smooth",block:s||"center"}),{success:!0,message:`已滚动到: ${e.description||((r=n.textContent)==null?void 0:r.trim())||"元素"}`}}async function Ze(e){var s;if(!e)return{success:!0,message:"已切换回主文档"};const t=document.querySelector(e);if(!t)return{success:!1,message:"未找到iframe",error:"IFRAME_NOT_FOUND"};try{return t.contentDocument||((s=t.contentWindow)==null?void 0:s.document)?{success:!0,message:`已切换到iframe: ${e}`,data:{frameUrl:t.src}}:{success:!1,message:"无法访问iframe内容（跨域限制）",error:"CROSS_ORIGIN"}}catch{return{success:!1,message:"无法访问iframe内容",error:"ACCESS_ERROR"}}}async function et(e,t){return{success:!0,message:`弹窗处理: ${e}`,data:{promptText:t}}}async function tt(e,t){try{return localStorage.setItem(e,t),{success:!0,message:`已设置 localStorage[${e}] = ${t}`}}catch(s){return{success:!1,message:"设置localStorage失败",error:String(s)}}}async function st(e){try{const t=localStorage.getItem(e);return{success:!0,message:`获取 localStorage[${e}]`,data:t}}catch(t){return{success:!1,message:"获取localStorage失败",error:String(t)}}}async function nt(e){try{if(e){const t=[];for(let s=0;s<localStorage.length;s++){const n=localStorage.key(s);n&&n.startsWith(e)&&t.push(n)}return t.forEach(s=>localStorage.removeItem(s)),{success:!0,message:`已清除 ${t.length} 个localStorage项`}}else{const t=localStorage.length;return localStorage.clear(),{success:!0,message:`已清除所有 ${t} 个localStorage项`}}}catch(t){return{success:!1,message:"清除localStorage失败",error:String(t)}}}async function rt(e,t,s){try{let n=`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(s!=null&&s.expires){const r=new Date(Date.now()+s.expires*1e3);n+=`;expires=${r.toUTCString()}`}return s!=null&&s.path&&(n+=`;path=${s.path}`),s!=null&&s.domain&&(n+=`;domain=${s.domain}`),s!=null&&s.secure&&(n+=";secure"),document.cookie=n,{success:!0,message:`已设置 Cookie: ${e}`}}catch(n){return{success:!1,message:"设置Cookie失败",error:String(n)}}}async function ct(e){var t;try{if(e){const s=(t=document.cookie.split("; ").find(n=>n.startsWith(`${encodeURIComponent(e)}=`)))==null?void 0:t.split("=")[1];return{success:!0,message:`获取 Cookie: ${e}`,data:s?decodeURIComponent(s):null}}else return{success:!0,message:"获取所有Cookies",data:document.cookie}}catch(s){return{success:!1,message:"获取Cookie失败",error:String(s)}}}function le(e){const t=e.getBoundingClientRect(),s=t.left+t.width/2,n=t.top+t.height/2,r={bubbles:!0,cancelable:!0,view:window,clientX:s,clientY:n};e.focus(),e.dispatchEvent(new MouseEvent("mousedown",{...r,button:0,buttons:1})),e.dispatchEvent(new MouseEvent("mouseup",{...r,button:0,buttons:0})),e.dispatchEvent(new MouseEvent("click",{...r,button:0})),e.dispatchEvent(new MouseEvent("mousedown",{...r,button:0,buttons:1})),e.dispatchEvent(new MouseEvent("mouseup",{...r,button:0,buttons:0})),e.dispatchEvent(new MouseEvent("click",{...r,button:0})),e.dispatchEvent(new MouseEvent("dblclick",{...r,button:0}))}async function ot(e){var s;const t=e.elementId?a(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n)return le(n),{success:!0,message:"已双击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return le(t),{success:!0,message:`已双击: ${e.description||((s=t.textContent)==null?void 0:s.trim())||"元素"}`}}function de(e){const t=e.getBoundingClientRect(),s=t.left+t.width/2,n=t.top+t.height/2;e.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window,button:2,buttons:2,clientX:s,clientY:n})),e.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window,button:2,buttons:0,clientX:s,clientY:n})),e.dispatchEvent(new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,view:window,button:2,clientX:s,clientY:n}))}async function at(e){var s;const t=e.elementId?a(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n)return de(n),{success:!0,message:"已右键点击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return de(t),{success:!0,message:`已右键点击: ${e.description||((s=t.textContent)==null?void 0:s.trim())||"元素"}`}}async function ut(e,t,s,n){const r=e.elementId?a(e.elementId):e.selector?document.querySelector(e.selector):null;if(!r)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const c=window.getSelection();if(!c)return{success:!1,message:"无法获取Selection对象",error:"NO_SELECTION"};c.removeAllRanges();const o=document.createRange();try{if(t){const l=it(r,t);if(!l)return{success:!1,message:`未找到文本: ${t}`,error:"TEXT_NOT_FOUND"};const g=(l.textContent||"").indexOf(t);o.setStart(l,g),o.setEnd(l,g+t.length)}else if(s!==void 0&&n!==void 0){const l=r.firstChild;if(!l||l.nodeType!==Node.TEXT_NODE)return{success:!1,message:"元素没有文本节点",error:"NO_TEXT_NODE"};o.setStart(l,s),o.setEnd(l,n)}else o.selectNodeContents(r);c.addRange(o);const i=c.toString();return{success:!0,message:`已选中文本: ${i}`,data:i}}catch(i){return{success:!1,message:`选中文本失败: ${i}`,error:"SELECT_ERROR"}}}function it(e,t){const s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);let n;for(;n=s.nextNode();)if(n.textContent&&n.textContent.includes(t))return n;return null}async function lt(e,t){var s;try{let n=t;if(!n){const r=window.getSelection();if(r&&!r.isCollapsed)n=r.toString();else if(e.elementId||e.selector){const c=e.elementId?a(e.elementId):document.querySelector(e.selector);c&&(n=((s=c.textContent)==null?void 0:s.trim())||"")}}return n?(await navigator.clipboard.writeText(n),{success:!0,message:`已复制到剪贴板: ${n.substring(0,50)}${n.length>50?"...":""}`}):{success:!1,message:"没有可复制的内容",error:"NO_CONTENT"}}catch(n){return{success:!1,message:`复制失败: ${n}`,error:"CLIPBOARD_ERROR"}}}async function dt(e){try{const t=await navigator.clipboard.readText();if(!t)return{success:!1,message:"剪贴板为空",error:"EMPTY_CLIPBOARD"};const s=e.elementId?a(e.elementId):e.selector?document.querySelector(e.selector):null;if(!s)return{success:!0,message:"已读取剪贴板内容",data:t};if(s.tagName==="INPUT"||s.tagName==="TEXTAREA"){const n=s;return n.focus(),n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已粘贴: ${t.substring(0,50)}${t.length>50?"...":""}`}}else if(s.getAttribute("contenteditable")==="true")return s.focus(),s.textContent=t,s.dispatchEvent(new Event("input",{bubbles:!0})),{success:!0,message:`已粘贴: ${t.substring(0,50)}${t.length>50?"...":""}`};return{success:!0,message:"已读取剪贴板内容",data:t}}catch(t){return{success:!1,message:`粘贴失败: ${t}`,error:"CLIPBOARD_ERROR"}}}async function mt(e,t){if(!t||t.length===0)return{success:!1,message:"未提供文件",error:"NO_FILES"};const s=e.elementId?a(e.elementId):e.selector?document.querySelector(e.selector):null;if(!s||s.tagName!=="INPUT"||s.type!=="file")return{success:!1,message:"目标元素不是文件输入框",error:"INVALID_ELEMENT"};const n=s;try{const r=new DataTransfer;for(const c of t){const o=atob(c.content),i=new Array(o.length);for(let m=0;m<o.length;m++)i[m]=o.charCodeAt(m);const l=new Uint8Array(i),p=new Blob([l],{type:c.type}),g=new File([p],c.name,{type:c.type});r.items.add(g)}return n.files=r.files,n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已上传 ${t.length} 个文件`}}catch(r){return{success:!1,message:`上传失败: ${r}`,error:"UPLOAD_ERROR"}}}async function ft(e){if(!e)return{success:!1,message:"未提供脚本",error:"NO_SCRIPT"};try{return{success:!0,message:"脚本执行成功",data:new Function(e)()}}catch(t){return{success:!1,message:`脚本执行失败: ${t}`,error:"SCRIPT_ERROR"}}}async function pt(e,t,s,n){var i,l;if(!s)return{success:!1,message:"未提供列表项内容",error:"NO_CONTENT"};let r=null;if(t)r=document.querySelector(t);else if(e.elementId||e.selector){const p=e.elementId?a(e.elementId):document.querySelector(e.selector);p&&(r=p.closest("ul, ol"))}if(!r)return{success:!1,message:"未找到列表容器",error:"LIST_NOT_FOUND"};const c=document.createElement("li");c.textContent=s;const o=e.elementId?a(e.elementId):e.selector?document.querySelector(e.selector):null;switch(n){case"before":o&&o.tagName==="LI"?(i=o.parentNode)==null||i.insertBefore(c,o):r.insertBefore(c,r.firstChild);break;case"after":o&&o.tagName==="LI"?(l=o.parentNode)==null||l.insertBefore(c,o.nextSibling):r.appendChild(c);break;case"first":r.insertBefore(c,r.firstChild);break;case"last":default:r.appendChild(c);break}return r.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已添加列表项: ${s}`}}async function gt(e,t){var c;let s=null;if(e.elementId||e.selector)s=e.elementId?a(e.elementId):document.querySelector(e.selector);else if(t!==void 0){const o=document.querySelectorAll("ul, ol");for(const i of o){const l=i.querySelectorAll(":scope > li");if(l[t]){s=l[t];break}}}if(!s||s.tagName!=="LI")return{success:!1,message:"未找到要删除的列表项",error:"ITEM_NOT_FOUND"};const n=((c=s.textContent)==null?void 0:c.trim())||"",r=s.parentNode;return s.remove(),r&&r.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已删除列表项: ${n}`}}async function Et(e,t){var r;if(!t)return{success:!1,message:"未提供新内容",error:"NO_CONTENT"};const s=e.elementId?a(e.elementId):e.selector?document.querySelector(e.selector):null;if(!s||s.tagName!=="LI")return{success:!1,message:"未找到列表项元素",error:"ITEM_NOT_FOUND"};const n=((r=s.textContent)==null?void 0:r.trim())||"";return s.textContent=t,s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已编辑列表项: "${n}" → "${t}"`}}async function ht(e,t){var r;if(t===void 0)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const s=e.elementId?a(e.elementId):e.selector?document.querySelector(e.selector):null;if(!s)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const n=((r=s.textContent)==null?void 0:r.trim())||"";return s.tagName==="INPUT"||s.tagName==="TEXTAREA"?s.value=t:(s.getAttribute("contenteditable"),s.textContent=t),s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已设置内容: "${n.substring(0,20)}..." → "${t.substring(0,20)}..."`}}async function bt(e,t){if(!t)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const s=e.elementId?a(e.elementId):e.selector?document.querySelector(e.selector):null;if(!s)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};if(s.tagName==="INPUT"||s.tagName==="TEXTAREA"){const n=s;n.value+=t}else s.getAttribute("contenteditable")==="true"?s.textContent=(s.textContent||"")+t:s.appendChild(document.createTextNode(t));return s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已追加内容: "${t.substring(0,30)}${t.length>30?"...":""}"`}}async function wt(e,t){if(!t)return{success:!1,message:"未提供内容",error:"NO_CONTENT"};const s=e.elementId?a(e.elementId):e.selector?document.querySelector(e.selector):null;if(!s)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};if(s.tagName==="INPUT"||s.tagName==="TEXTAREA"){const n=s;n.value=t+n.value}else s.getAttribute("contenteditable")==="true"?s.textContent=t+(s.textContent||""):s.insertBefore(document.createTextNode(t),s.firstChild);return s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已前置内容: "${t.substring(0,30)}${t.length>30?"...":""}"`}}async function yt(e,t,s){if(!t)return{success:!1,message:"未提供HTML内容",error:"NO_HTML"};const n=e.elementId?a(e.elementId):e.selector?document.querySelector(e.selector):null;if(!n)return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"};const r=s||"beforeend";return n.insertAdjacentHTML(r,t),n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已在${{beforebegin:"元素之前",afterbegin:"元素内部开头",beforeend:"元素内部末尾",afterend:"元素之后"}[r]}插入HTML`}}async function vt(e){try{if(e)return document.cookie=`${encodeURIComponent(e)}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`,{success:!0,message:`已清除 Cookie: ${e}`};{const t=document.cookie.split(";");return t.forEach(s=>{const[n]=s.split("="),r=n==null?void 0:n.trim();r&&(document.cookie=`${r}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`,document.cookie=`${r}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;domain=${window.location.hostname}`)}),{success:!0,message:`已清除 ${t.length} 个Cookies`}}}catch(t){return{success:!1,message:"清除Cookie失败",error:String(t)}}}async function ge(e){var t,s,n,r,c,o,i,l,p,g,m,v,T,x,O,_,A,L,$,k,R,U,M,D,P,q,F,B,X,H,W,z,V,G,Y,K,j,J,Q,Z,ee,te,se,ne,re;try{switch(e.action){case"fill":return await ke(e.target,(t=e.params)==null?void 0:t.value);case"click":return await Re(e.target);case"highlight":return await Ue(e.target,(s=e.params)==null?void 0:s.color);case"underline":return await Me(e.target);case"select":return await De(e.target,(n=e.params)==null?void 0:n.value);case"check":return await Pe(e.target);case"scroll":return await qe((r=e.params)==null?void 0:r.direction);case"read":return await Fe(e.target);case"hover":return await Be(e.target);case"type":return await Xe(e.target,(c=e.params)==null?void 0:c.value,(o=e.params)==null?void 0:o.delay);case"press":return await He((i=e.params)==null?void 0:i.key,(l=e.target)==null?void 0:l.selector);case"drag":return await We(e.target,(p=e.params)==null?void 0:p.destination);case"wait":return await ze(e.target,(g=e.params)==null?void 0:g.timeout,(m=e.params)==null?void 0:m.condition);case"focus":return await Ve(e.target);case"blur":return await Ge(e.target);case"clear":return await Ye(e.target);case"getAttribute":return await Ke(e.target,(v=e.params)==null?void 0:v.attribute);case"getProperty":return await je(e.target,(T=e.params)==null?void 0:T.property);case"navigate":return await Je((x=e.params)==null?void 0:x.navigateAction,(O=e.params)==null?void 0:O.url);case"scrollIntoView":return await Qe(e.target,(_=e.params)==null?void 0:_.behavior,(A=e.params)==null?void 0:A.block);case"switchFrame":return await Ze((L=e.params)==null?void 0:L.frameSelector);case"handleDialog":return await et(($=e.params)==null?void 0:$.dialogAction,(k=e.params)==null?void 0:k.promptText);case"setLocalStorage":return await tt((R=e.params)==null?void 0:R.key,(U=e.params)==null?void 0:U.value);case"getLocalStorage":return await st((M=e.params)==null?void 0:M.key);case"clearLocalStorage":return await nt((D=e.params)==null?void 0:D.prefix);case"setCookie":return await rt((P=e.params)==null?void 0:P.name,(q=e.params)==null?void 0:q.value,(F=e.params)==null?void 0:F.cookieOptions);case"getCookie":return await ct((B=e.params)==null?void 0:B.name);case"clearCookies":return await vt((X=e.params)==null?void 0:X.name);case"doubleClick":return await ot(e.target);case"rightClick":return await at(e.target);case"selectText":return await ut(e.target,(H=e.params)==null?void 0:H.searchText,(W=e.params)==null?void 0:W.startOffset,(z=e.params)==null?void 0:z.endOffset);case"copyToClipboard":return await lt(e.target,(V=e.params)==null?void 0:V.text);case"pasteFromClipboard":return await dt(e.target);case"upload":return await mt(e.target,(G=e.params)==null?void 0:G.files);case"evaluate":return await ft((Y=e.params)==null?void 0:Y.script);case"addListItem":return await pt(e.target,(K=e.params)==null?void 0:K.listSelector,(j=e.params)==null?void 0:j.itemContent,(J=e.params)==null?void 0:J.position);case"removeListItem":return await gt(e.target,(Q=e.params)==null?void 0:Q.itemIndex);case"editListItem":return await Et(e.target,(Z=e.params)==null?void 0:Z.itemContent);case"setContent":return await ht(e.target,(ee=e.params)==null?void 0:ee.content);case"appendContent":return await bt(e.target,(te=e.params)==null?void 0:te.content);case"prependContent":return await wt(e.target,(se=e.params)==null?void 0:se.content);case"insertHTML":return await yt(e.target,(ne=e.params)==null?void 0:ne.html,(re=e.params)==null?void 0:re.insertPosition);default:return{success:!1,message:`不支持的操作类型: ${e.action}`,error:"UNSUPPORTED_ACTION"}}}catch(be){return{success:!1,message:`执行操作时出错: ${be}`,error:"EXECUTION_ERROR"}}}async function Tt(e){const t=[];let s=0;for(const r of e){const c=await ge(r);t.push(c),c.success&&s++,await y(100)}const n=`执行了 ${e.length} 个操作，成功 ${s} 个，失败 ${e.length-s} 个`;return{success:s===e.length,results:t,summary:n}}function Nt(){document.querySelectorAll(".ai-highlight").forEach(e=>{const t=e.parentNode;t&&(t.replaceChild(document.createTextNode(e.textContent||""),e),t.normalize())}),document.querySelectorAll(".ai-underline").forEach(e=>{const t=e.parentNode;t&&(t.replaceChild(document.createTextNode(e.textContent||""),e),t.normalize())})}let u=null,d=null,w=null,E=!1,h=null,f=null,b=480;const It=320,Ct=800;let N=!1;function Ee(e){h&&(h.textContent=`
      /* 核心：缩小 html 宽度，让页面内容自然收缩 */
      html {
        width: calc(100% - ${e}px) !important;
        min-width: auto !important;
        overflow-x: hidden !important;
        position: relative !important;
      }

      /* 确保 body 跟随 html 宽度 */
      body {
        width: 100% !important;
        min-width: auto !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
        position: relative !important;
      }

      /* 确保聊天容器不受影响，固定在视口右侧 */
      #ai-chat-container {
        position: fixed !important;
        right: 0 !important;
        top: 0 !important;
        width: ${e}px !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box !important;
      }
    `)}function St(){if(!f)return;let e=0,t=0;const s=c=>{c.preventDefault(),N=!0,e=c.clientX,t=b;const o=document.createElement("div");o.id="ai-chat-resize-overlay",o.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2147483646;
      cursor: ew-resize;
    `,document.body.appendChild(o),f&&(f.style.background="rgba(102, 126, 234, 0.5)"),document.addEventListener("mousemove",n),document.addEventListener("mouseup",r)},n=c=>{if(!N)return;const o=e-c.clientX;let i=t+o;i=Math.max(It,Math.min(Ct,i)),b=i,d&&(d.style.width=`${i}px`),Ee(i)},r=()=>{N=!1;const c=document.getElementById("ai-chat-resize-overlay");c&&c.remove(),f&&(f.style.background="transparent"),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r),chrome.storage.local.set({chatWidth:b})};f.addEventListener("mousedown",s)}function S(){return{url:window.location.href,title:document.title}}async function xt(e){const t=S();if(!e)return(await chrome.runtime.sendMessage({type:"CREATE_SESSION",payload:{title:t.title||"新对话",pageUrl:t.url,pageTitle:t.title}})).data.id;const s=await chrome.runtime.sendMessage({type:"GET_SESSION_BY_TAB",payload:{tabId:e}});return s.success&&s.data?(await chrome.runtime.sendMessage({type:"UPDATE_SESSION",payload:{sessionId:s.data.id,updates:{pageUrl:t.url,pageTitle:t.title}}}),s.data.id):(await chrome.runtime.sendMessage({type:"CREATE_SESSION",payload:{title:t.title||"新对话",tabId:e,pageUrl:t.url,pageTitle:t.title}})).data.id}function I(e){const t=S(),s=chrome.runtime.getURL(`chat.html?sessionId=${e}&pageUrl=${encodeURIComponent(t.url)}&pageTitle=${encodeURIComponent(t.title)}`);if(u){u.src=s,setTimeout(()=>{u!=null&&u.contentWindow&&u.contentWindow.postMessage({type:"PAGE_INFO",url:t.url,title:t.title},"*")},500);return}d=document.createElement("div"),d.id="ai-chat-container",d.style.cssText=`
    position: fixed;
    width: ${b}px;
    height: 100vh;
    right: 0;
    top: 0;
    z-index: 2147483647;
    background: white;
    border-left: 1px solid #e5e7eb;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  `,f=document.createElement("div"),f.id="ai-chat-resize-handle",f.style.cssText=`
    position: absolute;
    left: 0;
    top: 0;
    width: 6px;
    height: 100%;
    cursor: ew-resize;
    background: transparent;
    z-index: 2147483648;
    transition: background 0.2s;
  `,f.addEventListener("mouseenter",()=>{f&&(f.style.background="rgba(102, 126, 234, 0.3)")}),f.addEventListener("mouseleave",()=>{f&&!N&&(f.style.background="transparent")}),u=document.createElement("iframe"),u.src=s,u.style.cssText=`
    width: 100%;
    height: 100%;
    border: none;
  `,d.appendChild(f),d.appendChild(u),document.body.appendChild(d),St(),h=document.createElement("style"),h.id="ai-chat-layout-style",Ee(b),document.head.appendChild(h);const n=new ResizeObserver(()=>{d&&(d.style.height=`${window.innerHeight}px`)});n.observe(document.documentElement),d.__resizeObserver=n,window.addEventListener("message",_t),E&&chrome.storage.local.set({chatPinned:!0,chatSessionId:e})}let me=window.location.href;const Ot=new MutationObserver(()=>{if(window.location.href!==me&&(me=window.location.href,u!=null&&u.contentWindow)){const e=S();u.contentWindow.postMessage({type:"PAGE_INFO",url:e.url,title:e.title},"*")}});Ot.observe(document.body,{childList:!0,subtree:!0});function _t(e){e.source===(u==null?void 0:u.contentWindow)&&(console.log("Received message from chat:",e.data),e.data.type==="CLOSE_CHAT"?he():e.data.type==="PIN_CHAT"&&(console.log("Handling PIN_CHAT"),At()))}function At(){E=!E,console.log("togglePin called, new isPinned:",E),E?(chrome.storage.local.set({chatPinned:!0,chatSessionId:w},()=>{console.log("Saved pin state to storage")}),u!=null&&u.contentWindow&&(u.contentWindow.postMessage({type:"PIN_STATUS_CHANGED",isPinned:!0},"*"),console.log("Sent PIN_STATUS_CHANGED: true to chat"))):(chrome.storage.local.remove(["chatPinned","chatSessionId"],()=>{console.log("Removed pin state from storage")}),u!=null&&u.contentWindow&&(u.contentWindow.postMessage({type:"PIN_STATUS_CHANGED",isPinned:!1},"*"),console.log("Sent PIN_STATUS_CHANGED: false to chat")))}function he(){if(d){const e=d.__resizeObserver;e&&e.disconnect(),d.remove(),d=null,u=null,f=null,h&&(h.remove(),h=null);const t=document.getElementById("ai-chat-resize-overlay");t&&t.remove(),E||chrome.storage.local.remove(["chatPinned","chatSessionId"])}}chrome.storage.local.get(["chatPinned","chatSessionId","chatWidth"],e=>{e.chatWidth&&(b=e.chatWidth),e.chatPinned&&e.chatSessionId&&(E=!0,w=e.chatSessionId,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{I(e.chatSessionId)}):I(e.chatSessionId))});chrome.runtime.onMessage.addListener((e,t,s)=>{var n,r;if(e.type==="OPEN_CHAT")if(e.sessionId)w=e.sessionId,d?u.src=chrome.runtime.getURL(`chat.html?sessionId=${e.sessionId}`):I(e.sessionId),s({success:!0});else{const c=e.tabId;return xt(c).then(o=>{w=o,d?u.src=chrome.runtime.getURL(`chat.html?sessionId=${o}`):I(o),s({success:!0,sessionId:o})}).catch(o=>{console.error("Failed to get/create session:",o),s({success:!1,error:o.message})}),!0}else if(e.type==="CLOSE_CHAT")he(),s({success:!0});else if(e.type==="CHECK_CHAT_STATUS")s({isOpen:!!d,isPinned:E,sessionId:w});else if(e.type==="GET_PAGE_CONTEXT"){const c=((n=e.payload)==null?void 0:n.userMessage)||"",o=Le(c);s({success:!0,data:o})}else if(e.type==="REQUEST_MORE_ELEMENTS"){const c=e.payload||{},o=$e(c);s({success:!0,data:o})}else if(e.type==="EXECUTE_PAGE_ACTION"){const c=e.payload;return ge(c).then(o=>{s({success:o.success,data:o})}),!0}else if(e.type==="EXECUTE_BATCH_ACTIONS"){const c=e.payload;return Tt(c).then(o=>{s({success:o.success,data:o})}),!0}else if(e.type==="CLEAR_AI_STYLES")Nt(),s({success:!0});else if(e.type==="GET_SELECTED_TEXT"){const c=((r=window.getSelection())==null?void 0:r.toString())||"";s({success:!0,data:c})}return!0});

})()