(function(){
'use strict';
const w=new Map,A={priorities:{form:10,button:8,link:3,text:1},viewport:{visible:5,nearViewport:2,hidden:0},maxElements:30};function L(){return`e_${Date.now()}_${Math.random().toString(36).substr(2,6)}`}function O(e){return e.top>=0&&e.left>=0&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth}function M(e){return e.top>=-200&&e.left>=-200&&e.bottom<=window.innerHeight+200&&e.right<=window.innerWidth+200}function k(e){const t=window.getComputedStyle(e);if(t.display==="none"||t.visibility==="hidden"||t.opacity==="0")return!1;const n=e.getBoundingClientRect();return!(n.width===0||n.height===0)}function U(e){var n,o;if(e.id){const s=document.querySelector(`label[for="${e.id}"]`);if(s)return(n=s.textContent)==null?void 0:n.trim()}const t=e.closest("label");if(t){const s=t.cloneNode(!0);return s.querySelectorAll("input, select, textarea").forEach(i=>i.remove()),(o=s.textContent)==null?void 0:o.trim()}}function P(e){var t;if(e.tagName==="BUTTON"||e.tagName==="A")return(t=e.textContent)==null?void 0:t.trim();if(e.tagName==="INPUT"){const n=e;if(n.type==="submit"||n.type==="button")return n.value}}function R(e){if(!k(e))return null;const t=e.getBoundingClientRect(),n=L();w.set(n,e);const o={id:n,tag:e.tagName.toLowerCase(),rect:{x:t.x,y:t.y,width:t.width,height:t.height},visible:O(t),disabled:e.disabled||e.getAttribute("aria-disabled")==="true"};if(e.tagName==="INPUT"){const s=e;o.type=s.type,o.name=s.name||void 0,o.placeholder=s.placeholder||void 0,s.type!=="password"&&(o.value=s.value||void 0)}if(e.tagName==="TEXTAREA"){const s=e;o.name=s.name||void 0,o.placeholder=s.placeholder||void 0,o.value=s.value||void 0}if(e.tagName==="SELECT"){const s=e;o.name=s.name||void 0,o.value=s.value||void 0}return o.text=P(e),o.label=U(e),o.ariaLabel=e.getAttribute("aria-label")||void 0,o}function C(){w.clear();const e=[],t=['input:not([type="hidden"])',"textarea","button","a[href]","select",'[role="button"]','[role="link"]','[role="checkbox"]','[role="radio"]','[contenteditable="true"]',"[onclick]",'[tabindex]:not([tabindex="-1"])'];return document.querySelectorAll(t.join(", ")).forEach(o=>{const s=R(o);s&&e.push(s)}),e}function f(e){return w.get(e)||null}function $(e){const t=["帮我","请","把","将","给","在","到","的","和","然后","并且","接着"];let n=e;return t.forEach(s=>{n=n.replace(new RegExp(s,"g")," ")}),n.split(/[\s,，。.!！?？、]+/).filter(s=>s.length>0)}function D(e,t,n){let o=0;const s=[e.text,e.placeholder,e.label,e.ariaLabel,e.name].filter(Boolean).join(" ");for(const r of t)s.toLowerCase().includes(r.toLowerCase())&&(o+=10);return e.tag==="input"||e.tag==="textarea"?o+=n.priorities.form:e.tag==="button"||e.tag==="input"&&(e.type==="submit"||e.type==="button")?o+=n.priorities.button:e.tag==="select"?o+=n.priorities.form:e.tag==="a"&&(o+=n.priorities.link),e.visible?o+=n.viewport.visible:M(new DOMRect(e.rect.x,e.rect.y,e.rect.width,e.rect.height))&&(o+=n.viewport.nearViewport),e.disabled&&(o-=5),o}function H(e,t,n=A){const o=$(t);return e.map(r=>({element:r,score:D(r,o,n)})).sort((r,i)=>i.score-r.score).slice(0,n.maxElements).map(r=>r.element)}function W(e){const t=[];let o={input:"输入框",textarea:"文本框",button:"按钮",a:"链接",select:"下拉框"}[e.tag]||e.tag;e.tag==="input"&&e.type&&(e.type==="password"?o="密码框":e.type==="submit"?o="提交按钮":e.type==="checkbox"?o="复选框":e.type==="radio"?o="单选框":e.type==="search"?o="搜索框":e.type==="email"&&(o="邮箱输入框")),t.push(o);const s=e.label||e.text||e.placeholder||e.ariaLabel||e.name;s&&t.push(s);const r=[];e.placeholder&&e.placeholder!==s&&r.push(`placeholder:${e.placeholder}`),e.type&&!["text","submit","button"].includes(e.type)&&r.push(`type:${e.type}`),e.disabled&&r.push("禁用");let i=t.join(":");return r.length>0&&(i+=`(${r.join(",")})`),i}function N(e){return e.map(t=>({id:t.id,desc:W(t)}))}function z(e=""){var s;const t=C(),n=H(t,e),o=N(n);return{url:window.location.href,title:document.title,elements:o,selectedText:((s=window.getSelection())==null?void 0:s.toString())||void 0}}function B(e){let t=C();if(e.region&&(t=t.filter(n=>{const o=n.rect;switch(e.region){case"header":return o.y<150;case"footer":return o.y>window.innerHeight-200;case"sidebar":return o.x<250||o.x>window.innerWidth-250;case"below_viewport":return o.y>window.innerHeight;case"form":const s=document.querySelectorAll("form");return Array.from(s).some(r=>{const i=r.getBoundingClientRect();return o.x>=i.left&&o.x<=i.right&&o.y>=i.top&&o.y<=i.bottom});default:return!0}})),e.elementType&&e.elementType!=="all"&&(t=t.filter(n=>{switch(e.elementType){case"input":return n.tag==="input"||n.tag==="textarea";case"button":return n.tag==="button"||n.tag==="input"&&(n.type==="submit"||n.type==="button");case"link":return n.tag==="a";case"select":return n.tag==="select";default:return!0}})),e.keyword){const n=e.keyword.toLowerCase();t=t.filter(o=>[o.text,o.placeholder,o.label,o.ariaLabel,o.name].filter(Boolean).join(" ").toLowerCase().includes(n))}return N(t)}function G(e){return new Promise(t=>setTimeout(t,e))}function b(e,t){e.focus(),e.value="",e.dispatchEvent(new Event("focus",{bubbles:!0})),e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))}function v(e){e.focus(),e.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))}async function X(e,t){if(!t)return{success:!1,message:"未提供填充值",error:"NO_VALUE"};const n=e.elementId?f(e.elementId):null;if(!n){if(e.selector){const o=document.querySelector(e.selector);if(o&&(o.tagName==="INPUT"||o.tagName==="TEXTAREA"))return b(o,t),{success:!0,message:`已填充: ${t}`}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return n.tagName!=="INPUT"&&n.tagName!=="TEXTAREA"?n.getAttribute("contenteditable")==="true"?(n.focus(),n.textContent=t,n.dispatchEvent(new Event("input",{bubbles:!0})),{success:!0,message:`已填充: ${t}`}):{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"}:(b(n,t),{success:!0,message:`已填充: ${t}`})}async function q(e){var n;const t=e.elementId?f(e.elementId):null;if(!t){if(e.selector){const o=document.querySelector(e.selector);if(o)return v(o),{success:!0,message:"已点击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return v(t),{success:!0,message:`已点击: ${e.description||((n=t.textContent)==null?void 0:n.trim())||"元素"}`}}async function V(e,t){const n=t||"#ffeb3b",o=window.getSelection();if(o&&o.rangeCount>0&&!o.isCollapsed){const r=o.getRangeAt(0),i=document.createElement("span");i.className="ai-highlight",i.style.backgroundColor=n,i.style.padding="2px 0",i.style.borderRadius="2px";try{return r.surroundContents(i),o.removeAllRanges(),{success:!0,message:"已高亮选中文字"}}catch{return{success:!1,message:"无法高亮跨元素的选中内容",error:"CROSS_ELEMENT"}}}const s=e.elementId?f(e.elementId):null;return s?(s.style.backgroundColor=n,s.classList.add("ai-highlight"),{success:!0,message:"已高亮元素"}):{success:!1,message:"未找到要高亮的内容",error:"NO_TARGET"}}async function j(e){const t=window.getSelection();if(t&&t.rangeCount>0&&!t.isCollapsed){const o=t.getRangeAt(0),s=document.createElement("span");s.className="ai-underline",s.style.textDecoration="underline",s.style.textDecorationColor="#1a73e8",s.style.textDecorationThickness="2px";try{return o.surroundContents(s),t.removeAllRanges(),{success:!0,message:"已添加下划线"}}catch{return{success:!1,message:"无法为跨元素的选中内容添加下划线",error:"CROSS_ELEMENT"}}}const n=e.elementId?f(e.elementId):null;return n?(n.style.textDecoration="underline",n.style.textDecorationColor="#1a73e8",n.classList.add("ai-underline"),{success:!0,message:"已添加下划线"}):{success:!1,message:"未找到要添加下划线的内容",error:"NO_TARGET"}}async function F(e,t){if(!t)return{success:!1,message:"未提供选择值",error:"NO_VALUE"};const n=e.elementId?f(e.elementId):null;if(!n||n.tagName!=="SELECT"){if(e.selector){const o=document.querySelector(e.selector);if(o&&o.tagName==="SELECT")return T(o,t)}return{success:!1,message:"未找到下拉框元素",error:"ELEMENT_NOT_FOUND"}}return T(n,t)}function T(e,t){const n=Array.from(e.options).find(s=>s.value===t);if(n)return e.value=n.value,e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已选择: ${n.text}`};const o=Array.from(e.options).find(s=>s.text.toLowerCase().includes(t.toLowerCase()));return o?(e.value=o.value,e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已选择: ${o.text}`}):{success:!1,message:`未找到匹配的选项: ${t}`,error:"OPTION_NOT_FOUND"}}async function K(e){const t=e.elementId?f(e.elementId):null;if(!t){if(e.selector){const o=document.querySelector(e.selector);if(o&&o.type==="checkbox")return o.checked=!o.checked,o.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:o.checked?"已勾选":"已取消勾选"}}return{success:!1,message:"未找到复选框元素",error:"ELEMENT_NOT_FOUND"}}if(t.tagName!=="INPUT"||t.type!=="checkbox")return{success:!1,message:"目标元素不是复选框",error:"INVALID_ELEMENT"};const n=t;return n.checked=!n.checked,n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:n.checked?"已勾选":"已取消勾选"}}async function Y(e){const t=window.innerHeight*.8;switch(e){case"up":return window.scrollBy({top:-t,behavior:"smooth"}),{success:!0,message:"已向上滚动"};case"down":return window.scrollBy({top:t,behavior:"smooth"}),{success:!0,message:"已向下滚动"};case"top":return window.scrollTo({top:0,behavior:"smooth"}),{success:!0,message:"已滚动到顶部"};case"bottom":return window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}),{success:!0,message:"已滚动到底部"};default:return window.scrollBy({top:t,behavior:"smooth"}),{success:!0,message:"已向下滚动"}}}async function Q(e){var o,s;const t=e.elementId?f(e.elementId):null;if(!t){if(e.selector){const i=document.querySelector(e.selector);if(i)return{success:!0,message:"已读取内容",data:((o=i.textContent)==null?void 0:o.trim())||""}}const r=window.getSelection();return r&&!r.isCollapsed?{success:!0,message:"已读取选中内容",data:r.toString()}:{success:!1,message:"未找到要读取的内容",error:"NO_TARGET"}}return{success:!0,message:"已读取内容",data:((s=t.textContent)==null?void 0:s.trim())||""}}async function S(e){var t,n,o,s;try{switch(e.action){case"fill":return await X(e.target,(t=e.params)==null?void 0:t.value);case"click":return await q(e.target);case"highlight":return await V(e.target,(n=e.params)==null?void 0:n.color);case"underline":return await j(e.target);case"select":return await F(e.target,(o=e.params)==null?void 0:o.value);case"check":return await K(e.target);case"scroll":return await Y((s=e.params)==null?void 0:s.direction);case"read":return await Q(e.target);default:return{success:!1,message:`不支持的操作类型: ${e.action}`,error:"UNSUPPORTED_ACTION"}}}catch(r){return{success:!1,message:`执行操作时出错: ${r}`,error:"EXECUTION_ERROR"}}}async function J(e){const t=[];let n=0;for(const s of e){const r=await S(s);t.push(r),r.success&&n++,await G(100)}const o=`执行了 ${e.length} 个操作，成功 ${n} 个，失败 ${e.length-n} 个`;return{success:n===e.length,results:t,summary:o}}function Z(){document.querySelectorAll(".ai-highlight").forEach(e=>{const t=e.parentNode;t&&(t.replaceChild(document.createTextNode(e.textContent||""),e),t.normalize())}),document.querySelectorAll(".ai-underline").forEach(e=>{const t=e.parentNode;t&&(t.replaceChild(document.createTextNode(e.textContent||""),e),t.normalize())})}let c=null,a=null,h=null,u=!1,d=null,l=null,p=480;const ee=320,te=800;let g=!1;function I(e){d&&(d.textContent=`
      /* 核心：缩小 html 宽度，让页面内容自然收缩 */
      html {
        width: calc(100% - ${e}px) !important;
        min-width: auto !important;
        overflow-x: hidden !important;
        position: relative !important;
      }

      /* 确保 body 跟随 html 宽度 */
      body {
        width: 100% !important;
        min-width: auto !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
        position: relative !important;
      }

      /* 确保聊天容器不受影响，固定在视口右侧 */
      #ai-chat-container {
        position: fixed !important;
        right: 0 !important;
        top: 0 !important;
        width: ${e}px !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box !important;
      }
    `)}function ne(){if(!l)return;let e=0,t=0;const n=r=>{r.preventDefault(),g=!0,e=r.clientX,t=p;const i=document.createElement("div");i.id="ai-chat-resize-overlay",i.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2147483646;
      cursor: ew-resize;
    `,document.body.appendChild(i),l&&(l.style.background="rgba(102, 126, 234, 0.5)"),document.addEventListener("mousemove",o),document.addEventListener("mouseup",s)},o=r=>{if(!g)return;const i=e-r.clientX;let m=t+i;m=Math.max(ee,Math.min(te,m)),p=m,a&&(a.style.width=`${m}px`),I(m)},s=()=>{g=!1;const r=document.getElementById("ai-chat-resize-overlay");r&&r.remove(),l&&(l.style.background="transparent"),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",s),chrome.storage.local.set({chatWidth:p})};l.addEventListener("mousedown",n)}function y(){return{url:window.location.href,title:document.title}}async function oe(e){const t=y();if(!e)return(await chrome.runtime.sendMessage({type:"CREATE_SESSION",payload:{title:t.title||"新对话",pageUrl:t.url,pageTitle:t.title}})).data.id;const n=await chrome.runtime.sendMessage({type:"GET_SESSION_BY_TAB",payload:{tabId:e}});return n.success&&n.data?(await chrome.runtime.sendMessage({type:"UPDATE_SESSION",payload:{sessionId:n.data.id,updates:{pageUrl:t.url,pageTitle:t.title}}}),n.data.id):(await chrome.runtime.sendMessage({type:"CREATE_SESSION",payload:{title:t.title||"新对话",tabId:e,pageUrl:t.url,pageTitle:t.title}})).data.id}function E(e){const t=y(),n=chrome.runtime.getURL(`chat.html?sessionId=${e}&pageUrl=${encodeURIComponent(t.url)}&pageTitle=${encodeURIComponent(t.title)}`);if(c){c.src=n,setTimeout(()=>{c!=null&&c.contentWindow&&c.contentWindow.postMessage({type:"PAGE_INFO",url:t.url,title:t.title},"*")},500);return}a=document.createElement("div"),a.id="ai-chat-container",a.style.cssText=`
    position: fixed;
    width: ${p}px;
    height: 100vh;
    right: 0;
    top: 0;
    z-index: 2147483647;
    background: white;
    border-left: 1px solid #e5e7eb;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  `,l=document.createElement("div"),l.id="ai-chat-resize-handle",l.style.cssText=`
    position: absolute;
    left: 0;
    top: 0;
    width: 6px;
    height: 100%;
    cursor: ew-resize;
    background: transparent;
    z-index: 2147483648;
    transition: background 0.2s;
  `,l.addEventListener("mouseenter",()=>{l&&(l.style.background="rgba(102, 126, 234, 0.3)")}),l.addEventListener("mouseleave",()=>{l&&!g&&(l.style.background="transparent")}),c=document.createElement("iframe"),c.src=n,c.style.cssText=`
    width: 100%;
    height: 100%;
    border: none;
  `,a.appendChild(l),a.appendChild(c),document.body.appendChild(a),ne(),d=document.createElement("style"),d.id="ai-chat-layout-style",I(p),document.head.appendChild(d);const o=new ResizeObserver(()=>{a&&(a.style.height=`${window.innerHeight}px`)});o.observe(document.documentElement),a.__resizeObserver=o,window.addEventListener("message",re),u&&chrome.storage.local.set({chatPinned:!0,chatSessionId:e})}let x=window.location.href;const se=new MutationObserver(()=>{if(window.location.href!==x&&(x=window.location.href,c!=null&&c.contentWindow)){const e=y();c.contentWindow.postMessage({type:"PAGE_INFO",url:e.url,title:e.title},"*")}});se.observe(document.body,{childList:!0,subtree:!0});function re(e){e.source===(c==null?void 0:c.contentWindow)&&(console.log("Received message from chat:",e.data),e.data.type==="CLOSE_CHAT"?_():e.data.type==="PIN_CHAT"&&(console.log("Handling PIN_CHAT"),ie()))}function ie(){u=!u,console.log("togglePin called, new isPinned:",u),u?(chrome.storage.local.set({chatPinned:!0,chatSessionId:h},()=>{console.log("Saved pin state to storage")}),c!=null&&c.contentWindow&&(c.contentWindow.postMessage({type:"PIN_STATUS_CHANGED",isPinned:!0},"*"),console.log("Sent PIN_STATUS_CHANGED: true to chat"))):(chrome.storage.local.remove(["chatPinned","chatSessionId"],()=>{console.log("Removed pin state from storage")}),c!=null&&c.contentWindow&&(c.contentWindow.postMessage({type:"PIN_STATUS_CHANGED",isPinned:!1},"*"),console.log("Sent PIN_STATUS_CHANGED: false to chat")))}function _(){if(a){const e=a.__resizeObserver;e&&e.disconnect(),a.remove(),a=null,c=null,l=null,d&&(d.remove(),d=null);const t=document.getElementById("ai-chat-resize-overlay");t&&t.remove(),u||chrome.storage.local.remove(["chatPinned","chatSessionId"])}}chrome.storage.local.get(["chatPinned","chatSessionId","chatWidth"],e=>{e.chatWidth&&(p=e.chatWidth),e.chatPinned&&e.chatSessionId&&(u=!0,h=e.chatSessionId,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{E(e.chatSessionId)}):E(e.chatSessionId))});chrome.runtime.onMessage.addListener((e,t,n)=>{var o,s;if(e.type==="OPEN_CHAT")if(e.sessionId)h=e.sessionId,a?c.src=chrome.runtime.getURL(`chat.html?sessionId=${e.sessionId}`):E(e.sessionId),n({success:!0});else{const r=e.tabId;return oe(r).then(i=>{h=i,a?c.src=chrome.runtime.getURL(`chat.html?sessionId=${i}`):E(i),n({success:!0,sessionId:i})}).catch(i=>{console.error("Failed to get/create session:",i),n({success:!1,error:i.message})}),!0}else if(e.type==="CLOSE_CHAT")_(),n({success:!0});else if(e.type==="CHECK_CHAT_STATUS")n({isOpen:!!a,isPinned:u,sessionId:h});else if(e.type==="GET_PAGE_CONTEXT"){const r=((o=e.payload)==null?void 0:o.userMessage)||"",i=z(r);n({success:!0,data:i})}else if(e.type==="REQUEST_MORE_ELEMENTS"){const r=e.payload||{},i=B(r);n({success:!0,data:i})}else if(e.type==="EXECUTE_PAGE_ACTION"){const r=e.payload;return S(r).then(i=>{n({success:i.success,data:i})}),!0}else if(e.type==="EXECUTE_BATCH_ACTIONS"){const r=e.payload;return J(r).then(i=>{n({success:i.success,data:i})}),!0}else if(e.type==="CLEAR_AI_STYLES")Z(),n({success:!0});else if(e.type==="GET_SELECTED_TEXT"){const r=((s=window.getSelection())==null?void 0:s.toString())||"";n({success:!0,data:r})}return!0});

})()