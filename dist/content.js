(function(){
'use strict';
const p=new Map,N={priorities:{form:10,button:8,link:3,text:1},viewport:{visible:5,nearViewport:2,hidden:0},maxElements:30};function S(){return`e_${Date.now()}_${Math.random().toString(36).substr(2,6)}`}function I(e){return e.top>=0&&e.left>=0&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth}function A(e){return e.top>=-200&&e.left>=-200&&e.bottom<=window.innerHeight+200&&e.right<=window.innerWidth+200}function _(e){const t=window.getComputedStyle(e);if(t.display==="none"||t.visibility==="hidden"||t.opacity==="0")return!1;const o=e.getBoundingClientRect();return!(o.width===0||o.height===0)}function O(e){var o,n;if(e.id){const s=document.querySelector(`label[for="${e.id}"]`);if(s)return(o=s.textContent)==null?void 0:o.trim()}const t=e.closest("label");if(t){const s=t.cloneNode(!0);return s.querySelectorAll("input, select, textarea").forEach(i=>i.remove()),(n=s.textContent)==null?void 0:n.trim()}}function L(e){var t;if(e.tagName==="BUTTON"||e.tagName==="A")return(t=e.textContent)==null?void 0:t.trim();if(e.tagName==="INPUT"){const o=e;if(o.type==="submit"||o.type==="button")return o.value}}function P(e){if(!_(e))return null;const t=e.getBoundingClientRect(),o=S();p.set(o,e);const n={id:o,tag:e.tagName.toLowerCase(),rect:{x:t.x,y:t.y,width:t.width,height:t.height},visible:I(t),disabled:e.disabled||e.getAttribute("aria-disabled")==="true"};if(e.tagName==="INPUT"){const s=e;n.type=s.type,n.name=s.name||void 0,n.placeholder=s.placeholder||void 0,s.type!=="password"&&(n.value=s.value||void 0)}if(e.tagName==="TEXTAREA"){const s=e;n.name=s.name||void 0,n.placeholder=s.placeholder||void 0,n.value=s.value||void 0}if(e.tagName==="SELECT"){const s=e;n.name=s.name||void 0,n.value=s.value||void 0}return n.text=L(e),n.label=O(e),n.ariaLabel=e.getAttribute("aria-label")||void 0,n}function b(){p.clear();const e=[],t=['input:not([type="hidden"])',"textarea","button","a[href]","select",'[role="button"]','[role="link"]','[role="checkbox"]','[role="radio"]','[contenteditable="true"]',"[onclick]",'[tabindex]:not([tabindex="-1"])'];return document.querySelectorAll(t.join(", ")).forEach(n=>{const s=P(n);s&&e.push(s)}),e}function d(e){return p.get(e)||null}function k(e){const t=["帮我","请","把","将","给","在","到","的","和","然后","并且","接着"];let o=e;return t.forEach(s=>{o=o.replace(new RegExp(s,"g")," ")}),o.split(/[\s,，。.!！?？、]+/).filter(s=>s.length>0)}function U(e,t,o){let n=0;const s=[e.text,e.placeholder,e.label,e.ariaLabel,e.name].filter(Boolean).join(" ");for(const r of t)s.toLowerCase().includes(r.toLowerCase())&&(n+=10);return e.tag==="input"||e.tag==="textarea"?n+=o.priorities.form:e.tag==="button"||e.tag==="input"&&(e.type==="submit"||e.type==="button")?n+=o.priorities.button:e.tag==="select"?n+=o.priorities.form:e.tag==="a"&&(n+=o.priorities.link),e.visible?n+=o.viewport.visible:A(new DOMRect(e.rect.x,e.rect.y,e.rect.width,e.rect.height))&&(n+=o.viewport.nearViewport),e.disabled&&(n-=5),n}function M(e,t,o=N){const n=k(t);return e.map(r=>({element:r,score:U(r,n,o)})).sort((r,i)=>i.score-r.score).slice(0,o.maxElements).map(r=>r.element)}function R(e){const t=[];let n={input:"输入框",textarea:"文本框",button:"按钮",a:"链接",select:"下拉框"}[e.tag]||e.tag;e.tag==="input"&&e.type&&(e.type==="password"?n="密码框":e.type==="submit"?n="提交按钮":e.type==="checkbox"?n="复选框":e.type==="radio"?n="单选框":e.type==="search"?n="搜索框":e.type==="email"&&(n="邮箱输入框")),t.push(n);const s=e.label||e.text||e.placeholder||e.ariaLabel||e.name;s&&t.push(s);const r=[];e.placeholder&&e.placeholder!==s&&r.push(`placeholder:${e.placeholder}`),e.type&&!["text","submit","button"].includes(e.type)&&r.push(`type:${e.type}`),e.disabled&&r.push("禁用");let i=t.join(":");return r.length>0&&(i+=`(${r.join(",")})`),i}function y(e){return e.map(t=>({id:t.id,desc:R(t)}))}function $(e=""){var s;const t=b(),o=M(t,e),n=y(o);return{url:window.location.href,title:document.title,elements:n,selectedText:((s=window.getSelection())==null?void 0:s.toString())||void 0}}function D(e){let t=b();if(e.region&&(t=t.filter(o=>{const n=o.rect;switch(e.region){case"header":return n.y<150;case"footer":return n.y>window.innerHeight-200;case"sidebar":return n.x<250||n.x>window.innerWidth-250;case"below_viewport":return n.y>window.innerHeight;case"form":const s=document.querySelectorAll("form");return Array.from(s).some(r=>{const i=r.getBoundingClientRect();return n.x>=i.left&&n.x<=i.right&&n.y>=i.top&&n.y<=i.bottom});default:return!0}})),e.elementType&&e.elementType!=="all"&&(t=t.filter(o=>{switch(e.elementType){case"input":return o.tag==="input"||o.tag==="textarea";case"button":return o.tag==="button"||o.tag==="input"&&(o.type==="submit"||o.type==="button");case"link":return o.tag==="a";case"select":return o.tag==="select";default:return!0}})),e.keyword){const o=e.keyword.toLowerCase();t=t.filter(n=>[n.text,n.placeholder,n.label,n.ariaLabel,n.name].filter(Boolean).join(" ").toLowerCase().includes(o))}return y(t)}function H(e){return new Promise(t=>setTimeout(t,e))}function h(e,t){e.focus(),e.value="",e.dispatchEvent(new Event("focus",{bubbles:!0})),e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))}function g(e){e.focus(),e.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))}async function B(e,t){if(!t)return{success:!1,message:"未提供填充值",error:"NO_VALUE"};const o=e.elementId?d(e.elementId):null;if(!o){if(e.selector){const n=document.querySelector(e.selector);if(n&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"))return h(n,t),{success:!0,message:`已填充: ${t}`}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return o.tagName!=="INPUT"&&o.tagName!=="TEXTAREA"?o.getAttribute("contenteditable")==="true"?(o.focus(),o.textContent=t,o.dispatchEvent(new Event("input",{bubbles:!0})),{success:!0,message:`已填充: ${t}`}):{success:!1,message:"目标元素不是输入框",error:"INVALID_ELEMENT"}:(h(o,t),{success:!0,message:`已填充: ${t}`})}async function G(e){var o;const t=e.elementId?d(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n)return g(n),{success:!0,message:"已点击元素"}}return{success:!1,message:"未找到目标元素",error:"ELEMENT_NOT_FOUND"}}return g(t),{success:!0,message:`已点击: ${e.description||((o=t.textContent)==null?void 0:o.trim())||"元素"}`}}async function W(e,t){const o=t||"#ffeb3b",n=window.getSelection();if(n&&n.rangeCount>0&&!n.isCollapsed){const r=n.getRangeAt(0),i=document.createElement("span");i.className="ai-highlight",i.style.backgroundColor=o,i.style.padding="2px 0",i.style.borderRadius="2px";try{return r.surroundContents(i),n.removeAllRanges(),{success:!0,message:"已高亮选中文字"}}catch{return{success:!1,message:"无法高亮跨元素的选中内容",error:"CROSS_ELEMENT"}}}const s=e.elementId?d(e.elementId):null;return s?(s.style.backgroundColor=o,s.classList.add("ai-highlight"),{success:!0,message:"已高亮元素"}):{success:!1,message:"未找到要高亮的内容",error:"NO_TARGET"}}async function q(e){const t=window.getSelection();if(t&&t.rangeCount>0&&!t.isCollapsed){const n=t.getRangeAt(0),s=document.createElement("span");s.className="ai-underline",s.style.textDecoration="underline",s.style.textDecorationColor="#1a73e8",s.style.textDecorationThickness="2px";try{return n.surroundContents(s),t.removeAllRanges(),{success:!0,message:"已添加下划线"}}catch{return{success:!1,message:"无法为跨元素的选中内容添加下划线",error:"CROSS_ELEMENT"}}}const o=e.elementId?d(e.elementId):null;return o?(o.style.textDecoration="underline",o.style.textDecorationColor="#1a73e8",o.classList.add("ai-underline"),{success:!0,message:"已添加下划线"}):{success:!1,message:"未找到要添加下划线的内容",error:"NO_TARGET"}}async function V(e,t){if(!t)return{success:!1,message:"未提供选择值",error:"NO_VALUE"};const o=e.elementId?d(e.elementId):null;if(!o||o.tagName!=="SELECT"){if(e.selector){const n=document.querySelector(e.selector);if(n&&n.tagName==="SELECT")return w(n,t)}return{success:!1,message:"未找到下拉框元素",error:"ELEMENT_NOT_FOUND"}}return w(o,t)}function w(e,t){const o=Array.from(e.options).find(s=>s.value===t);if(o)return e.value=o.value,e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已选择: ${o.text}`};const n=Array.from(e.options).find(s=>s.text.toLowerCase().includes(t.toLowerCase()));return n?(e.value=n.value,e.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:`已选择: ${n.text}`}):{success:!1,message:`未找到匹配的选项: ${t}`,error:"OPTION_NOT_FOUND"}}async function z(e){const t=e.elementId?d(e.elementId):null;if(!t){if(e.selector){const n=document.querySelector(e.selector);if(n&&n.type==="checkbox")return n.checked=!n.checked,n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:n.checked?"已勾选":"已取消勾选"}}return{success:!1,message:"未找到复选框元素",error:"ELEMENT_NOT_FOUND"}}if(t.tagName!=="INPUT"||t.type!=="checkbox")return{success:!1,message:"目标元素不是复选框",error:"INVALID_ELEMENT"};const o=t;return o.checked=!o.checked,o.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0,message:o.checked?"已勾选":"已取消勾选"}}async function X(e){const t=window.innerHeight*.8;switch(e){case"up":return window.scrollBy({top:-t,behavior:"smooth"}),{success:!0,message:"已向上滚动"};case"down":return window.scrollBy({top:t,behavior:"smooth"}),{success:!0,message:"已向下滚动"};case"top":return window.scrollTo({top:0,behavior:"smooth"}),{success:!0,message:"已滚动到顶部"};case"bottom":return window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}),{success:!0,message:"已滚动到底部"};default:return window.scrollBy({top:t,behavior:"smooth"}),{success:!0,message:"已向下滚动"}}}async function j(e){var n,s;const t=e.elementId?d(e.elementId):null;if(!t){if(e.selector){const i=document.querySelector(e.selector);if(i)return{success:!0,message:"已读取内容",data:((n=i.textContent)==null?void 0:n.trim())||""}}const r=window.getSelection();return r&&!r.isCollapsed?{success:!0,message:"已读取选中内容",data:r.toString()}:{success:!1,message:"未找到要读取的内容",error:"NO_TARGET"}}return{success:!0,message:"已读取内容",data:((s=t.textContent)==null?void 0:s.trim())||""}}async function T(e){var t,o,n,s;try{switch(e.action){case"fill":return await B(e.target,(t=e.params)==null?void 0:t.value);case"click":return await G(e.target);case"highlight":return await W(e.target,(o=e.params)==null?void 0:o.color);case"underline":return await q(e.target);case"select":return await V(e.target,(n=e.params)==null?void 0:n.value);case"check":return await z(e.target);case"scroll":return await X((s=e.params)==null?void 0:s.direction);case"read":return await j(e.target);default:return{success:!1,message:`不支持的操作类型: ${e.action}`,error:"UNSUPPORTED_ACTION"}}}catch(r){return{success:!1,message:`执行操作时出错: ${r}`,error:"EXECUTION_ERROR"}}}async function K(e){const t=[];let o=0;for(const s of e){const r=await T(s);t.push(r),r.success&&o++,await H(100)}const n=`执行了 ${e.length} 个操作，成功 ${o} 个，失败 ${e.length-o} 个`;return{success:o===e.length,results:t,summary:n}}function Q(){document.querySelectorAll(".ai-highlight").forEach(e=>{const t=e.parentNode;t&&(t.replaceChild(document.createTextNode(e.textContent||""),e),t.normalize())}),document.querySelectorAll(".ai-underline").forEach(e=>{const t=e.parentNode;t&&(t.replaceChild(document.createTextNode(e.textContent||""),e),t.normalize())})}let c=null,a=null,m=null,l=!1,u=null;function x(){return{url:window.location.href,title:document.title}}function f(e){const t=x(),o=chrome.runtime.getURL(`chat.html?sessionId=${e}&pageUrl=${encodeURIComponent(t.url)}&pageTitle=${encodeURIComponent(t.title)}`);if(c){c.src=o,setTimeout(()=>{c!=null&&c.contentWindow&&c.contentWindow.postMessage({type:"PAGE_INFO",url:t.url,title:t.title},"*")},500);return}a=document.createElement("div"),a.id="ai-chat-container",a.style.cssText=`
    position: fixed;
    width: 400px;
    height: 100vh;
    right: 0;
    top: 0;
    z-index: 2147483647;
    background: white;
    border-left: 1px solid #e5e7eb;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  `,c=document.createElement("iframe"),c.src=o,c.style.cssText=`
    width: 100%;
    height: 100%;
    border: none;
  `,a.appendChild(c),document.body.appendChild(a),u=document.createElement("style"),u.id="ai-chat-layout-style",u.textContent=`
    /* 核心：缩小 html 宽度，让页面内容自然收缩 */
    html {
      width: calc(100% - 400px) !important;
      min-width: auto !important;
      overflow-x: hidden !important;
      position: relative !important;
    }

    /* 确保 body 跟随 html 宽度 */
    body {
      width: 100% !important;
      min-width: auto !important;
      max-width: 100% !important;
      overflow-x: hidden !important;
      position: relative !important;
    }

    /* 确保聊天容器不受影响，固定在视口右侧 */
    #ai-chat-container {
      position: fixed !important;
      right: 0 !important;
      top: 0 !important;
      width: 400px !important;
      height: 100vh !important;
      margin: 0 !important;
      padding: 0 !important;
      box-sizing: border-box !important;
    }
  `,document.head.appendChild(u);const n=new ResizeObserver(()=>{a&&(a.style.height=`${window.innerHeight}px`)});n.observe(document.documentElement),a.__resizeObserver=n,window.addEventListener("message",F),l&&chrome.storage.local.set({chatPinned:!0,chatSessionId:e})}let E=window.location.href;const Y=new MutationObserver(()=>{if(window.location.href!==E&&(E=window.location.href,c!=null&&c.contentWindow)){const e=x();c.contentWindow.postMessage({type:"PAGE_INFO",url:e.url,title:e.title},"*")}});Y.observe(document.body,{childList:!0,subtree:!0});function F(e){e.source===(c==null?void 0:c.contentWindow)&&(console.log("Received message from chat:",e.data),e.data.type==="CLOSE_CHAT"?C():e.data.type==="PIN_CHAT"&&(console.log("Handling PIN_CHAT"),J()))}function J(){l=!l,console.log("togglePin called, new isPinned:",l),l?(chrome.storage.local.set({chatPinned:!0,chatSessionId:m},()=>{console.log("Saved pin state to storage")}),c!=null&&c.contentWindow&&(c.contentWindow.postMessage({type:"PIN_STATUS_CHANGED",isPinned:!0},"*"),console.log("Sent PIN_STATUS_CHANGED: true to chat"))):(chrome.storage.local.remove(["chatPinned","chatSessionId"],()=>{console.log("Removed pin state from storage")}),c!=null&&c.contentWindow&&(c.contentWindow.postMessage({type:"PIN_STATUS_CHANGED",isPinned:!1},"*"),console.log("Sent PIN_STATUS_CHANGED: false to chat")))}function C(){if(a){const e=a.__resizeObserver;e&&e.disconnect(),a.remove(),a=null,c=null,u&&(u.remove(),u=null),l||chrome.storage.local.remove(["chatPinned","chatSessionId"])}}chrome.storage.local.get(["chatPinned","chatSessionId"],e=>{e.chatPinned&&e.chatSessionId&&(l=!0,m=e.chatSessionId,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{f(e.chatSessionId)}):f(e.chatSessionId))});chrome.runtime.onMessage.addListener((e,t,o)=>{var n,s;if(e.type==="OPEN_CHAT")m=e.sessionId,a?c.src=chrome.runtime.getURL(`chat.html?sessionId=${e.sessionId}`):f(e.sessionId),o({success:!0});else if(e.type==="CLOSE_CHAT")C(),o({success:!0});else if(e.type==="CHECK_CHAT_STATUS")o({isOpen:!!a,isPinned:l,sessionId:m});else if(e.type==="GET_PAGE_CONTEXT"){const r=((n=e.payload)==null?void 0:n.userMessage)||"",i=$(r);o({success:!0,data:i})}else if(e.type==="REQUEST_MORE_ELEMENTS"){const r=e.payload||{},i=D(r);o({success:!0,data:i})}else if(e.type==="EXECUTE_PAGE_ACTION"){const r=e.payload;return T(r).then(i=>{o({success:i.success,data:i})}),!0}else if(e.type==="EXECUTE_BATCH_ACTIONS"){const r=e.payload;return K(r).then(i=>{o({success:i.success,data:i})}),!0}else if(e.type==="CLEAR_AI_STYLES")Q(),o({success:!0});else if(e.type==="GET_SELECTED_TEXT"){const r=((s=window.getSelection())==null?void 0:s.toString())||"";o({success:!0,data:r})}return!0});

})()