import{d as ae,f as le,m as b,o as l,c as i,b as t,t as m,g as u,n as T,F as S,r as z,h as $,v as F,w as D,p as ie,l as r,q as H,s as re,_ as de,e as ce}from"./chunks/_plugin-vue_export-helper-C6Ao9Pha.js";const ue={class:"chat-wrapper"},pe={class:"chat-container"},ve={class:"chat-header"},ge={class:"header-left"},ke={class:"header-title"},me={key:0,class:"model-badge"},we={class:"header-right"},he={key:0,class:"empty-state"},ye={key:0,class:"message-box user-box"},fe={key:1,class:"assistant-content"},xe={key:0,class:"message-box assistant-box"},_e={class:"block-content"},Ce={key:1,class:"tool-block"},be={class:"tool-header"},Ae={class:"tool-name"},Me={key:0,class:"tool-badge approved"},Ie={key:1,class:"tool-badge rejected"},Te={class:"tool-params"},Se={key:0,class:"tool-actions"},Be=["onClick"],Ee=["onClick"],Le={key:1,class:"message assistant"},je={class:"chat-input-area"},ze={key:0,class:"agent-selected-indicator"},De={key:0,class:"agent-dropdown-menu"},He={class:"agent-dropdown-header"},Ne={class:"agent-dropdown-list"},Pe={key:0,class:"agent-dropdown-loading"},Ve={key:1,class:"agent-dropdown-empty"},Ue=["onClick"],Re={class:"agent-dropdown-info"},Ge={class:"agent-dropdown-name"},$e={key:0,class:"recommended-tag"},Fe={class:"agent-dropdown-desc"},Oe={key:0,class:"agent-check"},Ke=["onKeydown"],qe=["disabled"],Je=ae({__name:"App",setup(Xe){const A=r(),N=r(),w=r(""),v=r(!1),d=r([]),g=r(1),y=r(!1),O=H(()=>{if(d.value.length===0)return!1;const s=d.value[d.value.length-1];return s.role!=="assistant"?!1:s.blocks.some(e=>e.type==="tool_use"&&e.status==="pending")}),h=r([]),p=r(null),k=r(!1),f=r(""),B=r(!1),x=r(null),M=r(""),E=r(""),_=r("gpt-3.5-turbo"),L=r(""),C=r(!1),P=H(()=>window.self!==window.top),V=H(()=>{if(!f.value)return h.value;const s=f.value.toLowerCase();return h.value.filter(e=>{var o;return e.name.toLowerCase().includes(s)||e.description.toLowerCase().includes(s)||((o=e.tags)==null?void 0:o.some(a=>a.toLowerCase().includes(s)))})}),K=()=>{d.value=[{id:1,sessionId:1,role:"user",blocks:[{type:"text",text:"帮我搜索一下当前页面的标题"}],createdAt:Date.now()},{id:2,sessionId:1,role:"assistant",blocks:[{type:"text",text:"好的，我需要调用工具来获取页面信息。"},{type:"tool_use",id:"tool_001",name:"get_page_info",input:{action:"get_title",url:"https://example.com"},status:"pending"}],createdAt:Date.now(),isComplete:!1}]};le(async()=>{K();const s=new URLSearchParams(window.location.search),e=s.get("sessionId");e&&(g.value=parseInt(e));const o=s.get("pageUrl"),a=s.get("pageTitle");o&&(M.value=decodeURIComponent(o)),a&&(E.value=decodeURIComponent(a)),await U(),await q(),b(()=>{var n;(n=N.value)==null||n.focus()}),window.addEventListener("message",n=>{n.data.type==="PIN_STATUS_CHANGED"&&(y.value=n.data.isPinned),n.data.type==="PAGE_INFO"&&(M.value=n.data.url,E.value=n.data.title,U())}),document.addEventListener("click",n=>{n.target.closest(".agent-selector")||(k.value=!1)})});const U=async()=>{B.value=!0;try{const s=await chrome.runtime.sendMessage({type:"GET_AGENTS",payload:{url:M.value}});if(s.success&&s.data){if(h.value=s.data.agents||[],x.value=s.data.recommended||null,x.value&&!p.value){const e=h.value.find(o=>o.id===x.value);e&&(p.value=e)}!p.value&&h.value.length>0&&(p.value=h.value[0])}}catch(s){console.error("加载 Agent 列表失败:",s)}finally{B.value=!1}},q=async()=>{try{const s=await chrome.runtime.sendMessage({type:"GET_SETTING",payload:{key:"model"}});s!=null&&s.success&&s.data?_.value=s.data:_.value="gpt-3.5-turbo"}catch(s){console.error("加载模型设置失败:",s),_.value="gpt-3.5-turbo"}},J=()=>{k.value=!k.value,k.value&&(f.value="")},Q=s=>{p.value=s,k.value=!1},W=s=>s.blocks.filter(o=>o.type==="text").map(o=>o.text).join(""),X=s=>JSON.stringify(s,null,2),R=async()=>{if(!w.value.trim()||v.value||C.value||O.value)return;const s=w.value.trim();w.value="";const e={sessionId:g.value,role:"user",blocks:[{type:"text",text:s}],createdAt:Date.now()};d.value.push(e),b(I),p.value?await Y(s):await Z(s)},Y=async s=>{C.value=!0,L.value="";const e={sessionId:g.value,role:"assistant",blocks:[{type:"text",text:""}],createdAt:Date.now()};d.value.push(e);const o=d.value.length-1;try{const a=chrome.runtime.connect({name:"chat-stream"});a.onMessage.addListener(n=>{if(n.type==="content"){L.value+=n.content;const c=d.value[o].blocks.find(j=>j.type==="text");c&&c.type==="text"&&(c.text=L.value),b(I)}else if(n.type==="done")C.value=!1,a.disconnect();else if(n.type==="error"){console.error("流式响应错误:",n.error);const c=d.value[o].blocks.find(j=>j.type==="text");c&&c.type==="text"&&(c.text=`错误: ${n.error}`),C.value=!1,a.disconnect()}}),a.postMessage({agentId:p.value.id,sessionId:g.value,message:s,context:{url:M.value,title:E.value}})}catch(a){console.error("发送流式消息失败:",a);const n=d.value[o].blocks.find(c=>c.type==="text");n&&n.type==="text"&&(n.text=`发送失败: ${a}`),C.value=!1}},Z=async s=>{v.value=!0;try{const e=await chrome.runtime.sendMessage({type:"SEND_MESSAGE",payload:{sessionId:g.value,content:s}});if(e.success){const o={sessionId:g.value,role:"assistant",blocks:e.blocks||[{type:"text",text:e.response}],createdAt:Date.now(),isComplete:e.isComplete!==!1};d.value.push(o),b(I)}}catch(e){console.error("发送消息失败:",e)}finally{v.value=!1}},G=async(s,e)=>{const o=d.value[d.value.length-1];if(o&&o.role==="assistant"){const n=o.blocks.find(c=>c.type==="tool_use"&&c.id===s);n&&(n.status=e?"approved":"rejected")}v.value=!0,await new Promise(n=>setTimeout(n,500));const a={id:3,sessionId:g.value,role:"assistant",blocks:[{type:"text",text:e?"页面标题是：Example Domain。任务已完成！":"好的，已取消获取页面信息的操作。"}],createdAt:Date.now(),isComplete:!0};d.value.push(a),b(I),v.value=!1},I=()=>{A.value&&(A.value.scrollTop=A.value.scrollHeight)},ee=()=>{console.log("togglePin clicked, current isPinned:",y.value),window.parent&&window.parent!==window?(console.log("Sending PIN_CHAT message to parent"),window.parent.postMessage({type:"PIN_CHAT"},"*"),y.value=!y.value):console.log("Not in iframe, cannot pin")},te=()=>{window.parent&&window.parent!==window?window.parent.postMessage({type:"CLOSE_CHAT"},"*"):window.close()},se=()=>{const s=chrome.runtime.getURL(`chat.html?sessionId=${g.value}`);chrome.tabs.create({url:s}),window.parent&&window.parent.postMessage({type:"CLOSE_CHAT"},"*")},oe=()=>{chrome.tabs.create({url:"https://github.com/anthropics/claude-code/issues"})},ne=()=>{const s=chrome.runtime.getURL("options.html");chrome.tabs.create({url:s})};return(s,e)=>(l(),i("div",ue,[t("div",pe,[t("div",ve,[t("div",ge,[e[4]||(e[4]=t("div",{class:"logo-icon"},[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})])],-1)),t("div",ke,[e[3]||(e[3]=t("h3",null,"AI Chat Assistant",-1)),_.value?(l(),i("span",me,m(_.value),1)):u("",!0)])]),t("div",we,[t("button",{class:"icon-btn",onClick:oe,title:"帮助文档"},[...e[5]||(e[5]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("circle",{cx:"12",cy:"12",r:"10","stroke-width":"2"}),t("path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),t("line",{x1:"12",y1:"17",x2:"12.01",y2:"17","stroke-width":"2","stroke-linecap":"round"})],-1)])]),t("button",{class:"icon-btn",onClick:ne,title:"设置"},[...e[6]||(e[6]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("circle",{cx:"12",cy:"12",r:"3","stroke-width":"2"}),t("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])]),P.value?(l(),i("button",{key:0,class:T(["icon-btn",{active:y.value}]),onClick:ee,title:"固定窗口"},[...e[7]||(e[7]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M16 4v8l3 3-2 2-3-3-4 4-2-2 4-4-3-3 2-2 3 3V4h2z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],2)):u("",!0),P.value?(l(),i("button",{key:1,class:"icon-btn",onClick:se,title:"全屏打开"},[...e[8]||(e[8]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):u("",!0),t("button",{class:"icon-btn",onClick:te,title:"关闭"},[...e[9]||(e[9]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"18",y1:"6",x2:"6",y2:"18","stroke-width":"2","stroke-linecap":"round"}),t("line",{x1:"6",y1:"6",x2:"18",y2:"18","stroke-width":"2","stroke-linecap":"round"})],-1)])])])]),t("div",{class:"chat-messages",ref_key:"messagesContainer",ref:A},[d.value.length===0?(l(),i("div",he,[...e[10]||(e[10]=[t("p",null,"开始对话吧",-1)])])):u("",!0),(l(!0),i(S,null,z(d.value,o=>(l(),i("div",{key:o.id||o.createdAt,class:T(["message",o.role])},[o.role==="user"?(l(),i("div",ye,m(W(o)),1)):(l(),i("div",fe,[(l(!0),i(S,null,z(o.blocks,(a,n)=>(l(),i(S,{key:n},[a.type==="text"?(l(),i("div",xe,[e[11]||(e[11]=t("span",{class:"block-indicator text-indicator"},"▶",-1)),t("span",_e,m(a.text),1)])):a.type==="tool_use"?(l(),i("div",Ce,[t("div",be,[e[12]||(e[12]=t("span",{class:"block-indicator tool-indicator"},"⚙",-1)),t("span",Ae,m(a.name),1),a.status==="approved"?(l(),i("span",Me,"已批准")):a.status==="rejected"?(l(),i("span",Ie,"已拒绝")):u("",!0)]),t("pre",Te,m(X(a.input)),1),a.status==="pending"&&!v.value?(l(),i("div",Se,[t("button",{class:"btn btn-approve",onClick:c=>G(a.id,!0)},"Approve",8,Be),t("button",{class:"btn btn-reject",onClick:c=>G(a.id,!1)},"Reject",8,Ee)])):u("",!0)])):u("",!0)],64))),128))]))],2))),128)),v.value?(l(),i("div",Le,[...e[13]||(e[13]=[t("div",{class:"assistant-content"},[t("div",{class:"message-box assistant-box typing"},[t("span"),t("span"),t("span")])],-1)])])):u("",!0)],512),t("div",je,[t("div",{class:"agent-selector",onClick:J},[t("div",{class:T(["agent-selector-btn",{active:k.value}])},[e[14]||(e[14]=t("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"})],-1)),p.value?(l(),i("span",ze)):u("",!0)],2),k.value?(l(),i("div",De,[t("div",He,[$(t("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=o=>f.value=o),placeholder:"搜索 Agent...",onClick:e[1]||(e[1]=D(()=>{},["stop"]))},null,512),[[F,f.value]])]),t("div",Ne,[B.value?(l(),i("div",Pe,[...e[15]||(e[15]=[t("div",{class:"loading-spinner"},null,-1),t("span",null,"加载中...",-1)])])):V.value.length===0?(l(),i("div",Ve," 暂无可用 Agent ")):(l(!0),i(S,{key:2},z(V.value,o=>{var a,n;return l(),i("div",{key:o.id,class:T(["agent-dropdown-item",{selected:((a=p.value)==null?void 0:a.id)===o.id,recommended:o.id===x.value}]),onClick:D(c=>Q(o),["stop"])},[e[17]||(e[17]=t("div",{class:"agent-dropdown-avatar"},[t("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"})])],-1)),t("div",Re,[t("div",Ge,[re(m(o.name)+" ",1),o.id===x.value?(l(),i("span",$e,"推荐")):u("",!0)]),t("div",Fe,m(o.description),1)]),((n=p.value)==null?void 0:n.id)===o.id?(l(),i("div",Oe,[...e[16]||(e[16]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("polyline",{points:"20 6 9 17 4 12","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):u("",!0)],10,Ue)}),128))])])):u("",!0)]),$(t("textarea",{"onUpdate:modelValue":e[2]||(e[2]=o=>w.value=o),onKeydown:ie(D(R,["exact","prevent"]),["enter"]),placeholder:"输入消息... (Enter发送)",rows:"1",ref_key:"inputArea",ref:N},null,40,Ke),[[F,w.value]]),t("button",{class:"send-btn",onClick:R,disabled:!w.value.trim()||v.value},[...e[18]||(e[18]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"22",y1:"2",x2:"11",y2:"13","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),t("polygon",{points:"22 2 15 22 11 13 2 9 22 2","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],8,qe)])])]))}}),Qe=de(Je,[["__scopeId","data-v-4cdd203f"]]),We=ce(Qe);We.mount("#app");
