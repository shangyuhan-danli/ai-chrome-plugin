import{d as ae,f as le,m as f,o as l,c as r,b as t,t as y,g as u,n as S,F as T,r as j,h as O,v as $,w as z,p as re,l as d,q as H,s as ie,_ as de,e as ce}from"./chunks/_plugin-vue_export-helper-C6Ao9Pha.js";const ue={class:"chat-wrapper"},ve={class:"chat-container"},pe={class:"chat-header"},ge={class:"header-left"},ke={class:"header-title"},ye={key:0,class:"model-badge"},he={class:"header-right"},we={key:0,class:"empty-state"},me={key:0,class:"message-box user-box"},fe={key:1,class:"assistant-content"},_e={key:0,class:"message-box assistant-box"},xe={class:"block-content"},Ce={key:1,class:"tool-block"},be={class:"tool-header"},Me={class:"tool-name"},Ae={key:0,class:"tool-badge approved"},Ie={key:1,class:"tool-badge rejected"},Se={class:"tool-params"},Te={key:0,class:"tool-actions"},Be=["onClick"],Ee=["onClick"],Le={key:1,class:"message assistant"},Ne={class:"chat-input-area"},je={key:0,class:"agent-selected-indicator"},ze={key:0,class:"agent-dropdown-menu"},He={class:"agent-dropdown-header"},Pe={class:"agent-dropdown-list"},Ve={key:0,class:"agent-dropdown-loading"},Ue={key:1,class:"agent-dropdown-empty"},De=["onClick"],Re={class:"agent-dropdown-info"},Ge={class:"agent-dropdown-name"},Oe={key:0,class:"recommended-tag"},$e={class:"agent-dropdown-desc"},Fe={key:0,class:"agent-check"},Ke=["onKeydown"],qe=["disabled"],Je=ae({__name:"App",setup(Xe){const A=d(),P=d(),h=d(""),g=d(!1),c=d([]),p=d(1),_=d(!1),F=H(()=>{if(c.value.length===0)return!1;const s=c.value[c.value.length-1];return s.role!=="assistant"?!1:s.blocks.some(e=>e.type==="tool_use"&&e.status==="pending")}),w=d([]),v=d(null),k=d(!1),x=d(""),B=d(!1),C=d(null),I=d(""),E=d(""),m=d("gpt-3.5-turbo"),L=d(""),b=d(!1),V=H(()=>window.self!==window.top),U=H(()=>{if(!x.value)return w.value;const s=x.value.toLowerCase();return w.value.filter(e=>{var o;return e.name.toLowerCase().includes(s)||e.description.toLowerCase().includes(s)||((o=e.tags)==null?void 0:o.some(a=>a.toLowerCase().includes(s)))})});le(async()=>{const s=new URLSearchParams(window.location.search),e=s.get("sessionId");e&&(p.value=parseInt(e));const o=s.get("pageUrl"),a=s.get("pageTitle");o&&(I.value=decodeURIComponent(o)),a&&(E.value=decodeURIComponent(a)),await Q(),await D(),await K(),f(()=>{var n;(n=P.value)==null||n.focus()}),window.addEventListener("message",n=>{n.data.type==="PIN_STATUS_CHANGED"&&(_.value=n.data.isPinned),n.data.type==="PAGE_INFO"&&(I.value=n.data.url,E.value=n.data.title,D())}),document.addEventListener("click",n=>{n.target.closest(".agent-selector")||(k.value=!1)})});const D=async()=>{B.value=!0;try{const s=await chrome.runtime.sendMessage({type:"GET_AGENTS",payload:{url:I.value}});if(s.success&&s.data){if(w.value=s.data.agents||[],C.value=s.data.recommended||null,C.value&&!v.value){const e=w.value.find(o=>o.id===C.value);e&&(v.value=e)}!v.value&&w.value.length>0&&(v.value=w.value[0])}}catch(s){console.error("加载 Agent 列表失败:",s)}finally{B.value=!1}},K=async()=>{try{const s=await chrome.runtime.sendMessage({type:"GET_SETTING",payload:{key:"model"}});s!=null&&s.success&&s.data?m.value=s.data:m.value="gpt-3.5-turbo"}catch(s){console.error("加载模型设置失败:",s),m.value="gpt-3.5-turbo"}},q=()=>{k.value=!k.value,k.value&&(x.value="")},J=s=>{v.value=s,k.value=!1},Q=async()=>{const s=await chrome.runtime.sendMessage({type:"GET_MESSAGES",payload:{sessionId:p.value}});s.success&&(c.value=s.data.map(e=>({...e,blocks:e.blocks||[{type:"text",text:e.content}]})),f(M))},W=s=>s.blocks.filter(o=>o.type==="text").map(o=>o.text).join(""),X=s=>JSON.stringify(s,null,2),R=async()=>{if(!h.value.trim()||g.value||b.value||F.value)return;const s=h.value.trim();h.value="";const e={sessionId:p.value,role:"user",blocks:[{type:"text",text:s}],createdAt:Date.now()};c.value.push(e),f(M),v.value?await Y(s):await Z(s)},Y=async s=>{b.value=!0,L.value="";const e={sessionId:p.value,role:"assistant",blocks:[{type:"text",text:""}],createdAt:Date.now()};c.value.push(e);const o=c.value.length-1;try{const a=chrome.runtime.connect({name:"chat-stream"});a.onMessage.addListener(n=>{if(n.type==="content"){L.value+=n.content;const i=c.value[o].blocks.find(N=>N.type==="text");i&&i.type==="text"&&(i.text=L.value),f(M)}else if(n.type==="done")b.value=!1,a.disconnect();else if(n.type==="error"){console.error("流式响应错误:",n.error);const i=c.value[o].blocks.find(N=>N.type==="text");i&&i.type==="text"&&(i.text=`错误: ${n.error}`),b.value=!1,a.disconnect()}}),a.postMessage({agentId:v.value.id,sessionId:p.value,message:s,context:{url:I.value,title:E.value}})}catch(a){console.error("发送流式消息失败:",a);const n=c.value[o].blocks.find(i=>i.type==="text");n&&n.type==="text"&&(n.text=`发送失败: ${a}`),b.value=!1}},Z=async s=>{g.value=!0;try{const e=await chrome.runtime.sendMessage({type:"SEND_MESSAGE",payload:{sessionId:p.value,content:s}});if(e.success){const o={sessionId:p.value,role:"assistant",blocks:e.blocks||[{type:"text",text:e.response}],createdAt:Date.now(),isComplete:e.isComplete!==!1};c.value.push(o),f(M)}}catch(e){console.error("发送消息失败:",e)}finally{g.value=!1}},G=async(s,e)=>{var a;const o=c.value[c.value.length-1];if(o&&o.role==="assistant"){const n=o.blocks.find(i=>i.type==="tool_use"&&i.id===s);n&&(n.status=e?"approved":"rejected")}g.value=!0;try{const n=await chrome.runtime.sendMessage({type:"TOOL_RESPONSE",payload:{sessionId:p.value,toolResponse:{toolId:s,approved:e},agentId:(a=v.value)==null?void 0:a.id,model:m.value,userId:"default_user"}});if(n.success&&n.blocks){const i={sessionId:p.value,role:"assistant",blocks:n.blocks,createdAt:Date.now(),isComplete:n.isComplete};c.value.push(i),f(M)}}catch(n){console.error("处理工具响应失败:",n)}finally{g.value=!1}},M=()=>{A.value&&(A.value.scrollTop=A.value.scrollHeight)},ee=()=>{console.log("togglePin clicked, current isPinned:",_.value),window.parent&&window.parent!==window?(console.log("Sending PIN_CHAT message to parent"),window.parent.postMessage({type:"PIN_CHAT"},"*"),_.value=!_.value):console.log("Not in iframe, cannot pin")},te=()=>{window.parent&&window.parent!==window?window.parent.postMessage({type:"CLOSE_CHAT"},"*"):window.close()},se=()=>{const s=chrome.runtime.getURL(`chat.html?sessionId=${p.value}`);chrome.tabs.create({url:s}),window.parent&&window.parent.postMessage({type:"CLOSE_CHAT"},"*")},oe=()=>{chrome.tabs.create({url:"https://github.com/anthropics/claude-code/issues"})},ne=()=>{const s=chrome.runtime.getURL("options.html");chrome.tabs.create({url:s})};return(s,e)=>(l(),r("div",ue,[t("div",ve,[t("div",pe,[t("div",ge,[e[4]||(e[4]=t("div",{class:"logo-icon"},[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})])],-1)),t("div",ke,[e[3]||(e[3]=t("h3",null,"AI Chat Assistant",-1)),m.value?(l(),r("span",ye,y(m.value),1)):u("",!0)])]),t("div",he,[t("button",{class:"icon-btn",onClick:oe,title:"帮助文档"},[...e[5]||(e[5]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("circle",{cx:"12",cy:"12",r:"10","stroke-width":"2"}),t("path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),t("line",{x1:"12",y1:"17",x2:"12.01",y2:"17","stroke-width":"2","stroke-linecap":"round"})],-1)])]),t("button",{class:"icon-btn",onClick:ne,title:"设置"},[...e[6]||(e[6]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("circle",{cx:"12",cy:"12",r:"3","stroke-width":"2"}),t("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])]),V.value?(l(),r("button",{key:0,class:S(["icon-btn",{active:_.value}]),onClick:ee,title:"固定窗口"},[...e[7]||(e[7]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M16 4v8l3 3-2 2-3-3-4 4-2-2 4-4-3-3 2-2 3 3V4h2z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],2)):u("",!0),V.value?(l(),r("button",{key:1,class:"icon-btn",onClick:se,title:"全屏打开"},[...e[8]||(e[8]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):u("",!0),t("button",{class:"icon-btn",onClick:te,title:"关闭"},[...e[9]||(e[9]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"18",y1:"6",x2:"6",y2:"18","stroke-width":"2","stroke-linecap":"round"}),t("line",{x1:"6",y1:"6",x2:"18",y2:"18","stroke-width":"2","stroke-linecap":"round"})],-1)])])])]),t("div",{class:"chat-messages",ref_key:"messagesContainer",ref:A},[c.value.length===0?(l(),r("div",we,[...e[10]||(e[10]=[t("p",null,"开始对话吧",-1)])])):u("",!0),(l(!0),r(T,null,j(c.value,o=>(l(),r("div",{key:o.id||o.createdAt,class:S(["message",o.role])},[o.role==="user"?(l(),r("div",me,y(W(o)),1)):(l(),r("div",fe,[(l(!0),r(T,null,j(o.blocks,(a,n)=>(l(),r(T,{key:n},[a.type==="text"?(l(),r("div",_e,[e[11]||(e[11]=t("span",{class:"block-indicator text-indicator"},"▶",-1)),t("span",xe,y(a.text),1)])):a.type==="tool_use"?(l(),r("div",Ce,[t("div",be,[e[12]||(e[12]=t("span",{class:"block-indicator tool-indicator"},"⚙",-1)),t("span",Me,y(a.name),1),a.status==="approved"?(l(),r("span",Ae,"已批准")):a.status==="rejected"?(l(),r("span",Ie,"已拒绝")):u("",!0)]),t("pre",Se,y(X(a.input)),1),a.status==="pending"&&!g.value?(l(),r("div",Te,[t("button",{class:"btn btn-approve",onClick:i=>G(a.id,!0)},"Approve",8,Be),t("button",{class:"btn btn-reject",onClick:i=>G(a.id,!1)},"Reject",8,Ee)])):u("",!0)])):u("",!0)],64))),128))]))],2))),128)),g.value?(l(),r("div",Le,[...e[13]||(e[13]=[t("div",{class:"assistant-content"},[t("div",{class:"message-box assistant-box typing"},[t("span"),t("span"),t("span")])],-1)])])):u("",!0)],512),t("div",Ne,[t("div",{class:"agent-selector",onClick:q},[t("div",{class:S(["agent-selector-btn",{active:k.value}])},[e[14]||(e[14]=t("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"})],-1)),v.value?(l(),r("span",je)):u("",!0)],2),k.value?(l(),r("div",ze,[t("div",He,[O(t("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=o=>x.value=o),placeholder:"搜索 Agent...",onClick:e[1]||(e[1]=z(()=>{},["stop"]))},null,512),[[$,x.value]])]),t("div",Pe,[B.value?(l(),r("div",Ve,[...e[15]||(e[15]=[t("div",{class:"loading-spinner"},null,-1),t("span",null,"加载中...",-1)])])):U.value.length===0?(l(),r("div",Ue," 暂无可用 Agent ")):(l(!0),r(T,{key:2},j(U.value,o=>{var a,n;return l(),r("div",{key:o.id,class:S(["agent-dropdown-item",{selected:((a=v.value)==null?void 0:a.id)===o.id,recommended:o.id===C.value}]),onClick:z(i=>J(o),["stop"])},[e[17]||(e[17]=t("div",{class:"agent-dropdown-avatar"},[t("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"})])],-1)),t("div",Re,[t("div",Ge,[ie(y(o.name)+" ",1),o.id===C.value?(l(),r("span",Oe,"推荐")):u("",!0)]),t("div",$e,y(o.description),1)]),((n=v.value)==null?void 0:n.id)===o.id?(l(),r("div",Fe,[...e[16]||(e[16]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("polyline",{points:"20 6 9 17 4 12","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):u("",!0)],10,De)}),128))])])):u("",!0)]),O(t("textarea",{"onUpdate:modelValue":e[2]||(e[2]=o=>h.value=o),onKeydown:re(z(R,["exact","prevent"]),["enter"]),placeholder:"输入消息... (Enter发送)",rows:"1",ref_key:"inputArea",ref:P},null,40,Ke),[[$,h.value]]),t("button",{class:"send-btn",onClick:R,disabled:!h.value.trim()||g.value},[...e[18]||(e[18]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"22",y1:"2",x2:"11",y2:"13","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),t("polygon",{points:"22 2 15 22 11 13 2 9 22 2","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],8,qe)])])]))}}),Qe=de(Je,[["__scopeId","data-v-be70d90e"]]),We=ce(Qe);We.mount("#app");
