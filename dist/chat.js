var Ue=Object.defineProperty;var ze=($,d,x)=>d in $?Ue($,d,{enumerable:!0,configurable:!0,writable:!0,value:x}):$[d]=x;var ie=($,d,x)=>ze($,typeof d!="symbol"?d+"":d,x);import{d as He,f as Je,m as S,o as c,c as u,b as t,t as M,g as C,w as U,n as L,p as ce,F as O,r as W,q as ue,h as de,v as pe,s as Ve,l as f,u as G,_ as Ge,e as qe}from"./chunks/_plugin-vue_export-helper-ByXR5g9Y.js";class Fe{constructor(){ie(this,"tools",new Map);this.registerBuiltinTools()}registerBuiltinTools(){this.register({name:"page_action",description:"åœ¨ç”¨æˆ·å½“å‰æµè§ˆçš„ç½‘é¡µä¸Šæ‰§è¡Œæ“ä½œï¼Œå¦‚å¡«å……è¾“å…¥æ¡†ã€ç‚¹å‡»æŒ‰é’®ã€é«˜äº®æ–‡å­—ç­‰ã€‚å¯ä»¥æ‰¹é‡æ‰§è¡Œå¤šä¸ªæ“ä½œã€‚",parameters:{type:"object",properties:{actions:{type:"array",description:"è¦æ‰§è¡Œçš„æ“ä½œåˆ—è¡¨",items:{type:"object",properties:{action:{type:"string",enum:["fill","click","highlight","underline","select","check","scroll","read"],description:"æ“ä½œç±»å‹: fill(å¡«å……è¾“å…¥æ¡†), click(ç‚¹å‡»), highlight(é«˜äº®), underline(ä¸‹åˆ’çº¿), select(é€‰æ‹©ä¸‹æ‹‰), check(å‹¾é€‰), scroll(æ»šåŠ¨), read(è¯»å–å†…å®¹)"},target:{type:"object",description:"ç›®æ ‡å…ƒç´ ",properties:{elementId:{type:"string",description:"å…ƒç´ ID (ä»é¡µé¢ä¸Šä¸‹æ–‡è·å–)"},selector:{type:"string",description:"CSSé€‰æ‹©å™¨ (å¤‡ç”¨)"},description:{type:"string",description:"å…ƒç´ æè¿° (ç”¨äºç¡®è®¤)"}}},params:{type:"object",description:"æ“ä½œå‚æ•°",properties:{value:{type:"string",description:"å¡«å……çš„å€¼æˆ–é€‰æ‹©çš„é€‰é¡¹"},color:{type:"string",description:"é«˜äº®é¢œè‰² (å¦‚ #ffeb3b)"},direction:{type:"string",enum:["up","down","top","bottom"],description:"æ»šåŠ¨æ–¹å‘"}}}},required:["action","target"]}}},required:["actions"]},execute:async(d,x)=>{const k=d.actions||[d],w=await chrome.tabs.sendMessage(x,{type:"EXECUTE_BATCH_ACTIONS",payload:k});return(w==null?void 0:w.data)||{success:!1,error:"æ‰§è¡Œå¤±è´¥"}}}),this.register({name:"request_more_elements",description:"å½“å‰é¡µé¢å…ƒç´ ä¿¡æ¯ä¸è¶³ä»¥å®Œæˆç”¨æˆ·è¯·æ±‚æ—¶ï¼Œè¯·æ±‚ç‰¹å®šåŒºåŸŸæˆ–ç±»å‹çš„æ›´å¤šå…ƒç´ ã€‚",parameters:{type:"object",properties:{region:{type:"string",enum:["form","header","sidebar","footer","below_viewport"],description:"é¡µé¢åŒºåŸŸ: form(è¡¨å•åŒºåŸŸ), header(é¡µå¤´), sidebar(ä¾§è¾¹æ ), footer(é¡µè„š), below_viewport(è§†å£ä¸‹æ–¹)"},elementType:{type:"string",enum:["input","button","link","select","all"],description:"å…ƒç´ ç±»å‹: input(è¾“å…¥æ¡†), button(æŒ‰é’®), link(é“¾æ¥), select(ä¸‹æ‹‰æ¡†), all(æ‰€æœ‰)"},keyword:{type:"string",description:"å…³é”®è¯ç­›é€‰ï¼ŒåŒ¹é…å…ƒç´ çš„æ–‡æœ¬ã€placeholderã€labelç­‰"}}},execute:async(d,x)=>{const k=await chrome.tabs.sendMessage(x,{type:"REQUEST_MORE_ELEMENTS",payload:d});return{success:!0,elements:(k==null?void 0:k.data)||[]}}}),this.register({name:"get_selected_text",description:"è·å–ç”¨æˆ·åœ¨é¡µé¢ä¸Šé€‰ä¸­çš„æ–‡å­—ï¼Œç”¨äºå¯¹é€‰ä¸­å†…å®¹è¿›è¡Œæ“ä½œã€‚",parameters:{type:"object",properties:{}},execute:async(d,x)=>{const k=await chrome.tabs.sendMessage(x,{type:"GET_SELECTED_TEXT"});return{success:!0,text:(k==null?void 0:k.data)||""}}}),this.register({name:"clear_ai_styles",description:"æ¸…é™¤ AI åœ¨é¡µé¢ä¸Šæ·»åŠ çš„æ‰€æœ‰é«˜äº®å’Œä¸‹åˆ’çº¿æ ·å¼ï¼Œæ¢å¤é¡µé¢åŸå§‹çŠ¶æ€ã€‚",parameters:{type:"object",properties:{}},execute:async(d,x)=>{const k=await chrome.tabs.sendMessage(x,{type:"CLEAR_AI_STYLES"});return{success:(k==null?void 0:k.success)||!1}}})}register(d){this.tools.set(d.name,d)}unregister(d){this.tools.delete(d)}isBrowserTool(d){return this.tools.has(d)}getToolNames(){return Array.from(this.tools.keys())}getToolDefinitions(){return Array.from(this.tools.values()).map(d=>({name:d.name,description:d.description,parameters:d.parameters}))}async execute(d,x){const k=this.tools.get(d);if(!k)return JSON.stringify({success:!1,error:`æœªçŸ¥çš„æµè§ˆå™¨å·¥å…·: ${d}`});try{const[w]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(w!=null&&w.id))return JSON.stringify({success:!1,error:"æ— æ³•è·å–å½“å‰æ ‡ç­¾é¡µ"});let a;try{a=JSON.parse(x)}catch{return JSON.stringify({success:!1,error:"æ— æ•ˆçš„å‚æ•°æ ¼å¼"})}const h=await k.execute(a,w.id);return JSON.stringify(h)}catch(w){return console.error(`æ‰§è¡Œå·¥å…· ${d} å¤±è´¥:`,w),JSON.stringify({success:!1,error:String(w)})}}}const z=new Fe,Ke={class:"chat-wrapper"},We={class:"chat-container"},Xe={class:"chat-header"},Qe={class:"header-left"},Ye={class:"header-title"},Ze={class:"header-badges"},et=["title"],tt={key:1,class:"model-badge"},st={class:"header-right"},ot={key:0,class:"session-dropdown-menu"},nt={class:"session-dropdown-header"},at={class:"session-dropdown-list"},lt={key:0,class:"session-dropdown-loading"},rt={key:1,class:"session-dropdown-empty"},it=["onClick"],ct={class:"session-dropdown-info"},ut={class:"session-dropdown-title"},dt={class:"session-dropdown-meta"},pt={key:0,class:"session-url"},vt={class:"session-time"},gt={key:0,class:"session-check"},kt={key:0,class:"empty-state"},ft={class:"message-box user-box"},yt={class:"message-time"},ht={class:"assistant-content"},mt={key:0,class:"think-block"},wt={class:"think-content"},_t={key:0,class:"message-box assistant-box"},xt={class:"block-content"},bt={key:1,class:"tool-block"},Ct={class:"tool-header"},Tt={class:"tool-name"},St={key:0,class:"tool-badge approved"},Mt={key:1,class:"tool-badge rejected"},At={class:"tool-params-container"},It=["innerHTML"],Bt={key:0,class:"tool-actions"},Nt=["onClick"],Et=["onClick"],$t={class:"message-time"},jt={key:1,class:"message assistant"},Dt={key:0,class:"token-stats-bar"},Lt={class:"token-stats-content"},Ot={class:"token-stats-left"},Pt={class:"token-value"},Rt={class:"token-stats-detail"},Ut={class:"token-item"},zt={class:"token-item-value prompt"},Ht={class:"token-item"},Jt={class:"token-item-value completion"},Vt={class:"token-progress-bar"},Gt={class:"chat-input-area"},qt={key:0,class:"agent-selected-indicator"},Ft={key:0,class:"agent-dropdown-menu"},Kt={class:"agent-dropdown-header"},Wt={class:"agent-dropdown-list"},Xt={key:0,class:"agent-dropdown-loading"},Qt={key:1,class:"agent-dropdown-empty"},Yt=["onClick"],Zt={class:"agent-dropdown-info"},es={class:"agent-dropdown-name"},ts={key:0,class:"recommended-tag"},ss={class:"agent-dropdown-desc"},os={key:0,class:"agent-check"},ns=["onKeydown"],as=["disabled"],ls=He({__name:"App",setup($){const d=f(),x=f(),k=f(""),w=f(!1),a=f([]),h=f(1),P=f(!1),ve=G(()=>{if(a.value.length===0)return!1;const o=a.value[a.value.length-1];return o.role!=="assistant"?!1:o.blocks.some(e=>e.type==="tool_use"&&e.status==="pending")}),R=f([]),T=f(null),j=f(!1),H=f(""),X=f(!1),J=f(null),q=f(""),F=f(""),Q=f([]),D=f(!1),Y=f(!1),I=f({total:0,prompt:0,completion:0}),ge=G(()=>I.value.total===0?0:I.value.prompt/I.value.total*100),ke=G(()=>I.value.total===0?0:I.value.completion/I.value.total*100),Z=o=>o>=1e6?(o/1e6).toFixed(1)+"M":o>=1e3?(o/1e3).toFixed(1)+"K":o.toString(),E=f("gpt-3.5-turbo"),y=f(""),b=f(!1),fe=f(null),ee=G(()=>window.self!==window.top),te=G(()=>{if(!H.value)return R.value;const o=H.value.toLowerCase();return R.value.filter(e=>{var s;return e.name.toLowerCase().includes(o)||e.description.toLowerCase().includes(o)||((s=e.tags)==null?void 0:s.some(n=>n.toLowerCase().includes(o)))})});Je(async()=>{const o=new URLSearchParams(window.location.search),e=o.get("sessionId");e&&(h.value=parseInt(e));const s=o.get("pageUrl"),n=o.get("pageTitle");s&&(q.value=decodeURIComponent(s)),n&&(F.value=decodeURIComponent(n)),await oe(),await se(),await ye(),S(()=>{var i;(i=x.value)==null||i.focus()}),window.addEventListener("message",i=>{i.data.type==="PIN_STATUS_CHANGED"&&(P.value=i.data.isPinned),i.data.type==="PAGE_INFO"&&(q.value=i.data.url,F.value=i.data.title,se())}),document.addEventListener("click",i=>{const r=i.target;r.closest(".agent-selector")||(j.value=!1),r.closest(".session-selector")||(D.value=!1)})});const se=async()=>{X.value=!0;try{const o=await chrome.runtime.sendMessage({type:"GET_AGENTS",payload:{userId:"default_user"}});if(o.success&&o.data){if(R.value=o.data.agents||[],J.value=o.data.recommended||null,J.value&&!T.value){const e=R.value.find(s=>s.id===J.value);e&&(T.value=e)}!T.value&&R.value.length>0&&(T.value=R.value[0])}}catch(o){console.error("åŠ è½½ Agent åˆ—è¡¨å¤±è´¥:",o)}finally{X.value=!1}},ye=async()=>{try{const o=await chrome.runtime.sendMessage({type:"GET_SETTING",payload:{key:"model"}});o!=null&&o.success&&o.data?E.value=o.data:E.value="gpt-3.5-turbo"}catch(o){console.error("åŠ è½½æ¨¡å‹è®¾ç½®å¤±è´¥:",o),E.value="gpt-3.5-turbo"}},he=()=>{j.value=!j.value,j.value&&(H.value="")},me=o=>{T.value=o,j.value=!1},we=async()=>{D.value=!D.value,D.value&&await _e()},_e=async()=>{Y.value=!0;try{const o=await chrome.runtime.sendMessage({type:"GET_SESSIONS"});o.success&&(Q.value=(o.data||[]).sort((e,s)=>s.updatedAt-e.updatedAt))}catch(o){console.error("åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:",o)}finally{Y.value=!1}},xe=async o=>{h.value=o.id,D.value=!1,o.pageUrl&&(q.value=o.pageUrl),o.pageTitle&&(F.value=o.pageTitle),await oe()},be=o=>{try{return new URL(o).hostname}catch{return o}},Ce=o=>{const s=Date.now()-o,n=Math.floor(s/6e4),i=Math.floor(s/36e5),r=Math.floor(s/864e5);return n<1?"åˆšåˆš":n<60?`${n}åˆ†é’Ÿå‰`:i<24?`${i}å°æ—¶å‰`:r<7?`${r}å¤©å‰`:new Date(o).toLocaleDateString("zh-CN")},oe=async()=>{const o=await chrome.runtime.sendMessage({type:"GET_MESSAGES",payload:{sessionId:h.value}});o.success&&(a.value=o.data.map(e=>({...e,blocks:e.blocks||[{type:"text",text:e.content}]})),S(B))},Te=o=>o.blocks.filter(s=>s.type==="text").map(s=>s.text).join(""),Se=o=>JSON.stringify(o,null,2).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?)/g,s=>{let n="json-string";return/:$/.test(s)?(n="json-key",s=s.replace(/:$/,""),`<span class="${n}">${s}</span>:`):`<span class="${n}">${s}</span>`}).replace(/\b(true|false)\b/g,'<span class="json-boolean">$1</span>').replace(/\b(null)\b/g,'<span class="json-null">$1</span>').replace(/\b(-?\d+\.?\d*)\b/g,'<span class="json-number">$1</span>'),Me=o=>{const e=o.currentTarget,s=e.parentElement,n=s==null?void 0:s.querySelector(".tool-params"),i=e.querySelector(".collapse-icon");n&&i&&(n.classList.toggle("collapsed"),i.classList.toggle("rotated"))},K=async(o="")=>{if(!ee.value)return null;try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id))return null;const s=await chrome.tabs.sendMessage(e.id,{type:"GET_PAGE_CONTEXT",payload:{userMessage:o}});if(s!=null&&s.success)return fe.value=s.data,s.data}catch(e){console.error("è·å–é¡µé¢ä¸Šä¸‹æ–‡å¤±è´¥:",e)}return null},Ae=async(o,e)=>await z.execute(o,e),Ie=async(o,e,s)=>{var N;const n={sessionId:h.value,role:"user",blocks:[{type:"text",text:`[å·¥å…· ${o} æ‰§è¡Œç»“æœ]: ${s}`}],createdAt:Date.now()};a.value.push(n),S(B),b.value=!0,y.value="";const i={sessionId:h.value,role:"assistant",blocks:[{type:"text",text:""}],createdAt:Date.now()};a.value.push(i);const r=a.value.length-1;let A="",m=null;try{const g=await K(),v=chrome.runtime.connect({name:"chat-stream"});v.onMessage.addListener(async l=>{if(l.type==="data"){const p=l.data;if(p.content){y.value+=p.content;const _=a.value[r].blocks.find(V=>V.type==="text");_&&_.type==="text"&&(_.text=y.value),S(B)}if(p.think&&p.think.reasoning_content&&(A=p.think.reasoning_content),p.toolCall&&p.toolCall.tool_name)try{m={type:"tool_use",id:`tool_${Date.now()}`,name:p.toolCall.tool_name,input:JSON.parse(p.toolCall.arguments||"{}"),status:"pending"}}catch(_){console.error("è§£æå·¥å…·å‚æ•°å¤±è´¥:",_)}p.statistic&&p.statistic.token_usage&&(I.value={total:p.statistic.token_usage.total_tokens||0,prompt:p.statistic.token_usage.prompt_tokens||0,completion:p.statistic.token_usage.completion_tokens||0})}else if(l.type==="done")b.value=!1,a.value[r].blocks=[],A&&(a.value[r].think=A),m?(a.value[r].blocks.push(m),a.value[r].isComplete=!1):(y.value&&a.value[r].blocks.push({type:"text",text:y.value}),a.value[r].isComplete=!0),v.disconnect(),S(B);else if(l.type==="error"){console.error("æµå¼å“åº”é”™è¯¯:",l.error);const p=a.value[r].blocks.find(_=>_.type==="text");p&&p.type==="text"&&(p.text=`é”™è¯¯: ${l.error}`),b.value=!1,v.disconnect()}}),v.postMessage({agentId:((N=T.value)==null?void 0:N.id)||"",sessionId:h.value,message:`æµè§ˆå™¨å·¥å…· ${o} æ‰§è¡Œç»“æœ: ${e}`,model:E.value,userId:"default_user",role:"user",currentPageInfo:g,browserTools:z.getToolDefinitions()})}catch(g){console.error("å‘é€å·¥å…·ç»“æœå¤±è´¥:",g),b.value=!1}},ne=async()=>{if(!k.value.trim()||w.value||b.value||ve.value)return;const o=k.value.trim();k.value="";const e={sessionId:h.value,role:"user",blocks:[{type:"text",text:o}],createdAt:Date.now()};a.value.push(e),S(B),T.value&&T.value.id?await Be(o):await Ne(o)},Be=async o=>{b.value=!0,y.value="";const e={sessionId:h.value,role:"assistant",blocks:[{type:"text",text:""}],createdAt:Date.now()};a.value.push(e);const s=a.value.length-1;let n="",i=null;try{const r=chrome.runtime.connect({name:"chat-stream"});r.onMessage.addListener(N=>{if(console.log("[Chat Stream] æ”¶åˆ°æ¶ˆæ¯:",N),N.type==="data"){const g=N.data;if(console.log("[Chat Stream] data å†…å®¹:",g),g.content){y.value+=g.content;const v=a.value[s].blocks.find(l=>l.type==="text");v&&v.type==="text"&&(v.text=y.value),S(B)}if(g.think&&g.think.reasoning_content&&(n=g.think.reasoning_content),g.toolCall&&g.toolCall.tool_name)try{i={type:"tool_use",id:`tool_${Date.now()}`,name:g.toolCall.tool_name,input:JSON.parse(g.toolCall.arguments||"{}"),status:"pending"}}catch(v){console.error("è§£æå·¥å…·å‚æ•°å¤±è´¥:",v)}g.statistic&&g.statistic.token_usage&&(I.value={total:g.statistic.token_usage.total_tokens||0,prompt:g.statistic.token_usage.prompt_tokens||0,completion:g.statistic.token_usage.completion_tokens||0})}else if(N.type==="done")console.log("[Chat Stream] æµå¼ä¼ è¾“å®Œæˆ"),b.value=!1,a.value[s].blocks=[],n&&(a.value[s].think=n),i?(a.value[s].blocks.push(i),a.value[s].isComplete=!1):(!n&&y.value&&a.value[s].blocks.push({type:"text",text:y.value}),a.value[s].isComplete=!0),r.disconnect(),S(B);else if(N.type==="error"){console.error("æµå¼å“åº”é”™è¯¯:",N.error);const g=a.value[s].blocks.find(v=>v.type==="text");g&&g.type==="text"&&(g.text=`é”™è¯¯: ${N.error}`),b.value=!1,r.disconnect()}});const A=await K(o),m=z.getToolDefinitions();r.postMessage({agentId:T.value.id,sessionId:h.value,message:o,model:E.value,userId:"default_user",role:"user",currentPageInfo:A,browserTools:m})}catch(r){console.error("å‘é€æµå¼æ¶ˆæ¯å¤±è´¥:",r);const A=a.value[s].blocks.find(m=>m.type==="text");A&&A.type==="text"&&(A.text=`å‘é€å¤±è´¥: ${r}`),b.value=!1}},Ne=async o=>{w.value=!0;try{const e=await chrome.runtime.sendMessage({type:"SEND_MESSAGE",payload:{sessionId:h.value,content:o}});if(e.success){const s={sessionId:h.value,role:"assistant",blocks:e.blocks||[{type:"text",text:e.response}],createdAt:Date.now(),isComplete:e.isComplete!==!1};a.value.push(s),S(B)}}catch(e){console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",e)}finally{w.value=!1}},ae=async(o,e)=>{const s=a.value[a.value.length-1];let n;s&&s.role==="assistant"&&(n=s.blocks.find(i=>i.type==="tool_use"&&i.id===o),n&&(n.status=e?"approved":"rejected")),e&&(n&&z.isBrowserTool(n.name)?await Ee(n):await $e(o))},Ee=async o=>{const e=await Ae(o.name,JSON.stringify(o.input));let s="";try{const n=JSON.parse(e);s=n.summary||n.message||(n.success?"æ‰§è¡ŒæˆåŠŸ":"æ‰§è¡Œå¤±è´¥")}catch{s=e}await Ie(o.name,e,s)},$e=async o=>{var A;b.value=!0,y.value="";const e={sessionId:h.value,role:"assistant",blocks:[{type:"text",text:""}],createdAt:Date.now()};a.value.push(e);const s=a.value.length-1;let n="",i=null,r="";try{const m=chrome.runtime.connect({name:"chat-stream"});m.onMessage.addListener(async v=>{if(console.log("[NonBrowserTool] æ”¶åˆ°æ¶ˆæ¯:",v),v.type==="data"){const l=v.data;if(console.log("[NonBrowserTool] data å†…å®¹:",JSON.stringify(l)),(l.role==="function"||l.content&&!l.think&&!l.toolCall&&!l.statistic)&&l.content){r+=l.content,console.log("[NonBrowserTool] æ”¶é›†å·¥å…·æ‰§è¡Œç»“æœ:",r);const _=a.value[s].blocks.find(V=>V.type==="text");_&&_.type==="text"&&(_.text=`[å·¥å…·æ‰§è¡Œä¸­...] ${r.substring(0,100)}...`),S(B);return}if(l.content){y.value+=l.content;const _=a.value[s].blocks.find(V=>V.type==="text");_&&_.type==="text"&&(_.text=y.value),S(B)}if(l.think&&l.think.reasoning_content&&(n+=l.think.reasoning_content),l.toolCall&&l.toolCall.tool_name)try{i={type:"tool_use",id:`tool_${Date.now()}`,name:l.toolCall.tool_name,input:JSON.parse(l.toolCall.arguments||"{}"),status:"pending"}}catch(_){console.error("è§£æå·¥å…·å‚æ•°å¤±è´¥:",_)}l.statistic&&l.statistic.token_usage&&(I.value={total:l.statistic.token_usage.total_tokens||0,prompt:l.statistic.token_usage.prompt_tokens||0,completion:l.statistic.token_usage.completion_tokens||0})}else if(v.type==="done"){if(console.log("[NonBrowserTool] æµå¼ä¼ è¾“å®Œæˆ"),console.log("[NonBrowserTool] toolResultContent:",r),console.log("[NonBrowserTool] streamingContent:",y.value),m.disconnect(),r){console.log("[NonBrowserTool] æ£€æµ‹åˆ°å·¥å…·ç»“æœï¼Œç»§ç»­å‘é€è¯·æ±‚..."),a.value[s].blocks=[{type:"text",text:`[å·¥å…·æ‰§è¡Œç»“æœ]: ${r.substring(0,200)}${r.length>200?"...":""}`}],a.value[s].isComplete=!0,S(B),await je(o,r);return}b.value=!1,a.value[s].blocks=[],n&&(a.value[s].think=n),i?(a.value[s].blocks.push(i),a.value[s].isComplete=!1):(!n&&y.value&&a.value[s].blocks.push({type:"text",text:y.value}),a.value[s].isComplete=!0),S(B)}else if(v.type==="error"){console.error("æµå¼å“åº”é”™è¯¯:",v.error);const l=a.value[s].blocks.find(p=>p.type==="text");l&&l.type==="text"&&(l.text=`é”™è¯¯: ${v.error}`),b.value=!1,m.disconnect()}});const N=await K(),g=z.getToolDefinitions();m.postMessage({agentId:((A=T.value)==null?void 0:A.id)||"",sessionId:h.value,message:JSON.stringify({toolId:o,approved:!0}),model:E.value,userId:"default_user",role:"function",currentPageInfo:N,browserTools:g})}catch(m){console.error("å¤„ç†å·¥å…·å“åº”å¤±è´¥:",m),b.value=!1}},je=async(o,e)=>{var A;y.value="";const s={sessionId:h.value,role:"assistant",blocks:[{type:"text",text:""}],createdAt:Date.now()};a.value.push(s);const n=a.value.length-1;let i="",r=null;try{const m=chrome.runtime.connect({name:"chat-stream"});m.onMessage.addListener(v=>{if(console.log("[SendToolResult] æ”¶åˆ°æ¶ˆæ¯:",v),v.type==="data"){const l=v.data;if(console.log("[SendToolResult] data å†…å®¹:",l),l.content){y.value+=l.content;const p=a.value[n].blocks.find(_=>_.type==="text");p&&p.type==="text"&&(p.text=y.value),S(B)}if(l.think&&l.think.reasoning_content&&(i+=l.think.reasoning_content),l.toolCall&&l.toolCall.tool_name)try{r={type:"tool_use",id:`tool_${Date.now()}`,name:l.toolCall.tool_name,input:JSON.parse(l.toolCall.arguments||"{}"),status:"pending"}}catch(p){console.error("è§£æå·¥å…·å‚æ•°å¤±è´¥:",p)}l.statistic&&l.statistic.token_usage&&(I.value={total:l.statistic.token_usage.total_tokens||0,prompt:l.statistic.token_usage.prompt_tokens||0,completion:l.statistic.token_usage.completion_tokens||0})}else if(v.type==="done")console.log("[SendToolResult] æµå¼ä¼ è¾“å®Œæˆ"),b.value=!1,a.value[n].blocks=[],i&&(a.value[n].think=i),r?(a.value[n].blocks.push(r),a.value[n].isComplete=!1):(!i&&y.value&&a.value[n].blocks.push({type:"text",text:y.value}),a.value[n].isComplete=!0),m.disconnect(),S(B);else if(v.type==="error"){console.error("æµå¼å“åº”é”™è¯¯:",v.error);const l=a.value[n].blocks.find(p=>p.type==="text");l&&l.type==="text"&&(l.text=`é”™è¯¯: ${v.error}`),b.value=!1,m.disconnect()}});const N=await K(),g=z.getToolDefinitions();m.postMessage({agentId:((A=T.value)==null?void 0:A.id)||"",sessionId:h.value,message:"",model:E.value,userId:"default_user",role:"user",currentPageInfo:N,browserTools:g})}catch(m){console.error("å‘é€å·¥å…·ç»“æœå¤±è´¥:",m),b.value=!1}},B=()=>{d.value&&(d.value.scrollTop=d.value.scrollHeight)},le=o=>new Date(o).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),De=()=>{console.log("togglePin clicked, current isPinned:",P.value),window.parent&&window.parent!==window?(console.log("Sending PIN_CHAT message to parent"),window.parent.postMessage({type:"PIN_CHAT"},"*"),P.value=!P.value):console.log("Not in iframe, cannot pin")},Le=()=>{window.parent&&window.parent!==window?window.parent.postMessage({type:"CLOSE_CHAT"},"*"):window.close()},Oe=()=>{const o=chrome.runtime.getURL(`chat.html?sessionId=${h.value}`);chrome.tabs.create({url:o}),window.parent&&window.parent.postMessage({type:"CLOSE_CHAT"},"*")},Pe=()=>{chrome.tabs.create({url:"https://github.com/anthropics/claude-code/issues"})},Re=()=>{const o=chrome.runtime.getURL("options.html");chrome.tabs.create({url:o})},re=async()=>{try{const o=q.value,e=F.value||"æ–°å¯¹è¯",s=await chrome.runtime.sendMessage({type:"CREATE_SESSION",payload:{title:e,pageUrl:o,pageTitle:e}});s.success&&(h.value=s.data.id,a.value=[],y.value="",b.value=!1,w.value=!1,S(()=>{var n;(n=x.value)==null||n.focus()}))}catch(o){console.error("åˆ›å»ºæ–°ä¼šè¯å¤±è´¥:",o)}};return(o,e)=>(c(),u("div",Ke,[t("div",We,[t("div",Xe,[t("div",Qe,[e[5]||(e[5]=t("div",{class:"logo-icon"},[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})])],-1)),t("div",Ye,[e[4]||(e[4]=t("h3",null,"AI Chat Assistant",-1)),t("div",Ze,[T.value?(c(),u("span",{key:0,class:"agent-badge",title:T.value.name},M(T.value.name),9,et)):C("",!0),E.value?(c(),u("span",tt,M(E.value),1)):C("",!0)])])]),t("div",st,[t("div",{class:"session-selector",onClick:U(we,["stop"])},[t("button",{class:L(["icon-btn",{active:D.value}]),title:"åˆ‡æ¢ä¼šè¯"},[...e[6]||(e[6]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],2),D.value?(c(),u("div",ot,[t("div",nt,[e[8]||(e[8]=t("span",null,"å†å²ä¼šè¯",-1)),t("button",{class:"session-new-btn",onClick:U(re,["stop"])},[...e[7]||(e[7]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"12",y1:"5",x2:"12",y2:"19","stroke-width":"2","stroke-linecap":"round"}),t("line",{x1:"5",y1:"12",x2:"19",y2:"12","stroke-width":"2","stroke-linecap":"round"})],-1),ce(" æ–°å»º ",-1)])])]),t("div",at,[Y.value?(c(),u("div",lt,[...e[9]||(e[9]=[t("div",{class:"loading-spinner"},null,-1),t("span",null,"åŠ è½½ä¸­...",-1)])])):Q.value.length===0?(c(),u("div",rt," æš‚æ— å†å²ä¼šè¯ ")):(c(!0),u(O,{key:2},W(Q.value,s=>(c(),u("div",{key:s.id,class:L(["session-dropdown-item",{selected:h.value===s.id}]),onClick:U(n=>xe(s),["stop"])},[t("div",ct,[t("div",ut,M(s.title||s.pageTitle||"æœªå‘½åä¼šè¯"),1),t("div",dt,[s.pageUrl?(c(),u("span",pt,M(be(s.pageUrl)),1)):C("",!0),t("span",vt,M(Ce(s.updatedAt)),1)])]),h.value===s.id?(c(),u("div",gt,[...e[10]||(e[10]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("polyline",{points:"20 6 9 17 4 12","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):C("",!0)],10,it))),128))])])):C("",!0)]),t("button",{class:"icon-btn",onClick:re,title:"æ–°å»ºä¼šè¯"},[...e[11]||(e[11]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"12",y1:"5",x2:"12",y2:"19","stroke-width":"2","stroke-linecap":"round"}),t("line",{x1:"5",y1:"12",x2:"19",y2:"12","stroke-width":"2","stroke-linecap":"round"})],-1)])]),t("button",{class:"icon-btn",onClick:Pe,title:"å¸®åŠ©æ–‡æ¡£"},[...e[12]||(e[12]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("circle",{cx:"12",cy:"12",r:"10","stroke-width":"2"}),t("path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),t("line",{x1:"12",y1:"17",x2:"12.01",y2:"17","stroke-width":"2","stroke-linecap":"round"})],-1)])]),t("button",{class:"icon-btn",onClick:Re,title:"è®¾ç½®"},[...e[13]||(e[13]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("circle",{cx:"12",cy:"12",r:"3","stroke-width":"2"}),t("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])]),ee.value?(c(),u("button",{key:0,class:L(["icon-btn",{active:P.value}]),onClick:De,title:"å›ºå®šçª—å£"},[...e[14]||(e[14]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M16 4v8l3 3-2 2-3-3-4 4-2-2 4-4-3-3 2-2 3 3V4h2z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],2)):C("",!0),ee.value?(c(),u("button",{key:1,class:"icon-btn",onClick:Oe,title:"å…¨å±æ‰“å¼€"},[...e[15]||(e[15]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):C("",!0),t("button",{class:"icon-btn",onClick:Le,title:"å…³é—­"},[...e[16]||(e[16]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"18",y1:"6",x2:"6",y2:"18","stroke-width":"2","stroke-linecap":"round"}),t("line",{x1:"6",y1:"6",x2:"18",y2:"18","stroke-width":"2","stroke-linecap":"round"})],-1)])])])]),t("div",{class:"chat-messages",ref_key:"messagesContainer",ref:d},[a.value.length===0?(c(),u("div",kt,[...e[17]||(e[17]=[t("p",null,"å¼€å§‹å¯¹è¯å§",-1)])])):C("",!0),(c(!0),u(O,null,W(a.value,s=>(c(),u("div",{key:s.id||s.createdAt,class:L(["message",s.role,"message-in"])},[s.role==="user"?(c(),u(O,{key:0},[t("div",ft,M(Te(s)),1),t("span",yt,M(le(s.createdAt)),1)],64)):(c(),u(O,{key:1},[t("div",ht,[s.think?(c(),u("div",mt,[e[18]||(e[18]=t("div",{class:"think-header"},[t("span",{class:"think-icon"},"ğŸ’­"),t("span",{class:"think-label"},"æ€è€ƒè¿‡ç¨‹")],-1)),t("div",wt,M(s.think),1)])):C("",!0),(c(!0),u(O,null,W(s.blocks,(n,i)=>(c(),u(O,{key:i},[n.type==="text"?(c(),u("div",_t,[e[19]||(e[19]=t("span",{class:"block-indicator text-indicator"},"â–¶",-1)),t("span",xt,M(n.text),1)])):n.type==="tool_use"?(c(),u("div",bt,[t("div",Ct,[e[20]||(e[20]=t("span",{class:"block-indicator tool-indicator"},"âš™",-1)),t("span",Tt,M(n.name),1),n.status==="approved"?(c(),u("span",St,"å·²æ‰¹å‡†")):n.status==="rejected"?(c(),u("span",Mt,"å·²æ‹’ç»")):C("",!0)]),t("div",At,[t("div",{class:"tool-params-header",onClick:e[0]||(e[0]=r=>Me(r))},[...e[21]||(e[21]=[t("svg",{class:"collapse-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("polyline",{points:"6 9 12 15 18 9","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1),t("span",{class:"tool-params-label"},"å‚æ•°",-1)])]),t("pre",{class:L(["tool-params",{collapsed:!1}])},[t("code",{innerHTML:Se(n.input)},null,8,It)])]),n.status==="pending"&&!w.value?(c(),u("div",Bt,[t("button",{class:"btn btn-approve",onClick:r=>ae(n.id,!0)},"Approve",8,Nt),t("button",{class:"btn btn-reject",onClick:r=>ae(n.id,!1)},"Reject",8,Et)])):C("",!0)])):C("",!0)],64))),128))]),t("span",$t,M(le(s.createdAt)),1)],64))],2))),128)),w.value?(c(),u("div",jt,[...e[22]||(e[22]=[t("div",{class:"assistant-content"},[t("div",{class:"message-box assistant-box typing"},[t("span"),t("span"),t("span")])],-1)])])):C("",!0)],512),I.value.total>0||b.value?(c(),u("div",Dt,[t("div",Lt,[t("div",Ot,[e[23]||(e[23]=t("span",{class:"token-label"},"Token æ¶ˆè€—",-1)),t("span",Pt,M(Z(I.value.total)),1)]),t("div",Rt,[t("div",Ut,[e[24]||(e[24]=t("span",{class:"token-item-label"},"è¾“å…¥",-1)),t("span",zt,M(Z(I.value.prompt)),1)]),t("div",Ht,[e[25]||(e[25]=t("span",{class:"token-item-label"},"è¾“å‡º",-1)),t("span",Jt,M(Z(I.value.completion)),1)])])]),t("div",Vt,[t("div",{class:"token-progress-prompt",style:ue({width:ge.value+"%"})},null,4),t("div",{class:"token-progress-completion",style:ue({width:ke.value+"%"})},null,4)])])):C("",!0),t("div",Gt,[t("div",{class:"agent-selector",onClick:he},[t("div",{class:L(["agent-selector-btn",{active:j.value}])},[e[26]||(e[26]=t("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"})],-1)),T.value?(c(),u("span",qt)):C("",!0)],2),j.value?(c(),u("div",Ft,[t("div",Kt,[de(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=s=>H.value=s),placeholder:"æœç´¢ Agent...",onClick:e[2]||(e[2]=U(()=>{},["stop"]))},null,512),[[pe,H.value]])]),t("div",Wt,[X.value?(c(),u("div",Xt,[...e[27]||(e[27]=[t("div",{class:"loading-spinner"},null,-1),t("span",null,"åŠ è½½ä¸­...",-1)])])):te.value.length===0?(c(),u("div",Qt," æš‚æ— å¯ç”¨ Agent ")):(c(!0),u(O,{key:2},W(te.value,s=>{var n,i;return c(),u("div",{key:s.id,class:L(["agent-dropdown-item",{selected:((n=T.value)==null?void 0:n.id)===s.id,recommended:s.id===J.value}]),onClick:U(r=>me(s),["stop"])},[e[29]||(e[29]=t("div",{class:"agent-dropdown-avatar"},[t("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"})])],-1)),t("div",Zt,[t("div",es,[ce(M(s.name)+" ",1),s.id===J.value?(c(),u("span",ts,"æ¨è")):C("",!0)]),t("div",ss,M(s.description),1)]),((i=T.value)==null?void 0:i.id)===s.id?(c(),u("div",os,[...e[28]||(e[28]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("polyline",{points:"20 6 9 17 4 12","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):C("",!0)],10,Yt)}),128))])])):C("",!0)]),de(t("textarea",{"onUpdate:modelValue":e[3]||(e[3]=s=>k.value=s),onKeydown:Ve(U(ne,["exact","prevent"]),["enter"]),placeholder:"è¾“å…¥æ¶ˆæ¯... (Enterå‘é€)",rows:"1",ref_key:"inputArea",ref:x},null,40,ns),[[pe,k.value]]),t("button",{class:"send-btn",onClick:ne,disabled:!k.value.trim()||w.value},[...e[30]||(e[30]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"22",y1:"2",x2:"11",y2:"13","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),t("polygon",{points:"22 2 15 22 11 13 2 9 22 2","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],8,as)])])]))}}),rs=Ge(ls,[["__scopeId","data-v-c30da63e"]]),is=qe(rs);is.mount("#app");
