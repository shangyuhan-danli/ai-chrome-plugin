import{d as X,f as Y,m as _,o as a,c as l,b as t,n as x,g as v,F as V,r as H,a as Z,h as D,v as U,w as B,p as ee,l as i,q as j,t as z,s as te,_ as se,e as oe}from"./chunks/_plugin-vue_export-helper-C6Ao9Pha.js";const ne={class:"chat-wrapper"},ae={class:"chat-container"},le={class:"chat-header"},ie={class:"header-right"},re={key:0,class:"empty-state"},de={class:"message-avatar"},ce={key:0,viewBox:"0 0 24 24",fill:"currentColor"},ue={key:1,viewBox:"0 0 24 24",fill:"currentColor"},ve={class:"message-content-wrapper"},pe={class:"message-content"},ge={class:"message-time"},we={key:1,class:"message assistant"},me={class:"chat-input-area"},he={key:0,class:"agent-selected-indicator"},fe={key:0,class:"agent-dropdown-menu"},ke={class:"agent-dropdown-header"},ye={class:"agent-dropdown-list"},_e={key:0,class:"agent-dropdown-loading"},Ce={key:1,class:"agent-dropdown-empty"},Ae=["onClick"],Me={class:"agent-dropdown-info"},xe={class:"agent-dropdown-name"},ze={key:0,class:"recommended-tag"},Se={class:"agent-dropdown-desc"},Ie={key:0,class:"agent-check"},Te=["onKeydown"],Be=["disabled"],Ee=X({__name:"App",setup(be){const C=i(),E=i(),g=i(""),m=i(!1),d=i([]),u=i(1),h=i(!1),w=i([]),c=i(null),p=i(!1),f=i(""),S=i(!1),k=i(null),A=i(""),I=i(""),T=i(""),y=i(!1),L=j(()=>window.self!==window.top),N=j(()=>{if(!f.value)return w.value;const s=f.value.toLowerCase();return w.value.filter(e=>{var o;return e.name.toLowerCase().includes(s)||e.description.toLowerCase().includes(s)||((o=e.tags)==null?void 0:o.some(r=>r.toLowerCase().includes(s)))})});Y(async()=>{const s=new URLSearchParams(window.location.search),e=s.get("sessionId");e&&(u.value=parseInt(e));const o=s.get("pageUrl"),r=s.get("pageTitle");o&&(A.value=decodeURIComponent(o)),r&&(I.value=decodeURIComponent(r)),await R(),await b(),_(()=>{var n;(n=E.value)==null||n.focus()}),window.addEventListener("message",n=>{n.data.type==="PIN_STATUS_CHANGED"&&(h.value=n.data.isPinned),n.data.type==="PAGE_INFO"&&(A.value=n.data.url,I.value=n.data.title,b())}),document.addEventListener("click",n=>{n.target.closest(".agent-selector")||(p.value=!1)})});const b=async()=>{S.value=!0;try{const s=await chrome.runtime.sendMessage({type:"GET_AGENTS",payload:{url:A.value}});if(s.success&&s.data){if(w.value=s.data.agents||[],k.value=s.data.recommended||null,k.value&&!c.value){const e=w.value.find(o=>o.id===k.value);e&&(c.value=e)}!c.value&&w.value.length>0&&(c.value=w.value[0])}}catch(s){console.error("加载 Agent 列表失败:",s)}finally{S.value=!1}},G=()=>{p.value=!p.value,p.value&&(f.value="")},F=s=>{c.value=s,p.value=!1},R=async()=>{const s=await chrome.runtime.sendMessage({type:"GET_MESSAGES",payload:{sessionId:u.value}});s.success&&(d.value=s.data,_(M))},P=async()=>{if(!g.value.trim()||m.value||y.value)return;const s=g.value.trim();g.value="",d.value.push({sessionId:u.value,role:"user",content:s,createdAt:Date.now()}),_(M),c.value?await $(s):await K(s)},$=async s=>{y.value=!0,T.value="";const e={sessionId:u.value,role:"assistant",content:"",createdAt:Date.now()};d.value.push(e);const o=d.value.length-1;try{const r=chrome.runtime.connect({name:"chat-stream"});r.onMessage.addListener(n=>{n.type==="content"?(T.value+=n.content,d.value[o].content=T.value,_(M)):n.type==="done"?(y.value=!1,r.disconnect()):n.type==="error"&&(console.error("流式响应错误:",n.error),d.value[o].content=`错误: ${n.error}`,y.value=!1,r.disconnect())}),r.postMessage({agentId:c.value.id,sessionId:u.value,message:s,context:{url:A.value,title:I.value}})}catch(r){console.error("发送流式消息失败:",r),d.value[o].content=`发送失败: ${r}`,y.value=!1}},K=async s=>{m.value=!0;try{const e=await chrome.runtime.sendMessage({type:"SEND_MESSAGE",payload:{sessionId:u.value,content:s}});e.success&&(d.value.push({sessionId:u.value,role:"assistant",content:e.response,createdAt:Date.now()}),_(M))}catch(e){console.error("发送消息失败:",e)}finally{m.value=!1}},M=()=>{C.value&&(C.value.scrollTop=C.value.scrollHeight)},O=s=>new Date(s).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),q=()=>{console.log("togglePin clicked, current isPinned:",h.value),window.parent&&window.parent!==window?(console.log("Sending PIN_CHAT message to parent"),window.parent.postMessage({type:"PIN_CHAT"},"*"),h.value=!h.value):console.log("Not in iframe, cannot pin")},Q=()=>{window.parent&&window.parent!==window?window.parent.postMessage({type:"CLOSE_CHAT"},"*"):window.close()},J=()=>{const s=chrome.runtime.getURL(`chat.html?sessionId=${u.value}`);chrome.tabs.create({url:s}),window.parent&&window.parent.postMessage({type:"CLOSE_CHAT"},"*")};return(s,e)=>(a(),l("div",ne,[t("div",ae,[t("div",le,[e[6]||(e[6]=t("div",{class:"header-left"},[t("div",{class:"logo-icon"},[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})])]),t("h3",null,"AI Chat Assistant")],-1)),t("div",ie,[L.value?(a(),l("button",{key:0,class:x(["icon-btn",{active:h.value}]),onClick:q,title:"固定窗口"},[...e[3]||(e[3]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M16 4v8l3 3-2 2-3-3-4 4-2-2 4-4-3-3 2-2 3 3V4h2z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],2)):v("",!0),L.value?(a(),l("button",{key:1,class:"icon-btn",onClick:J,title:"全屏打开"},[...e[4]||(e[4]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):v("",!0),t("button",{class:"icon-btn",onClick:Q,title:"关闭"},[...e[5]||(e[5]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"18",y1:"6",x2:"6",y2:"18","stroke-width":"2","stroke-linecap":"round"}),t("line",{x1:"6",y1:"6",x2:"18",y2:"18","stroke-width":"2","stroke-linecap":"round"})],-1)])])])]),t("div",{class:"chat-messages",ref_key:"messagesContainer",ref:C},[d.value.length===0?(a(),l("div",re,[...e[7]||(e[7]=[t("svg",{class:"empty-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1),t("p",null,"开始对话吧！",-1)])])):v("",!0),(a(!0),l(V,null,H(d.value,o=>(a(),l("div",{key:o.id,class:x(["message",o.role])},[t("div",de,[o.role==="user"?(a(),l("svg",ce,[...e[8]||(e[8]=[t("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"},null,-1)])])):(a(),l("svg",ue,[...e[9]||(e[9]=[t("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"},null,-1)])]))]),t("div",ve,[t("div",pe,z(o.content),1),t("div",ge,z(O(o.createdAt)),1)])],2))),128)),m.value?(a(),l("div",we,[...e[10]||(e[10]=[Z('<div class="message-avatar" data-v-4d54030a><svg viewBox="0 0 24 24" fill="currentColor" data-v-4d54030a><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" data-v-4d54030a></path></svg></div><div class="message-content-wrapper" data-v-4d54030a><div class="typing-indicator" data-v-4d54030a><span data-v-4d54030a></span><span data-v-4d54030a></span><span data-v-4d54030a></span></div></div>',2)])])):v("",!0)],512),t("div",me,[t("div",{class:"agent-selector",onClick:G},[t("div",{class:x(["agent-selector-btn",{active:p.value}])},[e[11]||(e[11]=t("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"})],-1)),c.value?(a(),l("span",he)):v("",!0)],2),p.value?(a(),l("div",fe,[t("div",ke,[D(t("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=o=>f.value=o),placeholder:"搜索 Agent...",onClick:e[1]||(e[1]=B(()=>{},["stop"]))},null,512),[[U,f.value]])]),t("div",ye,[S.value?(a(),l("div",_e,[...e[12]||(e[12]=[t("div",{class:"loading-spinner"},null,-1),t("span",null,"加载中...",-1)])])):N.value.length===0?(a(),l("div",Ce," 暂无可用 Agent ")):(a(!0),l(V,{key:2},H(N.value,o=>{var r,n;return a(),l("div",{key:o.id,class:x(["agent-dropdown-item",{selected:((r=c.value)==null?void 0:r.id)===o.id,recommended:o.id===k.value}]),onClick:B(W=>F(o),["stop"])},[e[14]||(e[14]=t("div",{class:"agent-dropdown-avatar"},[t("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"})])],-1)),t("div",Me,[t("div",xe,[te(z(o.name)+" ",1),o.id===k.value?(a(),l("span",ze,"推荐")):v("",!0)]),t("div",Se,z(o.description),1)]),((n=c.value)==null?void 0:n.id)===o.id?(a(),l("div",Ie,[...e[13]||(e[13]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("polyline",{points:"20 6 9 17 4 12","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):v("",!0)],10,Ae)}),128))])])):v("",!0)]),D(t("textarea",{"onUpdate:modelValue":e[2]||(e[2]=o=>g.value=o),onKeydown:ee(B(P,["exact","prevent"]),["enter"]),placeholder:"输入消息... (Enter发送)",rows:"1",ref_key:"inputArea",ref:E},null,40,Te),[[U,g.value]]),t("button",{class:"send-btn",onClick:P,disabled:!g.value.trim()||m.value},[...e[15]||(e[15]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"22",y1:"2",x2:"11",y2:"13","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),t("polygon",{points:"22 2 15 22 11 13 2 9 22 2","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],8,Be)])])]))}}),Le=se(Ee,[["__scopeId","data-v-4d54030a"]]),Ne=oe(Le);Ne.mount("#app");
