import{d as ie,f as re,m as y,o as i,c as r,b as t,t as h,g as v,n as T,F as B,r as L,h as O,v as $,w as j,p as ce,l as d,q as z,s as de,_ as ue,e as ve}from"./chunks/_plugin-vue_export-helper-C6Ao9Pha.js";const pe={class:"chat-wrapper"},ge={class:"chat-container"},ke={class:"chat-header"},ye={class:"header-left"},he={class:"header-title"},fe={class:"header-badges"},me=["title"],we={key:1,class:"model-badge"},_e={class:"header-right"},xe={key:0,class:"empty-state"},Ce={key:0,class:"message-box user-box"},be={key:1,class:"assistant-content"},Me={key:0,class:"message-box assistant-box"},Ae={class:"block-content"},Ie={key:1,class:"tool-block"},Se={class:"tool-header"},Te={class:"tool-name"},Be={key:0,class:"tool-badge approved"},Ee={key:1,class:"tool-badge rejected"},Ne={class:"tool-params"},Le={key:0,class:"tool-actions"},je=["onClick"],ze=["onClick"],He={key:1,class:"message assistant"},Pe={class:"chat-input-area"},Ve={key:0,class:"agent-selected-indicator"},De={key:0,class:"agent-dropdown-menu"},Ue={class:"agent-dropdown-header"},Re={class:"agent-dropdown-list"},Ge={key:0,class:"agent-dropdown-loading"},Oe={key:1,class:"agent-dropdown-empty"},$e=["onClick"],Fe={class:"agent-dropdown-info"},Ke={class:"agent-dropdown-name"},qe={key:0,class:"recommended-tag"},Je={class:"agent-dropdown-desc"},Qe={key:0,class:"agent-check"},We=["onKeydown"],Xe=["disabled"],Ye=ie({__name:"App",setup(tt){const I=d(),E=d(),w=d(""),g=d(!1),c=d([]),p=d(1),b=d(!1),F=z(()=>{if(c.value.length===0)return!1;const s=c.value[c.value.length-1];return s.role!=="assistant"?!1:s.blocks.some(e=>e.type==="tool_use"&&e.status==="pending")}),_=d([]),u=d(null),f=d(!1),M=d(""),N=d(!1),A=d(null),H=d(""),P=d(""),m=d("gpt-3.5-turbo"),S=d(""),x=d(!1),V=z(()=>window.self!==window.top),D=z(()=>{if(!M.value)return _.value;const s=M.value.toLowerCase();return _.value.filter(e=>{var o;return e.name.toLowerCase().includes(s)||e.description.toLowerCase().includes(s)||((o=e.tags)==null?void 0:o.some(a=>a.toLowerCase().includes(s)))})});re(async()=>{const s=new URLSearchParams(window.location.search),e=s.get("sessionId");e&&(p.value=parseInt(e));const o=s.get("pageUrl"),a=s.get("pageTitle");o&&(H.value=decodeURIComponent(o)),a&&(P.value=decodeURIComponent(a)),await Q(),await U(),await K(),y(()=>{var n;(n=E.value)==null||n.focus()}),window.addEventListener("message",n=>{n.data.type==="PIN_STATUS_CHANGED"&&(b.value=n.data.isPinned),n.data.type==="PAGE_INFO"&&(H.value=n.data.url,P.value=n.data.title,U())}),document.addEventListener("click",n=>{n.target.closest(".agent-selector")||(f.value=!1)})});const U=async()=>{N.value=!0;try{const s=await chrome.runtime.sendMessage({type:"GET_AGENTS",payload:{userId:"default_user"}});if(s.success&&s.data){if(_.value=s.data.agents||[],A.value=s.data.recommended||null,A.value&&!u.value){const e=_.value.find(o=>o.id===A.value);e&&(u.value=e)}!u.value&&_.value.length>0&&(u.value=_.value[0])}}catch(s){console.error("加载 Agent 列表失败:",s)}finally{N.value=!1}},K=async()=>{try{const s=await chrome.runtime.sendMessage({type:"GET_SETTING",payload:{key:"model"}});s!=null&&s.success&&s.data?m.value=s.data:m.value="gpt-3.5-turbo"}catch(s){console.error("加载模型设置失败:",s),m.value="gpt-3.5-turbo"}},q=()=>{f.value=!f.value,f.value&&(M.value="")},J=s=>{u.value=s,f.value=!1},Q=async()=>{const s=await chrome.runtime.sendMessage({type:"GET_MESSAGES",payload:{sessionId:p.value}});s.success&&(c.value=s.data.map(e=>({...e,blocks:e.blocks||[{type:"text",text:e.content}]})),y(C))},W=s=>s.blocks.filter(o=>o.type==="text").map(o=>o.text).join(""),X=s=>JSON.stringify(s,null,2),R=async()=>{if(!w.value.trim()||g.value||x.value||F.value)return;const s=w.value.trim();w.value="";const e={sessionId:p.value,role:"user",blocks:[{type:"text",text:s}],createdAt:Date.now()};c.value.push(e),y(C),u.value&&u.value.id?await Y(s):await Z(s)},Y=async s=>{x.value=!0,S.value="";const e={sessionId:p.value,role:"assistant",blocks:[{type:"text",text:""}],createdAt:Date.now()};c.value.push(e);const o=c.value.length-1;try{const a=chrome.runtime.connect({name:"chat-stream"});a.onMessage.addListener(n=>{if(n.type==="data"){const l=n.data;if(l.content){S.value+=l.content;const k=c.value[o].blocks.find(le=>le.type==="text");k&&k.type==="text"&&(k.text=S.value),y(C)}if(l.toolCall&&!l.toolCall.partial){const k={type:"tool_use",id:`tool_${Date.now()}`,name:l.toolCall.tool_name,input:JSON.parse(l.toolCall.arguments||"{}"),status:"pending"};c.value[o].blocks.push(k),c.value[o].isComplete=!1,y(C)}l.think&&!l.think.partial&&console.log("思考过程:",l.think.reasoning_content),l.statistic&&console.log("Token 使用统计:",l.statistic.token_usage)}else if(n.type==="done")x.value=!1,c.value[o].blocks.some(k=>k.type==="tool_use")||(c.value[o].isComplete=!0),a.disconnect();else if(n.type==="error"){console.error("流式响应错误:",n.error);const l=c.value[o].blocks.find(k=>k.type==="text");l&&l.type==="text"&&(l.text=`错误: ${n.error}`),x.value=!1,a.disconnect()}}),a.postMessage({agentId:u.value.id,sessionId:p.value,message:s,model:m.value,userId:"default_user",role:"user"})}catch(a){console.error("发送流式消息失败:",a);const n=c.value[o].blocks.find(l=>l.type==="text");n&&n.type==="text"&&(n.text=`发送失败: ${a}`),x.value=!1}},Z=async s=>{g.value=!0;try{const e=await chrome.runtime.sendMessage({type:"SEND_MESSAGE",payload:{sessionId:p.value,content:s}});if(e.success){const o={sessionId:p.value,role:"assistant",blocks:e.blocks||[{type:"text",text:e.response}],createdAt:Date.now(),isComplete:e.isComplete!==!1};c.value.push(o),y(C)}}catch(e){console.error("发送消息失败:",e)}finally{g.value=!1}},G=async(s,e)=>{var a;const o=c.value[c.value.length-1];if(o&&o.role==="assistant"){const n=o.blocks.find(l=>l.type==="tool_use"&&l.id===s);n&&(n.status=e?"approved":"rejected")}g.value=!0;try{const n=await chrome.runtime.sendMessage({type:"TOOL_RESPONSE",payload:{sessionId:p.value,toolResponse:{toolId:s,approved:e},agentId:(a=u.value)==null?void 0:a.id,model:m.value,userId:"default_user"}});if(n.success&&n.blocks){const l={sessionId:p.value,role:"assistant",blocks:n.blocks,createdAt:Date.now(),isComplete:n.isComplete};c.value.push(l),y(C)}}catch(n){console.error("处理工具响应失败:",n)}finally{g.value=!1}},C=()=>{I.value&&(I.value.scrollTop=I.value.scrollHeight)},ee=()=>{console.log("togglePin clicked, current isPinned:",b.value),window.parent&&window.parent!==window?(console.log("Sending PIN_CHAT message to parent"),window.parent.postMessage({type:"PIN_CHAT"},"*"),b.value=!b.value):console.log("Not in iframe, cannot pin")},te=()=>{window.parent&&window.parent!==window?window.parent.postMessage({type:"CLOSE_CHAT"},"*"):window.close()},se=()=>{const s=chrome.runtime.getURL(`chat.html?sessionId=${p.value}`);chrome.tabs.create({url:s}),window.parent&&window.parent.postMessage({type:"CLOSE_CHAT"},"*")},oe=()=>{chrome.tabs.create({url:"https://github.com/anthropics/claude-code/issues"})},ne=()=>{const s=chrome.runtime.getURL("options.html");chrome.tabs.create({url:s})},ae=async()=>{p.value=Date.now(),c.value=[],S.value="",x.value=!1,g.value=!1,y(()=>{var s;(s=E.value)==null||s.focus()})};return(s,e)=>(i(),r("div",pe,[t("div",ge,[t("div",ke,[t("div",ye,[e[4]||(e[4]=t("div",{class:"logo-icon"},[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})])],-1)),t("div",he,[e[3]||(e[3]=t("h3",null,"AI Chat Assistant",-1)),t("div",fe,[u.value?(i(),r("span",{key:0,class:"agent-badge",title:u.value.name},h(u.value.name),9,me)):v("",!0),m.value?(i(),r("span",we,h(m.value),1)):v("",!0)])])]),t("div",_e,[t("button",{class:"icon-btn",onClick:ae,title:"新建会话"},[...e[5]||(e[5]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"12",y1:"5",x2:"12",y2:"19","stroke-width":"2","stroke-linecap":"round"}),t("line",{x1:"5",y1:"12",x2:"19",y2:"12","stroke-width":"2","stroke-linecap":"round"})],-1)])]),t("button",{class:"icon-btn",onClick:oe,title:"帮助文档"},[...e[6]||(e[6]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("circle",{cx:"12",cy:"12",r:"10","stroke-width":"2"}),t("path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),t("line",{x1:"12",y1:"17",x2:"12.01",y2:"17","stroke-width":"2","stroke-linecap":"round"})],-1)])]),t("button",{class:"icon-btn",onClick:ne,title:"设置"},[...e[7]||(e[7]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("circle",{cx:"12",cy:"12",r:"3","stroke-width":"2"}),t("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])]),V.value?(i(),r("button",{key:0,class:T(["icon-btn",{active:b.value}]),onClick:ee,title:"固定窗口"},[...e[8]||(e[8]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M16 4v8l3 3-2 2-3-3-4 4-2-2 4-4-3-3 2-2 3 3V4h2z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],2)):v("",!0),V.value?(i(),r("button",{key:1,class:"icon-btn",onClick:se,title:"全屏打开"},[...e[9]||(e[9]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):v("",!0),t("button",{class:"icon-btn",onClick:te,title:"关闭"},[...e[10]||(e[10]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"18",y1:"6",x2:"6",y2:"18","stroke-width":"2","stroke-linecap":"round"}),t("line",{x1:"6",y1:"6",x2:"18",y2:"18","stroke-width":"2","stroke-linecap":"round"})],-1)])])])]),t("div",{class:"chat-messages",ref_key:"messagesContainer",ref:I},[c.value.length===0?(i(),r("div",xe,[...e[11]||(e[11]=[t("p",null,"开始对话吧",-1)])])):v("",!0),(i(!0),r(B,null,L(c.value,o=>(i(),r("div",{key:o.id||o.createdAt,class:T(["message",o.role])},[o.role==="user"?(i(),r("div",Ce,h(W(o)),1)):(i(),r("div",be,[(i(!0),r(B,null,L(o.blocks,(a,n)=>(i(),r(B,{key:n},[a.type==="text"?(i(),r("div",Me,[e[12]||(e[12]=t("span",{class:"block-indicator text-indicator"},"▶",-1)),t("span",Ae,h(a.text),1)])):a.type==="tool_use"?(i(),r("div",Ie,[t("div",Se,[e[13]||(e[13]=t("span",{class:"block-indicator tool-indicator"},"⚙",-1)),t("span",Te,h(a.name),1),a.status==="approved"?(i(),r("span",Be,"已批准")):a.status==="rejected"?(i(),r("span",Ee,"已拒绝")):v("",!0)]),t("pre",Ne,h(X(a.input)),1),a.status==="pending"&&!g.value?(i(),r("div",Le,[t("button",{class:"btn btn-approve",onClick:l=>G(a.id,!0)},"Approve",8,je),t("button",{class:"btn btn-reject",onClick:l=>G(a.id,!1)},"Reject",8,ze)])):v("",!0)])):v("",!0)],64))),128))]))],2))),128)),g.value?(i(),r("div",He,[...e[14]||(e[14]=[t("div",{class:"assistant-content"},[t("div",{class:"message-box assistant-box typing"},[t("span"),t("span"),t("span")])],-1)])])):v("",!0)],512),t("div",Pe,[t("div",{class:"agent-selector",onClick:q},[t("div",{class:T(["agent-selector-btn",{active:f.value}])},[e[15]||(e[15]=t("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"})],-1)),u.value?(i(),r("span",Ve)):v("",!0)],2),f.value?(i(),r("div",De,[t("div",Ue,[O(t("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=o=>M.value=o),placeholder:"搜索 Agent...",onClick:e[1]||(e[1]=j(()=>{},["stop"]))},null,512),[[$,M.value]])]),t("div",Re,[N.value?(i(),r("div",Ge,[...e[16]||(e[16]=[t("div",{class:"loading-spinner"},null,-1),t("span",null,"加载中...",-1)])])):D.value.length===0?(i(),r("div",Oe," 暂无可用 Agent ")):(i(!0),r(B,{key:2},L(D.value,o=>{var a,n;return i(),r("div",{key:o.id,class:T(["agent-dropdown-item",{selected:((a=u.value)==null?void 0:a.id)===o.id,recommended:o.id===A.value}]),onClick:j(l=>J(o),["stop"])},[e[18]||(e[18]=t("div",{class:"agent-dropdown-avatar"},[t("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"})])],-1)),t("div",Fe,[t("div",Ke,[de(h(o.name)+" ",1),o.id===A.value?(i(),r("span",qe,"推荐")):v("",!0)]),t("div",Je,h(o.description),1)]),((n=u.value)==null?void 0:n.id)===o.id?(i(),r("div",Qe,[...e[17]||(e[17]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("polyline",{points:"20 6 9 17 4 12","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):v("",!0)],10,$e)}),128))])])):v("",!0)]),O(t("textarea",{"onUpdate:modelValue":e[2]||(e[2]=o=>w.value=o),onKeydown:ce(j(R,["exact","prevent"]),["enter"]),placeholder:"输入消息... (Enter发送)",rows:"1",ref_key:"inputArea",ref:E},null,40,We),[[$,w.value]]),t("button",{class:"send-btn",onClick:R,disabled:!w.value.trim()||g.value},[...e[19]||(e[19]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"22",y1:"2",x2:"11",y2:"13","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),t("polygon",{points:"22 2 15 22 11 13 2 9 22 2","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],8,Xe)])])]))}}),Ze=ue(Ye,[["__scopeId","data-v-4a9c8b75"]]),et=ve(Ze);et.mount("#app");
