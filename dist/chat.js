import{d as le,f as ie,m as y,o as i,c as r,b as t,t as f,g as p,n as T,F as S,r as L,h as O,v as $,w as N,p as re,l as d,q as j,s as ce,_ as de,e as ue}from"./chunks/_plugin-vue_export-helper-C6Ao9Pha.js";const pe={class:"chat-wrapper"},ve={class:"chat-container"},ge={class:"chat-header"},ke={class:"header-left"},he={class:"header-title"},me={key:0,class:"model-badge"},ye={class:"header-right"},fe={key:0,class:"empty-state"},we={key:0,class:"message-box user-box"},_e={key:1,class:"assistant-content"},xe={key:0,class:"message-box assistant-box"},Ce={class:"block-content"},be={key:1,class:"tool-block"},Me={class:"tool-header"},Ae={class:"tool-name"},Ie={key:0,class:"tool-badge approved"},Te={key:1,class:"tool-badge rejected"},Se={class:"tool-params"},Be={key:0,class:"tool-actions"},Ee=["onClick"],Le=["onClick"],Ne={key:1,class:"message assistant"},je={class:"chat-input-area"},ze={key:0,class:"agent-selected-indicator"},He={key:0,class:"agent-dropdown-menu"},Pe={class:"agent-dropdown-header"},Ve={class:"agent-dropdown-list"},De={key:0,class:"agent-dropdown-loading"},Ue={key:1,class:"agent-dropdown-empty"},Re=["onClick"],Ge={class:"agent-dropdown-info"},Oe={class:"agent-dropdown-name"},$e={key:0,class:"recommended-tag"},Fe={class:"agent-dropdown-desc"},Ke={key:0,class:"agent-check"},qe=["onKeydown"],Je=["disabled"],Qe=le({__name:"App",setup(Ye){const I=d(),z=d(),w=d(""),k=d(!1),c=d([]),v=d(1),C=d(!1),F=j(()=>{if(c.value.length===0)return!1;const s=c.value[c.value.length-1];return s.role!=="assistant"?!1:s.blocks.some(e=>e.type==="tool_use"&&e.status==="pending")}),_=d([]),u=d(null),h=d(!1),b=d(""),B=d(!1),M=d(null),H=d(""),P=d(""),m=d("gpt-3.5-turbo"),E=d(""),A=d(!1),V=j(()=>window.self!==window.top),D=j(()=>{if(!b.value)return _.value;const s=b.value.toLowerCase();return _.value.filter(e=>{var o;return e.name.toLowerCase().includes(s)||e.description.toLowerCase().includes(s)||((o=e.tags)==null?void 0:o.some(a=>a.toLowerCase().includes(s)))})});ie(async()=>{const s=new URLSearchParams(window.location.search),e=s.get("sessionId");e&&(v.value=parseInt(e));const o=s.get("pageUrl"),a=s.get("pageTitle");o&&(H.value=decodeURIComponent(o)),a&&(P.value=decodeURIComponent(a)),await Q(),await U(),await K(),y(()=>{var n;(n=z.value)==null||n.focus()}),window.addEventListener("message",n=>{n.data.type==="PIN_STATUS_CHANGED"&&(C.value=n.data.isPinned),n.data.type==="PAGE_INFO"&&(H.value=n.data.url,P.value=n.data.title,U())}),document.addEventListener("click",n=>{n.target.closest(".agent-selector")||(h.value=!1)})});const U=async()=>{B.value=!0;try{const s=await chrome.runtime.sendMessage({type:"GET_AGENTS",payload:{userId:"default_user"}});if(s.success&&s.data){if(_.value=s.data.agents||[],M.value=s.data.recommended||null,M.value&&!u.value){const e=_.value.find(o=>o.id===M.value);e&&(u.value=e)}!u.value&&_.value.length>0&&(u.value=_.value[0])}}catch(s){console.error("加载 Agent 列表失败:",s)}finally{B.value=!1}},K=async()=>{try{const s=await chrome.runtime.sendMessage({type:"GET_SETTING",payload:{key:"model"}});s!=null&&s.success&&s.data?m.value=s.data:m.value="gpt-3.5-turbo"}catch(s){console.error("加载模型设置失败:",s),m.value="gpt-3.5-turbo"}},q=()=>{h.value=!h.value,h.value&&(b.value="")},J=s=>{u.value=s,h.value=!1},Q=async()=>{const s=await chrome.runtime.sendMessage({type:"GET_MESSAGES",payload:{sessionId:v.value}});s.success&&(c.value=s.data.map(e=>({...e,blocks:e.blocks||[{type:"text",text:e.content}]})),y(x))},W=s=>s.blocks.filter(o=>o.type==="text").map(o=>o.text).join(""),X=s=>JSON.stringify(s,null,2),R=async()=>{if(!w.value.trim()||k.value||A.value||F.value)return;const s=w.value.trim();w.value="";const e={sessionId:v.value,role:"user",blocks:[{type:"text",text:s}],createdAt:Date.now()};c.value.push(e),y(x),u.value&&u.value.id?await Y(s):await Z(s)},Y=async s=>{A.value=!0,E.value="";const e={sessionId:v.value,role:"assistant",blocks:[{type:"text",text:""}],createdAt:Date.now()};c.value.push(e);const o=c.value.length-1;try{const a=chrome.runtime.connect({name:"chat-stream"});a.onMessage.addListener(n=>{if(n.type==="data"){const l=n.data;if(l.content){E.value+=l.content;const g=c.value[o].blocks.find(ae=>ae.type==="text");g&&g.type==="text"&&(g.text=E.value),y(x)}if(l.toolCall&&!l.toolCall.partial){const g={type:"tool_use",id:`tool_${Date.now()}`,name:l.toolCall.tool_name,input:JSON.parse(l.toolCall.arguments||"{}"),status:"pending"};c.value[o].blocks.push(g),c.value[o].isComplete=!1,y(x)}l.think&&!l.think.partial&&console.log("思考过程:",l.think.reasoning_content),l.statistic&&console.log("Token 使用统计:",l.statistic.token_usage)}else if(n.type==="done")A.value=!1,c.value[o].blocks.some(g=>g.type==="tool_use")||(c.value[o].isComplete=!0),a.disconnect();else if(n.type==="error"){console.error("流式响应错误:",n.error);const l=c.value[o].blocks.find(g=>g.type==="text");l&&l.type==="text"&&(l.text=`错误: ${n.error}`),A.value=!1,a.disconnect()}}),a.postMessage({agentId:u.value.id,sessionId:v.value,message:s,model:m.value,userId:"default_user",role:"user"})}catch(a){console.error("发送流式消息失败:",a);const n=c.value[o].blocks.find(l=>l.type==="text");n&&n.type==="text"&&(n.text=`发送失败: ${a}`),A.value=!1}},Z=async s=>{k.value=!0;try{const e=await chrome.runtime.sendMessage({type:"SEND_MESSAGE",payload:{sessionId:v.value,content:s}});if(e.success){const o={sessionId:v.value,role:"assistant",blocks:e.blocks||[{type:"text",text:e.response}],createdAt:Date.now(),isComplete:e.isComplete!==!1};c.value.push(o),y(x)}}catch(e){console.error("发送消息失败:",e)}finally{k.value=!1}},G=async(s,e)=>{var a;const o=c.value[c.value.length-1];if(o&&o.role==="assistant"){const n=o.blocks.find(l=>l.type==="tool_use"&&l.id===s);n&&(n.status=e?"approved":"rejected")}k.value=!0;try{const n=await chrome.runtime.sendMessage({type:"TOOL_RESPONSE",payload:{sessionId:v.value,toolResponse:{toolId:s,approved:e},agentId:(a=u.value)==null?void 0:a.id,model:m.value,userId:"default_user"}});if(n.success&&n.blocks){const l={sessionId:v.value,role:"assistant",blocks:n.blocks,createdAt:Date.now(),isComplete:n.isComplete};c.value.push(l),y(x)}}catch(n){console.error("处理工具响应失败:",n)}finally{k.value=!1}},x=()=>{I.value&&(I.value.scrollTop=I.value.scrollHeight)},ee=()=>{console.log("togglePin clicked, current isPinned:",C.value),window.parent&&window.parent!==window?(console.log("Sending PIN_CHAT message to parent"),window.parent.postMessage({type:"PIN_CHAT"},"*"),C.value=!C.value):console.log("Not in iframe, cannot pin")},te=()=>{window.parent&&window.parent!==window?window.parent.postMessage({type:"CLOSE_CHAT"},"*"):window.close()},se=()=>{const s=chrome.runtime.getURL(`chat.html?sessionId=${v.value}`);chrome.tabs.create({url:s}),window.parent&&window.parent.postMessage({type:"CLOSE_CHAT"},"*")},oe=()=>{chrome.tabs.create({url:"https://github.com/anthropics/claude-code/issues"})},ne=()=>{const s=chrome.runtime.getURL("options.html");chrome.tabs.create({url:s})};return(s,e)=>(i(),r("div",pe,[t("div",ve,[t("div",ge,[t("div",ke,[e[4]||(e[4]=t("div",{class:"logo-icon"},[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})])],-1)),t("div",he,[e[3]||(e[3]=t("h3",null,"AI Chat Assistant",-1)),m.value?(i(),r("span",me,f(m.value),1)):p("",!0)])]),t("div",ye,[t("button",{class:"icon-btn",onClick:oe,title:"帮助文档"},[...e[5]||(e[5]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("circle",{cx:"12",cy:"12",r:"10","stroke-width":"2"}),t("path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),t("line",{x1:"12",y1:"17",x2:"12.01",y2:"17","stroke-width":"2","stroke-linecap":"round"})],-1)])]),t("button",{class:"icon-btn",onClick:ne,title:"设置"},[...e[6]||(e[6]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("circle",{cx:"12",cy:"12",r:"3","stroke-width":"2"}),t("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])]),V.value?(i(),r("button",{key:0,class:T(["icon-btn",{active:C.value}]),onClick:ee,title:"固定窗口"},[...e[7]||(e[7]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M16 4v8l3 3-2 2-3-3-4 4-2-2 4-4-3-3 2-2 3 3V4h2z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],2)):p("",!0),V.value?(i(),r("button",{key:1,class:"icon-btn",onClick:se,title:"全屏打开"},[...e[8]||(e[8]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{d:"M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):p("",!0),t("button",{class:"icon-btn",onClick:te,title:"关闭"},[...e[9]||(e[9]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"18",y1:"6",x2:"6",y2:"18","stroke-width":"2","stroke-linecap":"round"}),t("line",{x1:"6",y1:"6",x2:"18",y2:"18","stroke-width":"2","stroke-linecap":"round"})],-1)])])])]),t("div",{class:"chat-messages",ref_key:"messagesContainer",ref:I},[c.value.length===0?(i(),r("div",fe,[...e[10]||(e[10]=[t("p",null,"开始对话吧",-1)])])):p("",!0),(i(!0),r(S,null,L(c.value,o=>(i(),r("div",{key:o.id||o.createdAt,class:T(["message",o.role])},[o.role==="user"?(i(),r("div",we,f(W(o)),1)):(i(),r("div",_e,[(i(!0),r(S,null,L(o.blocks,(a,n)=>(i(),r(S,{key:n},[a.type==="text"?(i(),r("div",xe,[e[11]||(e[11]=t("span",{class:"block-indicator text-indicator"},"▶",-1)),t("span",Ce,f(a.text),1)])):a.type==="tool_use"?(i(),r("div",be,[t("div",Me,[e[12]||(e[12]=t("span",{class:"block-indicator tool-indicator"},"⚙",-1)),t("span",Ae,f(a.name),1),a.status==="approved"?(i(),r("span",Ie,"已批准")):a.status==="rejected"?(i(),r("span",Te,"已拒绝")):p("",!0)]),t("pre",Se,f(X(a.input)),1),a.status==="pending"&&!k.value?(i(),r("div",Be,[t("button",{class:"btn btn-approve",onClick:l=>G(a.id,!0)},"Approve",8,Ee),t("button",{class:"btn btn-reject",onClick:l=>G(a.id,!1)},"Reject",8,Le)])):p("",!0)])):p("",!0)],64))),128))]))],2))),128)),k.value?(i(),r("div",Ne,[...e[13]||(e[13]=[t("div",{class:"assistant-content"},[t("div",{class:"message-box assistant-box typing"},[t("span"),t("span"),t("span")])],-1)])])):p("",!0)],512),t("div",je,[t("div",{class:"agent-selector",onClick:q},[t("div",{class:T(["agent-selector-btn",{active:h.value}])},[e[14]||(e[14]=t("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"})],-1)),u.value?(i(),r("span",ze)):p("",!0)],2),h.value?(i(),r("div",He,[t("div",Pe,[O(t("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=o=>b.value=o),placeholder:"搜索 Agent...",onClick:e[1]||(e[1]=N(()=>{},["stop"]))},null,512),[[$,b.value]])]),t("div",Ve,[B.value?(i(),r("div",De,[...e[15]||(e[15]=[t("div",{class:"loading-spinner"},null,-1),t("span",null,"加载中...",-1)])])):D.value.length===0?(i(),r("div",Ue," 暂无可用 Agent ")):(i(!0),r(S,{key:2},L(D.value,o=>{var a,n;return i(),r("div",{key:o.id,class:T(["agent-dropdown-item",{selected:((a=u.value)==null?void 0:a.id)===o.id,recommended:o.id===M.value}]),onClick:N(l=>J(o),["stop"])},[e[17]||(e[17]=t("div",{class:"agent-dropdown-avatar"},[t("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[t("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"})])],-1)),t("div",Ge,[t("div",Oe,[ce(f(o.name)+" ",1),o.id===M.value?(i(),r("span",$e,"推荐")):p("",!0)]),t("div",Fe,f(o.description),1)]),((n=u.value)==null?void 0:n.id)===o.id?(i(),r("div",Ke,[...e[16]||(e[16]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("polyline",{points:"20 6 9 17 4 12","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):p("",!0)],10,Re)}),128))])])):p("",!0)]),O(t("textarea",{"onUpdate:modelValue":e[2]||(e[2]=o=>w.value=o),onKeydown:re(N(R,["exact","prevent"]),["enter"]),placeholder:"输入消息... (Enter发送)",rows:"1",ref_key:"inputArea",ref:z},null,40,qe),[[$,w.value]]),t("button",{class:"send-btn",onClick:R,disabled:!w.value.trim()||k.value},[...e[18]||(e[18]=[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("line",{x1:"22",y1:"2",x2:"11",y2:"13","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),t("polygon",{points:"22 2 15 22 11 13 2 9 22 2","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],8,Je)])])]))}}),We=de(Qe,[["__scopeId","data-v-4ac2791c"]]),Xe=ue(We);Xe.mount("#app");
