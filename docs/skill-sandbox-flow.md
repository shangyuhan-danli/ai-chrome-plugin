# Skill 沙箱执行流程图

## 完整执行流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        主页面（你的房子）                        │
│                                                                 │
│  1. 注册 Skill                                                  │
│     skillManager.registerSkill({ script: "..." })              │
│                                                                 │
│  2. 验证脚本安全性                                              │
│     ✓ 检查危险操作（eval, Function, document.write）          │
│     ✓ 检查脚本长度                                              │
│                                                                 │
│  3. 执行 Skill                                                  │
│     skillManager.executeSkill('skill-id', context)             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              创建沙箱 iframe（玻璃房间）                         │
│                                                                 │
│  const iframe = document.createElement('iframe')              │
│  iframe.sandbox.add('allow-scripts')      // 允许脚本          │
│  iframe.sandbox.add('allow-same-origin')  // 允许通信          │
│  iframe.src = 'about:blank'                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              注入脚本到沙箱                                     │
│                                                                 │
│  const sandboxScript = `                                       │
│    // 1. 注入上下文                                            │
│    const context = ${JSON.stringify(context)};                │
│                                                                 │
│    // 2. 创建 safeAPI（通过 postMessage）                      │
│    const safeAPI = {                                           │
│      getElementById: async (id) => {                           │
│        return await sendRequest('getElementById', { id });     │
│      }                                                          │
│    };                                                           │
│                                                                 │
│    // 3. 执行用户脚本                                          │
│    ${userScript}                                               │
│                                                                 │
│    // 4. 发送结果                                              │
│    parent.postMessage({ type: 'SKILL_RESULT', result }, '*'); │
│  `                                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              沙箱中执行用户脚本                                 │
│                                                                 │
│  // 用户脚本示例                                                │
│  const input = await safeAPI.getElementById('search-input');   │
│  return { value: input.value };                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ safeAPI 调用
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│          postMessage 通信（安全通道）                          │
│                                                                 │
│  沙箱 → 主页面:                                                │
│  {                                                              │
│    type: 'SKILL_REQUEST',                                      │
│    requestType: 'getElementById',                              │
│    data: { id: 'search-input' }                               │
│  }                                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│          主页面处理请求（handleSkillRequest）                   │
│                                                                 │
│  const el = document.getElementById('search-input');           │
│                                                                 │
│  // 只返回安全的数据（不返回 DOM 对象）                        │
│  return {                                                       │
│    tagName: el.tagName,                                        │
│    textContent: el.textContent,                                │
│    value: el.value                                             │
│  };                                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│          postMessage 返回响应                                  │
│                                                                 │
│  主页面 → 沙箱:                                                │
│  {                                                              │
│    type: 'SKILL_RESPONSE',                                     │
│    success: true,                                              │
│    result: { tagName: 'INPUT', value: 'iPhone' }               │
│  }                                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              沙箱收到响应，继续执行                             │
│                                                                 │
│  const input = await safeAPI.getElementById('search-input');   │
│  // input = { tagName: 'INPUT', value: 'iPhone' }             │
│                                                                 │
│  return { value: input.value };  // 返回 'iPhone'              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              发送最终结果                                       │
│                                                                 │
│  沙箱 → 主页面:                                                │
│  {                                                              │
│    type: 'SKILL_RESULT',                                       │
│    result: { value: 'iPhone' }                                 │
│  }                                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              主页面接收结果，返回给调用者                        │
│                                                                 │
│  resolve({ value: 'iPhone' })                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 关键点说明

### 1. 沙箱隔离

```
┌─────────────┐         ┌─────────────┐
│   主页面    │         │  沙箱 iframe│
│             │         │             │
│ document    │  ❌ 不能 │ 无法直接访问 │
│ window      │  直接访问│ 主页面 DOM  │
│             │         │             │
└─────────────┘         └─────────────┘
```

### 2. 安全通信

```
主页面 ←── postMessage ──→ 沙箱
  │                          │
  │  只发送安全数据          │  只能通过 safeAPI
  │  验证消息来源            │  请求操作
  │                          │
```

### 3. 超时保护

```
执行开始 ──→ [10秒计时器] ──→ 超时则终止
              │
              └─→ 正常完成则取消计时器
```

## 安全机制总结

1. ✅ **脚本验证**：执行前检查危险操作
2. ✅ **沙箱隔离**：在隔离的 iframe 中执行
3. ✅ **受限访问**：只能通过 safeAPI 访问主页面
4. ✅ **通信验证**：验证 postMessage 消息来源
5. ✅ **超时保护**：10秒超时自动终止
6. ✅ **数据过滤**：只返回安全的数据，不返回 DOM 对象
